!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.UM={},t.THREE)}(this,function(t,A){"use strict";var e=t.VERSION="0.5.8",k=function(t,e,i,r,o,n){if(t<=0||e<=0||i<=0||r<=0||o<=0||n<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[t,e,i,r,o,n];var s=Math.PI/180,a=Math.cos(s*r),l=Math.cos(s*o),h=Math.cos(s*n),c=Math.sin(s*r),d=Math.sin(s*o),u=Math.sin(s*n);if(0===c||0===d||0===u)throw Error("Impossible angle - N*180deg.");var f=(l*h-a)/u,p=f/d,_=Math.sqrt(1-p*p);this.orth=[t,e*h,i*l,0,e*u,-i*f,0,0,i*d*_],this.frac=[1/t,-h/(u*t),-(h*f+l*u)/(d*_*u*t),0,1/(u*e),p/(_*u*e),0,0,1/(d*_*i)]};function i(t,e){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],+e[4]*t[1]+e[5]*t[2],+e[8]*t[2]]}k.prototype.fractionalize=function(t){return i(t,this.frac)},k.prototype.orthogonalize=function(t){return i(t,this.orth)};var n=["HOH"].concat(["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"]);function s(t){for(var e=[new o],i=e[0].from_pdb(t.split("\n"));null!=i;){var r=new o;i=r.from_pdb(i),0<r.atoms.length&&e.push(r)}return e}var o=function(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=[0,0,0],this.upper_bound=[0,0,0],this.residue_map=null,this.cubes=null};o.prototype.from_pdb=function(t){for(var e=0,i=null,r=0,o=null,n=0;n<t.length;n++){var s=t[n],a=s.substring(0,6).toUpperCase();if("ATOM  "===a||"HETATM"===a){var l=new _;l.from_pdb_line(s),l.i_seq=r++,this.has_hydrogens||"H"!==l.element||(this.has_hydrogens=!0),l.chain!==i&&e++,l.chain_index=e,i=l.chain,this.atoms.push(l)}else if("ANISOU"===a);else if("CRYST1"===a){var h=parseFloat(s.substring(6,15)),c=parseFloat(s.substring(15,24)),d=parseFloat(s.substring(24,33)),u=parseFloat(s.substring(33,40)),f=parseFloat(s.substring(40,47)),p=parseFloat(s.substring(47,54));this.unit_cell=new k(h,c,d,u,f,p)}else if("TER"===a.substring(0,3))i=null;else if("ENDMDL"===a){for(;n<t.length;n++)if("MODEL "===t[n].substring(0,6).toUpperCase()){o=t.slice(n);break}break}}if(0===this.atoms.length)throw Error("No atom records found.");return this.calculate_bounds(),this.calculate_connectivity(),o},o.prototype.calculate_bounds=function(){for(var t=this.lower_bound=[1/0,1/0,1/0],e=this.upper_bound=[-1/0,-1/0,-1/0],i=0;i<this.atoms.length;i++)for(var r=this.atoms[i],o=0;o<3;o++){var n=r.xyz[o];n<t[o]&&(t[o]=n),n>e[o]&&(e[o]=n)}for(var s=0;s<3;++s)t[s]-=.001,e[s]+=.001},o.prototype.next_residue=function(t,e){for(var i=this.atoms.length,r=(t?t.i_seq:0)+i,o=t?1:0;o<i;o++){var n=(r+(e?-o:o))%i,s=this.atoms[n];if(s.is_main_conformer()&&("CA"===s.name&&"C"===s.element||"P"===s.name))return s}},o.prototype.extract_trace=function(){for(var t=[],e=[],i=null,r=0;r<this.atoms.length;r++){var o=this.atoms[r];if((""===o.altloc||"A"===o.altloc)&&("CA"===o.name&&"C"===o.element||"P"===o.name)){var n=!0;if(null!==i&&i.chain_index===o.chain_index){var s=o.distance_sq(i);("CA"===o.name&&s<=30.25||"P"===o.name&&s<56.25)&&(e.push(o),n=!1)}n&&(2<e.length&&t.push(e),e=[o]),i=o}}return 2<e.length&&t.push(e),t},o.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var t={},e=0;e<this.atoms.length;e++){var i=this.atoms[e],r=i.resid(),o=t[r];void 0===o?t[r]=[i]:o.push(i)}return this.residue_map=t},o.prototype.calculate_tangent_vector=function(t){for(var e=null,i=null,r=3===t[0].resname.length,o=r?"C":"C2'",n=r?"O":"O4'",s=0;s<t.length;s++){var a=t[s];a.is_main_conformer()&&(a.name===o?e=a.xyz:a.name===n&&(i=a.xyz))}if(null===e||null===i)return[0,0,1];var l=[e[0]-i[0],e[1]-i[1],e[2]-i[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},o.prototype.get_center=function(){for(var t=0,e=0,i=0,r=this.atoms.length,o=0;o<r;o++){var n=this.atoms[o].xyz;t+=n[0],e+=n[1],i+=n[2]}return[t/r,e/r,i/r]},o.prototype.calculate_connectivity=function(){for(var t=this.atoms,e=new h(t,3,this.lower_bound,this.upper_bound),i=0;i<e.boxes.length;i++){var r=e.boxes[i];if(0!==r.length)for(var o=e.get_nearby_atoms(i),n=0;n<r.length;n++)for(var s=r[n],a=0;a<o.length;a++){var l=o[a];s<l&&t[s].is_bonded_to(t[l])&&(t[s].bonds.push(l),t[l].bonds.push(s))}}this.cubes=e},o.prototype.get_nearest_atom=function(t,e,i,r){var o=this.cubes;if(null==o)throw Error("Missing Cubicles");for(var n=o.find_box_id(t,e,i),s=o.get_nearby_atoms(n),a=null,l=1/0,h=0;h<s.length;h++){var c=this.atoms[s[h]];if(null==r||r===c.name){var d=c.xyz[0]-t,u=c.xyz[1]-e,f=c.xyz[2]-i,p=d*d+u*u+f*f;p<l&&(a=c,l=p)}}return a};var _=function(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=-1,this.resseq=-1,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.i_seq=-1,this.is_ligand=null,this.bonds=[]};_.prototype.from_pdb_line=function(t){if(t.length<66)throw Error("ATOM or HETATM record is too short: "+t);var e=t.substring(0,6);if("HETATM"===e)this.hetero=!0;else if("ATOM  "!==e)throw Error("Wrong record type: "+e);this.name=t.substring(12,16).trim(),this.altloc=t.substring(16,17).trim(),this.resname=t.substring(17,20).trim(),this.chain=t.substring(20,22).trim(),this.resseq=parseInt(t.substring(22,26),10),this.icode=t.substring(26,27).trim();var i=parseFloat(t.substring(30,38)),r=parseFloat(t.substring(38,46)),o=parseFloat(t.substring(46,54));this.xyz=[i,r,o],this.occ=parseFloat(t.substring(54,60)),this.b=parseFloat(t.substring(60,66)),78<=t.length&&(this.element=t.substring(76,78).trim().toUpperCase()),this.is_ligand=-1===n.indexOf(this.resname)},_.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},_.prototype.distance_sq=function(t){var e=this.xyz[0]-t.xyz[0],i=this.xyz[1]-t.xyz[1],r=this.xyz[2]-t.xyz[2];return e*e+i*i+r*r},_.prototype.distance=function(t){return Math.sqrt(this.distance_sq(t))},_.prototype.midpoint=function(t){return[(this.xyz[0]+t.xyz[0])/2,(this.xyz[1]+t.xyz[1])/2,(this.xyz[2]+t.xyz[2])/2]},_.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},_.prototype.is_ion=function(){return this.element===this.resname},_.prototype.is_water=function(){return"HOH"===this.resname},_.prototype.is_same_residue=function(t,e){return t.resseq===this.resseq&&t.icode===this.icode&&t.chain===this.chain&&t.resname===this.resname&&(e||t.altloc===this.altloc)},_.prototype.is_same_conformer=function(t){return""===this.altloc||""===t.altloc||this.altloc===t.altloc},_.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},_.prototype.bond_radius=function(){return"H"===this.element?1.3:"S"===this.element||"P"===this.element?2.43:1.99},_.prototype.is_bonded_to=function(t){if(!this.is_same_conformer(t))return!1;var e=this.distance_sq(t);return!(2.2*2.2<e)&&(("H"!==this.element||"H"!==t.element)&&e<=this.bond_radius()*t.bond_radius())},_.prototype.resid=function(){return this.resseq+"/"+this.chain},_.prototype.long_label=function(){var t=this;return t.name+" /"+t.resseq+" "+t.resname+"/"+t.chain+" - occ: "+t.occ.toFixed(2)+" bf: "+t.b.toFixed(2)+" ele: "+t.element+" pos: ("+t.xyz[0].toFixed(2)+","+t.xyz[1].toFixed(2)+","+t.xyz[2].toFixed(2)+")"},_.prototype.short_label=function(){return this.name+" /"+this.resseq+" "+this.resname+"/"+this.chain};var h=function(t,e,i,r){this.boxes=[],this.box_length=e,this.lower_bound=i,this.upper_bound=r,this.xdim=Math.ceil((r[0]-i[0])/e),this.ydim=Math.ceil((r[1]-i[1])/e),this.zdim=Math.ceil((r[2]-i[2])/e);for(var o=this.xdim*this.ydim*this.zdim,n=0;n<o;n++)this.boxes.push([]);for(var s=0;s<t.length;s++){var a=t[s].xyz,l=this.find_box_id(a[0],a[1],a[2]);if(null===l)throw Error("wrong cubicle");this.boxes[l].push(s)}};h.prototype.find_box_id=function(t,e,i){var r=Math.floor((t-this.lower_bound[0])/this.box_length),o=Math.floor((e-this.lower_bound[1])/this.box_length),n=(Math.floor((i-this.lower_bound[2])/this.box_length)*this.ydim+o)*this.xdim+r;if(n<0||n>=this.boxes.length)throw Error("Ups!");return n},h.prototype.get_nearby_atoms=function(t){var e=[],i=this.xdim*this.ydim,r=Math.max(t%i,0),o=Math.max(r%this.xdim,0),n=Math.floor(r/this.xdim),s=Math.floor(t/i);console.assert(s*i+n*this.xdim+o===t);for(var a=o-1;a<=o+1;a++)if(!(a<0||a>=this.xdim))for(var l=n-1;l<=n+1;l++)if(!(l<0||l>=this.ydim))for(var h=s-1;h<=s+1;h++)if(!(h<0||h>=this.zdim)){var c=h*i+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var d=this.boxes[c],u=0;u<d.length;u++)e.push(d[u])}return e};var r=function(){this._points=null,this._values=null,this._size=[0,0,0]};r.prototype.set=function(t,e,i){if(i[0]<=0||i[1]<=0||i[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var r=i[0]*i[1]*i[2];if(e.length!==r||t.length!==r)throw Error("isosurface: array size mismatch");this._points=t,this._values=e,this._size=i},r.prototype.clear=function(){this._points=null,this._values=null},r.prototype.empty=function(){return null===this._values},r.prototype.isosurface=function(t,e){return function(t,e,i,r,o){var n="snapped MC"===o,s="squarish"===o?T:F,a=new Array(12),l=function(t){for(var e=[],i=0;i<8;++i){var r=P[i];e.push(r[0]+t[2]*(r[1]+t[1]*r[2]))}return e}(t),h=new Float32Array(8),c=[0,0,0],d=[c,c,c,c,c,c,c,c],u=t[0],f=t[1],p=t[2];if(null==e||null==i)return;for(var _=[],m=[],g=0,v=0;v<u-1;v++)for(var b=0;b<f-1;b++)for(var y=0;y<p-1;y++){var w=y+p*(b+f*v),x=0,z=void 0,A=void 0;for(z=0;z<8;++z)A=w+l[z],x|=e[A]<r?1<<z:0;if(0!==x&&255!==x){for(z=0;z<8;++z)A=w+l[z],h[z]=e[A],d[z]=i[A];var M=L[x];for(z=0;z<12;++z)if(0!=(M&1<<z)){var E=j[z],C=(r-h[E[0]])/(h[E[1]]-h[E[0]]);!0===n&&(.85<C?C=1:C<.15&&(C=0));var S=d[E[0]],k=d[E[1]];_.push(S[0]+(k[0]-S[0])*C,S[1]+(k[1]-S[1])*C,S[2]+(k[2]-S[2])*C),a[z]=g++}var O=s[x];for(z=0;z<O.length;z++)m.push(a[O[z]])}}return{vertices:_,segments:m}}(this._size,this._values,this._points,t,e)};var L=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),F=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],T=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],P=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],j=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];function a(t,e){var i=t%e;return 0<=i?i:i+e}var O=function(t){this.dim=t,this.values=new Float32Array(t[0]*t[1]*t[2])};function R(t,e){for(var i=0,r=0,o=t.length,n=e;n<o;n++)i+=t[n],r+=t[n]*t[n];var s=i/(o-e),a=r/(o-e)-s*s;return{mean:s,rms:Math.sqrt(a)}}O.prototype.grid2index=function(t,e,i){return t=a(t,this.dim[0]),e=a(e,this.dim[1]),i=a(i,this.dim[2]),this.dim[2]*(this.dim[1]*t+e)+i},O.prototype.grid2index_unchecked=function(t,e,i){return this.dim[2]*(this.dim[1]*t+e)+i},O.prototype.grid2frac=function(t,e,i){return[t/this.dim[0],e/this.dim[1],i/this.dim[2]]},O.prototype.frac2grid=function(t){return[0|Math.floor(t[0]*this.dim[0]),0|Math.floor(t[1]*this.dim[1]),0|Math.floor(t[2]*this.dim[2])]},O.prototype.set_grid_value=function(t,e,i,r){var o=this.grid2index(t,e,i);this.values[o]=r},O.prototype.get_grid_value=function(t,e,i){var r=this.grid2index(t,e,i);return this.values[r]};var l=function(){this.unit_cell=null,this.grid=null,this.stats={mean:0,rms:1},this.block=new r};function q(t){var e=t.toLowerCase().replace(/\s+/g,"").split(",");if(3!==e.length)throw Error("Unexpected symop: "+t);for(var i=[],r=0;r<3;r++){for(var o=e[r].split(/(?=[+-])/),n=[0,0,0,0],s=0;s<o.length;s++){var a="-"===o[s][0]?-1:1,l=o[s].match(/^[+-]?([xyz])$/);if(l){n[{x:0,y:1,z:2}[l[1]]]=a}else{if(!(l=o[s].match(/^[+-]?(\d)\/(\d)$/)))throw Error("What is "+o[s]+" in "+t);n[3]=a*Number(l[1])/Number(l[2])}}i.push(n)}return i}l.prototype.abs_level=function(t){return t*this.stats.rms+this.stats.mean},l.prototype.from_ccp4=function(t,e){if(void 0===e&&(e=!0),t.byteLength<1024)throw Error("File shorter than 1024 bytes.");var i=new Int32Array(t,0,256);if(542130509!==i[52])throw Error("not a CCP4 map");var r,o=[i[0],i[1],i[2]],n=i[3];if(2===n)r=4;else{if(0!==n)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");r=1}var s=[i[4],i[5],i[6]],a=[i[7],i[8],i[9]],l=i[23];if(1024+l+r*o[0]*o[1]*o[2]!==t.byteLength)throw Error("ccp4 file too short or too long");var h=new Float32Array(t,0,t.byteLength/4);this.unit_cell=new k(h[10],h[11],h[12],h[13],h[14],h[15]);var c,d=[i[16],i[17],i[18]],u=d.indexOf(1),f=d.indexOf(2),p=d.indexOf(3),_=h[19],m=h[20],g=new O(a);if(l%4!=0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");c=2===n?h:new Int8Array(t);var v=(1024+l)/r|0;this.stats.mean=h[21],this.stats.rms=h[54],(this.stats.mean<_||this.stats.mean>m||this.stats.rms<=0)&&(this.stats=R(c,v));var b=1,y=0;0===n&&-128===i[39]&&127===i[40]&&(y=.5*(_+m+(b=(m-_)/255)));var w=[s[0]+o[0],s[1]+o[1],s[2]+o[2]],x=[0,0,0];for(x[2]=s[2];x[2]<w[2];x[2]++)for(x[1]=s[1];x[1]<w[1];x[1]++)for(x[0]=s[0];x[0]<w[0];x[0]++)g.set_grid_value(x[u],x[f],x[p],b*c[v]+y),v++;if(e&&0<l)for(var z=new Uint8Array(t),A=0;A+80<=l;A+=80){var M=void 0,E="";for(M=0;M<80;++M)E+=String.fromCharCode(z[1024+A+M]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(E)){var C=q(E);for(M=0;M<3;++M)C[M][3]=0|Math.round(C[M][3]*a[M]);v=(1024+l)/r|0;var S=[0,0,0];for(x[2]=s[2];x[2]<w[2];x[2]++)for(x[1]=s[1];x[1]<w[1];x[1]++)for(x[0]=s[0];x[0]<w[0];x[0]++){for(M=0;M<3;++M)S[M]=x[u]*C[M][0]+x[f]*C[M][1]+x[p]*C[M][2]+C[M][3];g.set_grid_value(S[0],S[1],S[2],b*c[v]+y),v++}}}this.grid=g},l.prototype.from_dsn6=function(t){var e=new Uint8Array(t),i=new Int16Array(e.buffer);if(100!==i[18])for(var r=i.length,o=0;o<r;o++){var n=i[o];i[o]=(255&n)<<8|n>>8&255}if(100!==i[18])throw Error("Endian swap failed");var s=[i[0],i[1],i[2]],a=[i[3],i[4],i[5]],l=[i[6],i[7],i[8]],h=1/i[17];this.unit_cell=new k(h*i[9],h*i[10],h*i[11],h*i[12],h*i[13],h*i[14]);for(var c=new O(l),d=i[15]/100,u=i[16],f=512,p=[Math.ceil(a[0]/8),Math.ceil(a[1]/8),Math.ceil(a[2]/8)],_=0;_<p[2];_++)for(var m=0;m<p[1];m++)for(var g=0;g<p[0];g++)for(var v=0;v<8;v++)for(var b=8*_+v,y=0;y<8;y++)for(var w=8*m+y,x=0;x<8;x++){var z=8*g+x;if(!(z<a[0]&&w<a[1]&&b<a[2])){f+=8-x;break}var A=(e[f]-u)/d;f++,c.set_grid_value(s[0]+z,s[1]+w,s[2]+b,A)}this.stats=R(c.values,0),this.grid=c},l.prototype.show_debug_info=function(){console.log("unit cell:",this.unit_cell&&this.unit_cell.parameters),console.log("grid:",this.grid&&this.grid.dim)},l.prototype.extract_block=function(t,e){var i=this.grid,r=this.unit_cell;if(null!=i&&null!=r){for(var o=r.fractionalize(e),n=[t/r.parameters[0],t/r.parameters[1],t/r.parameters[2]],s=i.frac2grid([o[0]-n[0],o[1]-n[1],o[2]-n[2]]),a=i.frac2grid([o[0]+n[0],o[1]+n[1],o[2]+n[2]]),l=[a[0]-s[0]+1,a[1]-s[1]+1,a[2]-s[2]+1],h=[],c=[],d=s[0];d<=a[0];d++)for(var u=s[1];u<=a[1];u++)for(var f=s[2];f<=a[2];f++){var p=i.grid2frac(d,u,f),_=r.orthogonalize(p);h.push(_);var m=i.get_grid_value(d,u,f);c.push(m)}this.block.set(h,c,l)}},l.prototype.isomesh_in_block=function(t,e){var i=this.abs_level(t);return this.block.isosurface(i,e)},l.prototype.unit="e/Å³";var c=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]];function d(e,i,t){var r=c.map(function(t){return{x:i.x+e*(t[0]-.5),y:i.y+e*(t[1]-.5),z:i.z+e*(t[2]-.5)}});return H(S({gl_lines:!0,color:t.color,linewidth:t.linewidth,win_size:t.win_size,segments:!0}),r)}function u(e,t){for(var i=c.map(function(t){return{xyz:e(t)}}),r=[new A.Color(16711680),new A.Color(16755200),new A.Color(65280),new A.Color(11206400),new A.Color(255),new A.Color(43775)],o=6;o<c.length;o++)r.push(t.color);return H(S({gl_lines:!0,linewidth:1,segments:!0}),i,r)}function f(t){var e,i=[];if(t&&t[0].xyz)for(e=0;e<t.length;e++){var r=t[e].xyz;i.push(r[0],r[1],r[2]),i.push(r[0],r[1],r[2])}else for(e=0;e<t.length;e++){var o=t[e];i.push(o.x,o.y,o.z),i.push(o.x,o.y,o.z)}return i}function p(t){for(var e=t.length,i=new Float32Array(6*e),r=0;r<e;r++){var o=t[r];i[6*r]=o.r,i[6*r+1]=o.g,i[6*r+2]=o.b,i[6*r+3]=o.r,i[6*r+4]=o.g,i[6*r+5]=o.b}return i}var m=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * win_size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * win_size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / win_size;","}"].join("\n"),g=["attribute vec3 other;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / win_size;","}"].join("\n"),v=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function b(t){var e={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var i in t)e[i]={value:t[i]};return e}var y=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),w=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function x(t,e,i,r){var o=function(t,e){for(var i=[],r=0;r<t.length;r++){var o=t[r].xyz;i.push(new A.Vector3(o[0],o[1],o[2]))}return!e||e<2?i:new A.CatmullRomCurve3(i).getPoints((t.length-1)*e)}(t,r),n=function(t,e){if(!e||e<2)return t;for(var i=[],r=0;r<t.length-1;r++)for(var o=0;o<e;o++)i.push(t[r]);return i.push(t[t.length-1]),i}(e,r),s=function(t,e){e=e||1;var i,r=[];for(i=0;i<t.length-1;i++)for(var o=t[i],n=t[i+1],s=0;s<e;s++){var a=s/e,l=1-a;r.push(l*o[0]+a*n[0],l*o[1]+a*n[1],l*o[2]+a*n[2])}return r.push(t[i][0],t[i][1],t[i][2]),r}(i,r),a=new A.Object3D,l=B(o,n),h=new Float32Array(s);l.addAttribute("normal",new A.BufferAttribute(h,3));for(var c=new A.ShaderMaterial({uniforms:b({shift:0}),vertexShader:y,fragmentShader:w,fog:!0,vertexColors:A.VertexColors}),d=-4;d<5;d++){var u=0===d?c:c.clone();u.uniforms.shift.value=.1*d,a.add(new A.Line(l,u))}return a}function z(t,e){var i=new A.BufferGeometry,r=new Float32Array(t.vertices);i.addAttribute("position",new A.BufferAttribute(r,3));var o=t.vertices.length<196608?new Uint16Array(t.segments):new Uint32Array(t.segments);i.setIndex(new A.BufferAttribute(o,1));var n=new A.LineBasicMaterial(e);return new A.LineSegments(i,n)}var M=["uniform vec3 ucolor;","uniform vec3 fogColor;","varying vec4 vcolor;","void main() {","  vec2 scale = vec2(projectionMatrix[0][0], projectionMatrix[1][1]);","  float z = position.z;","  float fogFactor = (z > 0.5 ? 0.2 : 0.7);","  float alpha = 0.8 * smoothstep(z > 1.5 ? -10.0 : 0.01, 0.1, scale.y);","  vcolor = vec4(mix(ucolor, fogColor, fogFactor), alpha);","  gl_Position = vec4(position.xy * scale, -0.99, 1.0);","}"].join("\n"),E=["varying vec4 vcolor;","void main() {","  gl_FragColor = vcolor;","}"].join("\n");function C(){for(var t=[],e=-50;e<=50;e++){var i=0;e%5==0&&(i=e%2==0?2:1),t.push(-50,e,i,50,e,i),t.push(e,-50,i,e,50,i)}var r=new A.BufferGeometry;r.addAttribute("position",new A.BufferAttribute(new Float32Array(t),3));var o=new A.ShaderMaterial({uniforms:b({ucolor:new A.Color(8947848)}),vertexShader:M,fragmentShader:E,fog:!0});o.transparent=!0;var n=new A.LineSegments(r,o);return n.frustumCulled=!1,n.color_value=o.uniforms.ucolor.value,n}function S(t){return t.gl_lines?((o={}).linewidth=(r=t).linewidth,void 0===r.color?o.vertexColors=A.VertexColors:o.color=r.color,new A.LineBasicMaterial(o)):(i=b({linewidth:(e=t).linewidth,win_size:e.win_size}),new A.ShaderMaterial({uniforms:i,vertexShader:e.segments?g:m,fragmentShader:v,fog:!0,vertexColors:A.VertexColors}));var e,i,r,o}function B(t,e){var i,r=new A.BufferGeometry,o=new Float32Array(3*t.length);if(t&&t[0].xyz)for(i=0;i<t.length;i++){var n=t[i].xyz;o[3*i]=n[0],o[3*i+1]=n[1],o[3*i+2]=n[2]}else for(i=0;i<t.length;i++){var s=t[i];o[3*i]=s.x,o[3*i+1]=s.y,o[3*i+2]=s.z}if(r.addAttribute("position",new A.BufferAttribute(o,3)),null!=e){var a=new Float32Array(3*e.length);for(i=0;i<e.length;i++){var l=e[i];a[3*i]=l.r,a[3*i+1]=l.g,a[3*i+2]=l.b}r.addAttribute("color",new A.BufferAttribute(a,3))}return r}function N(t,e,i){var r=new A.Mesh(function(t,e){var i,r=t.length,o=f(t),n=new Float32Array(o),s=new Float32Array(6*r);for(i=0;i<6;i++)s[i]=o[i];for(;i<6*r;i++)s[i]=o[i-6];var a=new Float32Array(6*r);for(i=0;i<6*(r-1);i++)a[i]=o[i+6];for(;i<6*r;i++)a[i]=o[i];var l=new Float32Array(2*r);for(i=0;i<r;i++)l[2*i]=1,l[2*i+1]=-1;var h=p(e),c=new A.BufferGeometry;return c.addAttribute("position",new A.BufferAttribute(n,3)),c.addAttribute("previous",new A.BufferAttribute(s,3)),c.addAttribute("next",new A.BufferAttribute(a,3)),c.addAttribute("side",new A.BufferAttribute(l,1)),c.addAttribute("color",new A.BufferAttribute(h,3)),c}(e,i),t);return r.drawMode=A.TriangleStripDrawMode,r.raycast=X,r}function U(t,e,i){return t.isShaderMaterial?N(t,e,i):new A.Line(B(e,i),t)}function V(t,e,i){var r=new A.Mesh(function(t,e){var i,r,o=t.length,n=f(t),s=new Float32Array(n),a=new Float32Array(6*o);for(i=0;i<6*o;i+=12){for(r=0;r<6;r++)a[i+r]=n[i+r+6];for(;r<12;r++)a[i+r]=n[i+r-6]}var l=new Float32Array(2*o);for(i=0;i<o;i++)l[2*i]=-1,l[2*i+1]=1;var h=2*o<65536?new Uint16Array(3*o):new Uint32Array(3*o),c=[0,1,2,0,2,3];for(i=0;i<o/2;i++)for(r=0;r<6;r++)h[6*i+r]=4*i+c[r];var d=new A.BufferGeometry;if(d.addAttribute("position",new A.BufferAttribute(s,3)),d.addAttribute("other",new A.BufferAttribute(a,3)),d.addAttribute("side",new A.BufferAttribute(l,1)),null!=e){var u=p(e);d.addAttribute("color",new A.BufferAttribute(u,3))}return d.setIndex(new A.BufferAttribute(h,1)),d}(e,i),t);return r.raycast=X,r}function H(t,e,i){return t.isShaderMaterial?V(t,e,i):new A.LineSegments(B(e,i),t)}var K=["uniform float size;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = size;","}"].join("\n"),D=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function G(t,e,i){var r=B(t,e),o=new A.ShaderMaterial({uniforms:b({size:i}),vertexShader:K,fragmentShader:D,fog:!0,vertexColors:A.VertexColors}),n=new A.Points(r,o);return n.raycast=function(){},n}var Y=new A.Matrix4,I=new A.Ray;function X(t,e){var i=t.linePrecision*t.linePrecision;Y.getInverse(this.matrixWorld),I.copy(t.ray).applyMatrix4(Y);for(var r=new A.Vector3,o=new A.Vector3,n=new A.Vector3,s=new A.Vector3,a=this.drawMode===A.TriangleStripDrawMode?1:2,l=this.geometry.attributes.position.array,h=0,c=l.length/6-1;h<c;h+=a){r.fromArray(l,6*h),o.fromArray(l,6*h+6);var d=I.distanceSqToSegment(r,o,s,n);if(!(i<d)){s.applyMatrix4(this.matrixWorld);var u=t.ray.origin.distanceTo(s);u<t.near||u>t.far||e.push({distance:u,point:n.clone().applyMatrix4(this.matrixWorld),index:h,object:this,line_dist:Math.sqrt(d)})}}}function W(t,e){if("undefined"!=typeof document){var i=document.createElement("canvas");i.width=256,i.height=16;var r=i.getContext("2d");return r?(r.font=(e.font||"bold 14px")+" sans-serif",r.textBaseline="bottom",e.color&&(r.fillStyle=e.color),r.fillText(t,0,i.height),i):null}}var Z=["uniform vec2 canvas_size;","uniform vec2 win_size;","varying vec2 vUv;","void main() {","  vUv = uv;","  vec2 rel_offset = vec2(0.02, -0.3);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_Position.xy += (uv + rel_offset) * 2.0 * canvas_size / win_size;","  gl_Position.z += 0.2 * projectionMatrix[2][2];","}"].join("\n"),$=["#include <fog_pars_fragment>","varying vec2 vUv;","uniform sampler2D map;","void main() {","  gl_FragColor = texture2D(map, vUv);","#include <fog_fragment>","}"].join("\n");function Q(t,e){var i=W(t,e);if(i){var r=new A.Texture(i);r.needsUpdate=!0;var o=new A.BufferGeometry,n=e.pos,s=new Float32Array([].concat(n,n,n,n)),a=new Float32Array([0,1,1,1,0,0,1,0]),l=new Uint16Array([0,2,1,2,3,1]);o.setIndex(new A.BufferAttribute(l,1)),o.addAttribute("position",new A.BufferAttribute(s,3)),o.addAttribute("uv",new A.BufferAttribute(a,2));var h=new A.ShaderMaterial({uniforms:b({map:r,canvas_size:[i.width,i.height],win_size:e.win_size}),vertexShader:Z,fragmentShader:$,fog:!0});h.transparent=!0;var c=new A.Mesh(o,h);return c.remake=function(t,e){r.image=W(t,e),r.needsUpdate=!0},c}}function J(t,e,i){t.push(new A.Vector3(e[0]-i,e[1],e[2])),t.push(new A.Vector3(e[0]+i,e[1],e[2])),t.push(new A.Vector3(e[0],e[1]-i,e[2])),t.push(new A.Vector3(e[0],e[1]+i,e[2])),t.push(new A.Vector3(e[0],e[1],e[2]-i)),t.push(new A.Vector3(e[0],e[1],e[2]+i))}var tt={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},et=function(l,h){var c=1,d=tt.NONE,u=new A.Vector3,f=new A.Vector3,p=new A.Vector2,_=new A.Vector2,m=0,g=0,v=new A.Vector2,b=new A.Vector2,y=!0,w=null,x=null,z=null;this.slab_width=[2.5,7.5,null],this.toggle_auto=function(t){d===tt.AUTO_ROTATE&&typeof t==typeof w?d=tt.NONE:(d=tt.AUTO_ROTATE,x=null,w=t)},this.is_going=function(){return d===tt.GO},this.is_moving=function(){return d!==tt.NONE},this.update=function(){var t,e,i,r,o,n=!1,s=l.position.clone().sub(h);if(d===tt.AUTO_ROTATE&&function(t){u.copy(t).normalize();var e=Date.now(),i=18e-6*(null!==x?e-x:16.7)*c;x=e,!0===w?i=-i:!1!==w&&(w+=.02,i=4e-5*c*Math.cos(w)),f.crossVectors(l.up,t).multiplyScalar(i).add(u)}(s),u.equals(f)||(t=s,(e=new A.Quaternion).setFromUnitVectors(f,u),t.applyQuaternion(e),l.up.applyQuaternion(e),f.applyQuaternion(e),u.copy(f),n=!0),g!==m&&(l.zoom*=g/m,m=g,n=!0),!_.equals(p)){var a=(i=s,r=_.x-p.x,o=_.y-p.y,d===tt.ZOOM?l.zoom/=1-r+o:d===tt.SLAB?h.addScaledVector(i,-5/i.length()*o):d===tt.ROLL&&l.up.applyAxisAngle(i,.05*(r-o)),p.copy(_),d===tt.SLAB?10*r:null);a&&(this.slab_width[0]=Math.max(this.slab_width[0]+a,.01),this.slab_width[1]=Math.max(this.slab_width[1]+a,.01)),n=!0}return b.equals(v)||(!function(t){var e=b.x-v.x,i=b.y-v.y;e*=.5*(l.right-l.left)/l.zoom,i*=.5*(l.bottom-l.top)/l.zoom;var r=t.clone().cross(l.up).setLength(e);r.addScaledVector(l.up,i/l.up.length()),l.position.add(r),h.add(r),v.copy(b)}(s),n=y=!0),l.position.addVectors(h,s),d===tt.GO&&z&&(z(),n=!0),l.lookAt(h),n},this.start=function(t,e,i,r){switch(d!==tt.NONE&&d!==tt.AUTO_ROTATE||(d=t),this.move(e,i,r),d){case tt.ROTATE:u.copy(f);break;case tt.ZOOM:case tt.SLAB:case tt.ROLL:p.copy(_);break;case tt.PAN:v.copy(b),y=!1;break;case tt.PAN_ZOOM:m=g,v.copy(b)}},this.move=function(t,e,i){switch(d){case tt.ROTATE:var r=function(t,e){var i=0,r=t*t+e*e;if(r<1)i=Math.sqrt(1-r);else{var o=Math.sqrt(r);t/=o,e/=o}return[t,e,i]}(t,e),o=l.position.clone().sub(h);f.crossVectors(l.up,o).setLength(r[0]),f.addScaledVector(l.up,r[1]/l.up.length()),f.addScaledVector(o,r[2]/o.length());break;case tt.ZOOM:case tt.SLAB:case tt.ROLL:_.set(t,e);break;case tt.PAN:b.set(t,e);break;case tt.PAN_ZOOM:if(null==i)return;b.set(t,e),g=i}},this.stop=function(){var t=null;return d!==tt.PAN||y||(t=v),d=tt.NONE,u.copy(f),m=g,v.copy(b),t},this.go_to=function(e,i,r,t){if(e instanceof Array&&(e=new A.Vector3(e[0],e[1],e[2])),e&&!(e.distanceToSquared(h)<.001)||i&&!(i.distanceToSquared(l.position)<.1)||r&&!(r.distanceToSquared(l.up)<.1)){d=tt.GO,t=(t||60)/c;for(var o=[],n=0,s=1;s<=t;++s){var a=s/t;a=a<.5?2*a*a:-2*a*(a-2)-1,o.push((a-n)/(1-n)),n=a}z=function(){var t=o.shift();e&&(i||l.position.sub(h),h.lerp(e,t),i||l.position.add(h)),i&&l.position.lerp(i,t),r&&l.up.lerp(r,t),0===o.length&&(d=tt.NONE,z=null)}}}},it=["element","B-factor","occupancy","index","chain"],rt=["lines","trace","ribbon"],ot=["marching cubes","squarish"],nt=["normal","simplistic"],st=["bold 14px","14px","16px","bold 16px"];function at(t,e,i){var r=new A.Color(14737632);if(e<i){var o=(240-240*((t-e)/(i-e)))/360;r.setHSL(o,1,.5)}return r}function lt(t,e,i,r){var o,n=e[e.length-1];if("index"===t)o=function(t){return at(t.i_seq,0,n.i_seq)};else if("B-factor"===t){for(var s=1/0,a=-1/0,l=0;l<e.length;l++){var h=e[l].b;a<h&&(a=h),h<s&&(s=h)}o=function(t){return at(t.b,s,a)}}else if("occupancy"===t)o=function(t){return at(t.occ,0,1)};else if("chain"===t)o=function(t){return at(t.chain_index,0,n.chain_index)};else if(0===r)o=function(t){return i[t.element]||i.def};else{var c=i.C.clone().offsetHSL(r,0,0);o=function(t){var e=t.element;return"C"===e?c:i[e]||i.def}}return e.map(o)}function ht(t,e){return t*e[1]/700}var ct=function(t,e,i){this.map=t,this.name="",this.isolevel=i?3:e.default_isolevel,this.visible=!0,this.types=i?["map_pos","map_neg"]:["map_den"],this.block_ctr=new A.Vector3(1/0,0,0),this.el_objects=[]},dt=function t(e,i,r){this.model=e,this.label="(model #"+ ++t.ctor_counter+")",this.visible=!0,this.hue_shift=0,this.conf=i,this.win_size=r,this.atomic_objects=[]};function ut(t,e){return[t.x.toFixed(e),t.y.toFixed(e),t.z.toFixed(e)]}function ft(t){var e=t.touches,i=e[0].pageX-e[1].pageX,r=e[0].pageY-e[1].pageY;return{pageX:(e[0].pageX+e[1].pageX)/2,pageY:(e[0].pageY+e[1].pageY)/2,dist:Math.sqrt(i*i+r*r)}}dt.prototype.get_visible_atoms=function(){var t=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return t;for(var e=[],i=0,r=t;i<r.length;i+=1){var o=r[i];"H"!==o.element&&e.push(o)}return e},dt.prototype.add_bonds=function(t,e){for(var i=this.get_visible_atoms(),r=lt(t?"element":this.conf.color_aim,i,this.conf.colors,this.hue_shift),o=[],n=[],s=this.conf.hydrogens,a=t,l="ball&stick"===this.conf.render_style,h=0;h<i.length;h++){var c=i[h],d=r[h];if(!t||c.is_ligand)if(0!==c.bonds.length||l)for(var u=0;u<c.bonds.length;u++){var f=this.model.atoms[c.bonds[u]];if((s||"H"!==f.element)&&(!a||f.is_ligand)){var p=c.midpoint(f),_=new A.Vector3(p[0],p[1],p[2]),m=new A.Vector3(c.xyz[0],c.xyz[1],c.xyz[2]);if(l&&null!=e){var g=m.distanceTo(_)/e;m.lerp(_,g)}o.push(m,_),n.push(d,d)}}else{J(o,c.xyz,.7);for(var v=0;v<6;v++)n.push(d)}}if(0!==o.length){var b=ht(this.conf.bond_line,this.win_size),y="simplistic"===this.conf.line_style,w=S({gl_lines:y,linewidth:b,win_size:this.win_size,segments:!0});this.atomic_objects.push(H(w,o,n)),l&&null!=e?this.atomic_objects.push(G(i,r,e)):y||t||this.atomic_objects.push(G(i,r,b))}},dt.prototype.add_trace=function(){for(var t=this.model.extract_trace(),e=[].concat.apply([],t),i=lt(this.conf.color_aim,e,this.conf.colors,this.hue_shift),r=S({gl_lines:"simplistic"===this.conf.line_style,linewidth:ht(this.conf.bond_line,this.win_size),win_size:this.win_size}),o=0,n=0,s=t;n<s.length;n+=1){var a=s[n],l=i.slice(o,o+a.length);o+=a.length;var h=U(r,a,l);this.atomic_objects.push(h)}},dt.prototype.add_ribbon=function(t){for(var e=this.model.extract_trace(),i=this.model.get_residues(),r=[].concat.apply([],e),o=lt(this.conf.color_aim,r,this.conf.colors,this.hue_shift),n=0,s=0,a=e;s<a.length;s+=1){for(var l=a[s],h=[],c=[0,0,0],d=0,u=l;d<u.length;d+=1){var f=i[u[d].resid()],p=this.model.calculate_tangent_vector(f);p[0]*c[0]+p[1]*c[1]+p[2]*c[2]<0&&(p[0]=-p[0],p[1]=-p[1],p[2]=-p[2]),h.push(p),c=p}var _=o.slice(n,n+l.length);n+=l.length;var m=x(l,_,h,t);this.atomic_objects.push(m)}},dt.ctor_counter=0;var pt=function t(e){if(this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null,zoom_grid:C(),mark:null},this.labels={},this.nav=null,this.xhr_headers={},this.config={bond_line:4,map_line:1.25,map_radius:10,max_map_radius:40,default_isolevel:1.5,center_cube_size:.1,map_style:ot[0],render_style:rt[0],color_aim:it[0],line_style:nt[0],label_font:st[0],colors:this.ColorSchemes[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.last_ctr=new A.Vector3(1/0,0,0),this.selected={bag:null,atom:null},this.scene=new A.Scene,this.scene.fog=new A.Fog(this.config.colors.bg,0,1),this.light=new A.AmbientLight(16777215),this.scene.add(this.light),this.default_camera_pos=[0,0,100],e.share_view?(this.target=e.share_view.target,this.camera=e.share_view.camera,this.controls=e.share_view.controls,this.tied_viewer=e.share_view,this.tied_viewer.tied_viewer=this):(this.target=new A.Vector3(0,0,0),this.camera=new A.OrthographicCamera,this.camera.position.fromArray(this.default_camera_pos),this.controls=new et(this.camera,this.target)),this.raycaster=new A.Raycaster,this.set_common_key_bindings(),this.constructor===t&&this.set_real_space_key_bindings(),"undefined"!=typeof document){this.hud_el=o("hud");try{this.renderer=new A.WebGLRenderer({antialias:!0})}catch(t){return this.hud("No WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=o("viewer"),this.help_el=o("help"),this.hud_el&&(this.initial_hud_html=this.hud_el.innerHTML),null!=this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.update_camera();var i=this.renderer.domElement;this.container.appendChild(i),e.focusable&&(i.tabIndex=0),this.decor.zoom_grid.visible=!1,this.scene.add(this.decor.zoom_grid),window.Stats&&(this.stats=new window.Stats,this.container.appendChild(this.stats.dom)),window.addEventListener("resize",this.resize.bind(this)),(e.focusable?i:window).addEventListener("keydown",this.keydown.bind(this)),i.addEventListener("contextmenu",function(t){t.preventDefault()}),i.addEventListener("mousewheel",this.mousewheel.bind(this)),i.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),i.addEventListener("mousedown",this.mousedown.bind(this)),i.addEventListener("touchstart",this.touchstart.bind(this)),i.addEventListener("touchmove",this.touchmove.bind(this)),i.addEventListener("touchend",this.touchend.bind(this)),i.addEventListener("touchcancel",this.touchend.bind(this)),i.addEventListener("dblclick",this.dblclick.bind(this));var r=this;this.mousemove=function(t){t.preventDefault(),r.controls.move(r.relX(t),r.relY(t))},this.mouseup=function(t){t.preventDefault(),t.stopPropagation(),document.removeEventListener("mousemove",r.mousemove),document.removeEventListener("mouseup",r.mouseup),r.decor.zoom_grid.visible=!1;var e=r.controls.stop();if(e){var i=r.pick_atom(e,r.camera);null!=i&&r.select_atom(i,{steps:60})}r.redraw_maps()},this.scheduled=!1,this.request_render()}}function o(t){return null===e[t]?null:document.getElementById(e[t]||t)}};pt.prototype.pick_atom=function(t,e){for(var i=0,r=this.model_bags;i<r.length;i+=1){var o=r[i];if(o.visible){this.raycaster.setFromCamera(t,e),this.raycaster.near=e.near,this.raycaster.far=e.far-.15*(e.far-e.near),this.raycaster.linePrecision=.3;var n=this.raycaster.intersectObjects(o.atomic_objects);if(0<n.length){n.sort(function(t){return t.line_dist||1/0});var s=n[0].point,a=o.model.get_nearest_atom(s.x,s.y,s.z);if(null!=a)return{bag:o,atom:a}}}}},pt.prototype.set_colors=function(t){function e(t){return new A.Color(t)}if(null==t)t=this.config.colors;else if("number"==typeof t)t=this.ColorSchemes[t%this.ColorSchemes.length];else if("string"==typeof t){for(var i=0,r=this.ColorSchemes;i<r.length;i+=1){var o=r[i];if(o.name===t){t=o;break}}throw Error("Unknown color scheme.")}if("number"==typeof t.bg)for(var n in t)"name"!==n&&(t[n]=t[n]instanceof Array?t[n].map(e):e(t[n]));this.decor.zoom_grid.color_value.set(t.fg),this.config.config=t,this.redraw_all()},pt.prototype.relX=function(t){return 2*(t.pageX-this.window_offset[0])/this.window_size[0]-1},pt.prototype.relY=function(t){return 1-2*(t.pageY-this.window_offset[1])/this.window_size[1]},pt.prototype.hud=function(t,e){if("undefined"!=typeof document){var i=this.hud_el;if(i){null!=t?"HTML"===e?i.innerHTML=t:i.textContent=t:i.innerHTML=this.initial_hud_html;var r="ERR"===e;i.style.backgroundColor=r?"#b00":"",r&&t&&console.log("ERR: "+t)}else console.log("hud:",t)}},pt.prototype.redraw_center=function(t){var e=this.config.center_cube_size;(t||this.target.distanceToSquared(this.last_ctr)>.01*e*e)&&(this.last_ctr.copy(this.target),this.decor.mark&&this.scene.remove(this.decor.mark),this.decor.mark=d(e,this.target,{color:this.config.colors.center,linewidth:2,win_size:this.window_size}),this.scene.add(this.decor.mark))},pt.prototype.redraw_maps=function(t){this.redraw_center(t);for(var e=this.config.map_radius,i=0,r=this.map_bags;i<r.length;i+=1){var o=r[i];(t||this.target.distanceToSquared(o.block_ctr)>e/100)&&this.redraw_map(o)}},pt.prototype.remove_and_dispose=function(t){this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material&&(t.material.uniforms&&t.material.uniforms.map&&t.material.uniforms.map.value.dispose(),t.material.dispose());for(var e=0,i=t.children;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}},pt.prototype.clear_el_objects=function(t){for(var e=0,i=t.el_objects;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}t.el_objects=[]},pt.prototype.clear_atomic_objects=function(t){for(var e=0,i=t.atomic_objects;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}t.atomic_objects=[]},pt.prototype.set_atomic_objects=function(t){switch(t.atomic_objects=[],t.conf.render_style){case"lines":t.add_bonds();break;case"ball&stick":var e=this.camera.projectionMatrix.elements[5],i=Math.max(1,200*e);t.add_bonds(!1,i);break;case"trace":t.add_trace(),t.add_bonds(!0);break;case"ribbon":t.add_ribbon(8),t.add_bonds(!0)}for(var r=0,o=t.atomic_objects;r<o.length;r+=1){var n=o[r];this.scene.add(n)}},pt.prototype.toggle_label=function(t,e){if(null!=t.atom){var i=t.atom.short_label(),r=i,o=r in this.labels;if(void 0===e&&(e=!o),e){if(o)return;if(null==t.atom)return;var n=Q(i,{pos:t.atom.xyz,font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString(),win_size:this.window_size});if(!n)return;if(null==t.bag)return;this.labels[r]={o:n,bag:t.bag},this.scene.add(n)}else{if(!o)return;this.remove_and_dispose(this.labels[r].o),delete this.labels[r]}}},pt.prototype.redraw_labels=function(){for(var t in this.labels){var e=t;this.labels[t].o.remake(e,{font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString()})}},pt.prototype.toggle_map_visibility=function(t){"number"==typeof t&&(t=this.map_bags[t]),t.visible=!t.visible,this.redraw_map(t),this.request_render()},pt.prototype.redraw_map=function(t){this.clear_el_objects(t),t.visible&&(t.map.block.clear(),this.add_el_objects(t))},pt.prototype.toggle_model_visibility=function(t){null!=(t=t||this.selected.bag)&&(t.visible=!t.visible,this.redraw_model(t),this.request_render())},pt.prototype.redraw_model=function(t){this.clear_atomic_objects(t),t.visible&&this.set_atomic_objects(t)},pt.prototype.redraw_models=function(){for(var t=0,e=this.model_bags;t<e.length;t+=1){var i=e[t];this.redraw_model(i)}},pt.prototype.add_el_objects=function(t){if(t.visible&&!(this.config.map_radius<=0)){if(t.map.block.empty()){var e=this.target;t.block_ctr.copy(e),t.map.extract_block(this.config.map_radius,[e.x,e.y,e.z])}for(var i=0,r=t.types;i<r.length;i+=1){var o=r[i],n=("map_neg"===o?-1:1)*t.isolevel,s=t.map.isomesh_in_block(n,this.config.map_style);if(null!=s){var a=z(s,{color:this.config.colors[o],linewidth:this.config.map_line});t.el_objects.push(a),this.scene.add(a)}}}},pt.prototype.change_isolevel_by=function(t,e){if(!(t>=this.map_bags.length)){var i=this.map_bags[t];i.isolevel+=e,this.clear_el_objects(i),this.add_el_objects(i);var r=i.map.abs_level(i.isolevel).toFixed(4),o=this.tied_viewer;if(o&&t<o.map_bags.length){var n=o.map_bags[t];n.isolevel=i.isolevel,r+=" / "+n.map.abs_level(n.isolevel).toFixed(4),o.clear_el_objects(n),o.add_el_objects(n)}this.hud("map "+(t+1)+" level =  "+r+" "+i.map.unit+" ("+i.isolevel.toFixed(2)+" rmsd)")}},pt.prototype.change_map_radius=function(t){var e=this.config.max_map_radius,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+t,0),e),i.map_radius=Math.round(1e9*i.map_radius)/1e9;var r='map "radius": '+i.map_radius;i.map_radius===e?r+=" (max)":0===i.map_radius&&(r+=" (hidden maps)"),0===this.map_bags.length&&(r+="\nNB: no map is loaded."),this.hud(r),this.redraw_maps(!0)},pt.prototype.change_slab_width_by=function(t){var e=this.controls.slab_width;e[0]=Math.max(e[0]+t,.01),e[1]=Math.max(e[1]+t,.01),this.update_camera();var i=this.camera.far-this.camera.near;this.hud("clip width: "+i.toPrecision(3))},pt.prototype.change_zoom_by_factor=function(t){this.camera.zoom*=t,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toPrecision(3))},pt.prototype.change_bond_line=function(t){this.config.bond_line=Math.max(this.config.bond_line+t,.1),this.redraw_models(),this.hud("bond width: "+ht(this.config.bond_line,this.window_size).toFixed(1))},pt.prototype.change_map_line=function(t){this.config.map_line=Math.max(this.config.map_line+t,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))},pt.prototype.toggle_full_screen=function(){var t=document;if(t.fullscreenElement||t.mozFullScreenElement||t.webkitFullscreenElement||t.msFullscreenElement){var e=t.exitFullscreen||t.webkitExitFullscreen||t.mozCancelFullScreen||t.msExitFullscreen;e&&e.call(t)}else{var i=this.container;if(!i)return;var r=i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen;r&&r.call(i)}},pt.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var t=this.get_cell_box_func();t&&(this.decor.cell_box=u(t,{color:this.config.colors.fg}),this.scene.add(this.decor.cell_box))}},pt.prototype.get_cell_box_func=function(){var t=null;return null!=this.selected.bag&&(t=this.selected.bag.model.unit_cell),null==t&&0<this.map_bags.length&&(t=this.map_bags[0].map.unit_cell),t&&t.orthogonalize.bind(t)},pt.prototype.shift_clip=function(t){var e=this.camera.position.clone().sub(this.target);e.multiplyScalar(t/e.length()),this.target.add(e),this.camera.position.add(e),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+ut(e,2).join(" ")+"]")},pt.prototype.go_to_nearest_Ca=function(){var t=this.target,e=this.selected.bag;if(null!=e){var i=e.model.get_nearest_atom(t.x,t.y,t.z,"CA");null!=i?this.select_atom({bag:e,atom:i},{steps:30}):this.hud("no nearby CA")}},pt.prototype.permalink=function(){if("undefined"!=typeof window){var t=Math.round(-Math.log10(.001));window.location.hash="#xyz="+ut(this.target,t).join(",")+"&eye="+ut(this.camera.position,1).join(",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar")}},pt.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0),this.redraw_labels())},pt.prototype.toggle_help=function(){var t=this.help_el;t&&(t.style.display="block"===t.style.display?"none":"block",""===t.innerHTML&&(t.innerHTML=[this.MOUSE_HELP,this.KEYBOARD_HELP,this.ABOUT_HELP].join("\n\n")))},pt.prototype.select_next=function(t,e,i,r){var o=i.indexOf(this.config[e]),n=i.length,s=(o+(r?n-1:1))%n;this.config[e]=i[s];for(var a=t+":",l=0;l<n;l++){var h=l===s?"u":"s";a+=" <"+h+">"+("string"==typeof i[l]?i[l]:i[l].name)+"</"+h+">"}this.hud(a,"HTML")},pt.prototype.keydown=function(t){var e=this.key_bindings[t.keyCode];e?e.bind(this)(t):(!1===e&&t.preventDefault(),this.help_el&&this.hud("Nothing here. Press H for help.")),this.request_render()},pt.prototype.set_common_key_bindings=function(){var t=new Array(256);t[66]=function(t){this.select_next("color scheme","colors",this.ColorSchemes,t.shiftKey),this.set_colors()},t[67]=function(t){this.select_next("coloring by","color_aim",it,t.shiftKey),this.redraw_models()},t[69]=function(){var t=this.scene.fog,e=1===t.far;t.far=e?1e9:1,this.hud((e?"dis":"en")+"able fog"),this.redraw_all()},t[72]=this.toggle_help,t[73]=function(t){this.hud("toggled spinning"),this.controls.toggle_auto(t.shiftKey)},t[75]=function(){this.hud("toggled rocking"),this.controls.toggle_auto(0)},t[77]=function(t){this.change_zoom_by_factor(t.shiftKey?1.2:1.03)},t[78]=function(t){this.change_zoom_by_factor(1/(t.shiftKey?1.2:1.03))},t[81]=function(t){this.select_next("label font","label_font",st,t.shiftKey),this.redraw_labels()},t[82]=function(t){t.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("recentered"),this.recenter())},t[87]=function(t){this.select_next("map style","map_style",ot,t.shiftKey),this.redraw_maps(!0)},t[107]=t[61]=t[187]=function(t){this.change_isolevel_by(t.shiftKey?1:0,.1)},t[109]=t[173]=t[189]=function(t){this.change_isolevel_by(t.shiftKey?1:0,-.1)},t[219]=function(){this.change_map_radius(-2)},t[221]=function(){this.change_map_radius(2)},t[220]=function(t){this.select_next("bond lines","line_style",nt,t.shiftKey),this.redraw_models()},t[16]=t[17]=t[18]=t[225]=function(){},t[191]=t[222]=!1,this.key_bindings=t},pt.prototype.set_real_space_key_bindings=function(){var t=this.key_bindings;t[36]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_bond_line(.2)},t[35]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_bond_line(-.2)},t[32]=function(t){this.center_next_residue(t.shiftKey)},t[68]=function(){this.change_slab_width_by(-.1)},t[70]=function(t){t.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1)},t[80]=function(t){t.shiftKey?this.permalink():this.go_to_nearest_Ca()},t[84]=function(t){this.select_next("rendering as","render_style",rt,t.shiftKey),this.redraw_models()},t[85]=function(){this.hud("toggled unit cell box"),this.toggle_cell_box()},t[89]=function(t){this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models()},t[188]=function(t){t.shiftKey&&this.shift_clip(1)},t[190]=function(t){t.shiftKey&&this.shift_clip(-1)}},pt.prototype.mousedown=function(t){t.stopPropagation(),document.addEventListener("mouseup",this.mouseup),document.addEventListener("mousemove",this.mousemove);var e=tt.NONE;1===t.button||0===t.button&&t.ctrlKey?e=tt.PAN:0===t.button?(t.shiftKey&&this.dblclick(t),e=tt.ROTATE):2===t.button&&(t.ctrlKey?e=t.shiftKey?tt.ROLL:tt.SLAB:(this.decor.zoom_grid.visible=!0,e=tt.ZOOM)),this.controls.start(e,this.relX(t),this.relY(t)),this.request_render()},pt.prototype.dblclick=function(t){if(0===t.button){this.decor.selection&&(this.remove_and_dispose(this.decor.selection),this.decor.selection=null);var e=new A.Vector2(this.relX(t),this.relY(t)),i=this.pick_atom(e,this.camera);if(i){var r=i.atom;this.hud(i.bag.label+" "+r.long_label()),this.toggle_label(i);var o=this.config.colors[r.element]||this.config.colors.def,n=2.5*ht(this.config.bond_line,this.window_size);this.decor.selection=G([r],[o],n),this.scene.add(this.decor.selection)}else this.hud();this.request_render()}},pt.prototype.touchstart=function(t){var e=t.touches;if(1===e.length)this.controls.start(tt.ROTATE,this.relX(e[0]),this.relY(e[0]));else{var i=ft(t);this.controls.start(tt.PAN_ZOOM,this.relX(i),this.relY(i),i.dist)}this.request_render()},pt.prototype.touchmove=function(t){t.preventDefault(),t.stopPropagation();var e=t.touches;if(1===e.length)this.controls.move(this.relX(e[0]),this.relY(e[0]));else{var i=ft(t);this.controls.move(this.relX(i),this.relY(i),i.dist)}},pt.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},pt.prototype.mousewheel=function(t){t.preventDefault(),t.stopPropagation();var e=t.wheelDelta||-2*(t.detail||0);this.mousewheel_action(e,t),this.request_render()},pt.prototype.mousewheel_action=function(t,e){this.change_isolevel_by(e.shiftKey?1:0,5e-4*t)},pt.prototype.resize=function(){var t=this.container;if(null!=t){var e=t.clientWidth,i=t.clientHeight;this.window_offset[0]=t.offsetLeft,this.window_offset[1]=t.offsetTop,this.camera.left=-e,this.camera.right=e,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,i),e===this.window_size[0]&&i===this.window_size[1]||(this.window_size[0]=e,this.window_size[1]=i,this.redraw_models()),this.request_render()}},pt.prototype.recenter=function(t,e,i){var r,o=this.selected.bag;if(null!=t&&null==e&&null!=o){var n=o.model.get_center(),s=new A.Vector3(t[0]-n[0],t[1]-n[1],t[2]-n[2]);s.setLength(100),(r=s.y<90?new A.Vector3(0,1,0):new A.Vector3(1,0,0)).projectOnPlane(s).normalize(),t=new A.Vector3(t[0],t[1],t[2]),e=s.add(t)}else{if(null==t)if(null!=o)t=o.model.get_center();else{var a=this.get_cell_box_func();t=a?a([.5,.5,.5]):[0,0,0]}if(null!=e)e=new A.Vector3(e[0],e[1],e[2]),r=null;else{var l=this.default_camera_pos;e=new A.Vector3(t[0]+l[0],t[1]+l[1],t[2]+l[2]),r=A.Object3D.DefaultUp}}this.controls.go_to(t,e,r,i)},pt.prototype.center_next_residue=function(t){var e=this.selected.bag;if(null!=e){var i=e.model.next_residue(this.selected.atom,t);null!=i&&this.select_atom({bag:e,atom:i},{steps:30})}},pt.prototype.select_atom=function(t,e){void 0===e&&(e={}),this.hud("-> "+t.bag.label+" "+t.atom.long_label()),this.controls.go_to(t.atom.xyz,null,null,e.steps),this.toggle_label(this.selected,!1),this.selected={bag:t.bag,atom:t.atom},this.toggle_label(this.selected,!0)},pt.prototype.update_camera=function(){var t=this.camera.position.distanceTo(this.target),e=this.controls.slab_width,i=e[2]||this.camera.zoom;this.camera.near=t*(1-e[0]/i),this.camera.far=t*(1+e[1]/i),this.camera.updateProjectionMatrix()},pt.prototype.render=function(){if(this.scheduled=!0,null!==this.renderer){this.controls.update()&&this.update_camera();var t=this.tied_viewer;this.controls.is_going()||(this.redraw_maps(),t&&!t.scheduled&&t.redraw_maps()),this.renderer.render(this.scene,this.camera),t&&!t.scheduled&&t.renderer.render(t.scene,t.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update()}},pt.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},pt.prototype.add_model=function(t,e){void 0===e&&(e={});var i=new dt(t,this.config,this.window_size);i.hue_shift=e.hue_shift||.06*this.model_bags.length,this.model_bags.push(i),this.set_atomic_objects(i),this.request_render()},pt.prototype.add_map=function(t,e){var i=new ct(t,this.config,e);this.map_bags.push(i),this.add_el_objects(i),this.request_render()},pt.prototype.load_file=function(i,t,e){if(null!==this.renderer){var r=new XMLHttpRequest;for(var o in r.open("GET",i,!0),t.binary?r.responseType="arraybuffer":r.overrideMimeType("text/plain"),this.xhr_headers)this.xhr_headers.hasOwnProperty(o)&&r.setRequestHeader(o,this.xhr_headers[o]);var n=this;r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status&&null!==r.response&&""!==r.response)try{e(r)}catch(t){n.hud("Error: "+t.message+"\nwhen processing "+i,"ERR")}else n.hud("Failed to fetch "+i,"ERR")},t.progress&&r.addEventListener("progress",function(t){if(t.lengthComputable&&t.loaded&&t.total){var e=i.split("/").pop();n.hud("loading "+e+" ... "+(t.loaded/1024|0)+" / "+(t.total/1024|0)+" kB"),t.loaded===t.total&&n.hud()}});try{r.send(null)}catch(t){n.hud("loading "+i+" failed:\n"+t,"ERR")}}},pt.prototype.set_dropzone=function(t,n){var s=this;t.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",s.hud("ready for file drop...")}),t.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault();for(var e=[],i=0,r=t.dataTransfer.files;i<r.length;i+=1){var o=r[i];try{n(o)}catch(t){return void s.hud("Loading "+o.name+" failed.\n"+t.message,"ERR")}e.push(o.name)}s.hud("loading "+e.join(", "))})},pt.prototype.set_pdb_and_map_dropzone=function(t){var r=this;this.set_dropzone(t,function(t){var e=new FileReader;if(/\.(pdb|ent)$/.test(t.name))e.onload=function(t){r.load_pdb_from_text(t.target.result),r.recenter()},e.readAsText(t);else{if(!/\.(map|ccp4|dsn6|omap)$/.test(t.name))throw Error("Unknown file extension. Use: pdb, ent, ccp4, map, dsn6 or omap.");var i=/\.(dsn6|omap)$/.test(t.name)?"dsn6":"ccp4";e.onloadend=function(t){2==t.target.readyState&&(r.load_map_from_buffer(t.target.result,{format:i}),0===r.model_bags.length&&1===r.map_bags.length&&r.recenter())},e.readAsArrayBuffer(t)}})},pt.prototype.set_view=function(t){var e=function(){var t={};if("undefined"==typeof window)return t;for(var e=window.location.hash.substr(1).split("&"),i=0;i<e.length;i++){var r=e[i].split("="),o=r[1];"xyz"===r[0]||"eye"===r[0]?o=o.split(",").map(Number):"zoom"===r[0]&&(o=Number(o)),t[r[0]]=o}return t}();e.zoom&&(this.camera.zoom=e.zoom),this.recenter(e.xyz||t&&t.center,e.eye,1)},pt.prototype.load_pdb_from_text=function(t){for(var e=this.model_bags.length,i=0,r=s(t);i<r.length;i+=1){var o=r[i];this.add_model(o)}this.selected.bag=this.model_bags[e]},pt.prototype.load_pdb=function(t,e,i){var r=this;this.load_file(t,{binary:!1},function(t){r.load_pdb_from_text(t.responseText),r.set_view(e),i&&i()})},pt.prototype.load_map=function(t,e,i){if(null!=t){if("ccp4"!==e.format&&"dsn6"!==e.format)throw Error("Unknown map format.");var r=this;this.load_file(t,{binary:!0,progress:!0},function(t){r.load_map_from_buffer(t.response,e),i&&i()})}else i&&i()},pt.prototype.load_map_from_buffer=function(t,e){var i=new l;"dsn6"===e.format?i.from_dsn6(t):i.from_ccp4(t,!0),this.add_map(i,e.diff_map)},pt.prototype.load_ccp4_maps=function(t,e,i){var r=this;this.load_map(t,{diff_map:!1,format:"ccp4"},function(){r.load_map(e,{diff_map:!0,format:"ccp4"},i)})},pt.prototype.load_pdb_and_ccp4_maps=function(t,e,i,r){var o=this;this.load_pdb(t,{},function(){o.load_ccp4_maps(e,i,r)})},pt.prototype.load_from_pdbe=function(){if("undefined"==typeof window)return!1;var t=window.location.href.match(/[?&]id=([^&#]+)/);if(null==t)return!1;var e=t[1].toLowerCase();return this.load_pdb("https://www.ebi.ac.uk/pdbe/entry-files/pdb"+e+".ent"),!0},pt.prototype.MOUSE_HELP=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ"].join("\n"),pt.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","E = toggle fog","Q = label font","+/- = sigma level","]/[ = map radius","D/F = clip width","&lt;/> = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","R = center view","W = wireframe style","I = spin","K = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen"].join("\n"),pt.prototype.ABOUT_HELP='&nbsp; <a href="https://uglymol.github.io">uglymol</a> '+("string"==typeof e?e:"dev"),pt.prototype.ColorSchemes=[{name:"coot dark",bg:0,fg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,fg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,fg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,fg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}];var _t=["all","unindexed","#1"],mt=["two","three","none"],gt=["wheel","square"],vt=function(i){function t(t){if(i.call(this),this.box_size=[1,1,1],this.from_ccp4(t,!1),null!=this.unit_cell){var e=this.unit_cell.parameters;this.box_size=[e[0]/100,e[1]/100,e[2]/100],this.unit_cell=null}}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.extract_block=function(t,e){var i=this.grid;if(null!=i){for(var r=this.box_size,o=[],n=[],s=0;s<3;s++){var a=Math.floor(i.dim[s]*((e[s]-t)/r[s]+.5)),l=Math.floor(i.dim[s]*((e[s]+t)/r[s]+.5));if((a=Math.min(Math.max(0,a),i.dim[s]-1))===(l=Math.min(Math.max(0,l),i.dim[s]-1)))return;o.push(a),n.push(l)}for(var h=[],c=[],d=o[0];d<=n[0];d++)for(var u=o[1];u<=n[1];u++)for(var f=o[2];f<=n[2];f++){h.push([(d/i.dim[0]-.5)*r[0],(u/i.dim[1]-.5)*r[1],(f/i.dim[2]-.5)*r[2]]);var p=i.grid2index_unchecked(d,u,f);c.push(i.values[p])}var _=[n[0]-o[0]+1,n[1]-o[1]+1,n[2]-o[2]+1];this.block.set(h,c,_)}},t}(l);vt.prototype.unit="";var bt=function(e){function t(t){e.call(this,t),this.default_camera_pos=[100,0,0],this.axes=null,this.points=null,this.max_dist=-1,this.d_min=-1,this.d_max_inv=0,this.data={},this.config.show_only=_t[0],this.config.show_axes=mt[0],this.config.spot_shape=gt[0],this.config.center_cube_size=.001,this.set_reciprocal_key_bindings(),"undefined"!=typeof document&&this.set_dropzone(this.renderer.domElement,this.file_drop_callback.bind(this)),this.point_material=new A.ShaderMaterial({uniforms:b({size:3,show_only:-2,r2_max:100,r2_min:0}),defines:{ROUND:!0},vertexShader:"\nattribute float group;\nuniform float show_only;\nuniform float r2_max;\nuniform float r2_min;\nuniform float size;\nvarying vec3 vcolor;\nvoid main() {\n  vcolor = color;\n  float r2 = dot(position, position);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  if (r2 < r2_min || r2 >= r2_max || (show_only != -2.0 && show_only != group))\n    gl_Position.x = 2.0;\n  gl_PointSize = size;\n}",fragmentShader:"\n#include <fog_pars_fragment>\nvarying vec3 vcolor;\nvoid main() {\n  float alpha = 1.0;\n#ifdef ROUND\n  // not sure how reliable is such rounding of points\n  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);\n  float dist_sq = 4.0 * dot(diff, diff);\n  if (dist_sq >= 1.0) discard;\n  alpha = 1.0 - dist_sq * dist_sq * dist_sq;\n#endif\n  gl_FragColor = vec4(vcolor, alpha);\n#include <fog_fragment>\n}",vertexColors:A.VertexColors,fog:!0,transparent:!0})}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.set_reciprocal_key_bindings=function(){var t=this.key_bindings;t[65]=function(t){this.select_next("axes","show_axes",mt,t.shiftKey),this.set_axes()},t[68]=function(){this.change_slab_width_by(-.01)},t[70]=function(t){t.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.01)},t[80]=function(t){this.permalink()},t[83]=function(t){this.select_next("spot shape","spot_shape",gt,t.shiftKey),this.point_material.defines.ROUND="wheel"===this.config.spot_shape,this.point_material.needsUpdate=!0},t[85]=function(){0!==this.map_bags.length?(this.hud("toggled map box"),this.toggle_cell_box()):this.hud("Reciprocal-space density map not loaded.")},t[86]=function(t){this.select_next("show","show_only",_t,t.shiftKey);var e=_t.indexOf(this.config.show_only);this.point_material.uniforms.show_only.value=e-2},t[88]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_point_size(.5)},t[90]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_point_size(-.5)},t[188]=function(t){t.shiftKey&&this.shift_clip(.1)},t[190]=function(t){t.shiftKey&&this.shift_clip(-.1)},t[37]=function(){this.change_dmin(.05)},t[39]=function(){this.change_dmin(-.05)},t[38]=function(){this.change_dmax(.025)},t[40]=function(){this.change_dmax(-.025)},t[107]=t[61]=t[187]=function(t){this.change_isolevel_by(0,.01)},t[109]=t[173]=t[189]=function(t){this.change_isolevel_by(0,-.01)},t[219]=function(){this.change_map_radius(-.001)},t[221]=function(){this.change_map_radius(.001)}},t.prototype.file_drop_callback=function(t){var e=new FileReader;/\.(map|ccp4)$/.test(t.name)?(e.onloadend=function(t){2==t.target.readyState&&self.load_map_from_ab(t.target.result)},e.readAsArrayBuffer(t)):(e.onload=function(t){self.load_from_string(t.target.result,{})},e.readAsText(t))},t.prototype.load_data=function(t,e){void 0===e&&(e={});var i=this;this.load_file(t,{binary:!1,progress:!0},function(t){i.load_from_string(t.responseText,e)&&e.callback&&e.callback()})},t.prototype.load_from_string=function(t,e){if("{"===t[0])this.data=function(t){var e,i=JSON.parse(t),r=i.rlp.length;if(0<r&&i.rlp[0]instanceof Array){e=new Float32Array(3*r);for(var o=0;o<r;o++)for(var n=0;n<3;n++)e[3*o+n]=i.rlp[o][n]}else e=new Float32Array(i.rlp);return{pos:e,lattice_ids:i.experiment_id||function(t){for(var e=[],i=0;i<t;i++)e.push(-1);return e}(r)}}(t);else{if("#"!==t[0])return this.hud("Unrecognized file type."),!1;this.data=function(t){for(var e=t.split("\n").filter(function(t){return 0<t.length&&"#"!==t[0]}),i=new Float32Array(3*e.length),r=[],o=0;o<e.length;o++){for(var n=e[o].split(",").map(Number),s=0;s<3;s++)i[3*o+s]=n[s];r.push(n[3])}return{pos:i,lattice_ids:r}}(t)}this.max_dist=function(t){for(var e=0,i=0;i<t.length;i+=3){var r=3*i,o=t[r]*t[r]+t[r+1]*t[r+1]+t[r+2]*t[r+2];e<o&&(e=o)}return Math.sqrt(e)}(this.data.pos),this.d_min=1/this.max_dist;var i=function(t){for(var e=-1/0,i=0;i<t.length;i++)t[i]>e&&(e=t[i]);return e}(this.data.lattice_ids);_t.splice(3);for(var r=1;r<=i;r++)_t.push("#"+(r+1));this.set_axes(),this.set_points(this.data),this.camera.zoom=.5*(this.camera.top-this.camera.bottom);var o=1.01*this.max_dist;return this.controls.slab_width=[o,o,100],this.set_view(e),this.hud("Loaded "+this.data.pos.length+" spots."),!0},t.prototype.load_map_from_ab=function(t){0<this.map_bags.length&&this.clear_el_objects(this.map_bags.pop());var e=new vt(t);if(null!=e){var i=e.box_size[0]/2;this.config.map_radius=Math.round(i/2*100)/100,this.config.max_map_radius=Math.round(1.5*i*100)/100,this.config.default_isolevel=.3,this.add_map(e,!1);var r=1/i,o="Loaded density map ("+r.toFixed(2)+"Å).\n";null!==this.points&&r>this.d_min&&(o+="Adjusted spot clipping. ",this.change_dmin(r-this.d_min)),this.hud(o+"Use +/- to change the isolevel.")}},t.prototype.set_axes=function(){if(null!=this.axes&&(this.remove_and_dispose(this.axes),this.axes=null),"none"!==this.config.show_axes){var t=[];J(t,[0,0,0],1.2*this.max_dist);var e=this.config.colors.axes,i=[e[0],e[0],e[1],e[1],e[2],e[2]];"two"===this.config.show_axes&&(t.splice(4),i.splice(4));var r=S({win_size:this.window_size,linewidth:3,segments:!0});this.axes=H(r,t,i),this.scene.add(this.axes)}},t.prototype.set_points=function(t){if(null!=this.points&&(this.remove_and_dispose(this.points),this.points=null),null!=t&&null!=t.lattice_ids&&null!=t.pos){var e=new Float32Array(3*t.lattice_ids.length);this.colorize_by_id(e,t.lattice_ids);var i=new A.BufferGeometry;i.addAttribute("position",new A.BufferAttribute(t.pos,3)),i.addAttribute("color",new A.BufferAttribute(e,3));var r=new Float32Array(t.lattice_ids);i.addAttribute("group",new A.BufferAttribute(r,1)),this.points=new A.Points(i,this.point_material),this.scene.add(this.points),this.request_render()}},t.prototype.colorize_by_id=function(t,e){for(var i=this.config.colors.lattices,r=0;r<e.length;r++){var o=i[(e[r]+1)%4];t[3*r]=o.r,t[3*r+1]=o.g,t[3*r+2]=o.b}},t.prototype.mousewheel_action=function(t,e){this.change_zoom_by_factor(1+5e-4*t)},t.prototype.change_point_size=function(t){var e=this.point_material.uniforms.size;e.value=Math.max(e.value+t,.5),this.hud("point size: "+e.value.toFixed(1))},t.prototype.change_dmin=function(t){this.d_min=Math.max(this.d_min+t,.1);var e=0<this.d_max_inv?1/this.d_max_inv:null;null!==e&&this.d_min>e&&(this.d_min=e),this.point_material.uniforms.r2_max.value=1/(this.d_min*this.d_min);var i=null!==e?e.toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")},t.prototype.change_dmax=function(t){var e=Math.min(this.d_max_inv+t,1/this.d_min);e<1e-6&&(e=0),this.d_max_inv=e,this.point_material.uniforms.r2_min.value=e*e;var i=0<e?(1/e).toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")},t.prototype.redraw_models=function(){this.set_points(this.data)},t.prototype.get_cell_box_func=function(){if(0===this.map_bags.length)return null;var e=this.map_bags[0].map.box_size;return function(t){return[(t[0]-.5)*e[0],(t[1]-.5)*e[1],(t[2]-.5)*e[2]]}},t}(pt);bt.prototype.ColorSchemes=[{name:"solarized dark",bg:11062,fg:16643811,map_den:15657173,center:16643811,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]},{name:"solarized light",bg:16643811,fg:11062,map_den:472642,center:11062,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]}],bt.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","V = show (un)indexed","A = toggle axes","U = toggle map box","B = bg color","E = toggle fog","M/N = zoom","D/F = clip width","&lt;/> = move clip","R = center view","Z/X = point size","S = point shape","Shift+P = permalink","Shift+F = full screen","←/→ = max resol.","↑/↓ = min resol.","+/- = map level"].join("\n"),bt.prototype.MOUSE_HELP=pt.prototype.MOUSE_HELP.split("\n").slice(0,-2).join("\n"),t.UnitCell=k,t.modelsFromPDB=s,t.Model=o,t.Block=r,t.ElMap=l,t.makeCube=d,t.makeRgbBox=u,t.makeUniforms=b,t.makeRibbon=x,t.makeChickenWire=z,t.makeGrid=C,t.makeLineMaterial=S,t.makeLine=U,t.makeLineSegments=H,t.makeWheels=G,t.makeLabel=Q,t.addXyzCross=J,t.STATE=tt,t.Controls=et,t.Viewer=pt,t.ReciprocalSpaceMap=vt,t.ReciprocalViewer=bt,Object.defineProperty(t,"__esModule",{value:!0})});