var UGLYMOL_VERSION="0.3.1",THREE=THREE||require("three"),UnitCell=function(){"use strict";function e(e,t,r,i,o,n){function s(e,t){var r=e[0],i=e[1],o=e[2];return[t[0]*r+t[1]*i+t[2]*o,t[4]*i+t[5]*o,t[8]*o]}if(e<=0||t<=0||r<=0||i<=0||o<=0||n<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[e,t,r,i,o,n];var a=Math.PI/180,l=Math.cos(a*i),h=Math.cos(a*o),c=Math.cos(a*n),u=Math.sin(a*i),d=Math.sin(a*o),f=Math.sin(a*n);if(0===u||0===d||0===f)throw Error("Impossible angle - N*180deg.");var m=(h*c-l)/f,p=m/d,_=Math.sqrt(1-p*p),g=[e,t*c,r*h,0,t*f,-r*m,0,0,r*d*_],v=[1/e,-c/(f*e),-(c*m+h*f)/(d*_*f*e),0,1/(f*t),p/(_*f*t),0,0,1/(d*_*r)];this.fractionalize=function(e){return s(e,v)},this.orthogonalize=function(e){return s(e,g)}}return e}(),Model=function(){"use strict";function e(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=null,this.upper_bound=null}function t(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=null,this.resseq=null,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.charge=0,this.i_seq=null,this.is_ligand=null,this.bonds=[]}function r(e,t,r,i){var o;this.boxes=[],this.xdim=Math.ceil((i[0]-r[0])/t),this.ydim=Math.ceil((i[1]-r[1])/t),this.zdim=Math.ceil((i[2]-r[2])/t);var n=this.xdim*this.ydim*this.zdim;for(o=0;o<n;o++)this.boxes.push([]);for(this.find_box_id=function(e,i,o){var n=Math.floor((e-r[0])/t),s=Math.floor((i-r[1])/t),a=Math.floor((o-r[2])/t),l=(a*this.ydim+s)*this.xdim+n;return l>=0&&l<this.boxes.length?l:null},o=0;o<e.length;o++){var s=e[o].xyz,a=this.find_box_id(s[0],s[1],s[2]);if(null===a)throw Error("wrong cubicle");this.boxes[a].push(o)}}var i=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],o=["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"],n=["HOH"].concat(i,o);return e.prototype.from_pdb=function(e){for(var r=e.split("\n"),i=0,o=null,n=0,s=0;s<r.length;s++){var a=r[s],l=a.substring(0,6);if("ATOM  "===l||"HETATM"===l){var h=new t;h.from_pdb_line(a),h.i_seq=n++,this.has_hydrogens||"H"!==h.element||(this.has_hydrogens=!0),h.chain!==o&&i++,h.chain_index=i,o=h.chain,this.atoms.push(h)}else if("ANISOU"===l);else if("CRYST1"===l){var c=parseFloat(a.substring(6,15)),u=parseFloat(a.substring(15,24)),d=parseFloat(a.substring(24,33)),f=parseFloat(a.substring(33,40)),m=parseFloat(a.substring(40,47)),p=parseFloat(a.substring(47,54));this.unit_cell=new UnitCell(c,u,d,f,m,p)}else"TER"===l.substring(0,3)&&(o=null)}if(0===this.atoms.length)throw Error("No atom records found.");this.calculate_bounds(),this.calculate_connectivity()},e.prototype.calculate_bounds=function(){for(var e=this.lower_bound=[1/0,1/0,1/0],t=this.upper_bound=[-(1/0),-(1/0),-(1/0)],r=0;r<this.atoms.length;r++)for(var i=this.atoms[r],o=0;o<3;o++){var n=i.xyz[o];n<e[o]&&(e[o]=n),n>t[o]&&(t[o]=n)}for(var s=0;s<3;++s)e[s]-=.001,t[s]+=.001},e.prototype.next_residue=function(e,t){for(var r=this.atoms.length,i=(e?e.i_seq:0)+r,o=e?1:0;o<r;o++){var n=(i+(t?-o:o))%r,s=this.atoms[n];if(s.is_main_conformer()&&("CA"===s.name&&"C"===s.element||"P"===s.name))return s}},e.prototype.extract_trace=function(){for(var e=[],t=[],r=null,i=0;i<this.atoms.length;i++){var o=this.atoms[i];if((""===o.altloc||"A"===o.altloc)&&("CA"===o.name&&"C"===o.element||"P"===o.name)){var n=!0;if(null!==r&&r.chain_index===o.chain_index){var s=o.distance_sq(r);("CA"===o.name&&s<=30.25||"P"===o.name&&s<56.25)&&(t.push(o),n=!1)}n&&(t.length>2&&e.push(t),t=[o]),r=o}}return t.length>2&&e.push(t),e},e.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var e={},t=0;t<this.atoms.length;t++){var r=this.atoms[t],i=r.resid(),o=e[i];void 0===o?e[i]=[r]:o.push(r)}return this.residue_map=e,e},e.prototype.calculate_tangent_vector=function(e){for(var t=null,r=null,i=3===e[0].resname.length,o=i?"C":"C2'",n=i?"O":"O4'",s=0;s<e.length;s++){var a=e[s];a.is_main_conformer()&&(a.name===o?t=a.xyz:a.name===n&&(r=a.xyz))}if(null===t||null===r)return[0,0,1];var l=[t[0]-r[0],t[1]-r[1],t[2]-r[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},e.prototype.get_center=function(){for(var e=0,t=0,r=0,i=this.atoms.length,o=0;o<i;o++){var n=this.atoms[o].xyz;e+=n[0],t+=n[1],r+=n[2]}return[e/i,t/i,r/i]},t.prototype.from_pdb_line=function(e){if(e.length<66)throw Error("ATOM or HETATM record is too short: "+e);var t=e.substring(0,6);if("HETATM"===t)this.hetero=!0;else if("ATOM  "!==t)throw Error("Wrong record type: "+t);this.name=e.substring(12,16).trim(),this.altloc=e.substring(16,17).trim(),this.resname=e.substring(17,20).trim(),this.chain=e.substring(20,22).trim(),this.resseq=parseInt(e.substring(22,26),10),this.icode=e.substring(26,27).trim();var r=parseFloat(e.substring(30,38)),i=parseFloat(e.substring(38,46)),o=parseFloat(e.substring(46,54));this.xyz=[r,i,o],this.occ=parseFloat(e.substring(54,60)),this.b=parseFloat(e.substring(60,66)),e.length>=78&&(this.element=e.substring(76,78).trim().toUpperCase()),e.length>=80&&(this.charge=e.substring(78,80).trim()),this.is_ligand=n.indexOf(this.resname)===-1},t.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},t.prototype.distance_sq=function(e){var t=this.xyz[0]-e.xyz[0],r=this.xyz[1]-e.xyz[1],i=this.xyz[2]-e.xyz[2];return t*t+r*r+i*i},t.prototype.distance=function(e){return Math.sqrt(this.distance_sq(e))},t.prototype.midpoint=function(e){return[(this.xyz[0]+e.xyz[0])/2,(this.xyz[1]+e.xyz[1])/2,(this.xyz[2]+e.xyz[2])/2]},t.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},t.prototype.is_s_or_p=function(){return"S"===this.element||"P"===this.element},t.prototype.is_ion=function(){return this.element===this.resname},t.prototype.is_water=function(){return"HOH"===this.resname},t.prototype.is_same_residue=function(e,t){return e.resseq===this.resseq&&e.icode===this.icode&&e.chain===this.chain&&e.resname===this.resname&&(t||e.altloc===this.altloc)},t.prototype.is_same_conformer=function(e){return""===this.altloc||""===e.altloc||this.altloc===e.altloc},t.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},t.prototype.is_bonded_to=function(e){var t=3.9601,r=1.3*1.3,i=2.2*2.2;if(!this.is_same_conformer(e))return!1;if("H"===this.element&&"H"===e.element)return!1;var o=this.distance_sq(e);return!(o>i)&&("H"===this.element||"H"===e.element?o<=r:o<=t||this.is_s_or_p()||e.is_s_or_p())},t.prototype.resid=function(){return this.resseq+"/"+this.chain},t.prototype.long_label=function(){var e=this;return e.name+" /"+e.resseq+" "+e.resname+"/"+e.chain+" - occ: "+e.occ.toFixed(2)+" bf: "+e.b.toFixed(2)+" ele: "+e.element+" pos: ("+e.xyz[0].toFixed(2)+","+e.xyz[1].toFixed(2)+","+e.xyz[2].toFixed(2)+")"},r.prototype.get_nearby_atoms=function(e){var t=[],r=this.xdim*this.ydim,i=Math.max(e%r,0),o=Math.max(i%this.xdim,0),n=Math.floor(i/this.xdim),s=Math.floor(e/r);console.assert(s*r+n*this.xdim+o===e);for(var a=o-1;a<=o+1;a++)if(!(a<0||a>=this.xdim))for(var l=n-1;l<=n+1;l++)if(!(l<0||l>=this.ydim))for(var h=s-1;h<=s+1;h++)if(!(h<0||h>=this.zdim)){var c=h*r+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var u=this.boxes[c],d=0;d<u.length;d++)t.push(u[d])}return t},e.prototype.calculate_connectivity=function(){for(var e=this.atoms,t=new r(e,3,this.lower_bound,this.upper_bound),i=0;i<t.boxes.length;i++){var o=t.boxes[i];if(0!==o.length)for(var n=t.get_nearby_atoms(i),s=0;s<o.length;s++)for(var a=o[s],l=0;l<n.length;l++){var h=n[l];h>a&&e[a].is_bonded_to(e[h])&&(e[a].bonds.push(h),e[h].bonds.push(a))}}this.cubes=t},e.prototype.get_nearest_atom=function(e,t,r,i){for(var o=this.cubes.find_box_id(e,t,r),n=this.cubes.get_nearby_atoms(o),s=null,a=1/0,l=0;l<n.length;l++){var h=this.atoms[n[l]];if(void 0===i||null===i||i===h.name){var c=h.xyz[0]-e,u=h.xyz[1]-t,d=h.xyz[2]-r,f=c*c+u*u+d*d;f<a&&(s=h,a=f)}}return s},e}(),ElMap=function(){"use strict";function e(e){this.dim=e,this.values=new Float32Array(e[0]*e[1]*e[2])}function t(e,t){var r=e%t;return r>=0?r:r+t}function r(){this.unit_cell=null,this.grid=null,this.mean=0,this.rms=1}function i(e){var t=e.toLowerCase().replace(/\s+/g,"").split(",");if(3!==t.length)throw Error("Unexpected symop: "+e);for(var r=[],i=0;i<3;i++){for(var o=t[i].split(/(?=[+-])/),n=[0,0,0,0],s=0;s<o.length;s++){var a=o[s],l="-"===a[0]?-1:1,h=o[s].match(/^[+-]?([xyz])$/);if(h){var c={x:0,y:1,z:2}[h[1]];n[c]=l}else{if(h=o[s].match(/^[+-]?(\d)\/(\d)$/),!h)throw Error("What is "+o[s]+" in "+e);n[3]=l*Number(h[1])/Number(h[2])}}r.push(n)}return r}return e.prototype.grid2index=function(e,r,i){return e=t(e,this.dim[0]),r=t(r,this.dim[1]),i=t(i,this.dim[2]),this.dim[2]*(this.dim[1]*e+r)+i},e.prototype.grid2frac=function(e,t,r){return[e/this.dim[0],t/this.dim[1],r/this.dim[2]]},e.prototype.frac2grid=function(e){return[0|Math.floor(e[0]*this.dim[0]),0|Math.floor(e[1]*this.dim[1]),0|Math.floor(e[2]*this.dim[2])]},e.prototype.set_grid_value=function(e,t,r,i){var o=this.grid2index(e,t,r);this.values[o]=i},e.prototype.get_grid_value=function(e,t,r){var i=this.grid2index(e,t,r);return this.values[i]},r.prototype.calculate_stddev=function(e,t){for(var r=0,i=0,o=e.length,n=t;n<o;n++)r+=e[n],i+=e[n]*e[n];var s=r/(o-t),a=i/(o-t)-s*s;this.mean=s,this.rms=Math.sqrt(a)},r.prototype.abs_level=function(e){return e*this.rms+this.mean},r.prototype.from_ccp4=function(t){if(t.byteLength<1024)throw Error("File shorter than 1024 bytes.");var r=new Int32Array(t,0,256);if(542130509!==r[52])throw Error("not a CCP4 map");var o=[r[0],r[1],r[2]];this.mode=r[3];var n;if(2===this.mode)n=4;else{if(0!==this.mode)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");n=1}var s=[r[4],r[5],r[6]],a=[r[7],r[8],r[9]],l=r[23];if(1024+l+n*o[0]*o[1]*o[2]!==t.byteLength)throw Error("ccp4 file too short or too long");var h=new Float32Array(t,0,t.byteLength>>2);this.unit_cell=new UnitCell(h[10],h[11],h[12],h[13],h[14],h[15]);var c=[r[16],r[17],r[18]],u=c.indexOf(1),d=c.indexOf(2),f=c.indexOf(3);if(this.min=h[19],this.max=h[20],this.sg_number=r[22],this.lskflg=r[24],this.grid=new e(a),l%4!==0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");var m;m=2===this.mode?h:new Int8Array(t);var p=(1024+l)/n|0;this.mean=h[21],this.rms=h[54],(this.mean<this.min||this.mean>this.max||this.rms<=0)&&this.calculate_stddev(m,p);var _=1,g=0;0===this.mode&&r[39]===-128&&127===r[40]&&(_=(this.max-this.min)/255,g=.5*(this.min+this.max+_));var v=[s[0]+o[0],s[1]+o[1],s[2]+o[2]],b=[0,0,0];for(b[2]=s[2];b[2]<v[2];b[2]++)for(b[1]=s[1];b[1]<v[1];b[1]++)for(b[0]=s[0];b[0]<v[0];b[0]++)this.grid.set_grid_value(b[u],b[d],b[f],_*m[p]+g),p++;if(l>0)for(var y=new Uint8Array(t),w=0;w+80<=l;w+=80){var E,x="";for(E=0;E<80;++E)x+=String.fromCharCode(y[1024+w+E]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(x)){var T=i(x);for(E=0;E<3;++E)T[E][3]=0|Math.round(T[E][3]*a[E]);p=(1024+l)/n|0;var R=[0,0,0];for(b[2]=s[2];b[2]<v[2];b[2]++)for(b[1]=s[1];b[1]<v[1];b[1]++)for(b[0]=s[0];b[0]<v[0];b[0]++){for(E=0;E<3;++E)R[E]=b[u]*T[E][0]+b[d]*T[E][1]+b[f]*T[E][2]+T[E][3];this.grid.set_grid_value(R[0],R[1],R[2],_*m[p]+g),p++}}}},r.prototype.from_dsn6=function(t){var r=new Uint8Array(t),i=new Int16Array(r.buffer);if(100!==i[18])for(var o=i.length,n=0;n<o;n++){var s=i[n];i[n]=(255&s)<<8|s>>8&255}if(100!==i[18])throw Error("Endian swap failed");var a=[i[0],i[1],i[2]],l=[i[3],i[4],i[5]],h=[i[6],i[7],i[8]],c=1/i[17];this.unit_cell=new UnitCell(c*i[9],c*i[10],c*i[11],c*i[12],c*i[13],c*i[14]),this.grid=new e(h);for(var u=i[15]/100,d=i[16],f=512,m=[Math.ceil(l[0]/8),Math.ceil(l[1]/8),Math.ceil(l[2]/8)],p=0;p<m[2];p++)for(var _=0;_<m[1];_++)for(var g=0;g<m[0];g++)for(var v=0;v<8;v++)for(var b=8*p+v,y=0;y<8;y++)for(var w=8*_+y,E=0;E<8;E++){var x=8*g+E;if(!(x<l[0]&&w<l[1]&&b<l[2])){f+=8-E;break}var T=(r[f]-d)/u;f++,this.grid.set_grid_value(a[0]+x,a[1]+w,a[2]+b,T)}this.calculate_stddev(this.grid.values,0)},r.prototype.show_debug_info=function(){console.log("unit cell: "+this.unit_cell.parameters.join(", ")),console.log("grid: "+this.grid.dim)},r.prototype.extract_block=function(e,t){var r=this.grid,i=this.unit_cell,o=[0,0,0],n=r.dim;if(t){var s=[t[0]-e,t[1]-e,t[2]-e],a=[t[0]+e,t[1]+e,t[2]+e],l=i.fractionalize(s),h=i.fractionalize(a);o=r.frac2grid(l),n=r.frac2grid(h)}for(var c=n[0]-o[0]+1,u=n[1]-o[1]+1,d=n[2]-o[2]+1,f=[],m=[],p=o[0];p<=n[0];p++)for(var _=o[1];_<=n[1];_++)for(var g=o[2];g<=n[2];g++){var v=r.grid2frac(p,_,g),b=i.orthogonalize(v);f.push(b);var y=r.get_grid_value(p,_,g);m.push(y)}this.block={points:f,values:m,size:[c,u,d]}},r.prototype.isomesh_in_block=function(e,t){var r=this.abs_level(e),i=this.block;return isosurface(i.size,i.values,i.points,r,t)},r}(),isosurface=function(){"use strict";function e(e,t,r){if(e[0]<=0||e[1]<=0||e[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var i=e[0]*e[1]*e[2];if(t.length!==i||r.length!==i)throw Error("isosurface: array size mismatch")}function t(e){for(var t=[],r=0;r<8;++r){var i=a[r];t.push(i[0]+e[2]*(i[1]+e[1]*i[2]))}return t}function r(e,r,i,a,h){for(var c="snapped MC"===h,u="squarish"===h?s:n,d=new Array(12),f=t(e),m=new Float32Array(8),p=[null,null,null,null,null,null,null,null],_=e[0],g=e[1],v=e[2],b=[],y=[],w=0,E=0;E<_-1;E++)for(var x=0;x<g-1;x++)for(var T=0;T<v-1;T++){var R,H,z=T+v*(x+g*E),A=0;for(R=0;R<8;++R)H=z+f[R],A|=r[H]<a?1<<R:0;if(0!==A&&255!==A){for(R=0;R<8;++R)H=z+f[R],m[R]=r[H],p[R]=i[H];var M=o[A];for(R=0;R<12;++R)if(0!==(M&1<<R)){var k=l[R],C=(a-m[k[0]])/(m[k[1]]-m[k[0]]);c===!0&&(C>.85?C=1:C<.15&&(C=0));var L=p[k[0]],O=p[k[1]];b.push(L[0]+(O[0]-L[0])*C,L[1]+(O[1]-L[1])*C,L[2]+(O[2]-L[2])*C),d[R]=w++}var F=u[A];for(R=0;R<F.length;R++)y.push(d[F[R]])}}return{vertices:b,segments:y}}function i(t,i,o,n,s){return e(t,i,o),r(t,i,o,n,s)}var o=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),n=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],s=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],a=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],l=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];return i}(),LineFactory=function(){"use strict";function e(e,t){var r,i=e.length,o=[];for(r=0;r<i;r++){var n=e[r];o.push(n.x,n.y,n.z),o.push(n.x,n.y,n.z)}var s=new Float32Array(o),a=new Float32Array(6*i);for(r=0;r<6;r++)a[r]=o[r];for(;r<6*i;r++)a[r]=o[r-6];var l=new Float32Array(6*i);for(r=0;r<6*(i-1);r++)l[r]=o[r+6];for(;r<6*i;r++)l[r]=o[r];var h=new Float32Array(2*i);for(r=0;r<i;r++)h[2*r]=1,h[2*r+1]=-1;var c=new Float32Array(6*i);for(r=0;r<i;r++){var u=t[r];c[6*r]=u.r,c[6*r+1]=u.g,c[6*r+2]=u.b,c[6*r+3]=u.r,c[6*r+4]=u.g,c[6*r+5]=u.b}var d=new THREE.BufferGeometry;return d.addAttribute("position",new THREE.BufferAttribute(s,3)),d.addAttribute("previous",new THREE.BufferAttribute(a,3)),d.addAttribute("next",new THREE.BufferAttribute(l,3)),d.addAttribute("side",new THREE.BufferAttribute(h,1)),d.addAttribute("color",new THREE.BufferAttribute(c,3)),d}function t(e,t){var r,i,o=e.length,n=[];for(r=0;r<o;r++){var s=e[r];n.push(s.x,s.y,s.z),n.push(s.x,s.y,s.z)}var a=new Float32Array(n),l=new Float32Array(6*o);for(r=0;r<6*o;r+=12){for(i=0;i<6;i++)l[r+i]=n[r+i+6];for(;i<12;i++)l[r+i]=n[r+i-6]}var h=new Float32Array(2*o);for(r=0;r<o;r++)h[2*r]=-1,h[2*r+1]=1;var c=new Float32Array(6*o);for(r=0;r<o;r++){var u=t[r];c[6*r]=u.r,c[6*r+1]=u.g,c[6*r+2]=u.b,c[6*r+3]=u.r,c[6*r+4]=u.g,c[6*r+5]=u.b}var d=2*o<65536?new Uint16Array(3*o):new Uint32Array(3*o),f=[0,1,2,0,2,3];for(r=0;r<o/2;r++)for(i=0;i<6;i++)d[6*r+i]=4*r+f[i];var m=new THREE.BufferGeometry;return m.addAttribute("position",new THREE.BufferAttribute(a,3)),m.addAttribute("other",new THREE.BufferAttribute(l,3)),m.addAttribute("side",new THREE.BufferAttribute(h,1)),m.addAttribute("color",new THREE.BufferAttribute(c,3)),m.setIndex(new THREE.BufferAttribute(d,1)),m}function r(e,t){for(var r=[],i=0;i<e.length;i++){var o=e[i].xyz;r.push(new THREE.Vector3(o[0],o[1],o[2]))}if(!t||t<2)return r;var n=new THREE.CatmullRomCurve3(r);return n.getPoints((e.length-1)*t)}function i(e,t){if(!t||t<2)return e;for(var r=[],i=0;i<e.length-1;i++)for(var o=0;o<t;o++)r.push(e[i]);return r.push(e[e.length-1]),r}function o(e,t){t=t||1;var r,i=[];for(r=0;r<e.length-1;r++)for(var o=e[r],n=e[r+1],s=0;s<t;s++){var a=s/t,l=1-a;i.push(l*o[0]+a*n[0],l*o[1]+a*n[1],l*o[2]+a*n[2])}return i.push(e[r][0],e[r][1],e[r][2]),i}function n(e){var t={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var r in e)t[r]={value:e[r]};return t}function s(e,t,r){this.use_gl_lines=e,e?(void 0===t.color&&(t.vertexColors=THREE.VertexColors),delete t.size,this.material=new THREE.LineBasicMaterial(t)):this.material=new THREE.ShaderMaterial({uniforms:n(t),vertexShader:r?d:u,fragmentShader:f,fog:!0,vertexColors:THREE.VertexColors})}function a(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r];t[3*r]=i.r,t[3*r+1]=i.g,t[3*r+2]=i.b}return t}function l(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r];t[3*r]=i.x,t[3*r+1]=i.y,t[3*r+2]=i.z}return t}function h(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r].xyz;t[3*r]=i[0],t[3*r+1]=i[1],t[3*r+2]=i[2]}return t}function c(e,t){var r=e.linePrecision*e.linePrecision;v.getInverse(this.matrixWorld),b.copy(e.ray).applyMatrix4(v);for(var i=new THREE.Vector3,o=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3,a=this.drawMode===THREE.TriangleStripDrawMode?1:2,l=this.geometry.attributes.position.array,h=0,c=l.length/6-1;h<c;h+=a){i.fromArray(l,6*h),o.fromArray(l,6*h+6);var u=b.distanceSqToSegment(i,o,s,n);if(!(u>r)){s.applyMatrix4(this.matrixWorld);var d=e.ray.origin.distanceTo(s);d<e.near||d>e.far||t.push({distance:d,point:n.clone().applyMatrix4(this.matrixWorld),index:h,object:this})}}}var u=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / size;","}"].join("\n"),d=["attribute vec3 other;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / size;","}"].join("\n"),f=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");s.prototype.make_line=function(t,o,n){var s=r(t,n),h=i(o,n);if(this.use_gl_lines){var u=new THREE.BufferGeometry,d=l(s);u.addAttribute("position",new THREE.BufferAttribute(d,3));var f=a(h);return u.addAttribute("color",new THREE.BufferAttribute(f,3)),new THREE.Line(u,this.material)}var m=new THREE.Mesh(e(s,h),this.material);return m.drawMode=THREE.TriangleStripDrawMode,m.raycast=c,m};var m=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),p=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");s.make_ribbon=function(e,t,s,h){var c=r(e,h),u=i(t,h),d=o(s,h),f=new THREE.Object3D,_=new THREE.BufferGeometry,g=l(c);_.addAttribute("position",new THREE.BufferAttribute(g,3));var v=a(u);_.addAttribute("color",new THREE.BufferAttribute(v,3));var b=new Float32Array(d);_.addAttribute("normal",new THREE.BufferAttribute(b,3));for(var y=new THREE.ShaderMaterial({uniforms:n({shift:0}),vertexShader:m,fragmentShader:p,fog:!0,vertexColors:THREE.VertexColors}),w=-4;w<5;w++){var E=0===w?y:y.clone();E.uniforms.shift.value=.1*w,f.add(new THREE.Line(_,E))}return f},s.prototype.make_line_segments=function(e){if(this.use_gl_lines)return new THREE.LineSegments(e,this.material);var r=e.vertices,i=e.colors,o=new THREE.Mesh(t(r,i),this.material);return o.raycast=c,o},s.make_chickenwire=function(e,t){var r=new THREE.BufferGeometry,i=new Float32Array(e.vertices);r.addAttribute("position",new THREE.BufferAttribute(i,3));var o=e.vertices.length<196608?new Uint16Array(e.segments):new Uint32Array(e.segments);
r.setIndex(new THREE.BufferAttribute(o,1));var n=new THREE.LineBasicMaterial(t);return new THREE.LineSegments(r,n)};var _=["uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = linewidth;","}"].join("\n"),g=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");s.prototype.make_caps=function(e,t){var r=h(e),i=a(t),o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.BufferAttribute(r,3)),o.addAttribute("color",new THREE.BufferAttribute(i,3));var n=new THREE.ShaderMaterial({uniforms:this.material.uniforms,vertexShader:_,fragmentShader:g,fog:!0,vertexColors:THREE.VertexColors});return new THREE.Points(o,n)},s.prototype.make_balls=function(e,t,r){var i=this.make_caps(e,t);return i.material.vertexShader=i.material.vertexShader.replace("= linewidth","="+r.toFixed(4)),i};var v=new THREE.Matrix4,b=new THREE.Ray;return s}(),Viewer=function(){"use strict";function e(e,t){var r=0,i=e*e+t*t;if(i<1)r=Math.sqrt(1-i);else{var o=Math.sqrt(i);e/=o,t/=o}return[e,t,r]}function t(e,t){return e*t[1]/700}function r(e,t){return void 0===m&&(m=new THREE.Raycaster),m.setFromCamera(e,t),m.near=t.near,m.far=t.far-.2*(t.far-t.near),m.linePrecision=.2,m}function i(e,t,r){for(var i=new THREE.Geometry,o=0;o<y.length;o++){var n=y[o],s=t.x+e*(n[0]-.5),a=t.y+e*(n[1]-.5),l=t.z+e*(n[2]-.5);i.vertices.push(new THREE.Vector3(s,a,l))}var h=new THREE.LineBasicMaterial({color:r,linewidth:2});return new THREE.LineSegments(i,h)}function o(e,t){if(!e)throw Error("Unit cell not defined!");for(var r=new THREE.Geometry,i=0;i<y.length;i++){var o=e.orthogonalize(y[i]);r.vertices.push(new THREE.Vector3(o[0],o[1],o[2]))}r.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775));for(var n=6;n<y.length;n++)r.colors.push(t);var s=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});return new THREE.LineSegments(r,s)}function n(e,t,r){var i=new THREE.Color(14737632);if(t<r){var o=(e-t)/(r-t),n=(240-240*o)/360;i.setHSL(n,1,.5)}return i}function s(e,t,r){var i,o,s=t[t.length-1];if("index"===e)i=function(e){return n(e.i_seq,0,s.i_seq)};else if("B-factor"===e){var a=1/0,l=-(1/0);for(o=0;o<t.length;o++){var h=t[o].b;h>l&&(l=h),h<a&&(a=h)}i=function(e){return n(e.b,a,l)}}else i="occupancy"===e?function(e){return n(e.occ,0,1)}:"chain"===e?function(e){return n(e.chain_index,0,s.chain_index)}:function(e){return r[e.element]||r.def};var c=[];for(o=0;o<t.length;o++)c.push(i(t[o]));return c}function a(e,t,r){var i=t.xyz,o=.7;e.vertices.push(new THREE.Vector3(i[0]-o,i[1],i[2])),e.vertices.push(new THREE.Vector3(i[0]+o,i[1],i[2])),e.vertices.push(new THREE.Vector3(i[0],i[1]-o,i[2])),e.vertices.push(new THREE.Vector3(i[0],i[1]+o,i[2])),e.vertices.push(new THREE.Vector3(i[0],i[1],i[2]-o)),e.vertices.push(new THREE.Vector3(i[0],i[1],i[2]+o));for(var n=0;n<6;n++)e.colors.push(r)}function l(e,t){this.map=e,this.name="",this.isolevel=t?3:1.5,this.visible=!0,this.types=t?["map_pos","map_neg"]:["map_den"],this.block_ctr=new THREE.Vector3(1/0,0,0),this.el_objects=[]}function h(e,t,r){this.model=e,this.name="",this.visible=!0,this.conf=t,this.win_size=r,this.atomic_objects=null}function c(e){if(this.config={bond_line:4,map_line:1.25,map_radius:10,map_style:x[0],render_style:E[0],color_aim:w[0],colors:_[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null},this.nav=null,this.last_ctr=new THREE.Vector3(1/0,0,0),this.initial_hud_html=null,this.initial_hud_bg="",this.selected_atom=null,this.active_model_bag=null,this.scene=new THREE.Scene,this.target=new THREE.Vector3,this.camera=new THREE.OrthographicCamera,this.scene.fog=new THREE.Fog(this.config.colors.bg,0,1),this.light=new THREE.AmbientLight(16777215),this.scene.add(this.light),this.controls=new b(this.camera,this.target),"undefined"!=typeof document){try{this.renderer=new THREE.WebGLRenderer({antialias:!0})}catch(e){return this.hud("no WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=document.getElementById(e.viewer||"viewer"),this.hud_el=document.getElementById(e.hud||"hud"),this.help_el=document.getElementById(e.help||"help"),null!==this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.container.appendChild(this.renderer.domElement),e.focusable&&(this.renderer.domElement.tabIndex=0),window.Stats&&(this.stats=new window.Stats,this.container.appendChild(this.stats.dom)),window.addEventListener("resize",this.resize.bind(this));var t=this.renderer.domElement,r=e.focusable?t:window;r.addEventListener("keydown",this.keydown.bind(this)),t.addEventListener("contextmenu",function(e){e.preventDefault()}),t.addEventListener("mousewheel",this.mousewheel.bind(this)),t.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),t.addEventListener("mousedown",this.mousedown.bind(this)),t.addEventListener("touchstart",this.touchstart.bind(this)),t.addEventListener("touchmove",this.touchmove.bind(this)),t.addEventListener("touchend",this.touchend.bind(this)),t.addEventListener("touchcancel",this.touchend.bind(this)),t.addEventListener("dblclick",this.dblclick.bind(this));var i=this;this.mousemove=function(e){e.preventDefault(),i.controls.move(i.relX(e),i.relY(e))},this.mouseup=function(e){e.preventDefault(),e.stopPropagation(),i.controls.stop(i.active_model_bag),document.removeEventListener("mousemove",i.mousemove),document.removeEventListener("mouseup",i.mouseup),i.redraw_maps()},this.scheduled=!1,this.request_render()}}}function u(e,t,r){return e.x.toFixed(t)+r+e.y.toFixed(t)+r+e.z.toFixed(t)}function d(e){var t=e.touches,r=t[0].pageX-t[1].pageX,i=t[0].pageY-t[1].pageY;return{pageX:(t[0].pageX+t[1].pageX)/2,pageY:(t[0].pageY+t[1].pageY)/2,dist:Math.sqrt(r*r+i*i)}}function f(){var e={};if("undefined"==typeof window)return e;for(var t=window.location.hash.substr(1).split("&"),r=0;r<t.length;r++){var i=t[r].split("="),o=i[1];"xyz"===i[0]||"eye"===i[0]?o=o.split(",").map(Number):"zoom"===i[0]&&(o=Number(o)),e[i[0]]=o}return e}var m,p=!1,_=[{name:"coot dark",bg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,cell_box:16777215,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,cell_box:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,cell_box:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,cell_box:0,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}],g=1,v={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},b=function(t,i){function o(e){w=Math.max(w+e,.01)}function n(e){var r=new THREE.Quaternion;r.setFromUnitVectors(u,c),e.applyQuaternion(r),t.up.applyQuaternion(r),u.applyQuaternion(r),c.copy(u)}function s(e){var r=f.x-d.x,n=f.y-d.y;h===v.ZOOM?t.zoom/=1-r+n:h===v.SLAB?(o(10*r),i.addScaledVector(e,-5/e.length()*n)):h===v.ROLL&&t.up.applyAxisAngle(e,.05*(r-n)),d.copy(f)}function a(e){var r=b.x-_.x,o=b.y-_.y;r*=.5*(t.right-t.left)/t.zoom,o*=.5*(t.bottom-t.top)/t.zoom;var n=e.clone().cross(t.up).setLength(r);n.addScaledVector(t.up,o/t.up.length()),t.position.add(n),i.add(n),_.copy(b)}function l(e){c.copy(e).normalize();var r=Date.now(),i=null!==x?r-x:16.7,o=18e-6*i*g;x=r,null!==E&&(E+=.02,o=4e-5*g*Math.cos(E)),u.crossVectors(t.up,e).multiplyScalar(o).add(c)}var h=v.NONE,c=new THREE.Vector3,u=new THREE.Vector3,d=new THREE.Vector2,f=new THREE.Vector2,m=0,p=0,_=new THREE.Vector2,b=new THREE.Vector2,y=!0,w=10,E=0,x=null,T=null;this.toggle_auto=function(e){h=h===v.AUTO_ROTATE?v.NONE:v.AUTO_ROTATE,x=null,E=e.rock?0:null},this.is_going=function(){return h===v.GO},this.is_moving=function(){return h!==v.NONE},this.update=function(){var e=!1,r=t.position.clone().sub(i);return h===v.AUTO_ROTATE&&l(r),c.equals(u)||(n(r),e=!0),p!==m&&(t.zoom*=p/m,m=p,e=!0),f.equals(d)||(s(r),e=!0),b.equals(_)||(a(r),y=!0,e=!0),t.position.addVectors(i,r),h===v.GO&&(T(),e=!0),t.lookAt(i),e},this.start=function(e,t,r,i){switch(h!==v.NONE&&h!==v.AUTO_ROTATE||(h=e),this.move(t,r,i),h){case v.ROTATE:c.copy(u);break;case v.ZOOM:case v.SLAB:case v.ROLL:d.copy(f);break;case v.PAN:_.copy(b),y=!1;break;case v.PAN_ZOOM:m=p,_.copy(b)}},this.move=function(r,o,n){switch(h){case v.ROTATE:var s=e(r,o),a=t.position.clone().sub(i);u.crossVectors(t.up,a).setLength(s[0]),u.addScaledVector(t.up,s[1]/t.up.length()),u.addScaledVector(a,s[2]/a.length());break;case v.ZOOM:case v.SLAB:case v.ROLL:f.set(r,o);break;case v.PAN:b.set(r,o);break;case v.PAN_ZOOM:b.set(r,o),p=n}},this.stop=function(e){var i=null;h===v.PAN&&!y&&e&&(i=e.pick_atom(r(_,t))),h=v.NONE,c.copy(u),m=p,_.copy(b),null!==i&&this.go_to(new THREE.Vector3(i.xyz[0],i.xyz[1],i.xyz[2]))},this.slab_width=function(){return w},this.change_slab_width=o,this.go_to=function(e,r,o,n){if(e&&!(e.distanceToSquared(i)<.1)||r&&!(r.distanceToSquared(t.position)<.1)||o&&!(o.distanceToSquared(t.up)<.1)){h=v.GO,n=n||60/g;for(var s=[],a=0,l=1;l<=n;++l){var c=l/n;c=c<.5?2*c*c:-2*c*(c-2)-1,s.push((c-a)/(1-a)),a=c}T=function(){var n=s.shift();e&&(r||t.position.sub(i),i.lerp(e,n),r||t.position.add(i)),r&&t.position.lerp(r,n),o&&t.up.lerp(o,n),0===s.length&&(h=v.NONE,T=null)}}}},y=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]],w=["element","B-factor","occupancy","index","chain"],E=["lines","trace","ribbon"],x=["marching cubes","squarish"];return h.prototype.pick_atom=function(e){var t=e.intersectObjects(this.atomic_objects);if(t.length<1)return null;var r=t[0].point;return this.model.get_nearest_atom(r.x,r.y,r.z)},h.prototype.get_visible_atoms=function(){var e=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return e;for(var t=[],r=0;r<e.length;r++)"H"!==e[r].element&&t.push(e[r]);return t},h.prototype.add_bonds=function(e,r){for(var i=this.get_visible_atoms(),o=e?"element":this.conf.color_aim,n=s(o,i,this.conf.colors),l=new THREE.Geometry,h={hydrogens:this.conf.hydrogens,ligands_only:e,balls:"ball&stick"===this.conf.render_style},c=0;c<i.length;c++){var u=i[c],d=n[c];if(!e||u.is_ligand)if(0!==u.bonds.length||h.balls)for(var f=0;f<u.bonds.length;f++){var m=this.model.atoms[u.bonds[f]];if((h.hydrogens||"H"!==m.element)&&(!h.ligands_only||m.is_ligand)){var _=u.midpoint(m),g=new THREE.Vector3(_[0],_[1],_[2]),v=new THREE.Vector3(u.xyz[0],u.xyz[1],u.xyz[2]);if(h.balls){var b=v.distanceTo(g)/r;v.lerp(g,b)}l.vertices.push(v,g),l.colors.push(d,d)}}else a(l,u,d)}var y=new LineFactory(p,{linewidth:t(this.conf.bond_line,this.win_size),size:this.win_size},!0);this.atomic_objects.push(y.make_line_segments(l)),h.balls?this.atomic_objects.push(y.make_balls(i,n,r)):p||e||this.atomic_objects.push(y.make_caps(i,n))},h.prototype.add_trace=function(e){for(var r=this.model.extract_trace(),i=[].concat.apply([],r),o=s(this.conf.color_aim,i,this.conf.colors),n=new LineFactory(p,{linewidth:t(this.conf.bond_line,this.win_size),size:this.win_size}),a=0,l=0;l<r.length;l++){var h=r[l],c=o.slice(a,a+h.length);a+=h.length;var u=n.make_line(h,c,e);this.atomic_objects.push(u)}},h.prototype.add_ribbon=function(e){for(var t=this.model.extract_trace(),r=this.model.get_residues(),i=[].concat.apply([],t),o=s(this.conf.color_aim,i,this.conf.colors),n=0,a=0;a<t.length;a++){for(var l=t[a],h=[],c=[0,0,0],u=0;u<l.length;u++){var d=r[l[u].resid()],f=this.model.calculate_tangent_vector(d);f[0]*c[0]+f[1]*c[1]+f[2]*c[2]<0&&(f[0]=-f[0],f[1]=-f[1],f[2]=-f[2]),h.push(f),c=f}var m=o.slice(n,n+l.length);n+=l.length;var p=LineFactory.make_ribbon(l,m,h,e);this.atomic_objects.push(p)}},c.prototype.set_colors=function(e){if(null==e)e=_[0];else if("number"==typeof e)e=_[e%_.length];else if("string"==typeof e)for(var t=0;t!==_.length;t++)if(_[t].name===e){e=_[t];break}if(void 0!==e.bg){if("number"==typeof e.bg)for(var r in e)"name"!==r&&(e[r]=new THREE.Color(e[r]));this.config.colors=e,this.redraw_all()}},c.prototype.relX=function(e){return 2*(e.pageX-this.window_offset[0])/this.window_size[0]-1},c.prototype.relY=function(e){return 1-2*(e.pageY-this.window_offset[1])/this.window_size[1]},c.prototype.hud=function(e,t){if("undefined"!=typeof document){var r=this.hud_el;r?(null===this.initial_hud_html&&(this.initial_hud_html=r.innerHTML,this.initial_hud_bg=r.style["background-color"]),void 0!==e?r.textContent=e:r.innerHTML=this.initial_hud_html,r.style["background-color"]="ERR"!==t?this.initial_hud_bg:"#b00","ERR"===t&&console.log("ERR: "+e)):console.log("hud: "+e)}},c.prototype.redraw_center=function(){this.target.distanceToSquared(this.last_ctr)>1e-4&&(this.last_ctr.copy(this.target),this.mark&&this.scene.remove(this.mark),this.mark=i(.1,this.target,this.config.colors.center),this.scene.add(this.mark))},c.prototype.redraw_maps=function(e){this.redraw_center();for(var t=0;t<this.map_bags.length;t++){var r=this.map_bags[t];(e||this.target.distanceToSquared(r.block_ctr)>.01)&&this.redraw_map(r)}},c.prototype.clear_el_objects=function(e){for(var t=0;t<e.el_objects.length;t++)this.scene.remove(e.el_objects[t]),e.el_objects[t].geometry.dispose();e.el_objects=[]},c.prototype.clear_atomic_objects=function(e){if(e.atomic_objects)for(var t=0;t<e.atomic_objects.length;t++)this.scene.remove(e.atomic_objects[t]);e.atomic_objects=null},c.prototype.set_atomic_objects=function(e){switch(e.atomic_objects=[],e.conf.render_style){case"lines":e.add_bonds();break;case"ball&stick":var t=this.camera.projectionMatrix.elements[5],r=Math.max(1,200*t);e.add_bonds(!1,r);break;case"trace":e.add_trace(),e.add_bonds(!0);break;case"ribbon":e.add_ribbon(8),e.add_bonds(!0)}for(var i=0;i<e.atomic_objects.length;i++)this.scene.add(e.atomic_objects[i])},c.prototype.toggle_map_visibility=function(e){"number"==typeof e&&(e=this.map_bags[e]),e.visible=!e.visible,this.redraw_map(e)},c.prototype.redraw_map=function(e){this.clear_el_objects(e),e.visible&&(e.map.block=null,this.add_el_objects(e))},c.prototype.toggle_model_visibility=function(e){e=e||this.active_model_bag,e.visible=!e.visible,this.redraw_model(e)},c.prototype.redraw_model=function(e){this.clear_atomic_objects(e),e.visible&&this.set_atomic_objects(e)},c.prototype.redraw_models=function(){for(var e=0;e<this.model_bags.length;e++)this.redraw_model(this.model_bags[e])},c.prototype.add_el_objects=function(e){if(e.visible){e.map.block||(e.block_ctr.copy(this.target),e.map.extract_block(this.config.map_radius,[this.target.x,this.target.y,this.target.z]));for(var t=0;t<e.types.length;t++){var r=e.types[t],i=("map_neg"===r?-1:1)*e.isolevel,o=e.map.isomesh_in_block(i,this.config.map_style),n=LineFactory.make_chickenwire(o,{color:this.config.colors[r],linewidth:this.config.map_line});e.el_objects.push(n),this.scene.add(n)}}},c.prototype.change_isolevel_by=function(e,t){if(!(e>=this.map_bags.length)){var r=this.map_bags[e];r.isolevel+=t;var i=r.map.abs_level(r.isolevel);this.hud("map "+(e+1)+" level =  "+i.toFixed(4)+"e/A^3 ("+r.isolevel.toFixed(2)+" rmsd)"),this.clear_el_objects(r),this.add_el_objects(r)}},c.prototype.change_map_radius=function(e){var t=2,r=40,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+e,t),r);var o='map "radius": '+i.map_radius;i.map_radius===r?o+=" (max)":i.map_radius===t&&(o+=" (min)"),this.hud(o),this.redraw_maps(!0)},c.prototype.change_slab_width_by=function(e){this.controls.change_slab_width(e),this.update_camera(),this.hud("clip width: "+(this.camera.far-this.camera.near).toFixed(1))},c.prototype.toggle_full_screen=function(){var e=document;if(e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement){var t=e.exitFullscreen||e.webkitExitFullscreen||e.mozCancelFullScreen||e.msExitFullscreen;t&&t.call(e)}else{var r=this.container,i=r.requestFullscreen||r.webkitRequestFullscreen||r.mozRequestFullScreen||r.msRequestFullscreen;i&&i.call(r)}},c.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var e=null;this.model_bags.length>0&&(e=this.model_bags[0].model.unit_cell),!e&&this.map_bags.length>0&&(e=this.map_bags[0].map.unit_cell),e&&(this.decor.cell_box=o(e,this.config.colors.cell_box),this.scene.add(this.decor.cell_box))}},c.prototype.shift_clip=function(e){var t=this.camera.position.clone().sub(this.target).setLength(1);e||t.negate(),this.target.add(t),this.camera.position.add(t),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+u(t,2," ")+"]")},c.prototype.go_to_nearest_Ca=function(){var e=this.target;if(null!==this.active_model_bag){var t=this.active_model_bag.model.get_nearest_atom(e.x,e.y,e.z,"CA");t?(this.hud(t.long_label()),this.controls.go_to(new THREE.Vector3(t.xyz[0],t.xyz[1],t.xyz[2]),null,null,30/g),this.selected_atom=t):this.hud("no nearby CA")}},c.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0))},c.toggle_help=function(e){e&&(e.style.display="block"===e.style.display?"none":"block",""===e.innerHTML&&(e.innerHTML=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ","\n<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","+/- = sigma level","]/[ = map radius","D/F = clip width","numpad 3/. = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","R = center view","W = wireframe style","I = spin","Shift+I = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen",'\n<a href="https://uglymol.github.io">about uglymol</a>'].join("\n")))},c.prototype.keydown=function(e){function r(t,r){var i=e.shiftKey?r.length-1:1;return r[(r.indexOf(t)+i)%r.length]}var i=e.keyCode;switch(i){case 84:this.config.render_style=r(this.config.render_style,E),this.hud("rendering as "+this.config.render_style),this.redraw_models();break;case 66:this.set_colors(r(this.config.colors,_)),this.hud("color scheme: "+this.config.colors.name);break;case 67:this.config.color_aim=r(this.config.color_aim,w),this.hud("coloring by "+this.config.color_aim),this.redraw_models();break;case 87:this.config.map_style=r(this.config.map_style,x),this.hud("map style: "+this.config.map_style),this.redraw_maps(!0);break;case 89:this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models();break;case 220:p=!p,this.hud((p?"simple":"round-capped")+" bonds"),this.redraw_models();break;case 107:case 61:case 187:this.change_isolevel_by(e.shiftKey?1:0,.1);break;case 109:case 173:case 189:this.change_isolevel_by(e.shiftKey?1:0,-.1);break;case 219:this.change_map_radius(-2);break;case 221:this.change_map_radius(2);break;case 68:this.change_slab_width_by(-.1);break;case 70:e.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1);break;case 77:case 78:this.camera.zoom*=77===i?1.03:1/1.03,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toFixed(2));break;case 80:e.shiftKey?(window.location.hash="#xyz="+u(this.target,1,",")+"&eye="+u(this.camera.position,1,",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar")):this.go_to_nearest_Ca();break;case 51:case 99:this.shift_clip(!0);break;case 108:case 110:this.shift_clip(!1);break;case 85:this.hud("toggled unit cell box"),this.toggle_cell_box();break;case 73:this.hud("toggled camera movement"),this.controls.toggle_auto({rock:e.shiftKey});break;case 82:e.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("model recentered"),this.recenter());break;case 72:c.toggle_help(this.help_el);break;case 36:case 35:e.ctrlKey?(this.config.map_line+=36===i?.1:-.1,this.config.map_line=Math.max(this.config.map_line,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))):(this.config.bond_line+=36===i?.2:-.2,this.config.bond_line=Math.max(this.config.bond_line,.1),this.redraw_models(),this.hud("bond width: "+t(this.config.bond_line,this.window_size).toFixed(1)));break;case 16:case 17:case 18:case 225:break;case 32:this.center_next_residue(e.shiftKey);break;default:this.help_el&&this.hud("Nothing here. Press H for help.")}this.request_render()},c.prototype.mousedown=function(e){e.stopPropagation();var t=v.NONE;1===e.button||0===e.button&&e.ctrlKey?t=v.PAN:0===e.button?(e.shiftKey&&this.dblclick(e),t=v.ROTATE):2===e.button&&(t=e.ctrlKey?e.shiftKey?v.ROLL:v.SLAB:v.ZOOM),this.controls.start(t,this.relX(e),this.relY(e)),document.addEventListener("mousemove",this.mousemove),document.addEventListener("mouseup",this.mouseup),this.request_render()},c.prototype.dblclick=function(e){if(0===e.button){this.decor.selection&&(this.scene.remove(this.decor.selection),this.decor.selection=null);var t,i=new THREE.Vector2(this.relX(e),this.relY(e));null!==this.active_model_bag&&(t=this.active_model_bag.pick_atom(r(i,this.camera))),t?(this.hud(t.long_label()),this.set_selection(t)):this.hud(),this.request_render()}},c.prototype.set_selection=function(e){var t=new THREE.Geometry;t.vertices.push(new THREE.Vector3(e.xyz[0],e.xyz[1],e.xyz[2]));var r=this.config.colors[e.element]||this.config.colors.def,i=new THREE.PointsMaterial({size:3,color:r});this.decor.selection=new THREE.Points(t,i),this.scene.add(this.decor.selection)},c.prototype.touchstart=function(e){var t=e.touches;if(1===t.length)this.controls.start(v.ROTATE,this.relX(t[0]),this.relY(t[0]));else{var r=d(e);this.controls.start(v.PAN_ZOOM,this.relX(r),this.relY(r),r.dist)}this.request_render()},c.prototype.touchmove=function(e){e.preventDefault(),e.stopPropagation();var t=e.touches;if(1===t.length)this.controls.move(this.relX(t[0]),this.relY(t[0]));else{var r=d(e);this.controls.move(this.relX(r),this.relY(r),r.dist)}},c.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},c.prototype.mousewheel=function(e){e.preventDefault(),e.stopPropagation();var t=e.wheelDelta?e.wheelDelta/2e3:(e.detail||0)/-1e3;this.change_isolevel_by(e.shiftKey?1:0,t),this.request_render()},c.prototype.resize=function(){var e=this.container,t=e.clientWidth,r=e.clientHeight;this.window_offset[0]=e.offsetLeft,this.window_offset[1]=e.offsetTop,this.camera.left=-t,this.camera.right=t,this.camera.top=r,this.camera.bottom=-r,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,r),t===this.window_size[0]&&r===this.window_size[1]||(this.window_size[0]=t,this.window_size[1]=r,this.redraw_models()),this.request_render()},c.prototype.recenter=function(e,t,r){var i,o=null;if(null!=e&&null!=t||(i=this.active_model_bag.model.get_center()),t&&(t=new THREE.Vector3(t[0],t[1],t[2])),null==e){if(null===this.active_model_bag)return;e=new THREE.Vector3(i[0],i[1],i[2]),t||(t=e.clone(),t.z+=100,o=THREE.Object3D.DefaultUp)}else if(e=new THREE.Vector3(e[0],e[1],e[2]),null==t&&null!==this.active_model_bag){t=new THREE.Vector3(i[0],i[1],i[2]),t.sub(e).negate().setLength(100),o=new THREE.Vector3(0,1,0).projectOnPlane(t);var n=o.length();n<.1&&(o.set(1,0,0).projectOnPlane(t),n=o.length()),o.divideScalar(n),t.add(e)}this.controls.go_to(e,t,o,r)},c.prototype.center_next_residue=function(e){if(this.active_model_bag){var t=this.active_model_bag.model.next_residue(this.selected_atom,e);t&&(this.hud("-> "+t.long_label()),this.controls.go_to(new THREE.Vector3(t.xyz[0],t.xyz[1],t.xyz[2]),null,null,30/g),this.selected_atom=t)}},c.prototype.update_camera=function(){var e=this.camera.position.distanceTo(this.target),t=.25*this.controls.slab_width()/this.camera.zoom;this.camera.near=e*(1-t),this.camera.far=e*(1+3*t),this.camera.updateProjectionMatrix()},c.prototype.render=function(){null!==this.renderer&&(this.controls.update()&&this.update_camera(),this.controls.is_going()||this.redraw_maps(),this.renderer.render(this.scene,this.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update())},c.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},c.prototype.set_model=function(e){var t=new h(e,this.config,this.window_size);this.model_bags.push(t),this.set_atomic_objects(t),this.active_model_bag=t,this.request_render()},c.prototype.add_map=function(e,t){var r=new l(e,t);this.map_bags.push(r),this.add_el_objects(r),this.request_render()},c.prototype.load_file=function(e,t,r,i){if(null!==this.renderer){var o=new XMLHttpRequest;o.open("GET",e,!0),t?o.responseType="arraybuffer":o.overrideMimeType("text/plain");var n=this;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status&&null!==o.response)try{r(o)}catch(t){n.hud("Error: "+t.message+"\nin "+e,"ERR")}else n.hud("Failed to fetch "+e,"ERR")},i&&o.addEventListener("progress",function(t){if(t.lengthComputable){var r=e.split("/").pop();n.hud("loading "+r+" ... "+(t.loaded>>10)+" / "+(t.total>>10)+" kB")}});try{o.send(null)}catch(t){n.hud("loading "+e+" failed:\n"+t,"ERR")}}},c.prototype.load_pdb=function(e,t){t=t||{};var r=this;this.load_file(e,!1,function(e){var i=new Model;i.from_pdb(e.responseText),r.set_model(i);var o=f();o.zoom&&(r.camera.zoom=o.zoom),r.recenter(t.center||o.xyz,o.eye,1),t.callback&&t.callback()})},c.prototype.load_map=function(e,t,r,i,o){if("ccp4"!==r&&"dsn6"!==r)throw Error("Unknown map filetype.");var n=this;this.load_file(e,!0,function(e){var o=new ElMap;"ccp4"===r?o.from_ccp4(e.response):o.from_dsn6(e.response),n.add_map(o,t),i&&i()},o)},c.prototype.load_ccp4_maps=function(e,t,r){var i=this;this.load_map(e,!1,"ccp4",function(){i.load_map(t,!0,"ccp4",function(){i.hud(),r&&r()},!0)},!0)},c.ColorSchemes=_,c.auto_speed=g,c}();"undefined"!=typeof module&&(module.exports={VERSION:UGLYMOL_VERSION,UnitCell:UnitCell,Model:Model,ElMap:ElMap,isosurface:isosurface,Viewer:Viewer});