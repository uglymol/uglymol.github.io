!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(e.UM=e.UM||{},e.THREE)}(this,function(e,t){"use strict";function r(e,t,r,i,o,n){function s(e,t){var r=e[0],i=e[1],o=e[2];return[t[0]*r+t[1]*i+t[2]*o,t[4]*i+t[5]*o,t[8]*o]}if(e<=0||t<=0||r<=0||i<=0||o<=0||n<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[e,t,r,i,o,n];var a=Math.PI/180,l=Math.cos(a*i),h=Math.cos(a*o),c=Math.cos(a*n),d=Math.sin(a*i),u=Math.sin(a*o),f=Math.sin(a*n);if(0===d||0===u||0===f)throw Error("Impossible angle - N*180deg.");var m=(h*c-l)/f,p=m/u,_=Math.sqrt(1-p*p),v=[e,t*c,r*h,0,t*f,-r*m,0,0,r*u*_],g=[1/e,-c/(f*e),-(c*m+h*f)/(u*_*f*e),0,1/(f*t),p/(_*f*t),0,0,1/(u*_*r)];this.fractionalize=function(e){return s(e,g)},this.orthogonalize=function(e){return s(e,v)}}function i(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=null,this.upper_bound=null}function o(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=null,this.resseq=null,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.charge=0,this.i_seq=null,this.is_ligand=null,this.bonds=[]}function n(e,t,r,i){var o;this.boxes=[],this.xdim=Math.ceil((i[0]-r[0])/t),this.ydim=Math.ceil((i[1]-r[1])/t),this.zdim=Math.ceil((i[2]-r[2])/t);var n=this.xdim*this.ydim*this.zdim;for(o=0;o<n;o++)this.boxes.push([]);for(this.find_box_id=function(e,i,o){var n=Math.floor((e-r[0])/t),s=Math.floor((i-r[1])/t),a=Math.floor((o-r[2])/t),l=(a*this.ydim+s)*this.xdim+n;return l>=0&&l<this.boxes.length?l:null},o=0;o<e.length;o++){var s=e[o].xyz,a=this.find_box_id(s[0],s[1],s[2]);if(null===a)throw Error("wrong cubicle");this.boxes[a].push(o)}}function s(e,t,r){if(e[0]<=0||e[1]<=0||e[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var i=e[0]*e[1]*e[2];if(t.length!==i||r.length!==i)throw Error("isosurface: array size mismatch")}function a(e){for(var t=[],r=0;r<8;++r){var i=D[r];t.push(i[0]+e[2]*(i[1]+e[1]*i[2]))}return t}function l(e,t,r,i,o){for(var n="snapped MC"===o,s="squarish"===o?Y:G,l=new Array(12),h=a(e),c=new Float32Array(8),d=[null,null,null,null,null,null,null,null],u=e[0],f=e[1],m=e[2],p=[],_=[],v=0,g=0;g<u-1;g++)for(var b=0;b<f-1;b++)for(var y=0;y<m-1;y++){var w,x,z=y+m*(b+f*g),A=0;for(w=0;w<8;++w)x=z+h[w],A|=t[x]<i?1<<w:0;if(0!==A&&255!==A){for(w=0;w<8;++w)x=z+h[w],c[w]=t[x],d[w]=r[x];var M=U[A];for(w=0;w<12;++w)if(0!==(M&1<<w)){var k=I[w],E=(i-c[k[0]])/(c[k[1]]-c[k[0]]);n===!0&&(E>.85?E=1:E<.15&&(E=0));var C=d[k[0]],O=d[k[1]];p.push(C[0]+(O[0]-C[0])*E,C[1]+(O[1]-C[1])*E,C[2]+(O[2]-C[2])*E),l[w]=v++}var L=s[A];for(w=0;w<L.length;w++)_.push(l[L[w]])}}return{vertices:p,segments:_}}function h(e,t,r,i,o){return s(e,t,r),l(e,t,r,i,o)}function c(e){this.dim=e,this.values=new Float32Array(e[0]*e[1]*e[2])}function d(e,t){var r=e%t;return r>=0?r:r+t}function u(){this.unit_cell=null,this.grid=null,this.mean=0,this.rms=1}function f(e){var t=e.toLowerCase().replace(/\s+/g,"").split(",");if(3!==t.length)throw Error("Unexpected symop: "+e);for(var r=[],i=0;i<3;i++){for(var o=t[i].split(/(?=[+-])/),n=[0,0,0,0],s=0;s<o.length;s++){var a=o[s],l="-"===a[0]?-1:1,h=o[s].match(/^[+-]?([xyz])$/);if(h){var c={x:0,y:1,z:2}[h[1]];n[c]=l}else{if(h=o[s].match(/^[+-]?(\d)\/(\d)$/),!h)throw Error("What is "+o[s]+" in "+e);n[3]=l*Number(h[1])/Number(h[2])}}r.push(n)}return r}function m(e,r){var i,o=e.length,n=[];for(i=0;i<o;i++){var s=e[i];n.push(s.x,s.y,s.z),n.push(s.x,s.y,s.z)}var a=new Float32Array(n),l=new Float32Array(6*o);for(i=0;i<6;i++)l[i]=n[i];for(;i<6*o;i++)l[i]=n[i-6];var h=new Float32Array(6*o);for(i=0;i<6*(o-1);i++)h[i]=n[i+6];for(;i<6*o;i++)h[i]=n[i];var c=new Float32Array(2*o);for(i=0;i<o;i++)c[2*i]=1,c[2*i+1]=-1;var d=new Float32Array(6*o);for(i=0;i<o;i++){var u=r[i];d[6*i]=u.r,d[6*i+1]=u.g,d[6*i+2]=u.b,d[6*i+3]=u.r,d[6*i+4]=u.g,d[6*i+5]=u.b}var f=new t.BufferGeometry;return f.addAttribute("position",new t.BufferAttribute(a,3)),f.addAttribute("previous",new t.BufferAttribute(l,3)),f.addAttribute("next",new t.BufferAttribute(h,3)),f.addAttribute("side",new t.BufferAttribute(c,1)),f.addAttribute("color",new t.BufferAttribute(d,3)),f}function p(e,r){var i,o,n=e.length,s=[];for(i=0;i<n;i++){var a=e[i];s.push(a.x,a.y,a.z),s.push(a.x,a.y,a.z)}var l=new Float32Array(s),h=new Float32Array(6*n);for(i=0;i<6*n;i+=12){for(o=0;o<6;o++)h[i+o]=s[i+o+6];for(;o<12;o++)h[i+o]=s[i+o-6]}var c=new Float32Array(2*n);for(i=0;i<n;i++)c[2*i]=-1,c[2*i+1]=1;var d=new Float32Array(6*n);for(i=0;i<n;i++){var u=r[i];d[6*i]=u.r,d[6*i+1]=u.g,d[6*i+2]=u.b,d[6*i+3]=u.r,d[6*i+4]=u.g,d[6*i+5]=u.b}var f=2*n<65536?new Uint16Array(3*n):new Uint32Array(3*n),m=[0,1,2,0,2,3];for(i=0;i<n/2;i++)for(o=0;o<6;o++)f[6*i+o]=4*i+m[o];var p=new t.BufferGeometry;return p.addAttribute("position",new t.BufferAttribute(l,3)),p.addAttribute("other",new t.BufferAttribute(h,3)),p.addAttribute("side",new t.BufferAttribute(c,1)),p.addAttribute("color",new t.BufferAttribute(d,3)),p.setIndex(new t.BufferAttribute(f,1)),p}function _(e,r){for(var i=[],o=0;o<e.length;o++){var n=e[o].xyz;i.push(new t.Vector3(n[0],n[1],n[2]))}if(!r||r<2)return i;var s=new t.CatmullRomCurve3(i);return s.getPoints((e.length-1)*r)}function v(e,t){if(!t||t<2)return e;for(var r=[],i=0;i<e.length-1;i++)for(var o=0;o<t;o++)r.push(e[i]);return r.push(e[e.length-1]),r}function g(e,t){t=t||1;var r,i=[];for(r=0;r<e.length-1;r++)for(var o=e[r],n=e[r+1],s=0;s<t;s++){var a=s/t,l=1-a;i.push(l*o[0]+a*n[0],l*o[1]+a*n[1],l*o[2]+a*n[2])}return i.push(e[r][0],e[r][1],e[r][2]),i}function b(e){var t={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var r in e)t[r]={value:e[r]};return t}function y(e,r,i){this.use_gl_lines=e,e?(void 0===r.color&&(r.vertexColors=t.VertexColors),delete r.size,this.material=new t.LineBasicMaterial(r)):this.material=new t.ShaderMaterial({uniforms:b(r),vertexShader:i?X:K,fragmentShader:W,fog:!0,vertexColors:t.VertexColors})}function w(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r];t[3*r]=i.r,t[3*r+1]=i.g,t[3*r+2]=i.b}return t}function x(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r];t[3*r]=i.x,t[3*r+1]=i.y,t[3*r+2]=i.z}return t}function z(e){for(var t=new Float32Array(3*e.length),r=0;r<e.length;r++){var i=e[r].xyz;t[3*r]=i[0],t[3*r+1]=i[1],t[3*r+2]=i[2]}return t}function A(e,r){var i=e.linePrecision*e.linePrecision;te.getInverse(this.matrixWorld),re.copy(e.ray).applyMatrix4(te);for(var o=new t.Vector3,n=new t.Vector3,s=new t.Vector3,a=new t.Vector3,l=this.drawMode===t.TriangleStripDrawMode?1:2,h=this.geometry.attributes.position.array,c=0,d=h.length/6-1;c<d;c+=l){o.fromArray(h,6*c),n.fromArray(h,6*c+6);var u=re.distanceSqToSegment(o,n,a,s);if(!(u>i)){a.applyMatrix4(this.matrixWorld);var f=e.ray.origin.distanceTo(a);f<e.near||f>e.far||r.push({distance:f,point:s.clone().applyMatrix4(this.matrixWorld),index:c,object:this})}}}function M(e,t){var r=0,i=e*e+t*t;if(i<1)r=Math.sqrt(1-i);else{var o=Math.sqrt(i);e/=o,t/=o}return[e,t,r]}function k(e,t){return e*t[1]/700}function E(e,r){return void 0===ee&&(ee=new t.Raycaster),ee.setFromCamera(e,r),ee.near=r.near,ee.far=r.far-.2*(r.far-r.near),ee.linePrecision=.2,ee}function C(e,r,i){for(var o=new t.Geometry,n=0;n<le.length;n++){var s=le[n],a=r.x+e*(s[0]-.5),l=r.y+e*(s[1]-.5),h=r.z+e*(s[2]-.5);o.vertices.push(new t.Vector3(a,l,h))}var c=new t.LineBasicMaterial({color:i,linewidth:2});return new t.LineSegments(o,c)}function O(e,r){if(!e)throw Error("Unit cell not defined!");for(var i=new t.Geometry,o=0;o<le.length;o++){var n=e.orthogonalize(le[o]);i.vertices.push(new t.Vector3(n[0],n[1],n[2]))}i.colors.push(new t.Color(16711680),new t.Color(16755200),new t.Color(65280),new t.Color(11206400),new t.Color(255),new t.Color(43775));for(var s=6;s<le.length;s++)i.colors.push(r);var a=new t.LineBasicMaterial({vertexColors:t.VertexColors});return new t.LineSegments(i,a)}function L(e,r,i){var o=new t.Color(14737632);if(r<i){var n=(e-r)/(i-r),s=(240-240*n)/360;o.setHSL(s,1,.5)}return o}function F(e,t,r){var i,o,n=t[t.length-1];if("index"===e)i=function(e){return L(e.i_seq,0,n.i_seq)};else if("B-factor"===e){var s=1/0,a=-(1/0);for(o=0;o<t.length;o++){var l=t[o].b;l>a&&(a=l),l<s&&(s=l)}i=function(e){return L(e.b,s,a)}}else i="occupancy"===e?function(e){return L(e.occ,0,1)}:"chain"===e?function(e){return L(e.chain_index,0,n.chain_index)}:function(e){return r[e.element]||r.def};var h=[];for(o=0;o<t.length;o++)h.push(i(t[o]));return h}function S(e,r,i){var o=r.xyz,n=.7;e.vertices.push(new t.Vector3(o[0]-n,o[1],o[2])),e.vertices.push(new t.Vector3(o[0]+n,o[1],o[2])),e.vertices.push(new t.Vector3(o[0],o[1]-n,o[2])),e.vertices.push(new t.Vector3(o[0],o[1]+n,o[2])),e.vertices.push(new t.Vector3(o[0],o[1],o[2]-n)),e.vertices.push(new t.Vector3(o[0],o[1],o[2]+n));for(var s=0;s<6;s++)e.colors.push(i)}function T(e,r){this.map=e,this.name="",this.isolevel=r?3:1.5,this.visible=!0,this.types=r?["map_pos","map_neg"]:["map_den"],this.block_ctr=new t.Vector3(1/0,0,0),this.el_objects=[]}function j(e,t,r){this.model=e,this.name="",this.visible=!0,this.conf=t,this.win_size=r,this.atomic_objects=null}function V(e){function r(t){return null===e[t]?null:document.getElementById(e[t]||t)}if(this.config={bond_line:4,map_line:1.25,map_radius:10,map_style:de[0],render_style:ce[0],color_aim:he[0],colors:oe[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null},this.nav=null,this.last_ctr=new t.Vector3(1/0,0,0),this.selected_atom=null,this.active_model_bag=null,this.scene=new t.Scene,this.scene.fog=new t.Fog(this.config.colors.bg,0,1),this.light=new t.AmbientLight(16777215),this.scene.add(this.light),e.share_view?(this.target=e.share_view.target,this.camera=e.share_view.camera,this.controls=e.share_view.controls,this.tied_viewer=e.share_view,this.tied_viewer.tied_viewer=this):(this.target=new t.Vector3,this.camera=new t.OrthographicCamera,this.controls=new ae(this.camera,this.target)),"undefined"!=typeof document){try{this.renderer=new t.WebGLRenderer({antialias:!0})}catch(e){return this.hud("no WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=r("viewer"),this.hud_el=r("hud"),this.help_el=r("help"),this.hud_el&&(this.initial_hud_html=this.hud_el.innerHTML,this.initial_hud_bg=this.hud_el.style["background-color"]),null!==this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.container.appendChild(this.renderer.domElement),e.focusable&&(this.renderer.domElement.tabIndex=0),window.Stats&&(this.stats=new window.Stats,this.container.appendChild(this.stats.dom)),window.addEventListener("resize",this.resize.bind(this));var i=this.renderer.domElement,o=e.focusable?i:window;o.addEventListener("keydown",this.keydown.bind(this)),i.addEventListener("contextmenu",function(e){e.preventDefault()}),i.addEventListener("mousewheel",this.mousewheel.bind(this)),i.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),i.addEventListener("mousedown",this.mousedown.bind(this)),i.addEventListener("touchstart",this.touchstart.bind(this)),i.addEventListener("touchmove",this.touchmove.bind(this)),i.addEventListener("touchend",this.touchend.bind(this)),i.addEventListener("touchcancel",this.touchend.bind(this)),i.addEventListener("dblclick",this.dblclick.bind(this));var n=this;this.mousemove=function(e){e.preventDefault(),n.controls.move(n.relX(e),n.relY(e))},this.mouseup=function(e){e.preventDefault(),e.stopPropagation(),n.controls.stop(n.active_model_bag),document.removeEventListener("mousemove",n.mousemove),document.removeEventListener("mouseup",n.mouseup),n.redraw_maps()},this.scheduled=!1,this.request_render()}}}function q(e,t,r){return e.x.toFixed(t)+r+e.y.toFixed(t)+r+e.z.toFixed(t)}function P(e){var t=e.touches,r=t[0].pageX-t[1].pageX,i=t[0].pageY-t[1].pageY;return{pageX:(t[0].pageX+t[1].pageX)/2,pageY:(t[0].pageY+t[1].pageY)/2,dist:Math.sqrt(r*r+i*i)}}function R(){var e={};if("undefined"==typeof window)return e;for(var t=window.location.hash.substr(1).split("&"),r=0;r<t.length;r++){var i=t[r].split("="),o=i[1];"xyz"===i[0]||"eye"===i[0]?o=o.split(",").map(Number):"zoom"===i[0]&&(o=Number(o)),e[i[0]]=o}return e}e.VERSION="0.5.0";var N=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],B=["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"],H=["HOH"].concat(N,B);i.prototype.from_pdb=function(e){for(var t=e.split("\n"),i=0,n=null,s=0,a=0;a<t.length;a++){var l=t[a],h=l.substring(0,6);if("ATOM  "===h||"HETATM"===h){var c=new o;c.from_pdb_line(l),c.i_seq=s++,this.has_hydrogens||"H"!==c.element||(this.has_hydrogens=!0),c.chain!==n&&i++,c.chain_index=i,n=c.chain,this.atoms.push(c)}else if("ANISOU"===h);else if("CRYST1"===h){var d=parseFloat(l.substring(6,15)),u=parseFloat(l.substring(15,24)),f=parseFloat(l.substring(24,33)),m=parseFloat(l.substring(33,40)),p=parseFloat(l.substring(40,47)),_=parseFloat(l.substring(47,54));this.unit_cell=new r(d,u,f,m,p,_)}else"TER"===h.substring(0,3)&&(n=null)}if(0===this.atoms.length)throw Error("No atom records found.");this.calculate_bounds(),this.calculate_connectivity()},i.prototype.calculate_bounds=function(){for(var e=this.lower_bound=[1/0,1/0,1/0],t=this.upper_bound=[-(1/0),-(1/0),-(1/0)],r=0;r<this.atoms.length;r++)for(var i=this.atoms[r],o=0;o<3;o++){var n=i.xyz[o];n<e[o]&&(e[o]=n),n>t[o]&&(t[o]=n)}for(var s=0;s<3;++s)e[s]-=.001,t[s]+=.001},i.prototype.next_residue=function(e,t){for(var r=this.atoms.length,i=(e?e.i_seq:0)+r,o=e?1:0;o<r;o++){var n=(i+(t?-o:o))%r,s=this.atoms[n];if(s.is_main_conformer()&&("CA"===s.name&&"C"===s.element||"P"===s.name))return s}},i.prototype.extract_trace=function(){for(var e=[],t=[],r=null,i=0;i<this.atoms.length;i++){var o=this.atoms[i];if((""===o.altloc||"A"===o.altloc)&&("CA"===o.name&&"C"===o.element||"P"===o.name)){var n=!0;if(null!==r&&r.chain_index===o.chain_index){var s=o.distance_sq(r);("CA"===o.name&&s<=30.25||"P"===o.name&&s<56.25)&&(t.push(o),n=!1)}n&&(t.length>2&&e.push(t),t=[o]),r=o}}return t.length>2&&e.push(t),e},i.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var e={},t=0;t<this.atoms.length;t++){var r=this.atoms[t],i=r.resid(),o=e[i];void 0===o?e[i]=[r]:o.push(r)}return this.residue_map=e,e},i.prototype.calculate_tangent_vector=function(e){for(var t=null,r=null,i=3===e[0].resname.length,o=i?"C":"C2'",n=i?"O":"O4'",s=0;s<e.length;s++){var a=e[s];a.is_main_conformer()&&(a.name===o?t=a.xyz:a.name===n&&(r=a.xyz))}if(null===t||null===r)return[0,0,1];var l=[t[0]-r[0],t[1]-r[1],t[2]-r[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},i.prototype.get_center=function(){for(var e=0,t=0,r=0,i=this.atoms.length,o=0;o<i;o++){var n=this.atoms[o].xyz;e+=n[0],t+=n[1],r+=n[2]}return[e/i,t/i,r/i]},o.prototype.from_pdb_line=function(e){if(e.length<66)throw Error("ATOM or HETATM record is too short: "+e);var t=e.substring(0,6);if("HETATM"===t)this.hetero=!0;else if("ATOM  "!==t)throw Error("Wrong record type: "+t);this.name=e.substring(12,16).trim(),this.altloc=e.substring(16,17).trim(),this.resname=e.substring(17,20).trim(),this.chain=e.substring(20,22).trim(),this.resseq=parseInt(e.substring(22,26),10),this.icode=e.substring(26,27).trim();var r=parseFloat(e.substring(30,38)),i=parseFloat(e.substring(38,46)),o=parseFloat(e.substring(46,54));this.xyz=[r,i,o],this.occ=parseFloat(e.substring(54,60)),this.b=parseFloat(e.substring(60,66)),e.length>=78&&(this.element=e.substring(76,78).trim().toUpperCase()),e.length>=80&&(this.charge=e.substring(78,80).trim()),this.is_ligand=H.indexOf(this.resname)===-1},o.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},o.prototype.distance_sq=function(e){var t=this.xyz[0]-e.xyz[0],r=this.xyz[1]-e.xyz[1],i=this.xyz[2]-e.xyz[2];return t*t+r*r+i*i},o.prototype.distance=function(e){return Math.sqrt(this.distance_sq(e))},o.prototype.midpoint=function(e){return[(this.xyz[0]+e.xyz[0])/2,(this.xyz[1]+e.xyz[1])/2,(this.xyz[2]+e.xyz[2])/2]},o.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},o.prototype.is_s_or_p=function(){return"S"===this.element||"P"===this.element},o.prototype.is_ion=function(){return this.element===this.resname},o.prototype.is_water=function(){return"HOH"===this.resname},o.prototype.is_same_residue=function(e,t){return e.resseq===this.resseq&&e.icode===this.icode&&e.chain===this.chain&&e.resname===this.resname&&(t||e.altloc===this.altloc)},o.prototype.is_same_conformer=function(e){return""===this.altloc||""===e.altloc||this.altloc===e.altloc},o.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},o.prototype.is_bonded_to=function(e){var t=3.9601,r=1.3*1.3,i=2.2*2.2;if(!this.is_same_conformer(e))return!1;if("H"===this.element&&"H"===e.element)return!1;var o=this.distance_sq(e);return!(o>i)&&("H"===this.element||"H"===e.element?o<=r:o<=t||this.is_s_or_p()||e.is_s_or_p())},o.prototype.resid=function(){return this.resseq+"/"+this.chain},o.prototype.long_label=function(){var e=this;return e.name+" /"+e.resseq+" "+e.resname+"/"+e.chain+" - occ: "+e.occ.toFixed(2)+" bf: "+e.b.toFixed(2)+" ele: "+e.element+" pos: ("+e.xyz[0].toFixed(2)+","+e.xyz[1].toFixed(2)+","+e.xyz[2].toFixed(2)+")"},n.prototype.get_nearby_atoms=function(e){var t=[],r=this.xdim*this.ydim,i=Math.max(e%r,0),o=Math.max(i%this.xdim,0),n=Math.floor(i/this.xdim),s=Math.floor(e/r);console.assert(s*r+n*this.xdim+o===e);for(var a=o-1;a<=o+1;a++)if(!(a<0||a>=this.xdim))for(var l=n-1;l<=n+1;l++)if(!(l<0||l>=this.ydim))for(var h=s-1;h<=s+1;h++)if(!(h<0||h>=this.zdim)){var c=h*r+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var d=this.boxes[c],u=0;u<d.length;u++)t.push(d[u])}return t},i.prototype.calculate_connectivity=function(){for(var e=this.atoms,t=new n(e,3,this.lower_bound,this.upper_bound),r=0;r<t.boxes.length;r++){var i=t.boxes[r];if(0!==i.length)for(var o=t.get_nearby_atoms(r),s=0;s<i.length;s++)for(var a=i[s],l=0;l<o.length;l++){var h=o[l];h>a&&e[a].is_bonded_to(e[h])&&(e[a].bonds.push(h),e[h].bonds.push(a))}}this.cubes=t},i.prototype.get_nearest_atom=function(e,t,r,i){for(var o=this.cubes.find_box_id(e,t,r),n=this.cubes.get_nearby_atoms(o),s=null,a=1/0,l=0;l<n.length;l++){var h=this.atoms[n[l]];if(void 0===i||null===i||i===h.name){var c=h.xyz[0]-e,d=h.xyz[1]-t,u=h.xyz[2]-r,f=c*c+d*d+u*u;f<a&&(s=h,a=f)}}return s};var U=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),G=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],Y=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],D=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],I=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];c.prototype.grid2index=function(e,t,r){return e=d(e,this.dim[0]),t=d(t,this.dim[1]),r=d(r,this.dim[2]),this.dim[2]*(this.dim[1]*e+t)+r},c.prototype.grid2frac=function(e,t,r){return[e/this.dim[0],t/this.dim[1],r/this.dim[2]]},c.prototype.frac2grid=function(e){return[0|Math.floor(e[0]*this.dim[0]),0|Math.floor(e[1]*this.dim[1]),0|Math.floor(e[2]*this.dim[2])]},c.prototype.set_grid_value=function(e,t,r,i){var o=this.grid2index(e,t,r);this.values[o]=i},c.prototype.get_grid_value=function(e,t,r){var i=this.grid2index(e,t,r);return this.values[i]},u.prototype.calculate_stddev=function(e,t){for(var r=0,i=0,o=e.length,n=t;n<o;n++)r+=e[n],i+=e[n]*e[n];var s=r/(o-t),a=i/(o-t)-s*s;this.mean=s,this.rms=Math.sqrt(a)},u.prototype.abs_level=function(e){return e*this.rms+this.mean},u.prototype.from_ccp4=function(e,t){if(void 0===t&&(t=!0),e.byteLength<1024)throw Error("File shorter than 1024 bytes.");var i=new Int32Array(e,0,256);if(542130509!==i[52])throw Error("not a CCP4 map");var o=[i[0],i[1],i[2]];this.mode=i[3];var n;if(2===this.mode)n=4;else{if(0!==this.mode)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");n=1}var s=[i[4],i[5],i[6]],a=[i[7],i[8],i[9]],l=i[23];if(1024+l+n*o[0]*o[1]*o[2]!==e.byteLength)throw Error("ccp4 file too short or too long");var h=new Float32Array(e,0,e.byteLength>>2);this.unit_cell=new r(h[10],h[11],h[12],h[13],h[14],h[15]);var d=[i[16],i[17],i[18]],u=d.indexOf(1),m=d.indexOf(2),p=d.indexOf(3);if(this.min=h[19],this.max=h[20],this.sg_number=i[22],this.lskflg=i[24],this.grid=new c(a),l%4!==0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");var _;_=2===this.mode?h:new Int8Array(e);var v=(1024+l)/n|0;this.mean=h[21],this.rms=h[54],(this.mean<this.min||this.mean>this.max||this.rms<=0)&&this.calculate_stddev(_,v);var g=1,b=0;0===this.mode&&i[39]===-128&&127===i[40]&&(g=(this.max-this.min)/255,b=.5*(this.min+this.max+g));var y=[s[0]+o[0],s[1]+o[1],s[2]+o[2]],w=[0,0,0];for(w[2]=s[2];w[2]<y[2];w[2]++)for(w[1]=s[1];w[1]<y[1];w[1]++)for(w[0]=s[0];w[0]<y[0];w[0]++)this.grid.set_grid_value(w[u],w[m],w[p],g*_[v]+b),
v++;if(t&&l>0)for(var x=new Uint8Array(e),z=0;z+80<=l;z+=80){var A,M="";for(A=0;A<80;++A)M+=String.fromCharCode(x[1024+z+A]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(M)){var k=f(M);for(A=0;A<3;++A)k[A][3]=0|Math.round(k[A][3]*a[A]);v=(1024+l)/n|0;var E=[0,0,0];for(w[2]=s[2];w[2]<y[2];w[2]++)for(w[1]=s[1];w[1]<y[1];w[1]++)for(w[0]=s[0];w[0]<y[0];w[0]++){for(A=0;A<3;++A)E[A]=w[u]*k[A][0]+w[m]*k[A][1]+w[p]*k[A][2]+k[A][3];this.grid.set_grid_value(E[0],E[1],E[2],g*_[v]+b),v++}}}},u.prototype.from_dsn6=function(e){var t=new Uint8Array(e),i=new Int16Array(t.buffer);if(100!==i[18])for(var o=i.length,n=0;n<o;n++){var s=i[n];i[n]=(255&s)<<8|s>>8&255}if(100!==i[18])throw Error("Endian swap failed");var a=[i[0],i[1],i[2]],l=[i[3],i[4],i[5]],h=[i[6],i[7],i[8]],d=1/i[17];this.unit_cell=new r(d*i[9],d*i[10],d*i[11],d*i[12],d*i[13],d*i[14]),this.grid=new c(h);for(var u=i[15]/100,f=i[16],m=512,p=[Math.ceil(l[0]/8),Math.ceil(l[1]/8),Math.ceil(l[2]/8)],_=0;_<p[2];_++)for(var v=0;v<p[1];v++)for(var g=0;g<p[0];g++)for(var b=0;b<8;b++)for(var y=8*_+b,w=0;w<8;w++)for(var x=8*v+w,z=0;z<8;z++){var A=8*g+z;if(!(A<l[0]&&x<l[1]&&y<l[2])){m+=8-z;break}var M=(t[m]-f)/u;m++,this.grid.set_grid_value(a[0]+A,a[1]+x,a[2]+y,M)}this.calculate_stddev(this.grid.values,0)},u.prototype.show_debug_info=function(){console.log("unit cell: "+this.unit_cell.parameters.join(", ")),console.log("grid: "+this.grid.dim)},u.prototype.extract_block=function(e,t){var r=this.grid,i=this.unit_cell,o=[0,0,0],n=r.dim;if(t){var s=[t[0]-e,t[1]-e,t[2]-e],a=[t[0]+e,t[1]+e,t[2]+e],l=i.fractionalize(s),h=i.fractionalize(a);o=r.frac2grid(l),n=r.frac2grid(h)}for(var c=n[0]-o[0]+1,d=n[1]-o[1]+1,u=n[2]-o[2]+1,f=[],m=[],p=o[0];p<=n[0];p++)for(var _=o[1];_<=n[1];_++)for(var v=o[2];v<=n[2];v++){var g=r.grid2frac(p,_,v),b=i.orthogonalize(g);f.push(b);var y=r.get_grid_value(p,_,v);m.push(y)}this.block={points:f,values:m,size:[c,d,u]}},u.prototype.isomesh_in_block=function(e,t){var r=this.abs_level(e),i=this.block;return h(i.size,i.values,i.points,r,t)};var K=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / size;","}"].join("\n"),X=["attribute vec3 other;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / size;","}"].join("\n"),W=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");y.prototype.make_line=function(e,r,i){var o=_(e,i),n=v(r,i);if(this.use_gl_lines){var s=new t.BufferGeometry,a=x(o);s.addAttribute("position",new t.BufferAttribute(a,3));var l=w(n);return s.addAttribute("color",new t.BufferAttribute(l,3)),new t.Line(s,this.material)}var h=new t.Mesh(m(o,n),this.material);return h.drawMode=t.TriangleStripDrawMode,h.raycast=A,h};var Z=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),Q=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");y.make_ribbon=function(e,r,i,o){var n=_(e,o),s=v(r,o),a=g(i,o),l=new t.Object3D,h=new t.BufferGeometry,c=x(n);h.addAttribute("position",new t.BufferAttribute(c,3));var d=w(s);h.addAttribute("color",new t.BufferAttribute(d,3));var u=new Float32Array(a);h.addAttribute("normal",new t.BufferAttribute(u,3));for(var f=new t.ShaderMaterial({uniforms:b({shift:0}),vertexShader:Z,fragmentShader:Q,fog:!0,vertexColors:t.VertexColors}),m=-4;m<5;m++){var p=0===m?f:f.clone();p.uniforms.shift.value=.1*m,l.add(new t.Line(h,p))}return l},y.prototype.make_line_segments=function(e){if(this.use_gl_lines)return new t.LineSegments(e,this.material);var r=e.vertices,i=e.colors,o=new t.Mesh(p(r,i),this.material);return o.raycast=A,o},y.make_chickenwire=function(e,r){var i=new t.BufferGeometry,o=new Float32Array(e.vertices);i.addAttribute("position",new t.BufferAttribute(o,3));var n=e.vertices.length<196608?new Uint16Array(e.segments):new Uint32Array(e.segments);i.setIndex(new t.BufferAttribute(n,1));var s=new t.LineBasicMaterial(r);return new t.LineSegments(i,s)};var $=["uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = linewidth;","}"].join("\n"),J=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");y.prototype.make_caps=function(e,r){var i=z(e),o=w(r),n=new t.BufferGeometry;n.addAttribute("position",new t.BufferAttribute(i,3)),n.addAttribute("color",new t.BufferAttribute(o,3));var s=new t.ShaderMaterial({uniforms:this.material.uniforms,vertexShader:$,fragmentShader:J,fog:!0,vertexColors:t.VertexColors});return new t.Points(n,s)},y.prototype.make_balls=function(e,t,r){var i=this.make_caps(e,t);return i.material.vertexShader=i.material.vertexShader.replace("= linewidth","="+r.toFixed(4)),i};var ee,te=new t.Matrix4,re=new t.Ray,ie=!1,oe=[{name:"coot dark",bg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,cell_box:16777215,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,cell_box:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,cell_box:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,cell_box:0,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}],ne=1,se={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},ae=function(e,r){function i(e){g=Math.max(g+e,.01)}function o(r){var i=new t.Quaternion;i.setFromUnitVectors(c,h),r.applyQuaternion(i),e.up.applyQuaternion(i),c.applyQuaternion(i),h.copy(c)}function n(t){var o=u.x-d.x,n=u.y-d.y;l===se.ZOOM?e.zoom/=1-o+n:l===se.SLAB?(i(10*o),r.addScaledVector(t,-5/t.length()*n)):l===se.ROLL&&e.up.applyAxisAngle(t,.05*(o-n)),d.copy(u)}function s(t){var i=_.x-p.x,o=_.y-p.y;i*=.5*(e.right-e.left)/e.zoom,o*=.5*(e.bottom-e.top)/e.zoom;var n=t.clone().cross(e.up).setLength(i);n.addScaledVector(e.up,o/e.up.length()),e.position.add(n),r.add(n),p.copy(_)}function a(t){h.copy(t).normalize();var r=Date.now(),i=null!==y?r-y:16.7,o=18e-6*i*ne;y=r,null!==b&&(b+=.02,o=4e-5*ne*Math.cos(b)),c.crossVectors(e.up,t).multiplyScalar(o).add(h)}var l=se.NONE,h=new t.Vector3,c=new t.Vector3,d=new t.Vector2,u=new t.Vector2,f=0,m=0,p=new t.Vector2,_=new t.Vector2,v=!0,g=10,b=0,y=null,w=null;this.toggle_auto=function(e){l=l===se.AUTO_ROTATE?se.NONE:se.AUTO_ROTATE,y=null,b=e.rock?0:null},this.is_going=function(){return l===se.GO},this.is_moving=function(){return l!==se.NONE},this.update=function(){var t=!1,i=e.position.clone().sub(r);return l===se.AUTO_ROTATE&&a(i),h.equals(c)||(o(i),t=!0),m!==f&&(e.zoom*=m/f,f=m,t=!0),u.equals(d)||(n(i),t=!0),_.equals(p)||(s(i),v=!0,t=!0),e.position.addVectors(r,i),l===se.GO&&(w(),t=!0),e.lookAt(r),t},this.start=function(e,t,r,i){switch(l!==se.NONE&&l!==se.AUTO_ROTATE||(l=e),this.move(t,r,i),l){case se.ROTATE:h.copy(c);break;case se.ZOOM:case se.SLAB:case se.ROLL:d.copy(u);break;case se.PAN:p.copy(_),v=!1;break;case se.PAN_ZOOM:f=m,p.copy(_)}},this.move=function(t,i,o){switch(l){case se.ROTATE:var n=M(t,i),s=e.position.clone().sub(r);c.crossVectors(e.up,s).setLength(n[0]),c.addScaledVector(e.up,n[1]/e.up.length()),c.addScaledVector(s,n[2]/s.length());break;case se.ZOOM:case se.SLAB:case se.ROLL:u.set(t,i);break;case se.PAN:_.set(t,i);break;case se.PAN_ZOOM:_.set(t,i),m=o}},this.stop=function(r){var i=null;l===se.PAN&&!v&&r&&(i=r.pick_atom(E(p,e))),l=se.NONE,h.copy(c),f=m,p.copy(_),null!==i&&this.go_to(new t.Vector3(i.xyz[0],i.xyz[1],i.xyz[2]))},this.slab_width=function(){return g},this.change_slab_width=i,this.go_to=function(t,i,o,n){if(t&&!(t.distanceToSquared(r)<.1)||i&&!(i.distanceToSquared(e.position)<.1)||o&&!(o.distanceToSquared(e.up)<.1)){l=se.GO,n=n||60/ne;for(var s=[],a=0,h=1;h<=n;++h){var c=h/n;c=c<.5?2*c*c:-2*c*(c-2)-1,s.push((c-a)/(1-a)),a=c}w=function(){var n=s.shift();t&&(i||e.position.sub(r),r.lerp(t,n),i||e.position.add(r)),i&&e.position.lerp(i,n),o&&e.up.lerp(o,n),0===s.length&&(l=se.NONE,w=null)}}}},le=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]],he=["element","B-factor","occupancy","index","chain"],ce=["lines","trace","ribbon"],de=["marching cubes","squarish"];j.prototype.pick_atom=function(e){var t=e.intersectObjects(this.atomic_objects);if(t.length<1)return null;var r=t[0].point;return this.model.get_nearest_atom(r.x,r.y,r.z)},j.prototype.get_visible_atoms=function(){var e=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return e;for(var t=[],r=0;r<e.length;r++)"H"!==e[r].element&&t.push(e[r]);return t},j.prototype.add_bonds=function(e,r){for(var i=this.get_visible_atoms(),o=e?"element":this.conf.color_aim,n=F(o,i,this.conf.colors),s=new t.Geometry,a={hydrogens:this.conf.hydrogens,ligands_only:e,balls:"ball&stick"===this.conf.render_style},l=0;l<i.length;l++){var h=i[l],c=n[l];if(!e||h.is_ligand)if(0!==h.bonds.length||a.balls)for(var d=0;d<h.bonds.length;d++){var u=this.model.atoms[h.bonds[d]];if((a.hydrogens||"H"!==u.element)&&(!a.ligands_only||u.is_ligand)){var f=h.midpoint(u),m=new t.Vector3(f[0],f[1],f[2]),p=new t.Vector3(h.xyz[0],h.xyz[1],h.xyz[2]);if(a.balls){var _=p.distanceTo(m)/r;p.lerp(m,_)}s.vertices.push(p,m),s.colors.push(c,c)}}else S(s,h,c)}var v=new y(ie,{linewidth:k(this.conf.bond_line,this.win_size),size:this.win_size},!0);this.atomic_objects.push(v.make_line_segments(s)),a.balls?this.atomic_objects.push(v.make_balls(i,n,r)):ie||e||this.atomic_objects.push(v.make_caps(i,n))},j.prototype.add_trace=function(e){for(var t=this.model.extract_trace(),r=[].concat.apply([],t),i=F(this.conf.color_aim,r,this.conf.colors),o=new y(ie,{linewidth:k(this.conf.bond_line,this.win_size),size:this.win_size}),n=0,s=0;s<t.length;s++){var a=t[s],l=i.slice(n,n+a.length);n+=a.length;var h=o.make_line(a,l,e);this.atomic_objects.push(h)}},j.prototype.add_ribbon=function(e){for(var t=this.model.extract_trace(),r=this.model.get_residues(),i=[].concat.apply([],t),o=F(this.conf.color_aim,i,this.conf.colors),n=0,s=0;s<t.length;s++){for(var a=t[s],l=[],h=[0,0,0],c=0;c<a.length;c++){var d=r[a[c].resid()],u=this.model.calculate_tangent_vector(d);u[0]*h[0]+u[1]*h[1]+u[2]*h[2]<0&&(u[0]=-u[0],u[1]=-u[1],u[2]=-u[2]),l.push(u),h=u}var f=o.slice(n,n+a.length);n+=a.length;var m=y.make_ribbon(a,f,l,e);this.atomic_objects.push(m)}},V.prototype.set_colors=function(e){if(null==e)e=oe[0];else if("number"==typeof e)e=oe[e%oe.length];else if("string"==typeof e)for(var r=0;r!==oe.length;r++)if(oe[r].name===e){e=oe[r];break}if(void 0!==e.bg){if("number"==typeof e.bg)for(var i in e)"name"!==i&&(e[i]=new t.Color(e[i]));this.redraw_all()}},V.prototype.relX=function(e){return 2*(e.pageX-this.window_offset[0])/this.window_size[0]-1},V.prototype.relY=function(e){return 1-2*(e.pageY-this.window_offset[1])/this.window_size[1]},V.prototype.hud=function(e,t){if("undefined"!=typeof document){var r=this.hud_el;if(r){void 0!==e?"HTML"===t?r.innerHTML=e:r.textContent=e:r.innerHTML=this.initial_hud_html;var i="ERR"===t;r.style["background-color"]=i?"#b00":this.initial_hud_bg,i&&console.log("ERR: "+e)}else console.log("hud: "+e)}},V.prototype.redraw_center=function(){this.target.distanceToSquared(this.last_ctr)>1e-4&&(this.last_ctr.copy(this.target),this.mark&&this.scene.remove(this.mark),this.mark=C(.1,this.target,this.config.colors.center),this.scene.add(this.mark))},V.prototype.redraw_maps=function(e){this.redraw_center();for(var t=0;t<this.map_bags.length;t++){var r=this.map_bags[t];(e||this.target.distanceToSquared(r.block_ctr)>.01)&&this.redraw_map(r)}},V.prototype.clear_el_objects=function(e){for(var t=0;t<e.el_objects.length;t++)this.scene.remove(e.el_objects[t]),e.el_objects[t].geometry.dispose();e.el_objects=[]},V.prototype.clear_atomic_objects=function(e){if(e.atomic_objects)for(var t=0;t<e.atomic_objects.length;t++)this.scene.remove(e.atomic_objects[t]);e.atomic_objects=null},V.prototype.set_atomic_objects=function(e){switch(e.atomic_objects=[],e.conf.render_style){case"lines":e.add_bonds();break;case"ball&stick":var t=this.camera.projectionMatrix.elements[5],r=Math.max(1,200*t);e.add_bonds(!1,r);break;case"trace":e.add_trace(),e.add_bonds(!0);break;case"ribbon":e.add_ribbon(8),e.add_bonds(!0)}for(var i=0;i<e.atomic_objects.length;i++)this.scene.add(e.atomic_objects[i])},V.prototype.toggle_map_visibility=function(e){"number"==typeof e&&(e=this.map_bags[e]),e.visible=!e.visible,this.redraw_map(e)},V.prototype.redraw_map=function(e){this.clear_el_objects(e),e.visible&&(e.map.block=null,this.add_el_objects(e))},V.prototype.toggle_model_visibility=function(e){e=e||this.active_model_bag,e.visible=!e.visible,this.redraw_model(e)},V.prototype.redraw_model=function(e){this.clear_atomic_objects(e),e.visible&&this.set_atomic_objects(e)},V.prototype.redraw_models=function(){for(var e=0;e<this.model_bags.length;e++)this.redraw_model(this.model_bags[e])},V.prototype.add_el_objects=function(e){if(e.visible){e.map.block||(e.block_ctr.copy(this.target),e.map.extract_block(this.config.map_radius,[this.target.x,this.target.y,this.target.z]));for(var t=0;t<e.types.length;t++){var r=e.types[t],i=("map_neg"===r?-1:1)*e.isolevel,o=e.map.isomesh_in_block(i,this.config.map_style),n=y.make_chickenwire(o,{color:this.config.colors[r],linewidth:this.config.map_line});e.el_objects.push(n),this.scene.add(n)}}},V.prototype.change_isolevel_by=function(e,t){if(!(e>=this.map_bags.length)){var r=this.map_bags[e];r.isolevel+=t,this.clear_el_objects(r),this.add_el_objects(r);var i=r.map.abs_level(r.isolevel),o=i.toFixed(4),n=this.tied_viewer;if(n&&e<n.map_bags.length){var s=n.map_bags[e];s.isolevel=r.isolevel,o+=" / "+s.map.abs_level(s.isolevel).toFixed(4),n.clear_el_objects(s),n.add_el_objects(s)}this.hud("map "+(e+1)+" level =  "+o+" e/Å³ ("+r.isolevel.toFixed(2)+" rmsd)")}},V.prototype.change_map_radius=function(e){var t=2,r=40,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+e,t),r);var o='map "radius": '+i.map_radius;i.map_radius===r?o+=" (max)":i.map_radius===t&&(o+=" (min)"),this.hud(o),this.redraw_maps(!0)},V.prototype.change_slab_width_by=function(e){this.controls.change_slab_width(e),this.update_camera(),this.hud("clip width: "+(this.camera.far-this.camera.near).toFixed(1))},V.prototype.toggle_full_screen=function(){var e=document;if(e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement){var t=e.exitFullscreen||e.webkitExitFullscreen||e.mozCancelFullScreen||e.msExitFullscreen;t&&t.call(e)}else{var r=this.container,i=r.requestFullscreen||r.webkitRequestFullscreen||r.mozRequestFullScreen||r.msRequestFullscreen;i&&i.call(r)}},V.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var e=null;this.model_bags.length>0&&(e=this.model_bags[0].model.unit_cell),!e&&this.map_bags.length>0&&(e=this.map_bags[0].map.unit_cell),e&&(this.decor.cell_box=O(e,this.config.colors.cell_box),this.scene.add(this.decor.cell_box))}},V.prototype.shift_clip=function(e){var t=this.camera.position.clone().sub(this.target).setLength(1);e||t.negate(),this.target.add(t),this.camera.position.add(t),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+q(t,2," ")+"]")},V.prototype.go_to_nearest_Ca=function(){var e=this.target;if(null!==this.active_model_bag){var r=this.active_model_bag.model.get_nearest_atom(e.x,e.y,e.z,"CA");r?(this.hud(r.long_label()),this.controls.go_to(new t.Vector3(r.xyz[0],r.xyz[1],r.xyz[2]),null,null,30/ne),this.selected_atom=r):this.hud("no nearby CA")}},V.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0))},V.toggle_help=function(e){e&&(e.style.display="block"===e.style.display?"none":"block",""===e.innerHTML&&(e.innerHTML=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ","\n<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","+/- = sigma level","]/[ = map radius","D/F = clip width","numpad 3/. = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","R = center view","W = wireframe style","I = spin","Shift+I = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen",'\n<a href="https://uglymol.github.io">about uglymol</a>'].join("\n")))},V.prototype.select_next=function(e,t,r,i){var o=r.indexOf(this.config[t]),n=r.length,s=(o+(i?n-1:1))%n;this.config[t]=r[s];for(var a=e+":",l=0;l<n;l++){var h=l===s?"u":"s",c=r[l].name||r[l];a+=" <"+h+">"+c+"</"+h+">"}this.hud(a,"HTML")},V.prototype.keydown=function(e){var t=e.keyCode;switch(t){case 84:this.select_next("rendering as","render_style",ce,e.shiftKey),this.redraw_models();break;case 66:this.select_next("color scheme","colors",oe,e.shiftKey),this.set_colors(this.config.colors);break;case 67:this.select_next("coloring by","color_aim",he,e.shiftKey),this.redraw_models();break;case 87:this.select_next("map style","map_style",de,e.shiftKey),this.redraw_maps(!0);break;case 89:this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models();break;case 220:ie=!ie,this.hud((ie?"simple":"round-capped")+" bonds"),this.redraw_models();break;case 107:case 61:case 187:this.change_isolevel_by(e.shiftKey?1:0,.1);break;case 109:case 173:case 189:this.change_isolevel_by(e.shiftKey?1:0,-.1);break;case 219:this.change_map_radius(-2);break;case 221:this.change_map_radius(2);break;case 68:this.change_slab_width_by(-.1);break;case 70:e.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1);break;case 77:case 78:this.camera.zoom*=77===t?1.03:1/1.03,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toFixed(2));break;case 80:e.shiftKey?(window.location.hash="#xyz="+q(this.target,1,",")+"&eye="+q(this.camera.position,1,",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar")):this.go_to_nearest_Ca();break;case 51:case 99:this.shift_clip(!0);break;case 108:case 110:this.shift_clip(!1);break;case 85:this.hud("toggled unit cell box"),this.toggle_cell_box();break;case 73:this.hud("toggled camera movement"),this.controls.toggle_auto({rock:e.shiftKey});break;case 82:e.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("model recentered"),this.recenter());break;case 72:V.toggle_help(this.help_el);break;case 36:case 35:e.ctrlKey?(this.config.map_line+=36===t?.1:-.1,this.config.map_line=Math.max(this.config.map_line,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))):(this.config.bond_line+=36===t?.2:-.2,this.config.bond_line=Math.max(this.config.bond_line,.1),this.redraw_models(),this.hud("bond width: "+k(this.config.bond_line,this.window_size).toFixed(1)));break;case 16:case 17:case 18:case 225:break;case 32:this.center_next_residue(e.shiftKey);break;default:this.help_el&&this.hud("Nothing here. Press H for help.")}this.request_render()},V.prototype.mousedown=function(e){e.stopPropagation();var t=se.NONE;1===e.button||0===e.button&&e.ctrlKey?t=se.PAN:0===e.button?(e.shiftKey&&this.dblclick(e),t=se.ROTATE):2===e.button&&(t=e.ctrlKey?e.shiftKey?se.ROLL:se.SLAB:se.ZOOM),this.controls.start(t,this.relX(e),this.relY(e)),document.addEventListener("mousemove",this.mousemove),document.addEventListener("mouseup",this.mouseup),this.request_render()},V.prototype.dblclick=function(e){if(0===e.button){this.decor.selection&&(this.scene.remove(this.decor.selection),this.decor.selection=null);var r,i=new t.Vector2(this.relX(e),this.relY(e));null!==this.active_model_bag&&(r=this.active_model_bag.pick_atom(E(i,this.camera))),r?(this.hud(r.long_label()),this.set_selection(r)):this.hud(),this.request_render()}},V.prototype.set_selection=function(e){var r=new t.Geometry;r.vertices.push(new t.Vector3(e.xyz[0],e.xyz[1],e.xyz[2]));var i=this.config.colors[e.element]||this.config.colors.def,o=new t.PointsMaterial({size:3,color:i});this.decor.selection=new t.Points(r,o),this.scene.add(this.decor.selection)},V.prototype.touchstart=function(e){var t=e.touches;if(1===t.length)this.controls.start(se.ROTATE,this.relX(t[0]),this.relY(t[0]));else{var r=P(e);this.controls.start(se.PAN_ZOOM,this.relX(r),this.relY(r),r.dist)}this.request_render()},V.prototype.touchmove=function(e){e.preventDefault(),e.stopPropagation();var t=e.touches;if(1===t.length)this.controls.move(this.relX(t[0]),this.relY(t[0]));else{var r=P(e);this.controls.move(this.relX(r),this.relY(r),r.dist)}},V.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},V.prototype.mousewheel=function(e){e.preventDefault(),e.stopPropagation();var t=e.wheelDelta?e.wheelDelta/2e3:(e.detail||0)/-1e3;this.change_isolevel_by(e.shiftKey?1:0,t),this.request_render()},V.prototype.resize=function(){var e=this.container,t=e.clientWidth,r=e.clientHeight;this.window_offset[0]=e.offsetLeft,this.window_offset[1]=e.offsetTop,this.camera.left=-t,this.camera.right=t,this.camera.top=r,this.camera.bottom=-r,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,r),t===this.window_size[0]&&r===this.window_size[1]||(this.window_size[0]=t,this.window_size[1]=r,this.redraw_models()),this.request_render()},V.prototype.recenter=function(e,r,i){var o,n=null;if(null!=e&&null!=r||(o=this.active_model_bag.model.get_center()),r&&(r=new t.Vector3(r[0],r[1],r[2])),null==e){if(null===this.active_model_bag)return;e=new t.Vector3(o[0],o[1],o[2]),r||(r=e.clone(),r.z+=100,n=t.Object3D.DefaultUp)}else if(e=new t.Vector3(e[0],e[1],e[2]),null==r&&null!==this.active_model_bag){r=new t.Vector3(o[0],o[1],o[2]),r.sub(e).negate().setLength(100),n=new t.Vector3(0,1,0).projectOnPlane(r);var s=n.length();s<.1&&(n.set(1,0,0).projectOnPlane(r),s=n.length()),n.divideScalar(s),r.add(e)}this.controls.go_to(e,r,n,i)},V.prototype.center_next_residue=function(e){if(this.active_model_bag){var r=this.active_model_bag.model.next_residue(this.selected_atom,e);r&&(this.hud("-> "+r.long_label()),this.controls.go_to(new t.Vector3(r.xyz[0],r.xyz[1],r.xyz[2]),null,null,30/ne),this.selected_atom=r)}},V.prototype.update_camera=function(){var e=this.camera.position.distanceTo(this.target),t=.25*this.controls.slab_width()/this.camera.zoom;this.camera.near=e*(1-t),this.camera.far=e*(1+3*t),this.camera.updateProjectionMatrix()},V.prototype.render=function(){if(this.scheduled=!0,null!==this.renderer){this.controls.update()&&this.update_camera();var e=this.tied_viewer;this.controls.is_going()||(this.redraw_maps(),e&&!e.scheduled&&e.redraw_maps()),this.renderer.render(this.scene,this.camera),e&&!e.scheduled&&e.renderer.render(e.scene,e.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update()}},V.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},V.prototype.set_model=function(e){var t=new j(e,this.config,this.window_size);this.model_bags.push(t),this.set_atomic_objects(t),this.active_model_bag=t,this.request_render()},V.prototype.add_map=function(e,t){var r=new T(e,t);this.map_bags.push(r),this.add_el_objects(r),this.request_render()},V.prototype.load_file=function(e,t,r,i){if(null!==this.renderer){var o=new XMLHttpRequest;o.open("GET",e,!0),t?o.responseType="arraybuffer":o.overrideMimeType("text/plain");var n=this;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status&&null!==o.response)try{r(o)}catch(t){n.hud("Error: "+t.message+"\nin "+e,"ERR")}else n.hud("Failed to fetch "+e,"ERR")},i&&o.addEventListener("progress",function(t){if(t.lengthComputable){var r=e.split("/").pop();n.hud("loading "+r+" ... "+(t.loaded>>10)+" / "+(t.total>>10)+" kB")}});try{o.send(null)}catch(t){n.hud("loading "+e+" failed:\n"+t,"ERR")}}},V.prototype.load_pdb=function(e,t){t=t||{};var r=this;this.load_file(e,!1,function(e){var o=new i;o.from_pdb(e.responseText),r.set_model(o);var n=R();n.zoom&&(r.camera.zoom=n.zoom),r.recenter(t.center||n.xyz,n.eye,1),t.callback&&t.callback()})},V.prototype.load_map=function(e,t,r,i,o){if("ccp4"!==r&&"dsn6"!==r)throw Error("Unknown map filetype.");var n=this;this.load_file(e,!0,function(e){var o=new u;"ccp4"===r?o.from_ccp4(e.response):o.from_dsn6(e.response),n.add_map(o,t),i&&i()},o)},V.prototype.load_ccp4_maps=function(e,t,r){var i=this;this.load_map(e,!1,"ccp4",function(){i.load_map(t,!0,"ccp4",function(){i.hud(),r&&r()},!0)},!0)},V.prototype.load_pdb_and_ccp4_maps=function(e,t,r,i){var o=this;this.load_pdb(e,{callback:function(){o.load_ccp4_maps(t,r,i)}})},V.ColorSchemes=oe,V.auto_speed=ne,e.UnitCell=r,e.Model=i,e.isosurface=h,e.ElMap=u,e.LineFactory=y,e.Viewer=V,Object.defineProperty(e,"__esModule",{value:!0})});