!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(e.UM=e.UM||{},e.THREE)}(this,function(e,t){"use strict";function i(e,t,i,r,o,s){function n(e,t){var i=e[0],r=e[1],o=e[2];return[t[0]*i+t[1]*r+t[2]*o,t[4]*r+t[5]*o,t[8]*o]}if(e<=0||t<=0||i<=0||r<=0||o<=0||s<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[e,t,i,r,o,s];var a=Math.PI/180,l=Math.cos(a*r),h=Math.cos(a*o),c=Math.cos(a*s),d=Math.sin(a*r),u=Math.sin(a*o),f=Math.sin(a*s);if(0===d||0===u||0===f)throw Error("Impossible angle - N*180deg.");var m=(h*c-l)/f,p=m/u,_=Math.sqrt(1-p*p),v=[e,t*c,i*h,0,t*f,-i*m,0,0,i*u*_],g=[1/e,-c/(f*e),-(c*m+h*f)/(u*_*f*e),0,1/(f*t),p/(_*f*t),0,0,1/(u*_*i)];this.fractionalize=function(e){return n(e,g)},this.orthogonalize=function(e){return n(e,v)}}function r(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=null,this.upper_bound=null}function o(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=null,this.resseq=null,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.charge=0,this.i_seq=null,this.is_ligand=null,this.bonds=[]}function s(e,t,i,r){var o;this.boxes=[],this.xdim=Math.ceil((r[0]-i[0])/t),this.ydim=Math.ceil((r[1]-i[1])/t),this.zdim=Math.ceil((r[2]-i[2])/t);var s=this.xdim*this.ydim*this.zdim;for(o=0;o<s;o++)this.boxes.push([]);for(this.find_box_id=function(e,r,o){var s=Math.floor((e-i[0])/t),n=Math.floor((r-i[1])/t),a=Math.floor((o-i[2])/t),l=(a*this.ydim+n)*this.xdim+s;return l>=0&&l<this.boxes.length?l:null},o=0;o<e.length;o++){var n=e[o].xyz,a=this.find_box_id(n[0],n[1],n[2]);if(null===a)throw Error("wrong cubicle");this.boxes[a].push(o)}}function n(e,t,i){if(e[0]<=0||e[1]<=0||e[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var r=e[0]*e[1]*e[2];if(t.length!==r||i.length!==r)throw Error("isosurface: array size mismatch")}function a(e){for(var t=[],i=0;i<8;++i){var r=Z[i];t.push(r[0]+e[2]*(r[1]+e[1]*r[2]))}return t}function l(e,t,i,r,o){for(var s="snapped MC"===o,n="squarish"===o?W:X,l=new Array(12),h=a(e),c=new Float32Array(8),d=[0,0,0],u=[d,d,d,d,d,d,d,d],f=e[0],m=e[1],p=e[2],_=[],v=[],g=0,b=0;b<f-1;b++)for(var y=0;y<m-1;y++)for(var w=0;w<p-1;w++){var x,z,A=w+p*(y+m*b),M=0;for(x=0;x<8;++x)z=A+h[x],M|=t[z]<r?1<<x:0;if(0!==M&&255!==M){for(x=0;x<8;++x)z=A+h[x],c[x]=t[z],u[x]=i[z];var k=I[M];for(x=0;x<12;++x)if(0!==(k&1<<x)){var C=Q[x],E=(r-c[C[0]])/(c[C[1]]-c[C[0]]);s===!0&&(E>.85?E=1:E<.15&&(E=0));var L=u[C[0]],F=u[C[1]];_.push(L[0]+(F[0]-L[0])*E,L[1]+(F[1]-L[1])*E,L[2]+(F[2]-L[2])*E),l[x]=g++}var O=n[M];for(x=0;x<O.length;x++)v.push(l[O[x]])}}return{vertices:_,segments:v}}function h(e,t,i,r,o){return n(e,t,i),l(e,t,i,r,o)}function c(e){this.dim=e,this.values=new Float32Array(e[0]*e[1]*e[2])}function d(e,t){var i=e%t;return i>=0?i:i+t}function u(){this.unit_cell=null,this.grid=null,this.mean=0,this.rms=1}function f(e){var t=e.toLowerCase().replace(/\s+/g,"").split(",");if(3!==t.length)throw Error("Unexpected symop: "+e);for(var i=[],r=0;r<3;r++){for(var o=t[r].split(/(?=[+-])/),s=[0,0,0,0],n=0;n<o.length;n++){var a=o[n],l="-"===a[0]?-1:1,h=o[n].match(/^[+-]?([xyz])$/);if(h){var c={x:0,y:1,z:2}[h[1]];s[c]=l}else{if(h=o[n].match(/^[+-]?(\d)\/(\d)$/),!h)throw Error("What is "+o[n]+" in "+e);s[3]=l*Number(h[1])/Number(h[2])}}i.push(s)}return i}function m(e,i,r){for(var o=new t.Geometry,s=0;s<$.length;s++){var n=$[s],a=i.x+e*(n[0]-.5),l=i.y+e*(n[1]-.5),h=i.z+e*(n[2]-.5);o.vertices.push(new t.Vector3(a,l,h))}var c=new t.LineBasicMaterial({color:r,linewidth:2});return new t.LineSegments(o,c)}function p(e,i){for(var r=new t.Geometry,o=0;o<$.length;o++){var s=e($[o]);r.vertices.push(new t.Vector3(s[0],s[1],s[2]))}r.colors.push(new t.Color(16711680),new t.Color(16755200),new t.Color(65280),new t.Color(11206400),new t.Color(255),new t.Color(43775));for(var n=6;n<$.length;n++)r.colors.push(i);var a=new t.LineBasicMaterial({vertexColors:t.VertexColors});return new t.LineSegments(r,a)}function _(e,i){var r,o=e.length,s=[];for(r=0;r<o;r++){var n=e[r];s.push(n.x,n.y,n.z),s.push(n.x,n.y,n.z)}var a=new Float32Array(s),l=new Float32Array(6*o);for(r=0;r<6;r++)l[r]=s[r];for(;r<6*o;r++)l[r]=s[r-6];var h=new Float32Array(6*o);for(r=0;r<6*(o-1);r++)h[r]=s[r+6];for(;r<6*o;r++)h[r]=s[r];var c=new Float32Array(2*o);for(r=0;r<o;r++)c[2*r]=1,c[2*r+1]=-1;var d=new Float32Array(6*o);for(r=0;r<o;r++){var u=i[r];d[6*r]=u.r,d[6*r+1]=u.g,d[6*r+2]=u.b,d[6*r+3]=u.r,d[6*r+4]=u.g,d[6*r+5]=u.b}var f=new t.BufferGeometry;return f.addAttribute("position",new t.BufferAttribute(a,3)),f.addAttribute("previous",new t.BufferAttribute(l,3)),f.addAttribute("next",new t.BufferAttribute(h,3)),f.addAttribute("side",new t.BufferAttribute(c,1)),f.addAttribute("color",new t.BufferAttribute(d,3)),f}function v(e,i){var r,o,s=e.length,n=[];for(r=0;r<s;r++){var a=e[r];n.push(a.x,a.y,a.z),n.push(a.x,a.y,a.z)}var l=new Float32Array(n),h=new Float32Array(6*s);for(r=0;r<6*s;r+=12){for(o=0;o<6;o++)h[r+o]=n[r+o+6];for(;o<12;o++)h[r+o]=n[r+o-6]}var c=new Float32Array(2*s);for(r=0;r<s;r++)c[2*r]=-1,c[2*r+1]=1;var d=new Float32Array(6*s);for(r=0;r<s;r++){var u=i[r];d[6*r]=u.r,d[6*r+1]=u.g,d[6*r+2]=u.b,d[6*r+3]=u.r,d[6*r+4]=u.g,d[6*r+5]=u.b}var f=2*s<65536?new Uint16Array(3*s):new Uint32Array(3*s),m=[0,1,2,0,2,3];for(r=0;r<s/2;r++)for(o=0;o<6;o++)f[6*r+o]=4*r+m[o];var p=new t.BufferGeometry;return p.addAttribute("position",new t.BufferAttribute(l,3)),p.addAttribute("other",new t.BufferAttribute(h,3)),p.addAttribute("side",new t.BufferAttribute(c,1)),p.addAttribute("color",new t.BufferAttribute(d,3)),p.setIndex(new t.BufferAttribute(f,1)),p}function g(e,i){for(var r=[],o=0;o<e.length;o++){var s=e[o].xyz;r.push(new t.Vector3(s[0],s[1],s[2]))}if(!i||i<2)return r;var n=new t.CatmullRomCurve3(r);return n.getPoints((e.length-1)*i)}function b(e,t){if(!t||t<2)return e;for(var i=[],r=0;r<e.length-1;r++)for(var o=0;o<t;o++)i.push(e[r]);return i.push(e[e.length-1]),i}function y(e,t){t=t||1;var i,r=[];for(i=0;i<e.length-1;i++)for(var o=e[i],s=e[i+1],n=0;n<t;n++){var a=n/t,l=1-a;r.push(l*o[0]+a*s[0],l*o[1]+a*s[1],l*o[2]+a*s[2])}return r.push(e[i][0],e[i][1],e[i][2]),r}function w(e){var t={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var i in e)t[i]={value:e[i]};return t}function x(e){for(var t=new Float32Array(3*e.length),i=0;i<e.length;i++){var r=e[i];t[3*i]=r.r,t[3*i+1]=r.g,t[3*i+2]=r.b}return t}function z(e){for(var t=new Float32Array(3*e.length),i=0;i<e.length;i++){var r=e[i];t[3*i]=r.x,t[3*i+1]=r.y,t[3*i+2]=r.z}return t}function A(e){for(var t=new Float32Array(3*e.length),i=0;i<e.length;i++){var r=e[i].xyz;t[3*i]=r[0],t[3*i+1]=r[1],t[3*i+2]=r[2]}return t}function M(e,i,r,o){var s=g(e,o),n=b(i,o),a=y(r,o),l=new t.Object3D,h=new t.BufferGeometry,c=z(s);h.addAttribute("position",new t.BufferAttribute(c,3));var d=x(n);h.addAttribute("color",new t.BufferAttribute(d,3));var u=new Float32Array(a);h.addAttribute("normal",new t.BufferAttribute(u,3));for(var f=new t.ShaderMaterial({uniforms:w({shift:0}),vertexShader:ie,fragmentShader:re,fog:!0,vertexColors:t.VertexColors}),m=-4;m<5;m++){var p=0===m?f:f.clone();p.uniforms.shift.value=.1*m,l.add(new t.Line(h,p))}return l}function k(e,i){var r=new t.BufferGeometry,o=new Float32Array(e.vertices);r.addAttribute("position",new t.BufferAttribute(o,3));var s=e.vertices.length<196608?new Uint16Array(e.segments):new Uint32Array(e.segments);r.setIndex(new t.BufferAttribute(s,1));var n=new t.LineBasicMaterial(i);return new t.LineSegments(r,n)}function C(){for(var e=50,i=[],r=-e;r<=e;r++){var o=0;r%5===0&&(o=r%2===0?2:1),i.push(-e,r,o,e,r,o),i.push(r,-e,o,r,e,o)}var s=new t.BufferGeometry;s.addAttribute("position",new t.BufferAttribute(new Float32Array(i),3));var n=new t.ShaderMaterial({uniforms:w({ucolor:new t.Color(8947848)}),vertexShader:oe,fragmentShader:se,fog:!0});n.transparent=!0;var a=new t.LineSegments(s,n);return a.frustumCulled=!1,a.color_value=n.uniforms.ucolor.value,a}function E(e){var i={};i.linewidth=e.linewidth,this.use_gl_lines=e.gl_lines,this.use_gl_lines?(void 0===e.color?i.vertexColors=t.VertexColors:i.color=e.color,this.material=new t.LineBasicMaterial(i)):(i.size=e.size,this.material=new t.ShaderMaterial({uniforms:w(i),vertexShader:e.as_segments?ee:J,fragmentShader:te,fog:!0,vertexColors:t.VertexColors}))}function L(e,i,r){var o=A(e),s=x(i),n=new t.BufferGeometry;n.addAttribute("position",new t.BufferAttribute(o,3)),n.addAttribute("color",new t.BufferAttribute(s,3));var a=new t.ShaderMaterial({uniforms:w({size:r}),vertexShader:ne,fragmentShader:ae,fog:!0,vertexColors:t.VertexColors}),l=new t.Points(n,a);return l.raycast=function(){},l}function F(e,i){var r=e.linePrecision*e.linePrecision;le.getInverse(this.matrixWorld),he.copy(e.ray).applyMatrix4(le);for(var o=new t.Vector3,s=new t.Vector3,n=new t.Vector3,a=new t.Vector3,l=this.drawMode===t.TriangleStripDrawMode?1:2,h=this.geometry.attributes.position.array,c=0,d=h.length/6-1;c<d;c+=l){o.fromArray(h,6*c),s.fromArray(h,6*c+6);var u=he.distanceSqToSegment(o,s,a,n);if(!(u>r)){a.applyMatrix4(this.matrixWorld);var f=e.ray.origin.distanceTo(a);f<e.near||f>e.far||i.push({distance:f,point:n.clone().applyMatrix4(this.matrixWorld),index:c,object:this,line_dist:Math.sqrt(u)})}}}function O(e,t){if("undefined"!=typeof document){var i=document.createElement("canvas");i.width=256,i.height=16;var r=i.getContext("2d");return r?(r.font=(t.font||"bold 14px")+" sans-serif",r.textBaseline="bottom",t.color&&(r.fillStyle=t.color),r.fillText(e,0,i.height),i):null}}function S(e,i){var r=O(e,i);if(r){var o=new t.Texture(r);o.needsUpdate=!0;var s=new t.BufferGeometry,n=i.pos,a=new Float32Array([].concat(n,n,n,n)),l=new Float32Array([0,1,1,1,0,0,1,0]),h=new Uint16Array([0,2,1,2,3,1]);s.setIndex(new t.BufferAttribute(h,1)),s.addAttribute("position",new t.BufferAttribute(a,3)),s.addAttribute("uv",new t.BufferAttribute(l,2));var c=new t.ShaderMaterial({uniforms:w({map:o,canvas_size:[r.width,r.height],win_size:i.win_size}),vertexShader:ce,fragmentShader:de,fog:!0});c.transparent=!0;var d=new t.Mesh(s,c);return d.remake=function(e,t){o.image=O(e,t),o.needsUpdate=!0},d}}function T(e,t){var i=0,r=e*e+t*t;if(r<1)i=Math.sqrt(1-r);else{var o=Math.sqrt(r);e/=o,t/=o}return[e,t,i]}function j(e,t){return e*t[1]/700}function q(e,i,r){var o=new t.Color(14737632);if(i<r){var s=(e-i)/(r-i),n=(240-240*s)/360;o.setHSL(n,1,.5)}return o}function R(e,t,i){var r,o,s=t[t.length-1];if("index"===e)r=function(e){return q(e.i_seq,0,s.i_seq)};else if("B-factor"===e){var n=1/0,a=-(1/0);for(o=0;o<t.length;o++){var l=t[o].b;l>a&&(a=l),l<n&&(n=l)}r=function(e){return q(e.b,n,a)}}else r="occupancy"===e?function(e){return q(e.occ,0,1)}:"chain"===e?function(e){return q(e.chain_index,0,s.chain_index)}:function(e){return i[e.element]||i.def};var h=[];for(o=0;o<t.length;o++)h.push(r(t[o]));return h}function P(e,i,r){var o=i.xyz,s=.7;e.vertices.push(new t.Vector3(o[0]-s,o[1],o[2])),e.vertices.push(new t.Vector3(o[0]+s,o[1],o[2])),e.vertices.push(new t.Vector3(o[0],o[1]-s,o[2])),e.vertices.push(new t.Vector3(o[0],o[1]+s,o[2])),e.vertices.push(new t.Vector3(o[0],o[1],o[2]-s)),e.vertices.push(new t.Vector3(o[0],o[1],o[2]+s));for(var n=0;n<6;n++)e.colors.push(r)}function V(e,i){this.map=e,this.name="",this.isolevel=i?3:1.5,this.visible=!0,this.types=i?["map_pos","map_neg"]:["map_den"],this.block_ctr=new t.Vector3(1/0,0,0),this.el_objects=[]}function B(e,t,i){this.model=e,this.name="",this.visible=!0,this.conf=t,this.win_size=i,this.atomic_objects=null}function N(e){function i(t){return null===e[t]?null:document.getElementById(e[t]||t)}if(this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null,zoom_grid:C()},this.labels={},this.nav=null,this.config={bond_line:4,map_line:1.25,map_radius:10,map_style:ge[0],render_style:ve[0],color_aim:_e[0],line_style:be[0],label_font:ye[0],colors:ue[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.last_ctr=new t.Vector3(1/0,0,0),this.selected_atom=null,this.active_model_bag=null,this.scene=new t.Scene,this.scene.fog=new t.Fog(this.config.colors.bg,0,1),this.light=new t.AmbientLight(16777215),this.scene.add(this.light),e.share_view?(this.target=e.share_view.target,this.camera=e.share_view.camera,this.controls=e.share_view.controls,this.tied_viewer=e.share_view,this.tied_viewer.tied_viewer=this):(this.target=new t.Vector3,this.camera=new t.OrthographicCamera,this.controls=new pe(this.camera,this.target)),this.raycaster=new t.Raycaster,"undefined"!=typeof document){try{this.renderer=new t.WebGLRenderer({antialias:!0})}catch(e){return this.hud("no WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=i("viewer"),this.hud_el=i("hud"),this.help_el=i("help"),this.hud_el&&(this.initial_hud_html=this.hud_el.innerHTML,this.initial_hud_bg=this.hud_el.style["background-color"]),null!==this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.container.appendChild(this.renderer.domElement),e.focusable&&(this.renderer.domElement.tabIndex=0),this.decor.zoom_grid.visible=!1,this.scene.add(this.decor.zoom_grid),window.Stats&&(this.stats=new window.Stats,this.container.appendChild(this.stats.dom)),window.addEventListener("resize",this.resize.bind(this));var r=this.renderer.domElement,o=e.focusable?r:window;o.addEventListener("keydown",this.keydown.bind(this)),r.addEventListener("contextmenu",function(e){e.preventDefault()}),r.addEventListener("mousewheel",this.mousewheel.bind(this)),r.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),r.addEventListener("mousedown",this.mousedown.bind(this)),r.addEventListener("touchstart",this.touchstart.bind(this)),r.addEventListener("touchmove",this.touchmove.bind(this)),r.addEventListener("touchend",this.touchend.bind(this)),r.addEventListener("touchcancel",this.touchend.bind(this)),r.addEventListener("dblclick",this.dblclick.bind(this));var s=this;this.mousemove=function(e){e.preventDefault(),s.controls.move(s.relX(e),s.relY(e))},this.mouseup=function(e){e.preventDefault(),e.stopPropagation(),document.removeEventListener("mousemove",s.mousemove),document.removeEventListener("mouseup",s.mouseup),s.decor.zoom_grid.visible=!1;var t=s.controls.stop();if(t){var i=s.pick_atom(t,s.camera);null!==i&&s.select_atom(i,{steps:60/fe})}s.redraw_maps()},this.scheduled=!1,this.request_render()}}}function H(e,t){return[e.x.toFixed(t),e.y.toFixed(t),e.z.toFixed(t)]}function U(e){var t=e.touches,i=t[0].pageX-t[1].pageX,r=t[0].pageY-t[1].pageY;return{pageX:(t[0].pageX+t[1].pageX)/2,pageY:(t[0].pageY+t[1].pageY)/2,dist:Math.sqrt(i*i+r*r)}}function G(){var e={};if("undefined"==typeof window)return e;for(var t=window.location.hash.substr(1).split("&"),i=0;i<t.length;i++){var r=t[i].split("="),o=r[1];"xyz"===r[0]||"eye"===r[0]?o=o.split(",").map(Number):"zoom"===r[0]&&(o=Number(o)),e[r[0]]=o}return e}e.VERSION="0.5.1";var D=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],K=["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"],Y=["HOH"].concat(D,K);r.prototype.from_pdb=function(e){for(var t=e.split("\n"),r=0,s=null,n=0,a=0;a<t.length;a++){var l=t[a],h=l.substring(0,6);if("ATOM  "===h||"HETATM"===h){var c=new o;c.from_pdb_line(l),c.i_seq=n++,this.has_hydrogens||"H"!==c.element||(this.has_hydrogens=!0),c.chain!==s&&r++,c.chain_index=r,s=c.chain,this.atoms.push(c)}else if("ANISOU"===h);else if("CRYST1"===h){var d=parseFloat(l.substring(6,15)),u=parseFloat(l.substring(15,24)),f=parseFloat(l.substring(24,33)),m=parseFloat(l.substring(33,40)),p=parseFloat(l.substring(40,47)),_=parseFloat(l.substring(47,54));this.unit_cell=new i(d,u,f,m,p,_)}else"TER"===h.substring(0,3)&&(s=null)}if(0===this.atoms.length)throw Error("No atom records found.");this.calculate_bounds(),this.calculate_connectivity()},r.prototype.calculate_bounds=function(){for(var e=this.lower_bound=[1/0,1/0,1/0],t=this.upper_bound=[-(1/0),-(1/0),-(1/0)],i=0;i<this.atoms.length;i++)for(var r=this.atoms[i],o=0;o<3;o++){var s=r.xyz[o];s<e[o]&&(e[o]=s),s>t[o]&&(t[o]=s)}for(var n=0;n<3;++n)e[n]-=.001,t[n]+=.001},r.prototype.next_residue=function(e,t){for(var i=this.atoms.length,r=(e?e.i_seq:0)+i,o=e?1:0;o<i;o++){var s=(r+(t?-o:o))%i,n=this.atoms[s];if(n.is_main_conformer()&&("CA"===n.name&&"C"===n.element||"P"===n.name))return n}},r.prototype.extract_trace=function(){for(var e=[],t=[],i=null,r=0;r<this.atoms.length;r++){var o=this.atoms[r];if((""===o.altloc||"A"===o.altloc)&&("CA"===o.name&&"C"===o.element||"P"===o.name)){var s=!0;if(null!==i&&i.chain_index===o.chain_index){var n=o.distance_sq(i);("CA"===o.name&&n<=30.25||"P"===o.name&&n<56.25)&&(t.push(o),s=!1)}s&&(t.length>2&&e.push(t),t=[o]),i=o}}return t.length>2&&e.push(t),e},r.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var e={},t=0;t<this.atoms.length;t++){var i=this.atoms[t],r=i.resid(),o=e[r];void 0===o?e[r]=[i]:o.push(i)}return this.residue_map=e,e},r.prototype.calculate_tangent_vector=function(e){for(var t=null,i=null,r=3===e[0].resname.length,o=r?"C":"C2'",s=r?"O":"O4'",n=0;n<e.length;n++){var a=e[n];a.is_main_conformer()&&(a.name===o?t=a.xyz:a.name===s&&(i=a.xyz))}if(null===t||null===i)return[0,0,1];var l=[t[0]-i[0],t[1]-i[1],t[2]-i[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},r.prototype.get_center=function(){for(var e=0,t=0,i=0,r=this.atoms.length,o=0;o<r;o++){var s=this.atoms[o].xyz;e+=s[0],t+=s[1],i+=s[2]}return[e/r,t/r,i/r]},o.prototype.from_pdb_line=function(e){if(e.length<66)throw Error("ATOM or HETATM record is too short: "+e);var t=e.substring(0,6);if("HETATM"===t)this.hetero=!0;else if("ATOM  "!==t)throw Error("Wrong record type: "+t);this.name=e.substring(12,16).trim(),this.altloc=e.substring(16,17).trim(),this.resname=e.substring(17,20).trim(),this.chain=e.substring(20,22).trim(),this.resseq=parseInt(e.substring(22,26),10),this.icode=e.substring(26,27).trim();var i=parseFloat(e.substring(30,38)),r=parseFloat(e.substring(38,46)),o=parseFloat(e.substring(46,54));this.xyz=[i,r,o],this.occ=parseFloat(e.substring(54,60)),this.b=parseFloat(e.substring(60,66)),e.length>=78&&(this.element=e.substring(76,78).trim().toUpperCase()),e.length>=80&&(this.charge=e.substring(78,80).trim()),this.is_ligand=Y.indexOf(this.resname)===-1},o.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},o.prototype.distance_sq=function(e){var t=this.xyz[0]-e.xyz[0],i=this.xyz[1]-e.xyz[1],r=this.xyz[2]-e.xyz[2];return t*t+i*i+r*r},o.prototype.distance=function(e){return Math.sqrt(this.distance_sq(e))},o.prototype.midpoint=function(e){return[(this.xyz[0]+e.xyz[0])/2,(this.xyz[1]+e.xyz[1])/2,(this.xyz[2]+e.xyz[2])/2]},o.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},o.prototype.is_s_or_p=function(){return"S"===this.element||"P"===this.element},o.prototype.is_ion=function(){return this.element===this.resname},o.prototype.is_water=function(){return"HOH"===this.resname},o.prototype.is_same_residue=function(e,t){return e.resseq===this.resseq&&e.icode===this.icode&&e.chain===this.chain&&e.resname===this.resname&&(t||e.altloc===this.altloc)},o.prototype.is_same_conformer=function(e){return""===this.altloc||""===e.altloc||this.altloc===e.altloc},o.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},o.prototype.is_bonded_to=function(e){var t=3.9601,i=1.3*1.3,r=2.2*2.2;if(!this.is_same_conformer(e))return!1;if("H"===this.element&&"H"===e.element)return!1;var o=this.distance_sq(e);return!(o>r)&&("H"===this.element||"H"===e.element?o<=i:o<=t||this.is_s_or_p()||e.is_s_or_p())},o.prototype.resid=function(){return this.resseq+"/"+this.chain},o.prototype.long_label=function(){var e=this;return e.name+" /"+e.resseq+" "+e.resname+"/"+e.chain+" - occ: "+e.occ.toFixed(2)+" bf: "+e.b.toFixed(2)+" ele: "+e.element+" pos: ("+e.xyz[0].toFixed(2)+","+e.xyz[1].toFixed(2)+","+e.xyz[2].toFixed(2)+")"},o.prototype.short_label=function(){var e=this;return e.name+" /"+e.resseq+" "+e.resname+"/"+e.chain},s.prototype.get_nearby_atoms=function(e){var t=[],i=this.xdim*this.ydim,r=Math.max(e%i,0),o=Math.max(r%this.xdim,0),s=Math.floor(r/this.xdim),n=Math.floor(e/i);console.assert(n*i+s*this.xdim+o===e);for(var a=o-1;a<=o+1;a++)if(!(a<0||a>=this.xdim))for(var l=s-1;l<=s+1;l++)if(!(l<0||l>=this.ydim))for(var h=n-1;h<=n+1;h++)if(!(h<0||h>=this.zdim)){var c=h*i+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var d=this.boxes[c],u=0;u<d.length;u++)t.push(d[u])}return t},r.prototype.calculate_connectivity=function(){for(var e=this.atoms,t=new s(e,3,this.lower_bound,this.upper_bound),i=0;i<t.boxes.length;i++){var r=t.boxes[i];if(0!==r.length)for(var o=t.get_nearby_atoms(i),n=0;n<r.length;n++)for(var a=r[n],l=0;l<o.length;l++){var h=o[l];h>a&&e[a].is_bonded_to(e[h])&&(e[a].bonds.push(h),e[h].bonds.push(a))}}this.cubes=t},r.prototype.get_nearest_atom=function(e,t,i,r){for(var o=this.cubes.find_box_id(e,t,i),s=this.cubes.get_nearby_atoms(o),n=null,a=1/0,l=0;l<s.length;l++){var h=this.atoms[s[l]];if(void 0===r||null===r||r===h.name){var c=h.xyz[0]-e,d=h.xyz[1]-t,u=h.xyz[2]-i,f=c*c+d*d+u*u;f<a&&(n=h,a=f)}}return n};var I=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),X=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],W=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],Z=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],Q=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];
c.prototype.grid2index=function(e,t,i){return e=d(e,this.dim[0]),t=d(t,this.dim[1]),i=d(i,this.dim[2]),this.dim[2]*(this.dim[1]*e+t)+i},c.prototype.grid2frac=function(e,t,i){return[e/this.dim[0],t/this.dim[1],i/this.dim[2]]},c.prototype.frac2grid=function(e){return[0|Math.floor(e[0]*this.dim[0]),0|Math.floor(e[1]*this.dim[1]),0|Math.floor(e[2]*this.dim[2])]},c.prototype.set_grid_value=function(e,t,i,r){var o=this.grid2index(e,t,i);this.values[o]=r},c.prototype.get_grid_value=function(e,t,i){var r=this.grid2index(e,t,i);return this.values[r]},u.prototype.calculate_stddev=function(e,t){for(var i=0,r=0,o=e.length,s=t;s<o;s++)i+=e[s],r+=e[s]*e[s];var n=i/(o-t),a=r/(o-t)-n*n;this.mean=n,this.rms=Math.sqrt(a)},u.prototype.abs_level=function(e){return e*this.rms+this.mean},u.prototype.from_ccp4=function(e,t){if(void 0===t&&(t=!0),e.byteLength<1024)throw Error("File shorter than 1024 bytes.");var r=new Int32Array(e,0,256);if(542130509!==r[52])throw Error("not a CCP4 map");var o=[r[0],r[1],r[2]];this.mode=r[3];var s;if(2===this.mode)s=4;else{if(0!==this.mode)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");s=1}var n=[r[4],r[5],r[6]],a=[r[7],r[8],r[9]],l=r[23];if(1024+l+s*o[0]*o[1]*o[2]!==e.byteLength)throw Error("ccp4 file too short or too long");var h=new Float32Array(e,0,e.byteLength>>2);this.unit_cell=new i(h[10],h[11],h[12],h[13],h[14],h[15]);var d=[r[16],r[17],r[18]],u=d.indexOf(1),m=d.indexOf(2),p=d.indexOf(3);if(this.min=h[19],this.max=h[20],this.sg_number=r[22],this.lskflg=r[24],this.grid=new c(a),l%4!==0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");var _;_=2===this.mode?h:new Int8Array(e);var v=(1024+l)/s|0;this.mean=h[21],this.rms=h[54],(this.mean<this.min||this.mean>this.max||this.rms<=0)&&this.calculate_stddev(_,v);var g=1,b=0;0===this.mode&&r[39]===-128&&127===r[40]&&(g=(this.max-this.min)/255,b=.5*(this.min+this.max+g));var y=[n[0]+o[0],n[1]+o[1],n[2]+o[2]],w=[0,0,0];for(w[2]=n[2];w[2]<y[2];w[2]++)for(w[1]=n[1];w[1]<y[1];w[1]++)for(w[0]=n[0];w[0]<y[0];w[0]++)this.grid.set_grid_value(w[u],w[m],w[p],g*_[v]+b),v++;if(t&&l>0)for(var x=new Uint8Array(e),z=0;z+80<=l;z+=80){var A,M="";for(A=0;A<80;++A)M+=String.fromCharCode(x[1024+z+A]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(M)){var k=f(M);for(A=0;A<3;++A)k[A][3]=0|Math.round(k[A][3]*a[A]);v=(1024+l)/s|0;var C=[0,0,0];for(w[2]=n[2];w[2]<y[2];w[2]++)for(w[1]=n[1];w[1]<y[1];w[1]++)for(w[0]=n[0];w[0]<y[0];w[0]++){for(A=0;A<3;++A)C[A]=w[u]*k[A][0]+w[m]*k[A][1]+w[p]*k[A][2]+k[A][3];this.grid.set_grid_value(C[0],C[1],C[2],g*_[v]+b),v++}}}},u.prototype.from_dsn6=function(e){var t=new Uint8Array(e),r=new Int16Array(t.buffer);if(100!==r[18])for(var o=r.length,s=0;s<o;s++){var n=r[s];r[s]=(255&n)<<8|n>>8&255}if(100!==r[18])throw Error("Endian swap failed");var a=[r[0],r[1],r[2]],l=[r[3],r[4],r[5]],h=[r[6],r[7],r[8]],d=1/r[17];this.unit_cell=new i(d*r[9],d*r[10],d*r[11],d*r[12],d*r[13],d*r[14]),this.grid=new c(h);for(var u=r[15]/100,f=r[16],m=512,p=[Math.ceil(l[0]/8),Math.ceil(l[1]/8),Math.ceil(l[2]/8)],_=0;_<p[2];_++)for(var v=0;v<p[1];v++)for(var g=0;g<p[0];g++)for(var b=0;b<8;b++)for(var y=8*_+b,w=0;w<8;w++)for(var x=8*v+w,z=0;z<8;z++){var A=8*g+z;if(!(A<l[0]&&x<l[1]&&y<l[2])){m+=8-z;break}var M=(t[m]-f)/u;m++,this.grid.set_grid_value(a[0]+A,a[1]+x,a[2]+y,M)}this.calculate_stddev(this.grid.values,0)},u.prototype.show_debug_info=function(){console.log("unit cell: "+this.unit_cell.parameters.join(", ")),console.log("grid: "+this.grid.dim)},u.prototype.extract_block=function(e,t){var i=this.grid,r=this.unit_cell,o=[0,0,0],s=i.dim;if(t){var n=[t[0]-e,t[1]-e,t[2]-e],a=[t[0]+e,t[1]+e,t[2]+e],l=r.fractionalize(n),h=r.fractionalize(a);o=i.frac2grid(l),s=i.frac2grid(h)}for(var c=s[0]-o[0]+1,d=s[1]-o[1]+1,u=s[2]-o[2]+1,f=[],m=[],p=o[0];p<=s[0];p++)for(var _=o[1];_<=s[1];_++)for(var v=o[2];v<=s[2];v++){var g=i.grid2frac(p,_,v),b=r.orthogonalize(g);f.push(b);var y=i.get_grid_value(p,_,v);m.push(y)}this.block={points:f,values:m,size:[c,d,u]}},u.prototype.isomesh_in_block=function(e,t){var i=this.abs_level(e),r=this.block;return h(r.size,r.values,r.points,i,t)};var $=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]],J=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / size;","}"].join("\n"),ee=["attribute vec3 other;","attribute float side;","uniform vec2 size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / size;","}"].join("\n"),te=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),ie=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),re=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),oe=["uniform vec3 ucolor;","uniform vec3 fogColor;","varying vec4 vcolor;","void main() {","  vec2 scale = vec2(projectionMatrix[0][0], projectionMatrix[1][1]);","  float z = position.z;","  float fogFactor = (z > 0.5 ? 0.2 : 0.7);","  float alpha = 0.8 * smoothstep(z > 1.5 ? -10.0 : 0.01, 0.1, scale.y);","  vcolor = vec4(mix(ucolor, fogColor, fogFactor), alpha);","  gl_Position = vec4(position.xy * scale, -0.99, 1.0);","}"].join("\n"),se=["varying vec4 vcolor;","void main() {","  gl_FragColor = vcolor;","}"].join("\n");E.prototype.make_line=function(e,i,r){var o=g(e,r),s=b(i,r);if(this.use_gl_lines){var n=new t.BufferGeometry,a=z(o);n.addAttribute("position",new t.BufferAttribute(a,3));var l=x(s);return n.addAttribute("color",new t.BufferAttribute(l,3)),new t.Line(n,this.material)}var h=new t.Mesh(_(o,s),this.material);return h.drawMode=t.TriangleStripDrawMode,h.raycast=F,h},E.prototype.make_line_segments=function(e){if(this.use_gl_lines)return new t.LineSegments(e,this.material);var i=e.vertices,r=e.colors,o=new t.Mesh(v(i,r),this.material);return o.raycast=F,o};var ne=["uniform float size;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = size;","}"].join("\n"),ae=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),le=new t.Matrix4,he=new t.Ray,ce=["uniform vec2 canvas_size;","uniform vec2 win_size;","varying vec2 vUv;","void main() {","  vUv = uv;","  vec2 rel_offset = vec2(0.02, -0.3);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_Position.xy += (uv + rel_offset) * 2.0 * canvas_size / win_size;","  gl_Position.z += 1.0 * projectionMatrix[2][2];","}"].join("\n"),de=["#include <fog_pars_fragment>","varying vec2 vUv;","uniform sampler2D map;","void main() {","  gl_FragColor = texture2D(map, vUv);","#include <fog_fragment>","}"].join("\n"),ue=[{name:"coot dark",bg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,cell_box:16777215,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,cell_box:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,cell_box:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,cell_box:0,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}],fe=1,me={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},pe=function(e,i){function r(e){g=Math.max(g+e,.01)}function o(i){var r=new t.Quaternion;r.setFromUnitVectors(c,h),i.applyQuaternion(r),e.up.applyQuaternion(r),c.applyQuaternion(r),h.copy(c)}function s(t){var o=u.x-d.x,s=u.y-d.y;l===me.ZOOM?e.zoom/=1-o+s:l===me.SLAB?(r(10*o),i.addScaledVector(t,-5/t.length()*s)):l===me.ROLL&&e.up.applyAxisAngle(t,.05*(o-s)),d.copy(u)}function n(t){var r=_.x-p.x,o=_.y-p.y;r*=.5*(e.right-e.left)/e.zoom,o*=.5*(e.bottom-e.top)/e.zoom;var s=t.clone().cross(e.up).setLength(r);s.addScaledVector(e.up,o/e.up.length()),e.position.add(s),i.add(s),p.copy(_)}function a(t){h.copy(t).normalize();var i=Date.now(),r=null!==y?i-y:16.7,o=18e-6*r*fe;y=i,b===!0?o=-o:b!==!1&&(b+=.02,o=4e-5*fe*Math.cos(b)),c.crossVectors(e.up,t).multiplyScalar(o).add(h)}var l=me.NONE,h=new t.Vector3,c=new t.Vector3,d=new t.Vector2,u=new t.Vector2,f=0,m=0,p=new t.Vector2,_=new t.Vector2,v=!0,g=10,b=null,y=null,w=null;this.toggle_auto=function(e){l===me.AUTO_ROTATE&&typeof e==typeof b?l=me.NONE:(l=me.AUTO_ROTATE,y=null,b=e)},this.is_going=function(){return l===me.GO},this.is_moving=function(){return l!==me.NONE},this.update=function(){var t=!1,r=e.position.clone().sub(i);return l===me.AUTO_ROTATE&&a(r),h.equals(c)||(o(r),t=!0),m!==f&&(e.zoom*=m/f,f=m,t=!0),u.equals(d)||(s(r),t=!0),_.equals(p)||(n(r),v=!0,t=!0),e.position.addVectors(i,r),l===me.GO&&w&&(w(),t=!0),e.lookAt(i),t},this.start=function(e,t,i,r){switch(l!==me.NONE&&l!==me.AUTO_ROTATE||(l=e),this.move(t,i,r),l){case me.ROTATE:h.copy(c);break;case me.ZOOM:case me.SLAB:case me.ROLL:d.copy(u);break;case me.PAN:p.copy(_),v=!1;break;case me.PAN_ZOOM:f=m,p.copy(_)}},this.move=function(t,r,o){switch(l){case me.ROTATE:var s=T(t,r),n=e.position.clone().sub(i);c.crossVectors(e.up,n).setLength(s[0]),c.addScaledVector(e.up,s[1]/e.up.length()),c.addScaledVector(n,s[2]/n.length());break;case me.ZOOM:case me.SLAB:case me.ROLL:u.set(t,r);break;case me.PAN:_.set(t,r);break;case me.PAN_ZOOM:_.set(t,r),m=o}},this.stop=function(){var e=null;return l!==me.PAN||v||(e=p),l=me.NONE,h.copy(c),f=m,p.copy(_),e},this.slab_width=function(){return g},this.change_slab_width=r,this.go_to=function(r,o,s,n){if(r instanceof Array&&(r=new t.Vector3(r[0],r[1],r[2])),r&&!(r.distanceToSquared(i)<.1)||o&&!(o.distanceToSquared(e.position)<.1)||s&&!(s.distanceToSquared(e.up)<.1)){l=me.GO,n=n||60/fe;for(var a=[],h=0,c=1;c<=n;++c){var d=c/n;d=d<.5?2*d*d:-2*d*(d-2)-1,a.push((d-h)/(1-h)),h=d}w=function(){var t=a.shift();r&&(o||e.position.sub(i),i.lerp(r,t),o||e.position.add(i)),o&&e.position.lerp(o,t),s&&e.up.lerp(s,t),0===a.length&&(l=me.NONE,w=null)}}}},_e=["element","B-factor","occupancy","index","chain"],ve=["lines","trace","ribbon"],ge=["marching cubes","squarish"],be=["normal","simplistic"],ye=["bold 14px","14px","16px","bold 16px"];B.prototype.get_visible_atoms=function(){var e=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return e;for(var t=[],i=0;i<e.length;i++)"H"!==e[i].element&&t.push(e[i]);return t},B.prototype.add_bonds=function(e,i){for(var r=this.get_visible_atoms(),o=e?"element":this.conf.color_aim,s=R(o,r,this.conf.colors),n=new t.Geometry,a={hydrogens:this.conf.hydrogens,ligands_only:e,balls:"ball&stick"===this.conf.render_style},l=0;l<r.length;l++){var h=r[l],c=s[l];if(!e||h.is_ligand)if(0!==h.bonds.length||a.balls)for(var d=0;d<h.bonds.length;d++){var u=this.model.atoms[h.bonds[d]];if((a.hydrogens||"H"!==u.element)&&(!a.ligands_only||u.is_ligand)){var f=h.midpoint(u),m=new t.Vector3(f[0],f[1],f[2]),p=new t.Vector3(h.xyz[0],h.xyz[1],h.xyz[2]);if(a.balls){var _=p.distanceTo(m)/i;p.lerp(m,_)}n.vertices.push(p,m),n.colors.push(c,c)}}else P(n,h,c)}var v=j(this.conf.bond_line,this.win_size),g="simplistic"===this.conf.line_style,b=new E({gl_lines:g,linewidth:v,size:this.win_size,as_segments:!0});this.atomic_objects.push(b.make_line_segments(n)),a.balls?this.atomic_objects.push(L(r,s,i)):g||e||this.atomic_objects.push(L(r,s,v))},B.prototype.add_trace=function(e){for(var t=this.model.extract_trace(),i=[].concat.apply([],t),r=R(this.conf.color_aim,i,this.conf.colors),o=new E({gl_lines:"simplistic"===this.conf.line_style,linewidth:j(this.conf.bond_line,this.win_size),size:this.win_size}),s=0,n=0;n<t.length;n++){var a=t[n],l=r.slice(s,s+a.length);s+=a.length;var h=o.make_line(a,l,e);this.atomic_objects.push(h)}},B.prototype.add_ribbon=function(e){for(var t=this.model.extract_trace(),i=this.model.get_residues(),r=[].concat.apply([],t),o=R(this.conf.color_aim,r,this.conf.colors),s=0,n=0;n<t.length;n++){for(var a=t[n],l=[],h=[0,0,0],c=0;c<a.length;c++){var d=i[a[c].resid()],u=this.model.calculate_tangent_vector(d);u[0]*h[0]+u[1]*h[1]+u[2]*h[2]<0&&(u[0]=-u[0],u[1]=-u[1],u[2]=-u[2]),l.push(u),h=u}var f=o.slice(s,s+a.length);s+=a.length;var m=M(a,f,l,e);this.atomic_objects.push(m)}},N.prototype.pick_atom=function(e,t){var i=this.active_model_bag;if(null!==i){this.raycaster.setFromCamera(e,t),this.raycaster.near=t.near,this.raycaster.far=t.far-.15*(t.far-t.near),this.raycaster.linePrecision=.3;var r=this.raycaster.intersectObjects(i.atomic_objects);if(r.length<1)return null;r.sort(function(e){return e.line_dist||1/0});var o=r[0].point;return i.model.get_nearest_atom(o.x,o.y,o.z)}},N.prototype.set_colors=function(e){if(null==e)e=ue[0];else if("number"==typeof e)e=ue[e%ue.length];else if("string"==typeof e)for(var i=0;i!==ue.length;i++)if(ue[i].name===e){e=ue[i];break}if(void 0!==e.bg){if("number"==typeof e.bg)for(var r in e)"name"!==r&&(e[r]=new t.Color(e[r]));this.decor.zoom_grid.color_value.set(e.cell_box),this.redraw_all()}},N.prototype.relX=function(e){return 2*(e.pageX-this.window_offset[0])/this.window_size[0]-1},N.prototype.relY=function(e){return 1-2*(e.pageY-this.window_offset[1])/this.window_size[1]},N.prototype.hud=function(e,t){if("undefined"!=typeof document){var i=this.hud_el;if(i){void 0!==e?"HTML"===t?i.innerHTML=e:i.textContent=e:i.innerHTML=this.initial_hud_html;var r="ERR"===t;i.style["background-color"]=r?"#b00":this.initial_hud_bg,r&&console.log("ERR: "+e)}else console.log("hud: "+e)}},N.prototype.redraw_center=function(){this.target.distanceToSquared(this.last_ctr)>1e-4&&(this.last_ctr.copy(this.target),this.mark&&this.scene.remove(this.mark),this.mark=m(.1,this.target,this.config.colors.center),this.scene.add(this.mark))},N.prototype.redraw_maps=function(e){this.redraw_center();for(var t=0;t<this.map_bags.length;t++){var i=this.map_bags[t];(e||this.target.distanceToSquared(i.block_ctr)>.01)&&this.redraw_map(i)}},N.prototype.remove_and_dispose=function(e,t){t||this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(e.material.uniforms&&e.material.uniforms.map&&e.material.uniforms.map.value.dispose(),e.material.dispose());for(var i=0;i<e.children.length;i++)this.remove_and_dispose(e.children[i])},N.prototype.clear_el_objects=function(e){for(var t=0;t<e.el_objects.length;t++)this.remove_and_dispose(e.el_objects[t]);e.el_objects=[]},N.prototype.clear_atomic_objects=function(e){if(e.atomic_objects)for(var t=0;t<e.atomic_objects.length;t++)this.remove_and_dispose(e.atomic_objects[t]);e.atomic_objects=null},N.prototype.set_atomic_objects=function(e){switch(e.atomic_objects=[],e.conf.render_style){case"lines":e.add_bonds();break;case"ball&stick":var t=this.camera.projectionMatrix.elements[5],i=Math.max(1,200*t);e.add_bonds(!1,i);break;case"trace":e.add_trace(),e.add_bonds(!0);break;case"ribbon":e.add_ribbon(8),e.add_bonds(!0)}for(var r=0;r<e.atomic_objects.length;r++)this.scene.add(e.atomic_objects[r])},N.prototype.toggle_label=function(e,t){if(e){var i=e.short_label(),r=i,o=r in this.labels;if(void 0===t&&(t=!o),t){if(o)return;var s=S(i,{pos:e.xyz,font:this.config.label_font,color:"#"+this.config.colors.cell_box.getHexString(),win_size:this.window_size});if(!s)return;this.labels[r]=s,this.scene.add(s)}else{if(!o)return;this.remove_and_dispose(this.labels[r]),delete this.labels[r]}}},N.prototype.redraw_labels=function(){for(var e in this.labels){var t=e;this.labels[e].remake(t,{font:this.config.label_font,color:"#"+this.config.colors.cell_box.getHexString()})}},N.prototype.toggle_map_visibility=function(e){"number"==typeof e&&(e=this.map_bags[e]),e.visible=!e.visible,this.redraw_map(e),this.request_render()},N.prototype.redraw_map=function(e){this.clear_el_objects(e),e.visible&&(e.map.block=null,this.add_el_objects(e))},N.prototype.toggle_model_visibility=function(e){e=e||this.active_model_bag,e.visible=!e.visible,this.redraw_model(e),this.request_render()},N.prototype.redraw_model=function(e){this.clear_atomic_objects(e),e.visible&&this.set_atomic_objects(e)},N.prototype.redraw_models=function(){for(var e=0;e<this.model_bags.length;e++)this.redraw_model(this.model_bags[e])},N.prototype.add_el_objects=function(e){if(e.visible&&!(this.config.map_radius<=0)){e.map.block||(e.block_ctr.copy(this.target),e.map.extract_block(this.config.map_radius,[this.target.x,this.target.y,this.target.z]));for(var t=0;t<e.types.length;t++){var i=e.types[t],r=("map_neg"===i?-1:1)*e.isolevel,o=e.map.isomesh_in_block(r,this.config.map_style),s=k(o,{color:this.config.colors[i],linewidth:this.config.map_line});e.el_objects.push(s),this.scene.add(s)}}},N.prototype.change_isolevel_by=function(e,t){if(!(e>=this.map_bags.length)){var i=this.map_bags[e];i.isolevel+=t,this.clear_el_objects(i),this.add_el_objects(i);var r=i.map.abs_level(i.isolevel),o=r.toFixed(4),s=this.tied_viewer;if(s&&e<s.map_bags.length){var n=s.map_bags[e];n.isolevel=i.isolevel,o+=" / "+n.map.abs_level(n.isolevel).toFixed(4),s.clear_el_objects(n),s.add_el_objects(n)}this.hud("map "+(e+1)+" level =  "+o+" e/Å³ ("+i.isolevel.toFixed(2)+" rmsd)")}},N.prototype.change_map_radius=function(e){var t=40,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+e,0),t);var r='map "radius": '+i.map_radius;i.map_radius===t?r+=" (max)":0===i.map_radius&&(r+=" (hidden maps)"),this.hud(r),this.redraw_maps(!0)},N.prototype.change_slab_width_by=function(e){this.controls.change_slab_width(e),this.update_camera(),this.hud("clip width: "+(this.camera.far-this.camera.near).toFixed(1))},N.prototype.change_zoom_by_factor=function(e){this.camera.zoom*=e,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toFixed(2))},N.prototype.toggle_full_screen=function(){var e=document;if(e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement){var t=e.exitFullscreen||e.webkitExitFullscreen||e.mozCancelFullScreen||e.msExitFullscreen;t&&t.call(e)}else{var i=this.container,r=i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen;r&&r.call(i)}},N.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var e=null;this.model_bags.length>0&&(e=this.model_bags[0].model.unit_cell),!e&&this.map_bags.length>0&&(e=this.map_bags[0].map.unit_cell),e&&(this.decor.cell_box=p(e.orthogonalize,this.config.colors.cell_box),this.scene.add(this.decor.cell_box))}},N.prototype.shift_clip=function(e){var t=this.camera.position.clone().sub(this.target).setLength(1);e||t.negate(),this.target.add(t),this.camera.position.add(t),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+H(t,2).join(" ")+"]")},N.prototype.go_to_nearest_Ca=function(){var e=this.target;if(null!==this.active_model_bag){var t=this.active_model_bag.model.get_nearest_atom(e.x,e.y,e.z,"CA");t?this.select_atom(t):this.hud("no nearby CA")}},N.prototype.permalink=function(){"undefined"!=typeof window&&(window.location.hash="#xyz="+H(this.target,1).join(",")+"&eye="+H(this.camera.position,1).join(",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar"))},N.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0),this.redraw_labels())},N.toggle_help=function(e){e&&(e.style.display="block"===e.style.display?"none":"block",""===e.innerHTML&&(e.innerHTML=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ","\n<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","Q = label font","+/- = sigma level","]/[ = map radius","D/F = clip width","numpad 3/. = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","R = center view","W = wireframe style","I = spin","K = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen",'\n<a href="https://uglymol.github.io">about uglymol</a>'].join("\n")))},N.prototype.select_next=function(e,t,i,r){var o=i.indexOf(this.config[t]),s=i.length,n=(o+(r?s-1:1))%s;this.config[t]=i[n];for(var a=e+":",l=0;l<s;l++){var h=l===n?"u":"s",c=i[l].name||i[l];a+=" <"+h+">"+c+"</"+h+">"}this.hud(a,"HTML")},N.prototype.keydown=function(e){var t=e.keyCode;switch(t){case 84:this.select_next("rendering as","render_style",ve,e.shiftKey),this.redraw_models();break;case 66:this.select_next("color scheme","colors",ue,e.shiftKey),this.set_colors(this.config.colors);break;case 67:this.select_next("coloring by","color_aim",_e,e.shiftKey),this.redraw_models();break;case 87:this.select_next("map style","map_style",ge,e.shiftKey),this.redraw_maps(!0);break;case 89:this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models();break;case 220:this.select_next("bond lines","line_style",be,e.shiftKey),this.redraw_models();break;case 107:case 61:case 187:this.change_isolevel_by(e.shiftKey?1:0,.1);break;case 109:case 173:case 189:this.change_isolevel_by(e.shiftKey?1:0,-.1);break;case 219:this.change_map_radius(-2);break;case 221:this.change_map_radius(2);break;case 68:this.change_slab_width_by(-.1);break;case 70:e.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1);break;case 77:this.change_zoom_by_factor(e.shiftKey?1.2:1.03);break;case 78:this.change_zoom_by_factor(1/(e.shiftKey?1.2:1.03));break;case 80:e.shiftKey?this.permalink():this.go_to_nearest_Ca();break;case 51:case 99:this.shift_clip(!0);break;case 108:case 110:this.shift_clip(!1);break;case 85:this.hud("toggled unit cell box"),this.toggle_cell_box();break;case 73:this.hud("toggled spinning"),this.controls.toggle_auto(e.shiftKey);break;case 75:this.hud("toggled rocking"),this.controls.toggle_auto(0);break;case 81:this.select_next("label font","label_font",ye,e.shiftKey),this.redraw_labels();break;case 82:e.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("model recentered"),this.recenter());break;case 72:N.toggle_help(this.help_el);break;case 36:case 35:e.ctrlKey?(this.config.map_line+=36===t?.1:-.1,this.config.map_line=Math.max(this.config.map_line,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))):(this.config.bond_line+=36===t?.2:-.2,this.config.bond_line=Math.max(this.config.bond_line,.1),this.redraw_models(),this.hud("bond width: "+j(this.config.bond_line,this.window_size).toFixed(1)));break;case 16:case 17:case 18:case 225:break;case 32:this.center_next_residue(e.shiftKey);break;case 191:case 222:e.preventDefault();default:this.help_el&&this.hud("Nothing here. Press H for help.")}this.request_render()},N.prototype.mousedown=function(e){e.stopPropagation(),document.addEventListener("mouseup",this.mouseup),document.addEventListener("mousemove",this.mousemove);var t=me.NONE;1===e.button||0===e.button&&e.ctrlKey?t=me.PAN:0===e.button?(e.shiftKey&&this.dblclick(e),t=me.ROTATE):2===e.button&&(e.ctrlKey?t=e.shiftKey?me.ROLL:me.SLAB:(this.decor.zoom_grid.visible=!0,t=me.ZOOM)),this.controls.start(t,this.relX(e),this.relY(e)),this.request_render()},N.prototype.dblclick=function(e){if(0===e.button){this.decor.selection&&(this.remove_and_dispose(this.decor.selection),this.decor.selection=null);var i=new t.Vector2(this.relX(e),this.relY(e)),r=this.pick_atom(i,this.camera);if(r){this.hud(r.long_label()),this.toggle_label(r);var o=this.config.colors[r.element]||this.config.colors.def,s=2.5*j(this.config.bond_line,this.window_size);this.decor.selection=L([r],[o],s),this.scene.add(this.decor.selection)}else this.hud();this.request_render()}},N.prototype.touchstart=function(e){var t=e.touches;if(1===t.length)this.controls.start(me.ROTATE,this.relX(t[0]),this.relY(t[0]));else{var i=U(e);this.controls.start(me.PAN_ZOOM,this.relX(i),this.relY(i),i.dist)}this.request_render()},N.prototype.touchmove=function(e){e.preventDefault(),e.stopPropagation();var t=e.touches;if(1===t.length)this.controls.move(this.relX(t[0]),this.relY(t[0]));else{var i=U(e);this.controls.move(this.relX(i),this.relY(i),i.dist)}},N.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},N.prototype.mousewheel=function(e){e.preventDefault(),e.stopPropagation();var t=e.wheelDelta?e.wheelDelta/2e3:(e.detail||0)/-1e3;this.change_isolevel_by(e.shiftKey?1:0,t),this.request_render()},N.prototype.resize=function(){var e=this.container,t=e.clientWidth,i=e.clientHeight;this.window_offset[0]=e.offsetLeft,this.window_offset[1]=e.offsetTop,this.camera.left=-t,this.camera.right=t,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,i),t===this.window_size[0]&&i===this.window_size[1]||(this.window_size[0]=t,this.window_size[1]=i,this.redraw_models()),this.request_render()},N.prototype.recenter=function(e,i,r){var o,s=this.active_model_bag;if(null!=e&&null==i&&null!==s){e=new t.Vector3(e[0],e[1],e[2]);var n=s.model.get_center(),a=new t.Vector3(e[0]-n[0],e[1]-n[1],e[2]-n[2]);a.setLength(100),o=a.y<90?new t.Vector3(0,1,0):new t.Vector3(1,0,0),o.projectOnPlane(a).normalize(),i=a.add(e)}else e=e||(s?s.model.get_center():[0,0,0]),null!=i?(i=new t.Vector3(i[0],i[1],i[2]),o=null):(i=new t.Vector3(e[0],e[1],e[2]+100),o=t.Object3D.DefaultUp);this.controls.go_to(e,i,o,r)},N.prototype.center_next_residue=function(e){if(this.active_model_bag){var t=this.active_model_bag.model.next_residue(this.selected_atom,e);t&&this.select_atom(t)}},N.prototype.select_atom=function(e,t){t=t||{},this.hud("-> "+e.long_label());var i=t.steps||30/fe;this.controls.go_to(e.xyz,null,null,i),this.toggle_label(this.selected_atom),this.selected_atom=e,this.toggle_label(e)},N.prototype.update_camera=function(){var e=this.camera.position.distanceTo(this.target),t=.25*this.controls.slab_width()/this.camera.zoom;this.camera.near=e*(1-t),this.camera.far=e*(1+3*t),this.camera.updateProjectionMatrix()},N.prototype.render=function(){if(this.scheduled=!0,null!==this.renderer){this.controls.update()&&this.update_camera();var e=this.tied_viewer;this.controls.is_going()||(this.redraw_maps(),e&&!e.scheduled&&e.redraw_maps()),this.renderer.render(this.scene,this.camera),e&&!e.scheduled&&e.renderer.render(e.scene,e.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update()}},N.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},N.prototype.set_model=function(e){var t=new B(e,this.config,this.window_size);this.model_bags.push(t),this.set_atomic_objects(t),this.active_model_bag=t,this.request_render()},N.prototype.add_map=function(e,t){var i=new V(e,t);this.map_bags.push(i),this.add_el_objects(i),this.request_render()},N.prototype.load_file=function(e,t,i,r){if(null!==this.renderer){var o=new XMLHttpRequest;o.open("GET",e,!0),t?o.responseType="arraybuffer":o.overrideMimeType("text/plain");var s=this;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status&&null!==o.response)try{i(o)}catch(t){s.hud("Error: "+t.message+"\nin "+e,"ERR")}else s.hud("Failed to fetch "+e,"ERR")},r&&o.addEventListener("progress",function(t){if(t.lengthComputable&&t.loaded&&t.total){var i=e.split("/").pop();s.hud("loading "+i+" ... "+(t.loaded>>10)+" / "+(t.total>>10)+" kB")}});try{o.send(null)}catch(t){s.hud("loading "+e+" failed:\n"+t,"ERR")}}},N.prototype.load_pdb=function(e,t){t=t||{};var i=this;this.load_file(e,!1,function(e){var o=new r;o.from_pdb(e.responseText),i.set_model(o);var s=G();s.zoom&&(i.camera.zoom=s.zoom),i.recenter(t.center||s.xyz,s.eye,1),t.callback&&t.callback()})},N.prototype.load_map=function(e,t,i,r,o){if("ccp4"!==i&&"dsn6"!==i)throw Error("Unknown map filetype.");var s=this;this.load_file(e,!0,function(e){var o=new u;"ccp4"===i?o.from_ccp4(e.response,!0):o.from_dsn6(e.response),s.add_map(o,t),r&&r()},o)},N.prototype.load_ccp4_maps=function(e,t,i){var r=this;this.load_map(e,!1,"ccp4",function(){r.load_map(t,!0,"ccp4",function(){r.hud(),i&&i()},!0)},!0)},N.prototype.load_pdb_and_ccp4_maps=function(e,t,i,r){var o=this;this.load_pdb(e,{callback:function(){o.load_ccp4_maps(t,i,r)}})},N.ColorSchemes=ue,N.auto_speed=fe,e.UnitCell=i,e.Model=r,e.isosurface=h,e.ElMap=u,e.makeCentralCube=m,e.makeRgbBox=p,e.makeRibbon=M,e.makeChickenWire=k,e.makeGrid=C,e.LineFactory=E,e.makeWheels=L,e.makeLabel=S,e.Viewer=N,Object.defineProperty(e,"__esModule",{value:!0})});