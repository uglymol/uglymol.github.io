!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.UM={})}(this,function(t){"use strict";var e=t.VERSION="0.5.8",z=function(t,e,i,r,n,o){if(t<=0||e<=0||i<=0||r<=0||n<=0||o<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[t,e,i,r,n,o];var s=Math.PI/180,a=Math.cos(s*r),l=Math.cos(s*n),h=Math.cos(s*o),c=Math.sin(s*r),u=Math.sin(s*n),d=Math.sin(s*o);if(0===c||0===u||0===d)throw Error("Impossible angle - N*180deg.");var f=(l*h-a)/d,p=f/u,m=Math.sqrt(1-p*p);this.orth=[t,e*h,i*l,0,e*d,-i*f,0,0,i*u*m],this.frac=[1/t,-h/(d*t),-(h*f+l*d)/(u*m*d*t),0,1/(d*e),p/(m*d*e),0,0,1/(u*m*i)]};function i(t,e){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],+e[4]*t[1]+e[5]*t[2],+e[8]*t[2]]}z.prototype.fractionalize=function(t){return i(t,this.frac)},z.prototype.orthogonalize=function(t){return i(t,this.orth)};var o=["HOH"].concat(["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"]);function s(t){for(var e=[new n],i=e[0].from_pdb(t.split("\n"));null!=i;){var r=new n;i=r.from_pdb(i),0<r.atoms.length&&e.push(r)}return e}var n=function(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=[0,0,0],this.upper_bound=[0,0,0],this.residue_map=null,this.cubes=null};n.prototype.from_pdb=function(t){for(var e=0,i=null,r=0,n=null,o=0;o<t.length;o++){var s=t[o],a=s.substring(0,6).toUpperCase();if("ATOM  "===a||"HETATM"===a){var l=new m;l.from_pdb_line(s),l.i_seq=r++,this.has_hydrogens||"H"!==l.element||(this.has_hydrogens=!0),l.chain!==i&&e++,l.chain_index=e,i=l.chain,this.atoms.push(l)}else if("ANISOU"===a);else if("CRYST1"===a){var h=parseFloat(s.substring(6,15)),c=parseFloat(s.substring(15,24)),u=parseFloat(s.substring(24,33)),d=parseFloat(s.substring(33,40)),f=parseFloat(s.substring(40,47)),p=parseFloat(s.substring(47,54));this.unit_cell=new z(h,c,u,d,f,p)}else if("TER"===a.substring(0,3))i=null;else if("ENDMDL"===a){for(;o<t.length;o++)if("MODEL "===t[o].substring(0,6).toUpperCase()){n=t.slice(o);break}break}}if(0===this.atoms.length)throw Error("No atom records found.");return this.calculate_bounds(),this.calculate_connectivity(),n},n.prototype.calculate_bounds=function(){for(var t=this.lower_bound=[1/0,1/0,1/0],e=this.upper_bound=[-1/0,-1/0,-1/0],i=0;i<this.atoms.length;i++)for(var r=this.atoms[i],n=0;n<3;n++){var o=r.xyz[n];o<t[n]&&(t[n]=o),o>e[n]&&(e[n]=o)}for(var s=0;s<3;++s)t[s]-=.001,e[s]+=.001},n.prototype.next_residue=function(t,e){for(var i=this.atoms.length,r=(t?t.i_seq:0)+i,n=t?1:0;n<i;n++){var o=(r+(e?-n:n))%i,s=this.atoms[o];if(s.is_main_conformer()&&("CA"===s.name&&"C"===s.element||"P"===s.name))return s}},n.prototype.extract_trace=function(){for(var t=[],e=[],i=null,r=0;r<this.atoms.length;r++){var n=this.atoms[r];if((""===n.altloc||"A"===n.altloc)&&("CA"===n.name&&"C"===n.element||"P"===n.name)){var o=!0;if(null!==i&&i.chain_index===n.chain_index){var s=n.distance_sq(i);("CA"===n.name&&s<=30.25||"P"===n.name&&s<56.25)&&(e.push(n),o=!1)}o&&(2<e.length&&t.push(e),e=[n]),i=n}}return 2<e.length&&t.push(e),t},n.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var t={},e=0;e<this.atoms.length;e++){var i=this.atoms[e],r=i.resid(),n=t[r];void 0===n?t[r]=[i]:n.push(i)}return this.residue_map=t},n.prototype.calculate_tangent_vector=function(t){for(var e=null,i=null,r=3===t[0].resname.length,n=r?"C":"C2'",o=r?"O":"O4'",s=0;s<t.length;s++){var a=t[s];a.is_main_conformer()&&(a.name===n?e=a.xyz:a.name===o&&(i=a.xyz))}if(null===e||null===i)return[0,0,1];var l=[e[0]-i[0],e[1]-i[1],e[2]-i[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},n.prototype.get_center=function(){for(var t=0,e=0,i=0,r=this.atoms.length,n=0;n<r;n++){var o=this.atoms[n].xyz;t+=o[0],e+=o[1],i+=o[2]}return[t/r,e/r,i/r]},n.prototype.calculate_connectivity=function(){for(var t=this.atoms,e=new h(t,3,this.lower_bound,this.upper_bound),i=0;i<e.boxes.length;i++){var r=e.boxes[i];if(0!==r.length)for(var n=e.get_nearby_atoms(i),o=0;o<r.length;o++)for(var s=r[o],a=0;a<n.length;a++){var l=n[a];s<l&&t[s].is_bonded_to(t[l])&&(t[s].bonds.push(l),t[l].bonds.push(s))}}this.cubes=e},n.prototype.get_nearest_atom=function(t,e,i,r){var n=this.cubes;if(null==n)throw Error("Missing Cubicles");for(var o=n.find_box_id(t,e,i),s=n.get_nearby_atoms(o),a=null,l=1/0,h=0;h<s.length;h++){var c=this.atoms[s[h]];if(null==r||r===c.name){var u=c.xyz[0]-t,d=c.xyz[1]-e,f=c.xyz[2]-i,p=u*u+d*d+f*f;p<l&&(a=c,l=p)}}return a};var m=function(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=-1,this.resseq=-1,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.i_seq=-1,this.is_ligand=null,this.bonds=[]};m.prototype.from_pdb_line=function(t){if(t.length<66)throw Error("ATOM or HETATM record is too short: "+t);var e=t.substring(0,6);if("HETATM"===e)this.hetero=!0;else if("ATOM  "!==e)throw Error("Wrong record type: "+e);this.name=t.substring(12,16).trim(),this.altloc=t.substring(16,17).trim(),this.resname=t.substring(17,20).trim(),this.chain=t.substring(20,22).trim(),this.resseq=parseInt(t.substring(22,26),10),this.icode=t.substring(26,27).trim();var i=parseFloat(t.substring(30,38)),r=parseFloat(t.substring(38,46)),n=parseFloat(t.substring(46,54));this.xyz=[i,r,n],this.occ=parseFloat(t.substring(54,60)),this.b=parseFloat(t.substring(60,66)),78<=t.length&&(this.element=t.substring(76,78).trim().toUpperCase()),this.is_ligand=-1===o.indexOf(this.resname)},m.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},m.prototype.distance_sq=function(t){var e=this.xyz[0]-t.xyz[0],i=this.xyz[1]-t.xyz[1],r=this.xyz[2]-t.xyz[2];return e*e+i*i+r*r},m.prototype.distance=function(t){return Math.sqrt(this.distance_sq(t))},m.prototype.midpoint=function(t){return[(this.xyz[0]+t.xyz[0])/2,(this.xyz[1]+t.xyz[1])/2,(this.xyz[2]+t.xyz[2])/2]},m.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},m.prototype.is_ion=function(){return this.element===this.resname},m.prototype.is_water=function(){return"HOH"===this.resname},m.prototype.is_same_residue=function(t,e){return t.resseq===this.resseq&&t.icode===this.icode&&t.chain===this.chain&&t.resname===this.resname&&(e||t.altloc===this.altloc)},m.prototype.is_same_conformer=function(t){return""===this.altloc||""===t.altloc||this.altloc===t.altloc},m.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},m.prototype.bond_radius=function(){return"H"===this.element?1.3:"S"===this.element||"P"===this.element?2.43:1.99},m.prototype.is_bonded_to=function(t){if(!this.is_same_conformer(t))return!1;var e=this.distance_sq(t);return!(2.2*2.2<e)&&(("H"!==this.element||"H"!==t.element)&&e<=this.bond_radius()*t.bond_radius())},m.prototype.resid=function(){return this.resseq+"/"+this.chain},m.prototype.long_label=function(){var t=this;return t.name+" /"+t.resseq+" "+t.resname+"/"+t.chain+" - occ: "+t.occ.toFixed(2)+" bf: "+t.b.toFixed(2)+" ele: "+t.element+" pos: ("+t.xyz[0].toFixed(2)+","+t.xyz[1].toFixed(2)+","+t.xyz[2].toFixed(2)+")"},m.prototype.short_label=function(){return this.name+" /"+this.resseq+" "+this.resname+"/"+this.chain};var h=function(t,e,i,r){this.boxes=[],this.box_length=e,this.lower_bound=i,this.upper_bound=r,this.xdim=Math.ceil((r[0]-i[0])/e),this.ydim=Math.ceil((r[1]-i[1])/e),this.zdim=Math.ceil((r[2]-i[2])/e);for(var n=this.xdim*this.ydim*this.zdim,o=0;o<n;o++)this.boxes.push([]);for(var s=0;s<t.length;s++){var a=t[s].xyz,l=this.find_box_id(a[0],a[1],a[2]);if(null===l)throw Error("wrong cubicle");this.boxes[l].push(s)}};h.prototype.find_box_id=function(t,e,i){var r=Math.floor((t-this.lower_bound[0])/this.box_length),n=Math.floor((e-this.lower_bound[1])/this.box_length),o=(Math.floor((i-this.lower_bound[2])/this.box_length)*this.ydim+n)*this.xdim+r;if(o<0||o>=this.boxes.length)throw Error("Ups!");return o},h.prototype.get_nearby_atoms=function(t){var e=[],i=this.xdim*this.ydim,r=Math.max(t%i,0),n=Math.max(r%this.xdim,0),o=Math.floor(r/this.xdim),s=Math.floor(t/i);console.assert(s*i+o*this.xdim+n===t);for(var a=n-1;a<=n+1;a++)if(!(a<0||a>=this.xdim))for(var l=o-1;l<=o+1;l++)if(!(l<0||l>=this.ydim))for(var h=s-1;h<=s+1;h++)if(!(h<0||h>=this.zdim)){var c=h*i+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var u=this.boxes[c],d=0;d<u.length;d++)e.push(u[d])}return e};var r=function(){this._points=null,this._values=null,this._size=[0,0,0]};r.prototype.set=function(t,e,i){if(i[0]<=0||i[1]<=0||i[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var r=i[0]*i[1]*i[2];if(e.length!==r||t.length!==r)throw Error("isosurface: array size mismatch");this._points=t,this._values=e,this._size=i},r.prototype.clear=function(){this._points=null,this._values=null},r.prototype.empty=function(){return null===this._values},r.prototype.isosurface=function(t,e){return function(t,e,i,r,n){var o="snapped MC"===n,s="squarish"===n?P:F,a=new Array(12),l=function(t){for(var e=[],i=0;i<8;++i){var r=C[i];e.push(r[0]+t[2]*(r[1]+t[1]*r[2]))}return e}(t),h=new Float32Array(8),c=[0,0,0],u=[c,c,c,c,c,c,c,c],d=t[0],f=t[1],p=t[2];if(null==e||null==i)return;for(var m=[],_=[],g=0,v=0;v<d-1;v++)for(var y=0;y<f-1;y++)for(var b=0;b<p-1;b++){var x=b+p*(y+f*v),w=0,E=void 0,A=void 0;for(E=0;E<8;++E)A=x+l[E],w|=e[A]<r?1<<E:0;if(0!==w&&255!==w){for(E=0;E<8;++E)A=x+l[E],h[E]=e[A],u[E]=i[A];var T=L[w];for(E=0;E<12;++E)if(0!=(T&1<<E)){var M=U[E],S=(r-h[M[0]])/(h[M[1]]-h[M[0]]);!0===o&&(.85<S?S=1:S<.15&&(S=0));var R=u[M[0]],z=u[M[1]];m.push(R[0]+(z[0]-R[0])*S,R[1]+(z[1]-R[1])*S,R[2]+(z[2]-R[2])*S),a[E]=g++}var O=s[w];for(E=0;E<O.length;E++)_.push(a[O[E]])}}return{vertices:m,segments:_}}(this._size,this._values,this._points,t,e)};var L=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),F=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],P=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],C=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],U=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];function a(t,e){var i=t%e;return 0<=i?i:i+e}var O=function(t){this.dim=t,this.values=new Float32Array(t[0]*t[1]*t[2])};function N(t,e){for(var i=0,r=0,n=t.length,o=e;o<n;o++)i+=t[o],r+=t[o]*t[o];var s=i/(n-e),a=r/(n-e)-s*s;return{mean:s,rms:Math.sqrt(a)}}O.prototype.grid2index=function(t,e,i){return t=a(t,this.dim[0]),e=a(e,this.dim[1]),i=a(i,this.dim[2]),this.dim[2]*(this.dim[1]*t+e)+i},O.prototype.grid2index_unchecked=function(t,e,i){return this.dim[2]*(this.dim[1]*t+e)+i},O.prototype.grid2frac=function(t,e,i){return[t/this.dim[0],e/this.dim[1],i/this.dim[2]]},O.prototype.frac2grid=function(t){return[0|Math.floor(t[0]*this.dim[0]),0|Math.floor(t[1]*this.dim[1]),0|Math.floor(t[2]*this.dim[2])]},O.prototype.set_grid_value=function(t,e,i,r){var n=this.grid2index(t,e,i);this.values[n]=r},O.prototype.get_grid_value=function(t,e,i){var r=this.grid2index(t,e,i);return this.values[r]};var l=function(){this.unit_cell=null,this.grid=null,this.stats={mean:0,rms:1},this.block=new r};function D(t){var e=t.toLowerCase().replace(/\s+/g,"").split(",");if(3!==e.length)throw Error("Unexpected symop: "+t);for(var i=[],r=0;r<3;r++){for(var n=e[r].split(/(?=[+-])/),o=[0,0,0,0],s=0;s<n.length;s++){var a="-"===n[s][0]?-1:1,l=n[s].match(/^[+-]?([xyz])$/);if(l){o[{x:0,y:1,z:2}[l[1]]]=a}else{if(!(l=n[s].match(/^[+-]?(\d)\/(\d)$/)))throw Error("What is "+n[s]+" in "+t);o[3]=a*Number(l[1])/Number(l[2])}}i.push(o)}return i}l.prototype.abs_level=function(t){return t*this.stats.rms+this.stats.mean},l.prototype.from_ccp4=function(t,e){if(void 0===e&&(e=!0),t.byteLength<1024)throw Error("File shorter than 1024 bytes.");var i=new Int32Array(t,0,256);if(542130509!==i[52])throw Error("not a CCP4 map");var r,n=[i[0],i[1],i[2]],o=i[3];if(2===o)r=4;else{if(0!==o)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");r=1}var s=[i[4],i[5],i[6]],a=[i[7],i[8],i[9]],l=i[23];if(1024+l+r*n[0]*n[1]*n[2]!==t.byteLength)throw Error("ccp4 file too short or too long");var h=new Float32Array(t,0,t.byteLength/4);this.unit_cell=new z(h[10],h[11],h[12],h[13],h[14],h[15]);var c,u=[i[16],i[17],i[18]],d=u.indexOf(1),f=u.indexOf(2),p=u.indexOf(3),m=h[19],_=h[20],g=new O(a);if(l%4!=0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");c=2===o?h:new Int8Array(t);var v=(1024+l)/r|0;this.stats.mean=h[21],this.stats.rms=h[54],(this.stats.mean<m||this.stats.mean>_||this.stats.rms<=0)&&(this.stats=N(c,v));var y=1,b=0;0===o&&-128===i[39]&&127===i[40]&&(b=.5*(m+_+(y=(_-m)/255)));var x=[s[0]+n[0],s[1]+n[1],s[2]+n[2]],w=[0,0,0];for(w[2]=s[2];w[2]<x[2];w[2]++)for(w[1]=s[1];w[1]<x[1];w[1]++)for(w[0]=s[0];w[0]<x[0];w[0]++)g.set_grid_value(w[d],w[f],w[p],y*c[v]+b),v++;if(e&&0<l)for(var E=new Uint8Array(t),A=0;A+80<=l;A+=80){var T=void 0,M="";for(T=0;T<80;++T)M+=String.fromCharCode(E[1024+A+T]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(M)){var S=D(M);for(T=0;T<3;++T)S[T][3]=0|Math.round(S[T][3]*a[T]);v=(1024+l)/r|0;var R=[0,0,0];for(w[2]=s[2];w[2]<x[2];w[2]++)for(w[1]=s[1];w[1]<x[1];w[1]++)for(w[0]=s[0];w[0]<x[0];w[0]++){for(T=0;T<3;++T)R[T]=w[d]*S[T][0]+w[f]*S[T][1]+w[p]*S[T][2]+S[T][3];g.set_grid_value(R[0],R[1],R[2],y*c[v]+b),v++}}}this.grid=g},l.prototype.from_dsn6=function(t){var e=new Uint8Array(t),i=new Int16Array(e.buffer);if(100!==i[18])for(var r=i.length,n=0;n<r;n++){var o=i[n];i[n]=(255&o)<<8|o>>8&255}if(100!==i[18])throw Error("Endian swap failed");var s=[i[0],i[1],i[2]],a=[i[3],i[4],i[5]],l=[i[6],i[7],i[8]],h=1/i[17];this.unit_cell=new z(h*i[9],h*i[10],h*i[11],h*i[12],h*i[13],h*i[14]);for(var c=new O(l),u=i[15]/100,d=i[16],f=512,p=[Math.ceil(a[0]/8),Math.ceil(a[1]/8),Math.ceil(a[2]/8)],m=0;m<p[2];m++)for(var _=0;_<p[1];_++)for(var g=0;g<p[0];g++)for(var v=0;v<8;v++)for(var y=8*m+v,b=0;b<8;b++)for(var x=8*_+b,w=0;w<8;w++){var E=8*g+w;if(!(E<a[0]&&x<a[1]&&y<a[2])){f+=8-w;break}var A=(e[f]-d)/u;f++,c.set_grid_value(s[0]+E,s[1]+x,s[2]+y,A)}this.stats=N(c.values,0),this.grid=c},l.prototype.show_debug_info=function(){console.log("unit cell:",this.unit_cell&&this.unit_cell.parameters),console.log("grid:",this.grid&&this.grid.dim)},l.prototype.extract_block=function(t,e){var i=this.grid,r=this.unit_cell;if(null!=i&&null!=r){for(var n=r.fractionalize(e),o=[t/r.parameters[0],t/r.parameters[1],t/r.parameters[2]],s=i.frac2grid([n[0]-o[0],n[1]-o[1],n[2]-o[2]]),a=i.frac2grid([n[0]+o[0],n[1]+o[1],n[2]+o[2]]),l=[a[0]-s[0]+1,a[1]-s[1]+1,a[2]-s[2]+1],h=[],c=[],u=s[0];u<=a[0];u++)for(var d=s[1];d<=a[1];d++)for(var f=s[2];f<=a[2];f++){var p=i.grid2frac(u,d,f),m=r.orthogonalize(p);h.push(m);var _=i.get_grid_value(u,d,f);c.push(_)}this.block.set(h,c,l)}},l.prototype.isomesh_in_block=function(t,e){var i=this.abs_level(t);return this.block.isosurface(i,e)},l.prototype.unit="e/Å³",void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var r=arguments[i];if(null!=r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e});var c,u,d,f,p,_,g,v,y,b,x=0,w=2,J=0,I=1,j=2,k=3,H=4,q=5,tt=100,et=204,it=205,G=3,rt=1001,nt=1003,ot=1004,st=1005,at=1006,lt=1008,ht=1009,ct=1015,ut=1023,dt=0,ft=1,E={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:(u="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),d=new Array(36),f=0,function(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?d[t]="-":14===t?d[t]="4":(f<=2&&(f=33554432+16777216*Math.random()|0),c=15&f,f>>=4,d[t]=u[19===t?3&c|8:c]);return d.join("")}),clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t}};function A(t,e,i,r){this._x=t||0,this._y=e||0,this._z=i||0,this._w=void 0!==r?r:1}function T(t,e){this.x=t||0,this.y=e||0}function pt(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}function M(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1]),0<arguments.length&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function mt(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),0<arguments.length&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function S(){}A.prototype={constructor:A,get x(){return this._x},get y(){return this._y},get z(){return this._z},get w(){return this._w},setFromRotationMatrix:function(t){var e,i=t.elements,r=i[0],n=i[4],o=i[8],s=i[1],a=i[5],l=i[9],h=i[2],c=i[6],u=i[10],d=r+a+u;return 0<d?(e=.5/Math.sqrt(d+1),this._w=.25/e,this._x=(c-l)*e,this._y=(o-h)*e,this._z=(s-n)*e):a<r&&u<r?(e=2*Math.sqrt(1+r-a-u),this._w=(c-l)/e,this._x=.25*e,this._y=(n+s)/e,this._z=(o+h)/e):u<a?(e=2*Math.sqrt(1+a-r-u),this._w=(o-h)/e,this._x=(n+s)/e,this._y=.25*e,this._z=(l+c)/e):(e=2*Math.sqrt(1+u-r-a),this._w=(s-n)/e,this._x=(o+h)/e,this._y=(l+c)/e,this._z=.25*e),this},setFromUnitVectors:function(t,e){return void 0===p&&(p=new pt),(_=t.dot(e)+1)<1e-6?(_=0,Math.abs(t.x)>Math.abs(t.z)?p.set(-t.y,t.x,0):p.set(0,-t.z,t.y)):p.crossVectors(t,e),this._x=p.x,this._y=p.y,this._z=p.z,this._w=_,this.normalize()},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this}},T.prototype={constructor:T,isVector2:!0,set:function(t,e){return this.x=t,this.y=e,this},clone:function(){return new this.constructor(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},equals:function(t){return t.x===this.x&&t.y===this.y}},pt.prototype={constructor:pt,isVector3:!0,set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},applyMatrix4:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements;return this.x=n[0]*e+n[4]*i+n[8]*r+n[12],this.y=n[1]*e+n[5]*i+n[9]*r+n[13],this.z=n[2]*e+n[6]*i+n[10]*r+n[14],this},applyProjection:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements,o=1/(n[3]*e+n[7]*i+n[11]*r+n[15]);return this.x=(n[0]*e+n[4]*i+n[8]*r+n[12])*o,this.y=(n[1]*e+n[5]*i+n[9]*r+n[13])*o,this.z=(n[2]*e+n[6]*i+n[10]*r+n[14])*o,this},applyQuaternion:function(t){var e=this.x,i=this.y,r=this.z,n=t.x,o=t.y,s=t.z,a=t.w,l=a*e+o*r-s*i,h=a*i+s*e-n*r,c=a*r+n*i-o*e,u=-n*e-o*i-s*r;return this.x=l*a+u*-n+h*-s-c*-o,this.y=h*a+u*-o+c*-n-l*-s,this.z=c*a+u*-s+l*-o-h*-n,this},unproject:function(t){return void 0===g&&(g=new mt),g.multiplyMatrices(t.matrixWorld,g.getInverse(t.projectionMatrix)),this.applyProjection(g)},transformDirection:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements;return this.x=n[0]*e+n[4]*i+n[8]*r,this.y=n[1]*e+n[5]*i+n[9]*r,this.z=n[2]*e+n[6]*i+n[10]*r,this.normalize()},divideScalar:function(t){return this.multiplyScalar(1/t)},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(t){return this.multiplyScalar(t/this.length())},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},cross:function(t){var e=this.x,i=this.y,r=this.z;return this.x=i*t.z-r*t.y,this.y=r*t.x-e*t.z,this.z=e*t.y-i*t.x,this},crossVectors:function(t,e){var i=t.x,r=t.y,n=t.z,o=e.x,s=e.y,a=e.z;return this.x=r*a-n*s,this.y=n*o-i*a,this.z=i*s-r*o,this},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,i=this.y-t.y,r=this.z-t.z;return e*e+i*i+r*r},setFromMatrixPosition:function(t){return this.setFromMatrixColumn(t,3)},setFromMatrixColumn:function(t,e){return this.fromArray(t.elements,4*e)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},M.prototype={constructor:M,isMatrix3:!0,set:function(t,e,i,r,n,o,s,a,l){var h=this.elements;return h[0]=t,h[1]=r,h[2]=s,h[3]=e,h[4]=n,h[5]=a,h[6]=i,h[7]=o,h[8]=l,this},setFromMatrix4:function(t){var e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},getInverse:function(t,e){t&&t.isMatrix4&&console.error("THREE.Matrix3.getInverse no longer takes a Matrix4 argument.");var i=t.elements,r=this.elements,n=i[0],o=i[1],s=i[2],a=i[3],l=i[4],h=i[5],c=i[6],u=i[7],d=i[8],f=d*l-h*u,p=h*c-d*a,m=u*a-l*c,_=n*f+o*p+s*m;if(0===_){var g="THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0";if(!0===e)throw new Error(g);return console.warn(g),this.identity()}var v=1/_;return r[0]=f*v,r[1]=(s*u-d*o)*v,r[2]=(h*o-s*l)*v,r[3]=p*v,r[4]=(d*n-s*c)*v,r[5]=(s*a-h*n)*v,r[6]=m*v,r[7]=(o*c-u*n)*v,r[8]=(l*n-o*a)*v,this},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},getNormalMatrix:function(t){return this.setFromMatrix4(t).getInverse(this).transpose()}},mt.prototype={constructor:mt,isMatrix4:!0,copy:function(t){return this.elements.set(t.elements),this},makeRotationFromQuaternion:function(t){var e=this.elements,i=t.x,r=t.y,n=t.z,o=t.w,s=i+i,a=r+r,l=n+n,h=i*s,c=i*a,u=i*l,d=r*a,f=r*l,p=n*l,m=o*s,_=o*a,g=o*l;return e[0]=1-(d+p),e[4]=c-g,e[8]=u+_,e[1]=c+g,e[5]=1-(h+p),e[9]=f-m,e[2]=u-_,e[6]=f+m,e[10]=1-(h+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},lookAt:function(t,e,i){void 0===v&&(v=new pt,y=new pt,b=new pt);var r=this.elements;return b.subVectors(t,e).normalize(),0===b.lengthSq()&&(b.z=1),v.crossVectors(i,b).normalize(),0===v.lengthSq()&&(b.z+=1e-4,v.crossVectors(i,b).normalize()),y.crossVectors(b,v),r[0]=v.x,r[4]=y.x,r[8]=b.x,r[1]=v.y,r[5]=y.y,r[9]=b.y,r[2]=v.z,r[6]=y.z,r[10]=b.z,this},multiplyMatrices:function(t,e){var i=t.elements,r=e.elements,n=this.elements,o=i[0],s=i[4],a=i[8],l=i[12],h=i[1],c=i[5],u=i[9],d=i[13],f=i[2],p=i[6],m=i[10],_=i[14],g=i[3],v=i[7],y=i[11],b=i[15],x=r[0],w=r[4],E=r[8],A=r[12],T=r[1],M=r[5],S=r[9],R=r[13],z=r[2],O=r[6],L=r[10],F=r[14],P=r[3],C=r[7],U=r[11],N=r[15];return n[0]=o*x+s*T+a*z+l*P,n[4]=o*w+s*M+a*O+l*C,n[8]=o*E+s*S+a*L+l*U,n[12]=o*A+s*R+a*F+l*N,n[1]=h*x+c*T+u*z+d*P,n[5]=h*w+c*M+u*O+d*C,n[9]=h*E+c*S+u*L+d*U,n[13]=h*A+c*R+u*F+d*N,n[2]=f*x+p*T+m*z+_*P,n[6]=f*w+p*M+m*O+_*C,n[10]=f*E+p*S+m*L+_*U,n[14]=f*A+p*R+m*F+_*N,n[3]=g*x+v*T+y*z+b*P,n[7]=g*w+v*M+y*O+b*C,n[11]=g*E+v*S+y*L+b*U,n[15]=g*A+v*R+y*F+b*N,this},setPosition:function(t){var e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},getInverse:function(t,e){var i=this.elements,r=t.elements,n=r[0],o=r[1],s=r[2],a=r[3],l=r[4],h=r[5],c=r[6],u=r[7],d=r[8],f=r[9],p=r[10],m=r[11],_=r[12],g=r[13],v=r[14],y=r[15],b=f*v*u-g*p*u+g*c*m-h*v*m-f*c*y+h*p*y,x=_*p*u-d*v*u-_*c*m+l*v*m+d*c*y-l*p*y,w=d*g*u-_*f*u+_*h*m-l*g*m-d*h*y+l*f*y,E=_*f*c-d*g*c-_*h*p+l*g*p+d*h*v-l*f*v,A=n*b+o*x+s*w+a*E;if(0===A){var T="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===e)throw new Error(T);return console.warn(T),this.identity()}var M=1/A;return i[0]=b*M,i[1]=(g*p*a-f*v*a-g*s*m+o*v*m+f*s*y-o*p*y)*M,i[2]=(h*v*a-g*c*a+g*s*u-o*v*u-h*s*y+o*c*y)*M,i[3]=(f*c*a-h*p*a-f*s*u+o*p*u+h*s*m-o*c*m)*M,i[4]=x*M,i[5]=(d*v*a-_*p*a+_*s*m-n*v*m-d*s*y+n*p*y)*M,i[6]=(_*c*a-l*v*a-_*s*u+n*v*u+l*s*y-n*c*y)*M,i[7]=(l*p*a-d*c*a+d*s*u-n*p*u-l*s*m+n*c*m)*M,i[8]=w*M,i[9]=(_*f*a-d*g*a-_*o*m+n*g*m+d*o*y-n*f*y)*M,i[10]=(l*g*a-_*h*a+_*o*u-n*g*u-l*o*y+n*h*y)*M,i[11]=(d*h*a-l*f*a-d*o*u+n*f*u+l*o*m-n*h*m)*M,i[12]=E*M,i[13]=(d*g*s-_*f*s+_*o*p-n*g*p-d*o*v+n*f*v)*M,i[14]=(_*h*s-l*g*s-_*o*c+n*g*c+l*o*v-n*h*v)*M,i[15]=(l*f*s-d*h*s+d*o*c-n*f*c-l*o*p+n*h*p)*M,this},scale:function(t){var e=this.elements,i=t.x,r=t.y,n=t.z;return e[0]*=i,e[4]*=r,e[8]*=n,e[1]*=i,e[5]*=r,e[9]*=n,e[2]*=i,e[6]*=r,e[10]*=n,e[3]*=i,e[7]*=r,e[11]*=n,this},getMaxScaleOnAxis:function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,r))},compose:function(t,e,i){return this.makeRotationFromQuaternion(e),this.scale(i),this.setPosition(t),this},makeOrthographic:function(t,e,i,r,n,o){var s=this.elements,a=1/(e-t),l=1/(i-r),h=1/(o-n),c=(e+t)*a,u=(i+r)*l,d=(o+n)*h;return s[0]=2*a,s[4]=0,s[8]=0,s[12]=-c,s[1]=0,s[5]=2*l,s[9]=0,s[13]=-u,s[2]=0,s[6]=0,s[10]=-2*h,s[14]=-d,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this}},Object.assign(S.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0!==this._listeners){var i=this._listeners[t];if(void 0!==i){var r=i.indexOf(e);-1!==r&&i.splice(r,1)}}},dispatchEvent:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;var i=[],r=0,n=e.length;for(r=0;r<n;r++)i[r]=e[r];for(r=0;r<n;r++)i[r].call(this,t)}}}});var R=0;function B(t){Object.defineProperty(this,"id",{value:R++}),this.uuid=E.generateUUID(),this.name="",this.image=void 0!==t?t:B.DEFAULT_IMAGE,this.wrapS=rt,this.wrapT=rt,this.magFilter=at,this.minFilter=lt,this.format=ut,this.type=ht,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.version=0}B.DEFAULT_IMAGE=void 0,B.DEFAULT_MAPPING=300,B.prototype={constructor:B,isTexture:!0,set needsUpdate(t){!0===t&&this.version++},dispose:function(){this.dispatchEvent({type:"dispose"})}},Object.assign(B.prototype,S.prototype);var V=new B;function W(t,e){t.uniform1f(this.addr,e)}function X(t,e){t.uniform1i(this.addr,e)}function K(t,e){void 0===e.x?t.uniform2fv(this.addr,e):t.uniform2f(this.addr,e.x,e.y)}function Y(t,e){void 0!==e.x?t.uniform3f(this.addr,e.x,e.y,e.z):void 0!==e.r?t.uniform3f(this.addr,e.r,e.g,e.b):t.uniform3fv(this.addr,e)}function Z(t,e){void 0===e.x?t.uniform4fv(this.addr,e):t.uniform4f(this.addr,e.x,e.y,e.z,e.w)}function Q(t,e){t.uniformMatrix2fv(this.addr,!1,e.elements||e)}function $(t,e){t.uniformMatrix3fv(this.addr,!1,e.elements||e)}function _t(t,e){t.uniformMatrix4fv(this.addr,!1,e.elements||e)}function gt(t,e,i){var r=i.allocTextureUnit();t.uniform1i(this.addr,r),i.setTexture2D(e||V,r)}function vt(t,e){t.uniform2iv(this.addr,e)}function yt(t,e){t.uniform3iv(this.addr,e)}function bt(t,e){t.uniform4iv(this.addr,e)}function xt(t,e,i){this.id=t,this.addr=i,this.setValue=function(t){switch(t){case 5126:return W;case 35664:return K;case 35665:return Y;case 35666:return Z;case 35674:return Q;case 35675:return $;case 35676:return _t;case 35678:return gt;case 5124:case 35670:return X;case 35667:case 35671:return vt;case 35668:case 35672:return yt;case 35669:case 35673:return bt}}(e.type)}var wt=/([\w\d_]+)(\])?(\[|\.)?/g;function Et(t,e,i){var r,n,o=t.name;for(wt.lastIndex=0;;){var s=wt.exec(o),a=s[1];if("]"===s[2]&&(a|=0),void 0===s[3]){r=i,n=new xt(a,t,e),r.seq.push(n),r.map[n.id]=n;break}}}function At(t,e,i){(function(){this.seq=[],this.map={}}).call(this),this.renderer=i;for(var r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),n=0;n!==r;++n){var o=t.getActiveUniform(e,n),s=o.name;Et(o,t.getUniformLocation(e,s),this)}}At.prototype.setValue=function(t,e,i){var r=this.map[e];void 0!==r&&r.setValue(t,i,this.renderer)},At.prototype.set=function(t,e,i){var r=this.map[i];void 0!==r&&r.setValue(t,e[i],this.renderer)},At.upload=function(t,e,i,r){for(var n=0,o=e.length;n!==o;++n){var s=e[n],a=i[s.id];!1!==a.needsUpdate&&s.setValue(t,a.value,r)}},At.seqWithValue=function(t,e){for(var i=[],r=0,n=t.length;r!==n;++r){var o=t[r];o.id in e&&i.push(o)}return i};var Tt=function(t){var e={};for(var i in t)for(var r in e[i]={},t[i]){var n=t[i][r];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?e[i][r]=n.clone():Array.isArray(n)?e[i][r]=n.slice():e[i][r]=n}return e},Mt={fog_fragment:"\n#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\ngl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"\n#ifdef USE_FOG\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\n#endif"};function St(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}function Rt(t,e,i){return void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}St.prototype={constructor:St,isVector4:!0,set:function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t,this.w*=t):(this.x=0,this.y=0,this.z=0,this.w=0),this},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}},Rt.prototype={constructor:Rt,isColor:!0,r:1,g:1,b:1,set:function(t){return t&&t.isColor?this.copy(t):"number"==typeof t&&this.setHex(t),this},setHex:function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},setRGB:function(t,e,i){return this.r=t,this.g=e,this.b=i,this},setHSL:function(){function o(t,e,i){return i<0&&(i+=1),1<i&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}return function(t,e,i){if(t=E.euclideanModulo(t,1),e=E.clamp(e,0,1),i=E.clamp(i,0,1),0===e)this.r=this.g=this.b=i;else{var r=i<=.5?i*(1+e):i+e-i*e,n=2*i-r;this.r=o(n,r,t+1/3),this.g=o(n,r,t),this.b=o(n,r,t-1/3)}return this}}(),getHSL:function(){var t,e,i={h:0,s:0,l:0},r=this.r,n=this.g,o=this.b,s=Math.max(r,n,o),a=Math.min(r,n,o),l=(a+s)/2;if(a===s)e=t=0;else{var h=s-a;switch(e=l<=.5?h/(s+a):h/(2-s-a),s){case r:t=(n-o)/h+(n<o?6:0);break;case n:t=(o-r)/h+2;break;case o:t=(r-n)/h+4}t/=6}return i.h=t,i.s=e,i.l=l,i},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)}};var zt,Ot,Lt,Ft=0;function Pt(){Object.defineProperty(this,"id",{value:Ft++}),this.uuid=E.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=I,this.vertexColors=x,this.opacity=1,this.transparent=!1,this.blendSrc=et,this.blendDst=it,this.blendEquation=tt,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=G,this.depthTest=!0,this.depthWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this._needsUpdate=!0}function Ct(t){Pt.call(this),this.type="ShaderMaterial",this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.fog=!1,this.lights=!1,this.extensions={fragDepth:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},(this.index0AttributeName=void 0)!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}function Ut(t,e){this.origin=void 0!==t?t:new pt,this.direction=void 0!==e?e:new pt}Pt.prototype={constructor:Pt,isMaterial:!0,get needsUpdate(){return this._needsUpdate},set needsUpdate(t){!0===t&&this.update(),this._needsUpdate=t},setValues:function(t){if(void 0!==t)for(var e in t){var i=t[e];if(void 0!==i){var r=this[e];void 0!==r?r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[e]="overdraw"===e?Number(i):i:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}else console.warn("THREE.Material: '"+e+"' parameter is undefined.")}},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.fog=t.fog,this.lights=t.lights,this.blending=t.blending,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.premultipliedAlpha=t.premultipliedAlpha,this.overdraw=t.overdraw,this.visible=t.visible,this},update:function(){this.dispatchEvent({type:"update"})},dispose:function(){this.dispatchEvent({type:"dispose"})}},Object.assign(Pt.prototype,S.prototype),((Ct.prototype=Object.create(Pt.prototype)).constructor=Ct).prototype.isShaderMaterial=!0,Ct.prototype.copy=function(t){return Pt.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Tt(t.uniforms),this.lights=t.lights,this.extensions=t.extensions,this},Ut.prototype={constructor:Ut,copy:function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},distanceSqToSegment:(zt=new pt,Ot=new pt,Lt=new pt,function(t,e,i,r){zt.copy(t).add(e).multiplyScalar(.5),Ot.copy(e).sub(t).normalize(),Lt.copy(this.origin).sub(zt);var n,o,s,a,l=.5*t.distanceTo(e),h=-this.direction.dot(Ot),c=Lt.dot(this.direction),u=-Lt.dot(Ot),d=Lt.lengthSq(),f=Math.abs(1-h*h);if(0<f)if(o=h*c-u,a=l*f,0<=(n=h*u-c))if(-a<=o)if(o<=a){var p=1/f;s=(n*=p)*(n+h*(o*=p)+2*c)+o*(h*n+o+2*u)+d}else o=l,s=-(n=Math.max(0,-(h*o+c)))*n+o*(o+2*u)+d;else o=-l,s=-(n=Math.max(0,-(h*o+c)))*n+o*(o+2*u)+d;else o<=-a?s=-(n=Math.max(0,-(-h*l+c)))*n+(o=0<n?-l:Math.min(Math.max(-l,-u),l))*(o+2*u)+d:o<=a?(n=0,s=(o=Math.min(Math.max(-l,-u),l))*(o+2*u)+d):s=-(n=Math.max(0,-(h*l+c)))*n+(o=0<n?l:Math.min(Math.max(-l,-u),l))*(o+2*u)+d;else o=0<h?-l:l,s=-(n=Math.max(0,-(h*o+c)))*n+o*(o+2*u)+d;return i&&i.copy(this.direction).multiplyScalar(n).add(this.origin),r&&r.copy(Ot).multiplyScalar(o).add(zt),s}),applyMatrix4:function(t){return this.direction.add(this.origin).applyMatrix4(t),this.origin.applyMatrix4(t),this.direction.sub(this.origin),this.direction.normalize(),this}};var Nt=0;function Dt(){Object.defineProperty(this,"id",{value:Nt++}),this.uuid=E.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Dt.DefaultUp.clone();var t=new pt,e=new A,i=new pt(1,1,1);Object.defineProperties(this,{position:{enumerable:!0,value:t},quaternion:{enumerable:!0,value:e},scale:{enumerable:!0,value:i},modelViewMatrix:{value:new mt},normalMatrix:{value:new M}}),this.matrix=new mt,this.matrixWorld=new mt,this.matrixAutoUpdate=Dt.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.visible=!0,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.onBeforeRender=function(){},this.onAfterRender=function(){}}function It(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=E.generateUUID(),this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}Dt.DefaultUp=new pt(0,1,0),Dt.DefaultMatrixAutoUpdate=!0,Object.assign(Dt.prototype,S.prototype,{isObject3D:!0,add:function(t){if(1<arguments.length){for(var e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?console.error("THREE.Object3D.add: object can't be added as a child of itself.",t):t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this},remove:function(t){if(1<arguments.length)for(var e=0;e<arguments.length;e++)this.remove(arguments[e]);var i=this.children.indexOf(t);-1!==i&&(t.parent=null,t.dispatchEvent({type:"removed"}),this.children.splice(i,1))},raycast:function(){},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==t||(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),t=!(this.matrixWorldNeedsUpdate=!1));for(var e=this.children,i=0,r=e.length;i<r;i++)e[i].updateMatrixWorld(t)}}),It.prototype={constructor:It,isBufferAttribute:!0,getX:function(t){return this.array[t*this.itemSize]},getY:function(t){return this.array[t*this.itemSize+1]},getZ:function(t){return this.array[t*this.itemSize+2]}};var jt,kt=0;function Ht(){Object.defineProperty(this,"id",{value:kt++}),this.uuid=E.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function qt(t,e){Dt.call(this),this.type="Mesh",this.geometry=void 0!==t?t:new Ht,this.material=e,this.drawMode=dt}function Gt(){Dt.call(this),this.type="Camera",this.matrixWorldInverse=new mt,this.projectionMatrix=new mt}function Bt(t,e,i,r,n,o){Gt.call(this),this.type="OrthographicCamera",this.zoom=1,this.left=t,this.right=e,this.top=i,this.bottom=r,this.near=void 0!==n?n:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()}function Vt(i,e,r){var n,o,s;return{setMode:function(t){n=t},setIndex:function(t){t.array instanceof Uint32Array&&e.get("OES_element_index_uint")?(o=i.UNSIGNED_INT,s=4):t.array instanceof Uint16Array?(o=i.UNSIGNED_SHORT,s=2):(o=i.UNSIGNED_BYTE,s=1)},render:function(t,e){i.drawElements(n,e,o,t*s),r.calls++,r.vertices+=e,n===i.TRIANGLES&&(r.faces+=e/3)}}}function Wt(i,t,r){var n;return{setMode:function(t){n=t},render:function(t,e){i.drawArrays(n,t,e),r.calls++,r.vertices+=e,n===i.TRIANGLES&&(r.faces+=e/3)}}}function Xt(t,e,i){var r=t.createShader(e);if(t.shaderSource(r,i),t.compileShader(r),!1===t.getShaderParameter(r,t.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==t.getShaderInfoLog(r)){var n=t.getShaderInfoLog(r);-1===n.indexOf("GL_ARB_gpu_shader5")&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",e===t.VERTEX_SHADER?"vertex":"fragment",n,i)}return r}Object.assign(Ht.prototype,S.prototype,{isBufferGeometry:!0,setIndex:function(t){this.index=t},addAttribute:function(t,e){return!1===(e&&e.isBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(t,new It(e,arguments[2]))):"index"===t?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(e)):(this.attributes[t]=e,this)},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Ht.MaxIndex=65535,qt.prototype=Object.assign(Object.create(Dt.prototype),{constructor:qt,isMesh:!0}),((Gt.prototype=Object.create(Dt.prototype)).constructor=Gt).prototype.isCamera=!0,Gt.prototype.lookAt=(jt=new mt,function(t){jt.lookAt(this.position,t,this.up),this.quaternion.setFromRotationMatrix(jt)}),Bt.prototype=Object.assign(Object.create(Gt.prototype),{constructor:Bt,isOrthographicCamera:!0,updateProjectionMatrix:function(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2,n=i-t,o=i+t,s=r+e,a=r-e;this.projectionMatrix.makeOrthographic(n,o,s,a,this.near,this.far)}});var Kt=0;function Yt(t){return t.replace(/#include +<([\w\d.]+)>/g,function(t,e){var i=Mt[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return Yt(i)})}function Zt(t,e,i,r){var n,o,s,a,l=t.context,h=i.extensions,c=i.__webglShader.vertexShader,u=i.__webglShader.fragmentShader,d=(n=h,o=t.extensions,[(n=n||{}).fragDepth&&o.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":""].join("\n")),f=l.createProgram();s=["precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,r.vertexColors?"#define USE_COLOR":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR"," attribute vec3 color;","#endif","\n"].join("\n"),a=[d,"precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,r.useFog&&r.fog?"#define USE_FOG":"",r.vertexColors?"#define USE_COLOR":"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",r.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].join("\n");var p=s+(c=Yt(c)),m=a+(u=Yt(u)),_=Xt(l,l.VERTEX_SHADER,p),g=Xt(l,l.FRAGMENT_SHADER,m);l.attachShader(f,_),l.attachShader(f,g),void 0!==i.index0AttributeName&&l.bindAttribLocation(f,0,i.index0AttributeName),l.linkProgram(f);var v,y,b=l.getProgramInfoLog(f),x=l.getShaderInfoLog(_),w=l.getShaderInfoLog(g),E=!0,A=!0;return!1===l.getProgramParameter(f,l.LINK_STATUS)?(E=!1,console.error("THREE.WebGLProgram: shader error: ",l.getError(),"gl.VALIDATE_STATUS",l.getProgramParameter(f,l.VALIDATE_STATUS),"gl.getProgramInfoLog",b,x,w)):""!==b?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",b):""!==x&&""!==w||(A=!1),A&&(this.diagnostics={runnable:E,material:i,programLog:b,vertexShader:{log:x,prefix:s},fragmentShader:{log:w,prefix:a}}),l.deleteShader(_),l.deleteShader(g),this.getUniforms=function(){return void 0===v&&(v=new At(l,f,t)),v},this.getAttributes=function(){return void 0===y&&(y=function(t,e,i){for(var r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<n;o++){var s=t.getActiveAttrib(e,o).name;r[s]=t.getAttribLocation(e,s)}return r}(l,f)),y},this.destroy=function(){l.deleteProgram(f),this.program=void 0},this.id=Kt++,this.code=e,this.usedTimes=1,this.program=f,this.vertexShader=_,this.fragmentShader=g,this}function Qt(a,n){var l=[],o=["precision","combine","vertexColors","fog","useFog","premultipliedAlpha","depthPacking"];this.getParameters=function(t,e,i){var r=a.getPrecision();return null!==t.precision&&(r=n.getMaxPrecision(t.precision))!==t.precision&&console.warn("THREE.WebGLProgram.getParameters:",t.precision,"not supported, using",r,"instead."),{precision:r,combine:t.combine,vertexColors:t.vertexColors,fog:!!e,useFog:t.fog,premultipliedAlpha:t.premultipliedAlpha,depthPacking:void 0!==t.depthPacking&&t.depthPacking}},this.getProgramCode=function(t,e){var i=[];i.push(t.fragmentShader),i.push(t.vertexShader);for(var r=0;r<o.length;r++)i.push(e[o[r]]);return i.join()},this.acquireProgram=function(t,e,i){for(var r,n=0,o=l.length;n<o;n++){var s=l[n];if(s.code===i){++(r=s).usedTimes;break}}return void 0===r&&(r=new Zt(a,i,t,e),l.push(r)),r},this.releaseProgram=function(t){if(0==--t.usedTimes){var e=l.indexOf(t);l[e]=l[l.length-1],l.pop(),t.destroy()}},this.programs=l}function $t(n,o,r){var s={};function a(t){var e=t.target,i=s[e.id];null!==i.index&&l(i.index),function(t){for(var e in t)l(t[e])}(i.attributes),e.removeEventListener("dispose",a),delete s[e.id],o.delete(e),o.delete(i),r.memory.geometries--}function l(t){var e,i,r=(e=t,o.get(e).__webglBuffer);void 0!==r&&(n.deleteBuffer(r),i=t,o.delete(i))}return{get:function(t){var e,i=t.geometry;return void 0!==s[i.id]?s[i.id]:(i.addEventListener("dispose",a),i.isBufferGeometry?e=i:i.isGeometry&&(void 0===i._bufferGeometry&&(i._bufferGeometry=(new Ht).setFromObject(t)),e=i._bufferGeometry),s[i.id]=e,r.memory.geometries++,e)}}}function Jt(s,n,t){var o=new $t(s,n,t);function a(t,e){var i=t,r=n.get(i);void 0===r.__webglBuffer?function(t,e,i){t.__webglBuffer=s.createBuffer(),s.bindBuffer(i,t.__webglBuffer);var r=e.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW;s.bufferData(i,e.array,r);var n=s.FLOAT,o=e.array;o instanceof Float32Array?n=s.FLOAT:o instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):o instanceof Uint16Array?n=s.UNSIGNED_SHORT:o instanceof Int16Array?n=s.SHORT:o instanceof Uint32Array?n=s.UNSIGNED_INT:o instanceof Int32Array?n=s.INT:o instanceof Int8Array?n=s.BYTE:o instanceof Uint8Array&&(n=s.UNSIGNED_BYTE);t.bytesPerElement=o.BYTES_PER_ELEMENT,t.type=n,t.version=e.version,e.onUploadCallback()}(r,i,e):r.version!==i.version&&function(t,e,i){s.bindBuffer(i,t.__webglBuffer),!1===e.dynamic?s.bufferData(i,e.array,s.STATIC_DRAW):-1===e.updateRange.count?s.bufferSubData(i,0,e.array):0===e.updateRange.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(s.bufferSubData(i,e.updateRange.offset*e.array.BYTES_PER_ELEMENT,e.array.subarray(e.updateRange.offset,e.updateRange.offset+e.updateRange.count)),e.updateRange.count=0);t.version=e.version}(r,i,e)}return{getAttributeBuffer:function(t){return n.get(t).__webglBuffer},getAttributeProperties:function(t){return n.get(t)},update:function(t){var e=o.get(t);t.geometry.isGeometry&&e.updateFromObject(t);var i=e.index,r=e.attributes;for(var n in null!==i&&a(i,s.ELEMENT_ARRAY_BUFFER),r)a(r[n],s.ARRAY_BUFFER);return e}}}function te(c,u,d,n,f,p,t){var m=t.memory;function _(t){return E.isPowerOfTwo(t.width)&&E.isPowerOfTwo(t.height)}function g(t){return t===nt||t===ot||t===st?c.NEAREST:c.LINEAR}function v(t){var e=t.target;e.removeEventListener("dispose",v),function(t){var e=n.get(t);if(void 0===e.__webglInit)return;c.deleteTexture(e.__webglTexture),n.delete(t)}(e),m.textures--}this.setTexture2D=function(t,e){var i=n.get(t);if(0<t.version&&i.__version!==t.version){var r=t.image;if(void 0===r)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==r.complete)return void function(t,e,i){void 0===t.__webglInit&&(t.__webglInit=!0,e.addEventListener("dispose",v),t.__webglTexture=c.createTexture(),m.textures++),d.activeTexture(c.TEXTURE0+i),d.bindTexture(c.TEXTURE_2D,t.__webglTexture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,e.flipY),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),c.pixelStorei(c.UNPACK_ALIGNMENT,e.unpackAlignment);var r,n=function(t,e){if(t.width>e||t.height>e){var i=e/Math.max(t.width,t.height),r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return r.width=Math.floor(t.width*i),r.height=Math.floor(t.height*i),r.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,r.width,r.height),console.warn("THREE.WebGLRenderer: image is too big ("+t.width+"x"+t.height+"). Resized to "+r.width+"x"+r.height,t),r}return t}(e.image,f.maxTextureSize);((r=e).wrapS!==rt||r.wrapT!==rt||r.minFilter!==nt&&r.minFilter!==at)&&!1===_(n)&&(n=function(t){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement){var e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return e.width=E.nearestPowerOfTwo(t.width),e.height=E.nearestPowerOfTwo(t.height),e.getContext("2d").drawImage(t,0,0,e.width,e.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+t.width+"x"+t.height+"). Resized to "+e.width+"x"+e.height,t),e}return t}(n));var o,s,a=_(n),l=p(e.format),h=p(e.type);o=c.TEXTURE_2D,s=e,a?(c.texParameteri(o,c.TEXTURE_WRAP_S,p(s.wrapS)),c.texParameteri(o,c.TEXTURE_WRAP_T,p(s.wrapT)),c.texParameteri(o,c.TEXTURE_MAG_FILTER,p(s.magFilter)),c.texParameteri(o,c.TEXTURE_MIN_FILTER,p(s.minFilter))):(c.texParameteri(o,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(o,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),s.wrapS===rt&&s.wrapT===rt||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",s),c.texParameteri(o,c.TEXTURE_MAG_FILTER,g(s.magFilter)),c.texParameteri(o,c.TEXTURE_MIN_FILTER,g(s.minFilter)),s.minFilter!==nt&&s.minFilter!==at&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",s)),u.get("EXT_texture_filter_anisotropic")&&s.type===ct&&u.get("OES_texture_float_linear"),d.texImage2D(c.TEXTURE_2D,0,l,l,h,n),e.generateMipmaps&&a&&c.generateMipmap(c.TEXTURE_2D),t.__version=e.version}(i,t,e);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}d.activeTexture(c.TEXTURE0+e),d.bindTexture(c.TEXTURE_2D,i.__webglTexture)}}function ee(){var r={};return{get:function(t){var e=t.uuid,i=r[e];return void 0===i&&(i={},r[e]=i),i},delete:function(t){delete r[t.uuid]}}}function ie(l,e,h){var t=new function(){var o=new St,s=new St;return{setClear:function(t,e,i,r,n){!0===n&&(t*=r,e*=r,i*=r),o.set(t,e,i,r),!1===s.equals(o)&&(l.clearColor(t,e,i,r),s.copy(o))}}},i=new function(){var e=null,i=null,r=null;return{setTest:function(t){t?R(l.DEPTH_TEST):z(l.DEPTH_TEST)},setMask:function(t){e!==t&&(l.depthMask(t),e=t)},setFunc:function(t){i!==t&&(l.depthFunc(l.LEQUAL),i=t)},setClear:function(t){r!==t&&(l.clearDepth(t),r=t)},reset:function(){r=i=e=null}}},r=l.getParameter(l.MAX_VERTEX_ATTRIBS),n=new Uint8Array(r),o=new Uint8Array(r),s=new Uint8Array(r),a={},c=null,u=null,d=null,f=null,p=null,m=null,_=null,g=!1,v=null,y=null,b=null,x=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS),w=parseFloat(/^WebGL\ ([0-9])/.exec(l.getParameter(l.VERSION))[1]),E=1<=parseFloat(w),A=null,T={},M=new St;var S={};function R(t){!0!==a[t]&&(l.enable(t),a[t]=!0)}function z(t){!1!==a[t]&&(l.disable(t),a[t]=!1)}function O(t,e,i,r,n,o,s,a){t!==J?R(l.BLEND):z(l.BLEND),t===c&&a===g||(t===j?a?(l.blendEquationSeparate(l.FUNC_ADD,l.FUNC_ADD),l.blendFuncSeparate(l.ONE,l.ONE,l.ONE,l.ONE)):(l.blendEquation(l.FUNC_ADD),l.blendFunc(l.SRC_ALPHA,l.ONE)):t===k?a?(l.blendEquationSeparate(l.FUNC_ADD,l.FUNC_ADD),l.blendFuncSeparate(l.ZERO,l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ONE_MINUS_SRC_ALPHA)):(l.blendEquation(l.FUNC_ADD),l.blendFunc(l.ZERO,l.ONE_MINUS_SRC_COLOR)):t===H?a?(l.blendEquationSeparate(l.FUNC_ADD,l.FUNC_ADD),l.blendFuncSeparate(l.ZERO,l.SRC_COLOR,l.ZERO,l.SRC_ALPHA)):(l.blendEquation(l.FUNC_ADD),l.blendFunc(l.ZERO,l.SRC_COLOR)):a?(l.blendEquationSeparate(l.FUNC_ADD,l.FUNC_ADD),l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA)):(l.blendEquationSeparate(l.FUNC_ADD,l.FUNC_ADD),l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA)),c=t,g=a),t===q?(n=n||e,o=o||i,s=s||r,e===u&&n===p||(l.blendEquationSeparate(h(e),h(n)),u=e,p=n),i===d&&r===f&&o===m&&s===_||(l.blendFuncSeparate(h(i),h(r),h(o),h(s)),d=i,f=r,m=o,_=s)):_=m=p=f=d=u=null}function L(t){i.setFunc(t)}function F(t){void 0===t&&(t=l.TEXTURE0+x-1),A!==t&&(l.activeTexture(t),A=t)}return S[l.TEXTURE_2D]=function(t,e,i){var r=new Uint8Array(4),n=l.createTexture();l.bindTexture(t,n),l.texParameteri(t,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(t,l.TEXTURE_MAG_FILTER,l.NEAREST);for(var o=0;o<i;o++)l.texImage2D(e+o,0,l.RGBA,1,1,0,l.RGBA,l.UNSIGNED_BYTE,r);return n}(l.TEXTURE_2D,l.TEXTURE_2D,1),{buffers:{color:t,depth:i},init:function(){t.setClear(0,0,0,1),i.setClear(1),R(l.DEPTH_TEST),L(G),R(l.BLEND),O(I)},initAttributes:function(){for(var t=0,e=n.length;t<e;t++)n[t]=0},enableAttribute:function(t){n[t]=1,0===o[t]&&(l.enableVertexAttribArray(t),o[t]=1),0!==s[t]&&(e.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(t,0),s[t]=0)},enableAttributeAndDivisor:function(t,e,i){n[t]=1,0===o[t]&&(l.enableVertexAttribArray(t),o[t]=1),s[t]!==e&&(i.vertexAttribDivisorANGLE(t,e),s[t]=e)},disableUnusedAttributes:function(){for(var t=0,e=o.length;t!==e;++t)o[t]!==n[t]&&(l.disableVertexAttribArray(t),o[t]=0)},enable:R,disable:z,setBlending:O,setDepthTest:function(t){i.setTest(t)},setDepthWrite:function(t){i.setMask(t)},setDepthFunc:L,setLineWidth:function(t){t!==v&&(E&&l.lineWidth(t),v=t)},setPolygonOffset:function(t,e,i){t?(R(l.POLYGON_OFFSET_FILL),y===e&&b===i||(l.polygonOffset(e,i),y=e,b=i)):z(l.POLYGON_OFFSET_FILL)},activeTexture:F,bindTexture:function(t,e){null===A&&F();var i=T[A];void 0===i&&(i={type:void 0,texture:void 0},T[A]=i),i.type===t&&i.texture===e||(l.bindTexture(t,e||S[t]),i.type=t,i.texture=e)},texImage2D:function(){try{l.texImage2D.apply(l,arguments)}catch(t){console.error(t)}},viewport:function(t){!1===M.equals(t)&&(l.viewport(t.x,t.y,t.z,t.w),M.copy(t))}}}function re(e,t,i){function r(t){if("highp"===t){if(0<e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision&&0<e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision)return"highp";t="mediump"}return"mediump"===t&&0<e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision&&0<e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision?"mediump":"lowp"}var n=void 0!==i.precision?i.precision:"highp",o=r(n);o!==n&&(console.warn("THREE.WebGLRenderer:",n,"not supported, using",o,"instead."),n=o);var s=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),l=e.getParameter(e.MAX_TEXTURE_SIZE),h=e.getParameter(e.MAX_VERTEX_ATTRIBS),c=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),u=e.getParameter(e.MAX_VARYING_VECTORS),d=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),f=0<a,p=!!t.get("OES_texture_float");return{getMaxPrecision:r,precision:n,maxTextures:s,maxVertexTextures:a,maxTextureSize:l,maxAttributes:h,maxVertexUniforms:c,maxVaryings:u,maxFragmentUniforms:d,vertexTextures:f,floatFragmentTextures:p,floatVertexTextures:f&&p}}function ne(i){var r={};return{get:function(t){if(void 0!==r[t])return r[t];var e;switch(t){case"WEBGL_depth_texture":e=i.getExtension("WEBGL_depth_texture")||i.getExtension("MOZ_WEBGL_depth_texture")||i.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":e=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;default:e=i.getExtension(t)}return null===e&&console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),r[t]=e}}}function oe(t){var r=void 0!==(t=t||{}).canvas?t.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),e=void 0!==t.context?t.context:null,i=void 0!==t.alpha&&t.alpha,n=void 0===t.depth||t.depth,o=void 0!==t.antialias&&t.antialias,s=void 0===t.premultipliedAlpha||t.premultipliedAlpha,a=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,l=[],h=[],c=-1,u=[],d=-1;this.domElement=r,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.sortObjects=!0;var w,E=this,A=null,T=null,f=null,M=-1,S="",R=null,p=new St,z=0,m=new Rt(0),_=0,g=r.width,v=r.height,O=1,y=new St(0,0,g,v),b=new mt,L=new pt,F=[0,0,0],x={calls:0,vertices:0,faces:0,points:0};this.info={render:x,memory:{geometries:0,textures:0},programs:null};try{var P={alpha:i,depth:n,antialias:o,premultipliedAlpha:s,preserveDrawingBuffer:a};if(null===(w=e||r.getContext("webgl",P)||r.getContext("experimental-webgl",P)))throw null!==r.getContext("webgl")?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.");void 0===w.getShaderPrecisionFormat&&(w.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),r.addEventListener("webglcontextlost",W,!1)}catch(t){console.error("THREE.WebGLRenderer: "+t)}var C=new ne(w);C.get("WEBGL_depth_texture"),C.get("OES_texture_float"),C.get("OES_texture_float_linear"),C.get("OES_texture_half_float"),C.get("OES_texture_half_float_linear"),C.get("OES_standard_derivatives"),C.get("ANGLE_instanced_arrays"),C.get("OES_element_index_uint")&&(Ht.MaxIndex=4294967296);var U=new re(w,C,t),N=new ie(w,C,$),D=new ee,I=new te(w,C,N,D,U,$,this.info),j=new Jt(w,D,this.info),k=new Qt(this,U);this.info.programs=k.programs;var H,q=new Wt(w,C,x),G=new Vt(w,C,x);function B(){N.init(),N.viewport(p.copy(y).multiplyScalar(O)),N.buffers.color.setClear(m.r,m.g,m.b,_,s)}function V(){R=A=null,S="",M=-1,N.reset()}function W(t){t.preventDefault(),V(),B(),D.clear()}function X(t){var e,i=t.target;i.removeEventListener("dispose",X),K(e=i),D.delete(e)}function K(t){var e=D.get(t).program;(t.program=void 0)!==e&&k.releaseProgram(e)}function Y(t,e){return t.object.renderOrder!==e.object.renderOrder?t.object.renderOrder-e.object.renderOrder:t.material.program&&e.material.program&&t.material.program!==e.material.program?t.material.program.id-e.material.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function Z(t,e){return t.object.renderOrder!==e.object.renderOrder?t.object.renderOrder-e.object.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function Q(t,e,i,r){for(var n=0,o=t.length;n<o;n++){var s=t[n],a=s.object,l=s.geometry,h=void 0===r?s.material:r,c=s.group;a.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,a.matrixWorld),a.normalMatrix.getNormalMatrix(a.modelViewMatrix),a.onBeforeRender(E,e,i,l,h,c),E.renderBufferDirect(i,e.fog,l,h,a,c),a.onAfterRender(E,e,i,l,h,c)}}function $(t){return t===rt?w.CLAMP_TO_EDGE:t===nt?w.NEAREST:t===ot?w.NEAREST_MIPMAP_NEAREST:t===st?w.NEAREST_MIPMAP_LINEAR:t===at?w.LINEAR:t===lt?w.LINEAR_MIPMAP_LINEAR:t===ht?w.UNSIGNED_BYTE:1010===t?w.BYTE:1011===t?w.SHORT:1012===t?w.UNSIGNED_SHORT:1013===t?w.INT:1014===t?w.UNSIGNED_INT:t===ct?w.FLOAT:1021===t?w.ALPHA:1022===t?w.RGB:t===ut?w.RGBA:t===tt?w.FUNC_ADD:101===t?w.FUNC_SUBTRACT:102===t?w.FUNC_REVERSE_SUBTRACT:200===t?w.ZERO:201===t?w.ONE:202===t?w.SRC_COLOR:203===t?w.ONE_MINUS_SRC_COLOR:t===et?w.SRC_ALPHA:t===it?w.ONE_MINUS_SRC_ALPHA:206===t?w.DST_ALPHA:207===t?w.ONE_MINUS_DST_ALPHA:208===t?w.DST_COLOR:209===t?w.ONE_MINUS_DST_COLOR:210===t?w.SRC_ALPHA_SATURATE:0}B(),this.context=w,this.capabilities=U,this.extensions=C,this.properties=D,this.state=N,this.getContext=function(){return w},this.getPrecision=function(){return U.precision},this.getPixelRatio=function(){return O},this.setPixelRatio=function(t){void 0!==t&&(O=t,this.setSize(y.z,y.w,!1))},this.setSize=function(t,e,i){g=t,v=e,r.width=t*O,r.height=e*O,!1!==i&&(r.style.width=t+"px",r.style.height=e+"px"),this.setViewport(0,0,t,e)},this.setViewport=function(t,e,i,r){N.viewport(y.set(t,e,i,r))},this.getClearColor=function(){return m},this.setClearColor=function(t,e){m.set(t),_=void 0!==e?e:1,N.buffers.color.setClear(m.r,m.g,m.b,_,s)},this.getClearAlpha=function(){return _},this.setClearAlpha=function(t){_=t,N.buffers.color.setClear(m.r,m.g,m.b,_,s)},this.clear=function(t,e){var i=0;(void 0===t||t)&&(i|=w.COLOR_BUFFER_BIT),(void 0===e||e)&&(i|=w.DEPTH_BUFFER_BIT),w.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearTarget=function(t,e,i){this.setRenderTarget(t),this.clear(e,i)},this.resetGLState=V,this.dispose=function(){u=[],h=[],c=d=-1,r.removeEventListener("webglcontextlost",W,!1)},this.renderBufferDirect=function(t,e,i,r,n,o){var s;!0===(s=r).transparent?N.setBlending(s.blending,s.blendEquation,s.blendSrc,s.blendDst,s.blendEquationAlpha,s.blendSrcAlpha,s.blendDstAlpha,s.premultipliedAlpha):N.setBlending(J),N.setDepthFunc(s.depthFunc),N.setDepthTest(s.depthTest),N.setDepthWrite(s.depthWrite),N.setPolygonOffset(s.polygonOffset,s.polygonOffsetFactor,s.polygonOffsetUnits);var a=function(t,e,i,r){z=0;var n=D.get(i);!1===i.needsUpdate&&(void 0===n.program?i.needsUpdate=!0:i.fog&&n.fog!==e&&(i.needsUpdate=!0));i.needsUpdate&&(!function(t,e,i){var r=D.get(t),n=k.getParameters(t,e,i),o=k.getProgramCode(t,n),s=r.program,a=!0;void 0===s?t.addEventListener("dispose",X):s.code!==o?K(t):a=!1;a&&(r.__webglShader={name:t.type,uniforms:t.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader},t.__webglShader=r.__webglShader,s=k.acquireProgram(t,n,o),r.program=s,t.program=s);var l=r.__webglShader.uniforms;r.fog=e,t.lights&&(l.ambientLightColor.value=F);var h=r.program.getUniforms(),c=At.seqWithValue(h.seq,l);r.uniformsList=c}(i,e,r),i.needsUpdate=!1);var o=!1,s=!1,a=n.program,l=a.getUniforms(),h=n.__webglShader.uniforms;a.id!==A&&(w.useProgram(a.program),A=a.id,s=o=!0);i.id!==M&&(M=i.id,s=!0);if(o||t!==R){if(l.set(w,t,"projectionMatrix"),t!==R&&(R=t,s=!0),i.isShaderMaterial){var c=l.map.cameraPosition;void 0!==c&&c.setValue(w,L.setFromMatrixPosition(t.matrixWorld))}i.isShaderMaterial&&l.setValue(w,"viewMatrix",t.matrixWorldInverse)}s&&(e&&i.fog&&(d=e,(u=h).fogColor.value=d.color,d.isFog&&(u.fogNear.value=d.near,u.fogFar.value=d.far)),At.upload(w,n.uniformsList,h,E));var u,d;return l.set(w,r,"modelViewMatrix"),l.set(w,r,"normalMatrix"),l.setValue(w,"modelMatrix",r.matrixWorld),a}(t,e,r,n),l=!1,h=i.id+"_"+a.id;h!==S&&(S=h,l=!0);var c,u=i.index,d=i.attributes.position;null!==u?(c=G).setIndex(u):c=q,l&&(!function(t,e,i,r){void 0===r&&(r=0);N.initAttributes();var n=i.attributes,o=e.getAttributes(),s=t.defaultAttributeValues;for(var a in o){var l=o[a];if(0<=l){var h=n[a];if(void 0!==h){var c=h.normalized,u=h.itemSize,d=j.getAttributeProperties(h),f=d.__webglBuffer,p=d.type,m=d.bytesPerElement;h.isInstancedBufferAttribute?(N.enableAttributeAndDivisor(l,h.meshPerAttribute,void 0),void 0===i.maxInstancedCount&&(i.maxInstancedCount=h.meshPerAttribute*h.count)):N.enableAttribute(l),w.bindBuffer(w.ARRAY_BUFFER,f),w.vertexAttribPointer(l,u,p,c,0,r*u*m)}else if(void 0!==s){var _=s[a];if(void 0!==_)switch(_.length){case 2:w.vertexAttrib2fv(l,_);break;case 3:w.vertexAttrib3fv(l,_);break;case 4:w.vertexAttrib4fv(l,_);break;default:w.vertexAttrib1fv(l,_)}}}}N.disableUnusedAttributes()}(r,a,i),null!==u&&w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,j.getAttributeBuffer(u)));var f=0;null!==u?f=u.count:void 0!==d&&(f=d.count);var p=1*i.drawRange.start,m=1*i.drawRange.count,_=null!==o?1*o.start:0,g=null!==o?1*o.count:1/0,v=Math.max(p,_),y=Math.min(f,p+m,_+g)-1,b=Math.max(0,y-v+1);if(0!==b){if(n.isMesh)switch(n.drawMode){case dt:c.setMode(w.TRIANGLES);break;case ft:c.setMode(w.TRIANGLE_STRIP);break;case 2:c.setMode(w.TRIANGLE_FAN)}else if(n.isLine){var x=r.linewidth;void 0===x&&(x=1),N.setLineWidth(x*(null===T?O:1)),n.isLineSegments?c.setMode(w.LINES):c.setMode(w.LINE_STRIP)}else n.isPoints&&c.setMode(w.POINTS);c.render(v,b)}},this.render=function(t,e,i,r){if(void 0===e||!0===e.isCamera){S="",M=-1,!(R=null)===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),e.matrixWorldInverse.getInverse(e.matrixWorld),b.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),l.length=0,d=c=-1,function t(e,i){if(!1===e.visible)return;if(e.isAmbientLight)l.push(e);else if(e.isMesh||e.isLine||e.isPoints){var r=e.material;if(!0===r.visible){!0===E.sortObjects&&(L.setFromMatrixPosition(e.matrixWorld),L.applyProjection(b));var n=j.update(e);!function(t,e,i,r,n){var o,s;i.transparent?(o=u,s=++d):(o=h,s=++c);var a=o[s];void 0!==a?(a.id=t.id,a.object=t,a.geometry=e,a.material=i,a.z=L.z,a.group=n):(a={id:t.id,object:t,geometry:e,material:i,z:L.z,group:n},o.push(a))}(e,n,r,L.z,null)}}var o=e.children;for(var s=0,a=o.length;s<a;s++)t(o[s],i)}(t,e),h.length=c+1,u.length=d+1,!0===E.sortObjects&&(h.sort(Y),u.sort(Z)),l[0]&&l[0].isAmbientLight&&(F[0]=l[0].color.r,F[1]=l[0].color.g,F[2]=l[0].color.b),x.calls=0,x.vertices=0,x.faces=0,void(x.points=0)===i&&(i=null),this.setRenderTarget(i);var n=t.background;if(null===n?N.buffers.color.setClear(m.r,m.g,m.b,_,s):n&&n.isColor&&(N.buffers.color.setClear(n.r,n.g,n.b,1,s),r=!0),(this.autoClear||r)&&this.clear(this.autoClearColor,this.autoClearDepth),t.overrideMaterial){var o=t.overrideMaterial;Q(h,t,e,o),Q(u,t,e,o)}else N.setBlending(J),Q(h,t,e),Q(u,t,e);i&&I.updateRenderTargetMipmap(i),N.setDepthTest(!0),N.setDepthWrite(!0)}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.allocTextureUnit=function(){var t=z;return t>=U.maxTextures&&console.warn("WebGLRenderer: trying to use "+t+" texture units while this GPU supports only "+U.maxTextures),z+=1,t},this.setTexture2D=(H=!1,function(t,e){t&&t.isWebGLRenderTarget&&(H||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),H=!0),t=t.texture),I.setTexture2D(t,e)}),this.setRenderTarget=function(t){var e;((T=t)&&void 0===D.get(t).__webglFramebuffer&&I.setupRenderTarget(t),t)?(e=D.get(t).__webglFramebuffer,p.copy(t.viewport)):(e=null,p.copy(y).multiplyScalar(O));f!==e&&(w.bindFramebuffer(w.FRAMEBUFFER,e),f=e),N.viewport(p)}}function se(t,e,i){this.name="",this.color=new Rt(t),this.near=void 0!==e?e:1,this.far=void 0!==i?i:1e3}function ae(){Dt.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function le(t,e,i){Dt.call(this),this.type="Line",this.geometry=void 0!==t?t:new Ht,this.material=e}function he(t,e){le.call(this,t,e),this.type="LineSegments"}function ce(t,e){Dt.call(this),this.type="Points",this.geometry=void 0!==t?t:new Ht,this.material=e}function ue(t){Dt.call(this),this.type="AmbientLight",this.color=new Rt(t)}function de(t,e,i,r){this.ray=new Ut(t,e),this.near=i||0,this.far=r||1/0}function fe(t,e){return t.distance-e.distance}function pe(t,e,i,r){if(!1!==t.visible&&(t.raycast(e,i),!0===r))for(var n=t.children,o=0,s=n.length;o<s;o++)pe(n[o],e,i,!0)}function me(){}se.prototype.isFog=!0,(ae.prototype=Object.create(Dt.prototype)).constructor=ae,le.prototype=Object.assign(Object.create(Dt.prototype),{constructor:le,isLine:!0}),he.prototype=Object.assign(Object.create(le.prototype),{constructor:he,isLineSegments:!0}),ce.prototype=Object.assign(Object.create(Dt.prototype),{constructor:ce,isPoints:!0}),ue.prototype=Object.assign(Object.create(Dt.prototype),{constructor:ue,isAmbientLight:!0}),de.prototype={constructor:de,linePrecision:1,setFromCamera:function(t,e){e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObjects:function(t,e){for(var i=[],r=0,n=t.length;r<n;r++)pe(t[r],this,i,e);return i.sort(fe),i}},me.prototype={constructor:me,getPoints:function(t){for(var e=[],i=0;i<=t;i++)e.push(this.getPoint(i/t));return e}},me.create=function(t,e){return t.prototype=Object.create(me.prototype),(t.prototype.constructor=t).prototype.getPoint=e,t};var _e=function(){var f=new pt,p=new t,m=new t,_=new t;function t(){}return t.prototype.init=function(t,e,i,r){this.c0=t,this.c1=i,this.c2=-3*t+3*e-2*i-r,this.c3=2*t-2*e+i+r},t.prototype.initNonuniformCatmullRom=function(t,e,i,r,n,o,s){var a=(e-t)/n-(i-t)/(n+o)+(i-e)/o,l=(i-e)/o-(r-e)/(o+s)+(r-i)/s;a*=o,l*=o,this.init(e,i,a,l)},t.prototype.calc=function(t){var e=t*t,i=e*t;return this.c0+this.c1*t+this.c2*e+this.c3*i},me.create(function(t){this.points=t||[],this.closed=!1},function(t){var e,i,r,n,o,s,a,l,h=this.points;(n=h.length)<2&&console.log("duh, you need at least 2 points"),r=(e=(n-(this.closed?0:1))*t)-(i=Math.floor(e)),this.closed?i+=0<i?0:(Math.floor(Math.abs(i)/h.length)+1)*h.length:0===r&&i===n-1&&(i=n-2,r=1),this.closed||0<i?o=h[(i-1)%n]:(f.subVectors(h[0],h[1]).add(h[0]),o=f),s=h[i%n],a=h[(i+1)%n],this.closed||i+2<n?l=h[(i+2)%n]:(f.subVectors(h[n-1],h[n-2]).add(h[n-1]),l=f);var c=Math.pow(o.distanceToSquared(s),.25),u=Math.pow(s.distanceToSquared(a),.25),d=Math.pow(a.distanceToSquared(l),.25);return u<1e-4&&(u=1),c<1e-4&&(c=u),d<1e-4&&(d=u),p.initNonuniformCatmullRom(o.x,s.x,a.x,l.x,c,u,d),m.initNonuniformCatmullRom(o.y,s.y,a.y,l.y,c,u,d),_.initNonuniformCatmullRom(o.z,s.z,a.z,l.z,c,u,d),new pt(p.calc(r),m.calc(r),_.calc(r))})}(),ge=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]];function ve(t){for(var e=new Float32Array(3*t.length),i=0;i<t.length;i++)e[3*i+0]=t[i].r,e[3*i+1]=t[i].g,e[3*i+2]=t[i].b;return new It(e,3)}var ye="\n#ifdef USE_COLOR\nvarying vec3 vcolor;\n#endif\nvoid main() {\n#ifdef USE_COLOR\n  vcolor = color;\n#endif\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",be="\n#include <fog_pars_fragment>\n#ifdef USE_COLOR\nvarying vec3 vcolor;\n#else\nuniform vec3 vcolor;\n#endif\nvoid main() {\n  gl_FragColor = vec4(vcolor, 1.0);\n#include <fog_fragment>\n}\n";function xe(t,e,i){for(var r=new Float32Array(3*ge.length),n=0;n<ge.length;n++){var o=ge[n];r[3*n+0]=e.x+t*(o[0]-.5),r[3*n+1]=e.y+t*(o[1]-.5),r[3*n+2]=e.z+t*(o[2]-.5)}var s=new Ct({uniforms:ze({vcolor:i.color}),vertexShader:ye,fragmentShader:be,fog:!0,linewidth:i.linewidth}),a=new Ht;return a.addAttribute("position",new It(r,3)),new he(a,s)}function we(t,e){for(var i=new Float32Array(3*ge.length),r=0;r<ge.length;r++){var n=t(ge[r]);i[3*r+0]=n[0],i[3*r+1]=n[1],i[3*r+2]=n[2]}for(var o=[new Rt(16711680),new Rt(16755200),new Rt(65280),new Rt(11206400),new Rt(255),new Rt(43775)],s=6;s<ge.length;s++)o.push(e);var a=new Ct({uniforms:ze({}),vertexShader:ye,fragmentShader:be,vertexColors:w,fog:!0,linewidth:1}),l=new Ht;return l.addAttribute("position",new It(i,3)),l.addAttribute("color",ve(o)),new he(l,a)}function Ee(t){var e,i=[];if(t&&t[0].xyz)for(e=0;e<t.length;e++){var r=t[e].xyz;i.push(r[0],r[1],r[2]),i.push(r[0],r[1],r[2])}else for(e=0;e<t.length;e++){var n=t[e];i.push(n.x,n.y,n.z),i.push(n.x,n.y,n.z)}return i}function Ae(t){for(var e=t.length,i=new Float32Array(6*e),r=0;r<e;r++){var n=t[r];i[6*r]=n.r,i[6*r+1]=n.g,i[6*r+2]=n.b,i[6*r+3]=n.r,i[6*r+4]=n.g,i[6*r+5]=n.b}return i}function Te(t){for(var e=4*t<65536?new Uint16Array(6*t):new Uint32Array(6*t),i=[0,1,2,0,2,3],r=0;r<t;r++)for(var n=0;n<6;n++)e[6*r+n]=4*r+i[n];return new It(e,1)}var Me=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * win_size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * win_size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / win_size;","}"].join("\n"),Se=["attribute vec3 other;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / win_size;","}"].join("\n"),Re=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function ze(t){var e={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var i in t)e[i]={value:t[i]};return e}var Oe=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),Le=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function Fe(t,e,i,r){for(var n=function(t,e){for(var i=[],r=0;r<t.length;r++){var n=t[r].xyz;i.push(new pt(n[0],n[1],n[2]))}return!e||e<2?i:new _e(i).getPoints((t.length-1)*e)}(t,r),o=function(t,e){if(!e||e<2)return t;for(var i=[],r=0;r<t.length-1;r++)for(var n=0;n<e;n++)i.push(t[r]);return i.push(t[t.length-1]),i}(e,r),s=function(t,e){e=e||1;var i,r=[];for(i=0;i<t.length-1;i++)for(var n=t[i],o=t[i+1],s=0;s<e;s++){var a=s/e,l=1-a;r.push(l*n[0]+a*o[0],l*n[1]+a*o[1],l*n[2]+a*o[2])}return r.push(t[i][0],t[i][1],t[i][2]),r}(i,r),a=new Dt,l=new Ht,h=new Float32Array(3*n.length),c=0;c<n.length;c++){var u=n[c];h[3*c+0]=u.x,h[3*c+1]=u.y,h[3*c+2]=u.z}l.addAttribute("position",new It(h,3)),l.addAttribute("color",ve(o));var d=new Float32Array(s);l.addAttribute("normal",new It(d,3));for(var f=new Ct({uniforms:ze({shift:0}),vertexShader:Oe,fragmentShader:Le,fog:!0,vertexColors:w}),p=-4;p<5;p++){var m=0===p?f:f.clone();m.uniforms.shift.value=.1*p,a.add(new le(l,m))}return a}function Pe(t,e){var i=new Ht,r=new Float32Array(t.vertices);i.addAttribute("position",new It(r,3));var n=t.vertices.length<196608?new Uint16Array(t.segments):new Uint32Array(t.segments);return i.setIndex(new It(n,1)),new he(i,new Ct({uniforms:ze({vcolor:e.color}),vertexShader:ye,fragmentShader:be,fog:!0,linewidth:e.linewidth}))}var Ce=["uniform vec3 ucolor;","uniform vec3 fogColor;","varying vec4 vcolor;","void main() {","  vec2 scale = vec2(projectionMatrix[0][0], projectionMatrix[1][1]);","  float z = position.z;","  float fogFactor = (z > 0.5 ? 0.2 : 0.7);","  float alpha = 0.8 * smoothstep(z > 1.5 ? -10.0 : 0.01, 0.1, scale.y);","  vcolor = vec4(mix(ucolor, fogColor, fogFactor), alpha);","  gl_Position = vec4(position.xy * scale, -0.99, 1.0);","}"].join("\n"),Ue=["varying vec4 vcolor;","void main() {","  gl_FragColor = vcolor;","}"].join("\n");function Ne(){for(var t=[],e=-50;e<=50;e++){var i=0;e%5==0&&(i=e%2==0?2:1),t.push(-50,e,i,50,e,i),t.push(e,-50,i,e,50,i)}var r=new Ht,n=new Float32Array(t);r.addAttribute("position",new It(n,3));var o=new Ct({uniforms:ze({ucolor:new Rt(8947848)}),vertexShader:Ce,fragmentShader:Ue,fog:!0});o.transparent=!0;var s=new he(r,o);return s.frustumCulled=!1,s.color_value=o.uniforms.ucolor.value,s}function De(t){return new Ct({uniforms:ze({linewidth:t.linewidth,win_size:t.win_size}),vertexShader:t.segments?Se:Me,fragmentShader:Re,fog:!0,vertexColors:w})}function Ie(t,e,i){var r=new qt(function(t,e){var i,r=t.length,n=Ee(t),o=new Float32Array(n),s=new Float32Array(6*r);for(i=0;i<6;i++)s[i]=n[i];for(;i<6*r;i++)s[i]=n[i-6];var a=new Float32Array(6*r);for(i=0;i<6*(r-1);i++)a[i]=n[i+6];for(;i<6*r;i++)a[i]=n[i];var l=new Float32Array(2*r);for(i=0;i<r;i++)l[2*i]=1,l[2*i+1]=-1;var h=Ae(e),c=new Ht;return c.addAttribute("position",new It(o,3)),c.addAttribute("previous",new It(s,3)),c.addAttribute("next",new It(a,3)),c.addAttribute("side",new It(l,1)),c.addAttribute("color",new It(h,3)),c}(e,i),t);return r.drawMode=ft,r.raycast=We,r}function je(t,e,i){var r=new qt(function(t,e){var i,r=t.length,n=Ee(t),o=new Float32Array(n),s=new Float32Array(6*r);for(i=0;i<6*r;i+=12){var a=void 0;for(a=0;a<6;a++)s[i+a]=n[i+a+6];for(;a<12;a++)s[i+a]=n[i+a-6]}var l=new Float32Array(2*r);for(i=0;i<r;i++)l[2*i]=-1,l[2*i+1]=1;var h=new Ht;if(h.addAttribute("position",new It(o,3)),h.addAttribute("other",new It(s,3)),h.addAttribute("side",new It(l,1)),null!=e){var c=Ae(e);h.addAttribute("color",new It(c,3))}return h.setIndex(Te(r/2)),h}(e,i),t);return r.raycast=We,r}var ke=["uniform float size;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = size;","}"].join("\n"),He=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n");function qe(t,e,i){for(var r=new Ht,n=new Float32Array(3*t.length),o=0;o<t.length;o++){var s=t[o].xyz;n[3*o+0]=s[0],n[3*o+1]=s[1],n[3*o+2]=s[2]}r.addAttribute("position",new It(n,3)),r.addAttribute("color",ve(e));var a=new ce(r,new Ct({uniforms:ze({size:i}),vertexShader:ke,fragmentShader:He,fog:!0,vertexColors:w}));return a.raycast=function(){},a}function Ge(t,e,i){for(var r=t.length,n=new Ht,o=new Float32Array(4*r*3),s=0;s<r;s++)for(var a=t[s].xyz,l=0;l<4;l++)for(var h=0;h<3;h++)o[3*(4*s+l)+h]=a[h];n.addAttribute("position",new It(o,3));for(var c=new Float32Array(4*r*2),u=0;u<r;u++)c[8*u+0]=-1,c[8*u+1]=-1,c[8*u+2]=-1,c[8*u+3]=1,c[8*u+4]=1,c[8*u+5]=1,c[8*u+6]=1,c[8*u+7]=-1;n.addAttribute("corner",new It(c,2));for(var d=new Float32Array(4*r*3),f=0;f<r;f++)for(var p=e[f],m=0;m<4;m++)d[3*(4*f+m)+0]=p.r,d[3*(4*f+m)+1]=p.g,d[3*(4*f+m)+2]=p.b;n.addAttribute("color",new It(d,3)),n.setIndex(Te(r));var _=new Ct({uniforms:ze({radius:i,lightDir:new pt(-.2,.3,1)}),vertexShader:"\nattribute vec2 corner;\nuniform float radius;\nvarying vec3 vcolor;\nvarying vec2 vcoor;\nvarying vec3 vpos;\n\nvoid main() {\n  vcolor = color;\n  vcoor = corner;\n  vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n  vpos = mvPosition.xyz;\n  mvPosition.xy += corner * radius;\n  gl_Position = projectionMatrix * mvPosition;\n}\n",fragmentShader:"\n#include <fog_pars_fragment>\nuniform mat4 projectionMatrix;\nuniform vec3 lightDir;\nvarying vec3 vcolor;\nvarying vec2 vcoor;\nvarying vec3 vpos;\n\nvoid main() {\n  float sq = dot(vcoor, vcoor);\n  if (sq > 1.0) discard;\n  float z = sqrt(1.0-sq);\n  vec3 xyz = vec3(vcoor.x, vcoor.y, z);\n  vec4 projPos = projectionMatrix * vec4(vpos + xyz, 1.0);\n  float ndcDepth = projPos.z / projPos.w;\n  gl_FragDepthEXT = ((gl_DepthRange.diff * ndcDepth) +\n                     gl_DepthRange.near + gl_DepthRange.far) / 2.0;\n  float weight = clamp(dot(xyz, lightDir), 0.0, 1.0);\n  gl_FragColor = vec4(weight * vcolor, 1.0);\n#include <fog_fragment>\n}\n",fog:!0,vertexColors:w});_.extensions.fragDepth=!0;var g=new qt(n,_);return g.raycast=function(){},g}var Be=new mt,Ve=new Ut;function We(t,e){var i=t.linePrecision*t.linePrecision;Be.getInverse(this.matrixWorld),Ve.copy(t.ray).applyMatrix4(Be);for(var r=new pt,n=new pt,o=new pt,s=new pt,a=this.drawMode===ft?1:2,l=this.geometry.attributes.position.array,h=0,c=l.length/6-1;h<c;h+=a){r.fromArray(l,6*h),n.fromArray(l,6*h+6);var u=Ve.distanceSqToSegment(r,n,s,o);if(!(i<u)){s.applyMatrix4(this.matrixWorld);var d=t.ray.origin.distanceTo(s);d<t.near||d>t.far||e.push({distance:d,point:o.clone().applyMatrix4(this.matrixWorld),index:h,object:this,line_dist:Math.sqrt(u)})}}}function Xe(t,e){if("undefined"!=typeof document){var i=document.createElement("canvas");i.width=256,i.height=16;var r=i.getContext("2d");return r?(r.font=(e.font||"bold 14px")+" sans-serif",r.textBaseline="bottom",e.color&&(r.fillStyle=e.color),r.fillText(t,0,i.height),i):null}}var Ke=["uniform vec2 canvas_size;","uniform vec2 win_size;","varying vec2 vUv;","void main() {","  vUv = uv;","  vec2 rel_offset = vec2(0.02, -0.3);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_Position.xy += (uv + rel_offset) * 2.0 * canvas_size / win_size;","  gl_Position.z += 0.2 * projectionMatrix[2][2];","}"].join("\n"),Ye=["#include <fog_pars_fragment>","varying vec2 vUv;","uniform sampler2D map;","void main() {","  gl_FragColor = texture2D(map, vUv);","#include <fog_fragment>","}"].join("\n");function Ze(t,e){var i=Xe(t,e);if(i){var r=new B(i);r.needsUpdate=!0;var n=new Ht,o=e.pos,s=new Float32Array([].concat(o,o,o,o)),a=new Float32Array([0,1,1,1,0,0,1,0]),l=new Uint16Array([0,2,1,2,3,1]);n.setIndex(new It(l,1)),n.addAttribute("position",new It(s,3)),n.addAttribute("uv",new It(a,2));var h=new Ct({uniforms:ze({map:r,canvas_size:[i.width,i.height],win_size:e.win_size}),vertexShader:Ke,fragmentShader:Ye,fog:!0});h.transparent=!0;var c=new qt(n,h);return c.remake=function(t,e){r.image=Xe(t,e),r.needsUpdate=!0},c}}function Qe(t,e,i){t.push(new pt(e[0]-i,e[1],e[2])),t.push(new pt(e[0]+i,e[1],e[2])),t.push(new pt(e[0],e[1]-i,e[2])),t.push(new pt(e[0],e[1]+i,e[2])),t.push(new pt(e[0],e[1],e[2]-i)),t.push(new pt(e[0],e[1],e[2]+i))}var $e={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},Je=function(l,h){var c=1,u=$e.NONE,d=new pt,f=new pt,p=new T,m=new T,_=0,g=0,v=new T,y=new T,b=!0,x=null,w=null,E=null;this.slab_width=[2.5,7.5,null],this.toggle_auto=function(t){u===$e.AUTO_ROTATE&&typeof t==typeof x?u=$e.NONE:(u=$e.AUTO_ROTATE,w=null,x=t)},this.is_going=function(){return u===$e.GO},this.is_moving=function(){return u!==$e.NONE},this.update=function(){var t,e,i,r,n,o=!1,s=l.position.clone().sub(h);if(u===$e.AUTO_ROTATE&&function(t){d.copy(t).normalize();var e=Date.now(),i=18e-6*(null!==w?e-w:16.7)*c;w=e,!0===x?i=-i:!1!==x&&(x+=.02,i=4e-5*c*Math.cos(x)),f.crossVectors(l.up,t).multiplyScalar(i).add(d)}(s),d.equals(f)||(t=s,(e=new A).setFromUnitVectors(f,d),t.applyQuaternion(e),l.up.applyQuaternion(e),f.applyQuaternion(e),d.copy(f),o=!0),g!==_&&(l.zoom*=g/_,_=g,o=!0),!m.equals(p)){var a=(i=s,r=m.x-p.x,n=m.y-p.y,u===$e.ZOOM?l.zoom/=1-r+n:u===$e.SLAB?h.addScaledVector(i,-5/i.length()*n):u===$e.ROLL&&l.up.applyAxisAngle(i,.05*(r-n)),p.copy(m),u===$e.SLAB?10*r:null);a&&(this.slab_width[0]=Math.max(this.slab_width[0]+a,.01),this.slab_width[1]=Math.max(this.slab_width[1]+a,.01)),o=!0}return y.equals(v)||(!function(t){var e=y.x-v.x,i=y.y-v.y;e*=.5*(l.right-l.left)/l.zoom,i*=.5*(l.bottom-l.top)/l.zoom;var r=t.clone().cross(l.up).setLength(e);r.addScaledVector(l.up,i/l.up.length()),l.position.add(r),h.add(r),v.copy(y)}(s),o=b=!0),l.position.addVectors(h,s),u===$e.GO&&E&&(E(),o=!0),l.lookAt(h),o},this.start=function(t,e,i,r){switch(u!==$e.NONE&&u!==$e.AUTO_ROTATE||(u=t),this.move(e,i,r),u){case $e.ROTATE:d.copy(f);break;case $e.ZOOM:case $e.SLAB:case $e.ROLL:p.copy(m);break;case $e.PAN:v.copy(y),b=!1;break;case $e.PAN_ZOOM:_=g,v.copy(y)}},this.move=function(t,e,i){switch(u){case $e.ROTATE:var r=function(t,e){var i=0,r=t*t+e*e;if(r<1)i=Math.sqrt(1-r);else{var n=Math.sqrt(r);t/=n,e/=n}return[t,e,i]}(t,e),n=l.position.clone().sub(h);f.crossVectors(l.up,n).setLength(r[0]),f.addScaledVector(l.up,r[1]/l.up.length()),f.addScaledVector(n,r[2]/n.length());break;case $e.ZOOM:case $e.SLAB:case $e.ROLL:m.set(t,e);break;case $e.PAN:y.set(t,e);break;case $e.PAN_ZOOM:if(null==i)return;y.set(t,e),g=i}},this.stop=function(){var t=null;return u!==$e.PAN||b||(t=v),u=$e.NONE,d.copy(f),_=g,v.copy(y),t},this.go_to=function(e,i,r,t){if(e instanceof Array&&(e=new pt(e[0],e[1],e[2])),e&&!(e.distanceToSquared(h)<.001)||i&&!(i.distanceToSquared(l.position)<.1)||r&&!(r.distanceToSquared(l.up)<.1)){u=$e.GO,t=(t||60)/c;for(var n=[],o=0,s=1;s<=t;++s){var a=s/t;a=a<.5?2*a*a:-2*a*(a-2)-1,n.push((a-o)/(1-o)),o=a}E=function(){var t=n.shift();e&&(i||l.position.sub(h),h.lerp(e,t),i||l.position.add(h)),i&&l.position.lerp(i,t),r&&l.up.lerp(r,t),0===n.length&&(u=$e.NONE,E=null)}}}},ti=["element","B-factor","occupancy","index","chain"],ei=["lines","trace","ribbon"],ii=["normal","ball&stick"],ri=["marching cubes","squarish"],ni=["normal","simplistic"],oi=["bold 14px","14px","16px","bold 16px"];function si(t,e,i){var r=new Rt(14737632);if(e<i){var n=(240-240*((t-e)/(i-e)))/360;r.setHSL(n,1,.5)}return r}function ai(t,e,i,r){var n,o=e[e.length-1];if("index"===t)n=function(t){return si(t.i_seq,0,o.i_seq)};else if("B-factor"===t){for(var s=1/0,a=-1/0,l=0;l<e.length;l++){var h=e[l].b;a<h&&(a=h),h<s&&(s=h)}n=function(t){return si(t.b,s,a)}}else if("occupancy"===t)n=function(t){return si(t.occ,0,1)};else if("chain"===t)n=function(t){return si(t.chain_index,0,o.chain_index)};else if(0===r)n=function(t){return i[t.element]||i.def};else{var c=i.C.getHSL(),u=new Rt(0,0,0);u.setHSL(c.h+r,c.s,c.l),n=function(t){var e=t.element;return"C"===e?u:i[e]||i.def}}return e.map(n)}function li(t,e){return t*e[1]/700}var hi=function(t,e,i){this.map=t,this.name="",this.isolevel=i?3:e.default_isolevel,this.visible=!0,this.types=i?["map_pos","map_neg"]:["map_den"],this.block_ctr=new pt(1/0,0,0),this.el_objects=[]},ci=function t(e,i,r){this.model=e,this.label="(model #"+ ++t.ctor_counter+")",this.visible=!0,this.hue_shift=0,this.conf=i,this.win_size=r,this.atomic_objects=[]};function ui(t,e){return[t.x.toFixed(e),t.y.toFixed(e),t.z.toFixed(e)]}function di(t){var e=t.touches,i=e[0].pageX-e[1].pageX,r=e[0].pageY-e[1].pageY;return{pageX:(e[0].pageX+e[1].pageX)/2,pageY:(e[0].pageY+e[1].pageY)/2,dist:Math.sqrt(i*i+r*r)}}ci.prototype.get_visible_atoms=function(){var t=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return t;for(var e=[],i=0,r=t;i<r.length;i+=1){var n=r[i];"H"!==n.element&&e.push(n)}return e},ci.prototype.add_bonds=function(t,e){for(var i=this.get_visible_atoms(),r=ai(t?"element":this.conf.color_aim,i,this.conf.colors,this.hue_shift),n=[],o=[],s=this.conf.hydrogens,a=0;a<i.length;a++){var l=i[a],h=r[a];if(!t||l.is_ligand)if(0===l.bonds.length&&null==e){Qe(n,l.xyz,.7);for(var c=0;c<6;c++)o.push(h)}else for(var u=0;u<l.bonds.length;u++){var d=this.model.atoms[l.bonds[u]];if((s||"H"!==d.element)&&(!t||d.is_ligand)){var f=l.midpoint(d),p=new pt(f[0],f[1],f[2]),m=new pt(l.xyz[0],l.xyz[1],l.xyz[2]);if(null!=e){var _=m.distanceTo(p)/e;m.lerp(p,_)}n.push(m,p),o.push(h,h)}}}if(0!==n.length){var g=li(this.conf.bond_line,this.win_size),v=De({linewidth:g,win_size:this.win_size,segments:!0});this.atomic_objects.push(je(v,n,o)),null!=e?this.atomic_objects.push(Ge(i,r,e)):"simplistic"===this.conf.line_style||t||this.atomic_objects.push(qe(i,r,g))}},ci.prototype.add_trace=function(){for(var t=this.model.extract_trace(),e=[].concat.apply([],t),i=ai(this.conf.color_aim,e,this.conf.colors,this.hue_shift),r=De({linewidth:li(this.conf.bond_line,this.win_size),win_size:this.win_size}),n=0,o=0,s=t;o<s.length;o+=1){var a=s[o],l=i.slice(n,n+a.length);n+=a.length;var h=Ie(r,a,l);this.atomic_objects.push(h)}},ci.prototype.add_ribbon=function(t){for(var e=this.model.extract_trace(),i=this.model.get_residues(),r=[].concat.apply([],e),n=ai(this.conf.color_aim,r,this.conf.colors,this.hue_shift),o=0,s=0,a=e;s<a.length;s+=1){for(var l=a[s],h=[],c=[0,0,0],u=0,d=l;u<d.length;u+=1){var f=i[d[u].resid()],p=this.model.calculate_tangent_vector(f);p[0]*c[0]+p[1]*c[1]+p[2]*c[2]<0&&(p[0]=-p[0],p[1]=-p[1],p[2]=-p[2]),h.push(p),c=p}var m=n.slice(o,o+l.length);o+=l.length;var _=Fe(l,m,h,t);this.atomic_objects.push(_)}},ci.ctor_counter=0;var fi=function t(e){if(this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null,zoom_grid:Ne(),mark:null},this.labels={},this.nav=null,this.xhr_headers={},this.config={bond_line:4,map_line:1.25,map_radius:10,max_map_radius:40,default_isolevel:1.5,center_cube_size:.1,map_style:ri[0],render_style:ei[0],ligand_style:ii[0],color_aim:ti[0],line_style:ni[0],label_font:oi[0],colors:this.ColorSchemes[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.last_ctr=new pt(1/0,0,0),this.selected={bag:null,atom:null},this.scene=new ae,this.scene.fog=new se(this.config.colors.bg,0,1),this.light=new ue(16777215),this.scene.add(this.light),this.default_camera_pos=[0,0,100],e.share_view?(this.target=e.share_view.target,this.camera=e.share_view.camera,this.controls=e.share_view.controls,this.tied_viewer=e.share_view,this.tied_viewer.tied_viewer=this):(this.target=new pt(0,0,0),this.camera=new Bt,this.camera.position.fromArray(this.default_camera_pos),this.controls=new Je(this.camera,this.target)),this.raycaster=new de,this.set_common_key_bindings(),this.constructor===t&&this.set_real_space_key_bindings(),"undefined"!=typeof document){this.hud_el=n("hud");try{this.renderer=new oe({antialias:!0})}catch(t){return this.hud("No WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=n("viewer"),this.help_el=n("help"),this.hud_el&&(""===this.hud_el.innerHTML&&(this.hud_el.innerHTML='This is UglyMol not Coot. <a href="#" onclick="V.toggle_help(); return false;">H shows help.</a>'),this.initial_hud_html=this.hud_el.innerHTML),null!=this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.update_camera();var i=this.renderer.domElement;this.container.appendChild(i),e.focusable&&(i.tabIndex=0),this.decor.zoom_grid.visible=!1,this.scene.add(this.decor.zoom_grid),window.addEventListener("resize",this.resize.bind(this)),(e.focusable?i:window).addEventListener("keydown",this.keydown.bind(this)),i.addEventListener("contextmenu",function(t){t.preventDefault()}),i.addEventListener("mousewheel",this.mousewheel.bind(this)),i.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),i.addEventListener("mousedown",this.mousedown.bind(this)),i.addEventListener("touchstart",this.touchstart.bind(this)),i.addEventListener("touchmove",this.touchmove.bind(this)),i.addEventListener("touchend",this.touchend.bind(this)),i.addEventListener("touchcancel",this.touchend.bind(this)),i.addEventListener("dblclick",this.dblclick.bind(this));var r=this;this.mousemove=function(t){t.preventDefault(),r.controls.move(r.relX(t),r.relY(t))},this.mouseup=function(t){t.preventDefault(),t.stopPropagation(),document.removeEventListener("mousemove",r.mousemove),document.removeEventListener("mouseup",r.mouseup),r.decor.zoom_grid.visible=!1;var e=r.controls.stop();if(e){var i=r.pick_atom(e,r.camera);null!=i&&r.select_atom(i,{steps:60})}r.redraw_maps()},this.scheduled=!1,this.request_render()}}function n(t){return null===e[t]?null:document.getElementById(e[t]||t)}};fi.prototype.pick_atom=function(t,e){for(var i=0,r=this.model_bags;i<r.length;i+=1){var n=r[i];if(n.visible){this.raycaster.setFromCamera(t,e),this.raycaster.near=e.near,this.raycaster.far=e.far-.15*(e.far-e.near),this.raycaster.linePrecision=.3;var o=this.raycaster.intersectObjects(n.atomic_objects);if(0<o.length){o.sort(function(t){return t.line_dist||1/0});var s=o[0].point,a=n.model.get_nearest_atom(s.x,s.y,s.z);if(null!=a)return{bag:n,atom:a}}}}},fi.prototype.set_colors=function(t){function e(t){return new Rt(t)}if(null==t)t=this.config.colors;else if("number"==typeof t)t=this.ColorSchemes[t%this.ColorSchemes.length];else if("string"==typeof t){for(var i=0,r=this.ColorSchemes;i<r.length;i+=1){var n=r[i];if(n.name===t){t=n;break}}throw Error("Unknown color scheme.")}if("number"==typeof t.bg)for(var o in t)"name"!==o&&(t[o]=t[o]instanceof Array?t[o].map(e):e(t[o]));this.decor.zoom_grid.color_value.set(t.fg),this.config.config=t,this.redraw_all()},fi.prototype.relX=function(t){return 2*(t.pageX-this.window_offset[0])/this.window_size[0]-1},fi.prototype.relY=function(t){return 1-2*(t.pageY-this.window_offset[1])/this.window_size[1]},fi.prototype.hud=function(t,e){if("undefined"!=typeof document){var i=this.hud_el;if(i){null!=t?"HTML"===e?i.innerHTML=t:i.textContent=t:i.innerHTML=this.initial_hud_html;var r="ERR"===e;i.style.backgroundColor=r?"#b00":"",r&&t&&console.log("ERR: "+t)}else console.log("hud:",t)}},fi.prototype.redraw_center=function(t){var e=this.config.center_cube_size;(t||this.target.distanceToSquared(this.last_ctr)>.01*e*e)&&(this.last_ctr.copy(this.target),this.decor.mark&&this.scene.remove(this.decor.mark),this.decor.mark=xe(e,this.target,{color:this.config.colors.center,linewidth:2,win_size:this.window_size}),this.scene.add(this.decor.mark))},fi.prototype.redraw_maps=function(t){this.redraw_center(t);for(var e=this.config.map_radius,i=0,r=this.map_bags;i<r.length;i+=1){var n=r[i];(t||this.target.distanceToSquared(n.block_ctr)>e/100)&&this.redraw_map(n)}},fi.prototype.remove_and_dispose=function(t){this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material&&(t.material.uniforms&&t.material.uniforms.map&&t.material.uniforms.map.value.dispose(),t.material.dispose());for(var e=0,i=t.children;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}},fi.prototype.clear_el_objects=function(t){for(var e=0,i=t.el_objects;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}t.el_objects=[]},fi.prototype.clear_atomic_objects=function(t){for(var e=0,i=t.atomic_objects;e<i.length;e+=1){var r=i[e];this.remove_and_dispose(r)}t.atomic_objects=[]},fi.prototype.set_atomic_objects=function(t){t.atomic_objects=[];switch(t.conf.render_style){case"lines":if(t.add_bonds(),"ball&stick"===t.conf.ligand_style){var e=t.model.atoms.filter(function(t){return t.is_ligand&&"H"!==t.element}),i=Ge(e,ai("element",e,t.conf.colors,t.hue_shift),.3);t.atomic_objects.push(i)}break;case"ball&stick":t.add_bonds(!1,.3);break;case"trace":t.add_trace(),t.add_bonds(!0);break;case"ribbon":t.add_ribbon(8),t.add_bonds(!0)}for(var r=0,n=t.atomic_objects;r<n.length;r+=1){var o=n[r];this.scene.add(o)}},fi.prototype.toggle_label=function(t,e){if(null!=t.atom){var i=t.atom.short_label(),r=i,n=r in this.labels;if(void 0===e&&(e=!n),e){if(n)return;if(null==t.atom)return;var o=Ze(i,{pos:t.atom.xyz,font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString(),win_size:this.window_size});if(!o)return;if(null==t.bag)return;this.labels[r]={o:o,bag:t.bag},this.scene.add(o)}else{if(!n)return;this.remove_and_dispose(this.labels[r].o),delete this.labels[r]}}},fi.prototype.redraw_labels=function(){for(var t in this.labels){var e=t;this.labels[t].o.remake(e,{font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString()})}},fi.prototype.toggle_map_visibility=function(t){"number"==typeof t&&(t=this.map_bags[t]),t.visible=!t.visible,this.redraw_map(t),this.request_render()},fi.prototype.redraw_map=function(t){this.clear_el_objects(t),t.visible&&(t.map.block.clear(),this.add_el_objects(t))},fi.prototype.toggle_model_visibility=function(t,e){null!=(t=t||this.selected.bag)&&(t.visible=null==e?!t.visible:e,this.redraw_model(t),this.request_render())},fi.prototype.redraw_model=function(t){this.clear_atomic_objects(t),t.visible&&this.set_atomic_objects(t)},fi.prototype.redraw_models=function(){for(var t=0,e=this.model_bags;t<e.length;t+=1){var i=e[t];this.redraw_model(i)}},fi.prototype.add_el_objects=function(t){if(t.visible&&!(this.config.map_radius<=0)){if(t.map.block.empty()){var e=this.target;t.block_ctr.copy(e),t.map.extract_block(this.config.map_radius,[e.x,e.y,e.z])}for(var i=0,r=t.types;i<r.length;i+=1){var n=r[i],o=("map_neg"===n?-1:1)*t.isolevel,s=t.map.isomesh_in_block(o,this.config.map_style);if(null!=s){var a=Pe(s,{color:this.config.colors[n],linewidth:this.config.map_line});t.el_objects.push(a),this.scene.add(a)}}}},fi.prototype.change_isolevel_by=function(t,e){if(!(t>=this.map_bags.length)){var i=this.map_bags[t];i.isolevel+=e,this.clear_el_objects(i),this.add_el_objects(i);var r=i.map.abs_level(i.isolevel).toFixed(4),n=this.tied_viewer;if(n&&t<n.map_bags.length){var o=n.map_bags[t];o.isolevel=i.isolevel,r+=" / "+o.map.abs_level(o.isolevel).toFixed(4),n.clear_el_objects(o),n.add_el_objects(o)}this.hud("map "+(t+1)+" level =  "+r+" "+i.map.unit+" ("+i.isolevel.toFixed(2)+" rmsd)")}},fi.prototype.change_map_radius=function(t){var e=this.config.max_map_radius,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+t,0),e),i.map_radius=Math.round(1e9*i.map_radius)/1e9;var r='map "radius": '+i.map_radius;i.map_radius===e?r+=" (max)":0===i.map_radius&&(r+=" (hidden maps)"),0===this.map_bags.length&&(r+="\nNB: no map is loaded."),this.hud(r),this.redraw_maps(!0)},fi.prototype.change_slab_width_by=function(t){var e=this.controls.slab_width;e[0]=Math.max(e[0]+t,.01),e[1]=Math.max(e[1]+t,.01),this.update_camera();var i=this.camera.far-this.camera.near;this.hud("clip width: "+i.toPrecision(3))},fi.prototype.change_zoom_by_factor=function(t){this.camera.zoom*=t,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toPrecision(3))},fi.prototype.change_bond_line=function(t){this.config.bond_line=Math.max(this.config.bond_line+t,.1),this.redraw_models(),this.hud("bond width: "+li(this.config.bond_line,this.window_size).toFixed(1))},fi.prototype.change_map_line=function(t){this.config.map_line=Math.max(this.config.map_line+t,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))},fi.prototype.toggle_full_screen=function(){var t=document;if(t.fullscreenElement||t.mozFullScreenElement||t.webkitFullscreenElement||t.msFullscreenElement){var e=t.exitFullscreen||t.webkitExitFullscreen||t.mozCancelFullScreen||t.msExitFullscreen;e&&e.call(t)}else{var i=this.container;if(!i)return;var r=i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen;r&&r.call(i)}},fi.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var t=this.get_cell_box_func();t&&(this.decor.cell_box=we(t,this.config.colors.fg),this.scene.add(this.decor.cell_box))}},fi.prototype.get_cell_box_func=function(){var t=null;return null!=this.selected.bag&&(t=this.selected.bag.model.unit_cell),null==t&&0<this.map_bags.length&&(t=this.map_bags[0].map.unit_cell),t&&t.orthogonalize.bind(t)},fi.prototype.shift_clip=function(t){var e=this.camera.position.clone().sub(this.target);e.multiplyScalar(t/e.length()),this.target.add(e),this.camera.position.add(e),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+ui(e,2).join(" ")+"]")},fi.prototype.go_to_nearest_Ca=function(){var t=this.target,e=this.selected.bag;if(null!=e){var i=e.model.get_nearest_atom(t.x,t.y,t.z,"CA");null!=i?this.select_atom({bag:e,atom:i},{steps:30}):this.hud("no nearby CA")}},fi.prototype.toggle_inactive_models=function(){var t=this.model_bags.length;if(t<2)this.hud((0==t?"No":"Only one")+' model is loaded. "V" is for working with multiple models.');else{for(var e=!this.model_bags.every(function(t){return t.visible}),i=0,r=this.model_bags;i<r.length;i+=1){var n=r[i],o=e||n===this.selected.bag;this.toggle_model_visibility(n,o)}this.hud(e?"All models visible":"Inactive models hidden")}},fi.prototype.permalink=function(){if("undefined"!=typeof window){var t=Math.round(-Math.log10(.001));window.location.hash="#xyz="+ui(this.target,t).join(",")+"&eye="+ui(this.camera.position,1).join(",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar")}},fi.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0),this.redraw_labels())},fi.prototype.toggle_help=function(){var t=this.help_el;t&&(t.style.display="block"===t.style.display?"none":"block",""===t.innerHTML&&(t.innerHTML=[this.MOUSE_HELP,this.KEYBOARD_HELP,this.ABOUT_HELP].join("\n\n")))},fi.prototype.select_next=function(t,e,i,r){var n=i.indexOf(this.config[e]),o=i.length,s=(n+(r?o-1:1))%o;this.config[e]=i[s];for(var a=t+":",l=0;l<o;l++){var h=l===s?"u":"s";a+=" <"+h+">"+("string"==typeof i[l]?i[l]:i[l].name)+"</"+h+">"}this.hud(a,"HTML")},fi.prototype.keydown=function(t){var e=this.key_bindings[t.keyCode];e?e.bind(this)(t):(!1===e&&t.preventDefault(),this.help_el&&this.hud("Nothing here. Press H for help.")),this.request_render()},fi.prototype.set_common_key_bindings=function(){var t=new Array(256);t[66]=function(t){this.select_next("color scheme","colors",this.ColorSchemes,t.shiftKey),this.set_colors()},t[67]=function(t){this.select_next("coloring by","color_aim",ti,t.shiftKey),this.redraw_models()},t[69]=function(){var t=this.scene.fog,e=1===t.far;t.far=e?1e9:1,this.hud((e?"dis":"en")+"able fog"),this.redraw_all()},t[72]=this.toggle_help,t[73]=function(t){this.hud("toggled spinning"),this.controls.toggle_auto(t.shiftKey)},t[75]=function(){this.hud("toggled rocking"),this.controls.toggle_auto(0)},t[77]=function(t){this.change_zoom_by_factor(t.shiftKey?1.2:1.03)},t[78]=function(t){this.change_zoom_by_factor(1/(t.shiftKey?1.2:1.03))},t[81]=function(t){this.select_next("label font","label_font",oi,t.shiftKey),this.redraw_labels()},t[82]=function(t){t.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("recentered"),this.recenter())},t[87]=function(t){this.select_next("map style","map_style",ri,t.shiftKey),this.redraw_maps(!0)},t[107]=t[61]=t[187]=function(t){this.change_isolevel_by(t.shiftKey?1:0,.1)},t[109]=t[173]=t[189]=function(t){this.change_isolevel_by(t.shiftKey?1:0,-.1)},t[219]=function(){this.change_map_radius(-2)},t[221]=function(){this.change_map_radius(2)},t[220]=function(t){this.select_next("bond lines","line_style",ni,t.shiftKey),this.redraw_models()},t[16]=t[17]=t[18]=t[225]=function(){},t[191]=t[222]=!1,this.key_bindings=t},fi.prototype.set_real_space_key_bindings=function(){var t=this.key_bindings;t[36]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_bond_line(.2)},t[35]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_bond_line(-.2)},t[32]=function(t){this.center_next_residue(t.shiftKey)},t[68]=function(){this.change_slab_width_by(-.1)},t[70]=function(t){t.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1)},t[76]=function(t){this.select_next("ligands as","ligand_style",ii,t.shiftKey),this.redraw_models()},t[80]=function(t){t.shiftKey?this.permalink():this.go_to_nearest_Ca()},t[84]=function(t){this.select_next("rendering as","render_style",ei,t.shiftKey),this.redraw_models()},t[85]=function(){this.hud("toggled unit cell box"),this.toggle_cell_box()},t[86]=function(){this.toggle_inactive_models()},t[89]=function(t){this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models()},t[188]=function(t){t.shiftKey&&this.shift_clip(1)},t[190]=function(t){t.shiftKey&&this.shift_clip(-1)}},fi.prototype.mousedown=function(t){t.stopPropagation(),document.addEventListener("mouseup",this.mouseup),document.addEventListener("mousemove",this.mousemove);var e=$e.NONE;1===t.button||0===t.button&&t.ctrlKey?e=$e.PAN:0===t.button?(t.shiftKey&&this.dblclick(t),e=$e.ROTATE):2===t.button&&(t.ctrlKey?e=t.shiftKey?$e.ROLL:$e.SLAB:(this.decor.zoom_grid.visible=!0,e=$e.ZOOM)),this.controls.start(e,this.relX(t),this.relY(t)),this.request_render()},fi.prototype.dblclick=function(t){if(0===t.button){this.decor.selection&&(this.remove_and_dispose(this.decor.selection),this.decor.selection=null);var e=new T(this.relX(t),this.relY(t)),i=this.pick_atom(e,this.camera);if(i){var r=i.atom;this.hud(i.bag.label+" "+r.long_label()),this.toggle_label(i);var n=this.config.colors[r.element]||this.config.colors.def,o=2.5*li(this.config.bond_line,this.window_size);this.decor.selection=qe([r],[n],o),this.scene.add(this.decor.selection)}else this.hud();this.request_render()}},fi.prototype.touchstart=function(t){var e=t.touches;if(1===e.length)this.controls.start($e.ROTATE,this.relX(e[0]),this.relY(e[0]));else{var i=di(t);this.controls.start($e.PAN_ZOOM,this.relX(i),this.relY(i),i.dist)}this.request_render()},fi.prototype.touchmove=function(t){t.preventDefault(),t.stopPropagation();var e=t.touches;if(1===e.length)this.controls.move(this.relX(e[0]),this.relY(e[0]));else{var i=di(t);this.controls.move(this.relX(i),this.relY(i),i.dist)}},fi.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},fi.prototype.mousewheel=function(t){t.preventDefault(),t.stopPropagation();var e=t.wheelDelta||-2*(t.detail||0);this.mousewheel_action(e,t),this.request_render()},fi.prototype.mousewheel_action=function(t,e){this.change_isolevel_by(e.shiftKey?1:0,5e-4*t)},fi.prototype.resize=function(){var t=this.container;if(null!=t){var e=t.clientWidth,i=t.clientHeight;this.window_offset[0]=t.offsetLeft,this.window_offset[1]=t.offsetTop,this.camera.left=-e,this.camera.right=e,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,i),e===this.window_size[0]&&i===this.window_size[1]||(this.window_size[0]=e,this.window_size[1]=i,this.redraw_models()),this.request_render()}},fi.prototype.recenter=function(t,e,i){var r,n=this.selected.bag;if(null!=t&&null==e&&null!=n){var o=n.model.get_center(),s=new pt(t[0]-o[0],t[1]-o[1],t[2]-o[2]);s.setLength(100),(r=s.y<90?new pt(0,1,0):new pt(1,0,0)).projectOnPlane(s).normalize(),t=new pt(t[0],t[1],t[2]),e=s.add(t)}else{if(null==t)if(null!=n)t=n.model.get_center();else{var a=this.get_cell_box_func();t=a?a([.5,.5,.5]):[0,0,0]}if(null!=e)e=new pt(e[0],e[1],e[2]),r=null;else{var l=this.default_camera_pos;e=new pt(t[0]+l[0],t[1]+l[1],t[2]+l[2]),r=Dt.DefaultUp}}this.controls.go_to(t,e,r,i)},fi.prototype.center_next_residue=function(t){var e=this.selected.bag;if(null!=e){var i=e.model.next_residue(this.selected.atom,t);null!=i&&this.select_atom({bag:e,atom:i},{steps:30})}},fi.prototype.select_atom=function(t,e){void 0===e&&(e={}),this.hud("-> "+t.bag.label+" "+t.atom.long_label()),this.controls.go_to(t.atom.xyz,null,null,e.steps),this.toggle_label(this.selected,!1),this.selected={bag:t.bag,atom:t.atom},this.toggle_label(this.selected,!0)},fi.prototype.update_camera=function(){var t=this.camera.position.distanceTo(this.target),e=this.controls.slab_width,i=e[2]||this.camera.zoom;this.camera.near=t*(1-e[0]/i),this.camera.far=t*(1+e[1]/i),this.camera.updateProjectionMatrix()},fi.prototype.render=function(){if(this.scheduled=!0,null!==this.renderer){this.controls.update()&&this.update_camera();var t=this.tied_viewer;this.controls.is_going()||(this.redraw_maps(),t&&!t.scheduled&&t.redraw_maps()),this.renderer.render(this.scene,this.camera),t&&!t.scheduled&&t.renderer.render(t.scene,t.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update()}},fi.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},fi.prototype.add_model=function(t,e){void 0===e&&(e={});var i=new ci(t,this.config,this.window_size);i.hue_shift=e.hue_shift||.06*this.model_bags.length,this.model_bags.push(i),this.set_atomic_objects(i),this.request_render()},fi.prototype.add_map=function(t,e){var i=new hi(t,this.config,e);this.map_bags.push(i),this.add_el_objects(i),this.request_render()},fi.prototype.load_file=function(i,t,e){if(null!==this.renderer){var r=new XMLHttpRequest;for(var n in r.open("GET",i,!0),t.binary?r.responseType="arraybuffer":r.overrideMimeType("text/plain"),this.xhr_headers)this.xhr_headers.hasOwnProperty(n)&&r.setRequestHeader(n,this.xhr_headers[n]);var o=this;r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status&&null!==r.response&&""!==r.response)try{e(r)}catch(t){o.hud("Error: "+t.message+"\nwhen processing "+i,"ERR")}else o.hud("Failed to fetch "+i,"ERR")},t.progress&&r.addEventListener("progress",function(t){if(t.lengthComputable&&t.loaded&&t.total){var e=i.split("/").pop();o.hud("loading "+e+" ... "+(t.loaded/1024|0)+" / "+(t.total/1024|0)+" kB"),t.loaded===t.total&&o.hud()}});try{r.send(null)}catch(t){o.hud("loading "+i+" failed:\n"+t,"ERR")}}},fi.prototype.set_dropzone=function(t,o){var s=this;t.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",s.hud("ready for file drop...")}),t.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault();for(var e=[],i=0,r=t.dataTransfer.files;i<r.length;i+=1){var n=r[i];try{o(n)}catch(t){return void s.hud("Loading "+n.name+" failed.\n"+t.message,"ERR")}e.push(n.name)}s.hud("loading "+e.join(", "))})},fi.prototype.set_pdb_and_map_dropzone=function(t){var r=this;this.set_dropzone(t,function(t){var e=new FileReader;if(/\.(pdb|ent)$/.test(t.name))e.onload=function(t){r.load_pdb_from_text(t.target.result),r.recenter()},e.readAsText(t);else{if(!/\.(map|ccp4|mrc|dsn6|omap)$/.test(t.name))throw Error("Unknown file extension. Use: pdb, ent, ccp4, mrc, map, dsn6 or omap.");var i=/\.(dsn6|omap)$/.test(t.name)?"dsn6":"ccp4";e.onloadend=function(t){2==t.target.readyState&&(r.load_map_from_buffer(t.target.result,{format:i}),0===r.model_bags.length&&1===r.map_bags.length&&r.recenter())},e.readAsArrayBuffer(t)}})},fi.prototype.set_view=function(t){var e=function(){var t={};if("undefined"==typeof window)return t;for(var e=window.location.hash.substr(1).split("&"),i=0;i<e.length;i++){var r=e[i].split("="),n=r[1];"xyz"===r[0]||"eye"===r[0]?n=n.split(",").map(Number):"zoom"===r[0]&&(n=Number(n)),t[r[0]]=n}return t}();e.zoom&&(this.camera.zoom=e.zoom),this.recenter(e.xyz||t&&t.center,e.eye,1)},fi.prototype.load_pdb_from_text=function(t){for(var e=this.model_bags.length,i=0,r=s(t);i<r.length;i+=1){var n=r[i];this.add_model(n)}this.selected.bag=this.model_bags[e]},fi.prototype.load_pdb=function(t,e,i){var r=this;this.load_file(t,{binary:!1,progress:!0},function(t){r.load_pdb_from_text(t.responseText),null!=e&&e.stay||r.set_view(e),i&&i()})},fi.prototype.load_map=function(t,e,i){if(null!=t){if("ccp4"!==e.format&&"dsn6"!==e.format)throw Error("Unknown map format.");var r=this;this.load_file(t,{binary:!0,progress:!0},function(t){r.load_map_from_buffer(t.response,e),i&&i()})}else i&&i()},fi.prototype.load_map_from_buffer=function(t,e){var i=new l;"dsn6"===e.format?i.from_dsn6(t):i.from_ccp4(t,!0),this.add_map(i,e.diff_map)},fi.prototype.load_maps=function(t,e,i,r){var n=i.format||"ccp4",o=this;this.load_map(t,{diff_map:!1,format:n},function(){o.load_map(e,{diff_map:!0,format:n},r)})},fi.prototype.load_pdb_and_maps=function(t,e,i,r,n){var o=this;this.load_pdb(t,r,function(){o.load_maps(e,i,r,n)})},fi.prototype.load_ccp4_maps=function(t,e,i){this.load_maps(t,e,{format:"ccp4"},i)},fi.prototype.load_pdb_and_ccp4_maps=function(t,e,i,r){this.load_pdb_and_maps(t,e,i,{format:"ccp4"},r)},fi.prototype.load_from_pdbe=function(t,e){var i=t.toLowerCase();this.load_pdb_and_maps("https://www.ebi.ac.uk/pdbe/entry-files/pdb"+i+".ent","https://www.ebi.ac.uk/pdbe/coordinates/files/"+i+".ccp4","https://www.ebi.ac.uk/pdbe/coordinates/files/"+i+"_diff.ccp4",{format:"ccp4"},e)},fi.prototype.load_from_rcsb=function(t,e){var i=t.toLowerCase();this.load_pdb_and_maps("https://files.rcsb.org/download/"+i+".pdb","https://edmaps.rcsb.org/maps/"+i+"_2fofc.dsn6","https://edmaps.rcsb.org/maps/"+i+"_fofc.dsn6",{format:"dsn6"},e)},fi.prototype.MOUSE_HELP=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ"].join("\n"),fi.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","E = toggle fog","Q = label font","+/- = sigma level","]/[ = map radius","D/F = clip width","&lt;/> = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","V = inactive models","R = center view","W = wireframe style","I = spin","K = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen"].join("\n"),fi.prototype.ABOUT_HELP='&nbsp; <a href="https://uglymol.github.io">uglymol</a> '+("string"==typeof e?e:"dev"),fi.prototype.ColorSchemes=[{name:"coot dark",bg:0,fg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,fg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,fg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,fg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}];var pi=["all","unindexed","#1"],mi=["two","three","none"],_i=["wheel","square"],gi=function(i){function t(t){if(i.call(this),this.box_size=[1,1,1],this.from_ccp4(t,!1),null!=this.unit_cell){var e=this.unit_cell.parameters;this.box_size=[e[0]/100,e[1]/100,e[2]/100],this.unit_cell=null}}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.extract_block=function(t,e){var i=this.grid;if(null!=i){for(var r=this.box_size,n=[],o=[],s=0;s<3;s++){var a=Math.floor(i.dim[s]*((e[s]-t)/r[s]+.5)),l=Math.floor(i.dim[s]*((e[s]+t)/r[s]+.5));if((a=Math.min(Math.max(0,a),i.dim[s]-1))===(l=Math.min(Math.max(0,l),i.dim[s]-1)))return;n.push(a),o.push(l)}for(var h=[],c=[],u=n[0];u<=o[0];u++)for(var d=n[1];d<=o[1];d++)for(var f=n[2];f<=o[2];f++){h.push([(u/i.dim[0]-.5)*r[0],(d/i.dim[1]-.5)*r[1],(f/i.dim[2]-.5)*r[2]]);var p=i.grid2index_unchecked(u,d,f);c.push(i.values[p])}var m=[o[0]-n[0]+1,o[1]-n[1]+1,o[2]-n[2]+1];this.block.set(h,c,m)}},t}(l);gi.prototype.unit="";var vi="\n#include <fog_pars_fragment>\nvarying vec3 vcolor;\nvoid main() {\n  // not sure how reliable is such rounding of points\n  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);\n  float dist_sq = 4.0 * dot(diff, diff);\n  if (dist_sq >= 1.0) discard;\n  float alpha = 1.0 - dist_sq * dist_sq * dist_sq;\n  gl_FragColor = vec4(vcolor, alpha);\n#include <fog_fragment>\n}",yi=function(e){function t(t){e.call(this,t),this.default_camera_pos=[100,0,0],this.axes=null,this.points=null,this.max_dist=-1,this.d_min=-1,this.d_max_inv=0,this.data={},this.config.show_only=pi[0],this.config.show_axes=mi[0],this.config.spot_shape=_i[0],this.config.center_cube_size=.001,this.set_reciprocal_key_bindings(),"undefined"!=typeof document&&this.set_dropzone(this.renderer.domElement,this.file_drop_callback.bind(this)),this.point_material=new Ct({uniforms:ze({size:3,show_only:-2,r2_max:100,r2_min:0}),vertexShader:"\nattribute float group;\nuniform float show_only;\nuniform float r2_max;\nuniform float r2_min;\nuniform float size;\nvarying vec3 vcolor;\nvoid main() {\n  vcolor = color;\n  float r2 = dot(position, position);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  if (r2 < r2_min || r2 >= r2_max || (show_only != -2.0 && show_only != group))\n    gl_Position.x = 2.0;\n  gl_PointSize = size;\n}",fragmentShader:vi,vertexColors:w,fog:!0,transparent:!0})}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.set_reciprocal_key_bindings=function(){var t=this.key_bindings;t[65]=function(t){this.select_next("axes","show_axes",mi,t.shiftKey),this.set_axes()},t[68]=function(){this.change_slab_width_by(-.01)},t[70]=function(t){t.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.01)},t[80]=function(t){this.permalink()},t[83]=function(t){this.select_next("spot shape","spot_shape",_i,t.shiftKey),"wheel"===this.config.spot_shape?this.point_material.fragmentShader=vi:this.point_material.fragmentShader="\n#include <fog_pars_fragment>\nvarying vec3 vcolor;\nvoid main() {\n  gl_FragColor = vec4(vcolor, 1.0);\n#include <fog_fragment>\n}",this.point_material.needsUpdate=!0},t[85]=function(){0!==this.map_bags.length?(this.hud("toggled map box"),this.toggle_cell_box()):this.hud("Reciprocal-space density map not loaded.")},t[86]=function(t){this.select_next("show","show_only",pi,t.shiftKey);var e=pi.indexOf(this.config.show_only);this.point_material.uniforms.show_only.value=e-2},t[88]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_point_size(.5)},t[90]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_point_size(-.5)},t[188]=function(t){t.shiftKey&&this.shift_clip(.1)},t[190]=function(t){t.shiftKey&&this.shift_clip(-.1)},t[37]=function(){this.change_dmin(.05)},t[39]=function(){this.change_dmin(-.05)},t[38]=function(){this.change_dmax(.025)},t[40]=function(){this.change_dmax(-.025)},t[107]=t[61]=t[187]=function(t){this.change_isolevel_by(0,.01)},t[109]=t[173]=t[189]=function(t){this.change_isolevel_by(0,-.01)},t[219]=function(){this.change_map_radius(-.001)},t[221]=function(){this.change_map_radius(.001)}},t.prototype.file_drop_callback=function(t){var e=new FileReader;/\.(map|ccp4)$/.test(t.name)?(e.onloadend=function(t){2==t.target.readyState&&self.load_map_from_ab(t.target.result)},e.readAsArrayBuffer(t)):(e.onload=function(t){self.load_from_string(t.target.result,{})},e.readAsText(t))},t.prototype.load_data=function(t,e){void 0===e&&(e={});var i=this;this.load_file(t,{binary:!1,progress:!0},function(t){i.load_from_string(t.responseText,e)&&e.callback&&e.callback()})},t.prototype.load_from_string=function(t,e){if("{"===t[0])this.data=function(t){var e,i=JSON.parse(t),r=i.rlp.length;if(0<r&&i.rlp[0]instanceof Array){e=new Float32Array(3*r);for(var n=0;n<r;n++)for(var o=0;o<3;o++)e[3*n+o]=i.rlp[n][o]}else e=new Float32Array(i.rlp);return{pos:e,lattice_ids:i.experiment_id||function(t){for(var e=[],i=0;i<t;i++)e.push(-1);return e}(r)}}(t);else{if("#"!==t[0])return this.hud("Unrecognized file type."),!1;this.data=function(t){for(var e=t.split("\n").filter(function(t){return 0<t.length&&"#"!==t[0]}),i=new Float32Array(3*e.length),r=[],n=0;n<e.length;n++){for(var o=e[n].split(",").map(Number),s=0;s<3;s++)i[3*n+s]=o[s];r.push(o[3])}return{pos:i,lattice_ids:r}}(t)}this.max_dist=function(t){for(var e=0,i=0;i<t.length;i+=3){var r=3*i,n=t[r]*t[r]+t[r+1]*t[r+1]+t[r+2]*t[r+2];e<n&&(e=n)}return Math.sqrt(e)}(this.data.pos),this.d_min=1/this.max_dist;var i=function(t){for(var e=-1/0,i=0;i<t.length;i++)t[i]>e&&(e=t[i]);return e}(this.data.lattice_ids);pi.splice(3);for(var r=1;r<=i;r++)pi.push("#"+(r+1));this.set_axes(),this.set_points(this.data),this.camera.zoom=.5*(this.camera.top-this.camera.bottom);var n=1.01*this.max_dist;return this.controls.slab_width=[n,n,100],this.set_view(e),this.hud("Loaded "+this.data.pos.length+" spots."),!0},t.prototype.load_map_from_ab=function(t){0<this.map_bags.length&&this.clear_el_objects(this.map_bags.pop());var e=new gi(t);if(null!=e){var i=e.box_size[0]/2;this.config.map_radius=Math.round(i/2*100)/100,this.config.max_map_radius=Math.round(1.5*i*100)/100,this.config.default_isolevel=.3,this.add_map(e,!1);var r=1/i,n="Loaded density map ("+r.toFixed(2)+"Å).\n";null!==this.points&&r>this.d_min&&(n+="Adjusted spot clipping. ",this.change_dmin(r-this.d_min)),this.hud(n+"Use +/- to change the isolevel.")}},t.prototype.set_axes=function(){if(null!=this.axes&&(this.remove_and_dispose(this.axes),this.axes=null),"none"!==this.config.show_axes){var t=[];Qe(t,[0,0,0],1.2*this.max_dist);var e=this.config.colors.axes,i=[e[0],e[0],e[1],e[1],e[2],e[2]];"two"===this.config.show_axes&&(t.splice(4),i.splice(4));var r=De({win_size:this.window_size,linewidth:3,segments:!0});this.axes=je(r,t,i),this.scene.add(this.axes)}},t.prototype.set_points=function(t){if(null!=this.points&&(this.remove_and_dispose(this.points),this.points=null),null!=t&&null!=t.lattice_ids&&null!=t.pos){var e=new Float32Array(3*t.lattice_ids.length);this.colorize_by_id(e,t.lattice_ids);var i=new Ht;i.addAttribute("position",new It(t.pos,3)),i.addAttribute("color",new It(e,3));var r=new Float32Array(t.lattice_ids);i.addAttribute("group",new It(r,1)),this.points=new ce(i,this.point_material),this.scene.add(this.points),this.request_render()}},t.prototype.colorize_by_id=function(t,e){for(var i=this.config.colors.lattices,r=0;r<e.length;r++){var n=i[(e[r]+1)%4];t[3*r]=n.r,t[3*r+1]=n.g,t[3*r+2]=n.b}},t.prototype.mousewheel_action=function(t,e){this.change_zoom_by_factor(1+5e-4*t)},t.prototype.change_point_size=function(t){var e=this.point_material.uniforms.size;e.value=Math.max(e.value+t,.5),this.hud("point size: "+e.value.toFixed(1))},t.prototype.change_dmin=function(t){this.d_min=Math.max(this.d_min+t,.1);var e=0<this.d_max_inv?1/this.d_max_inv:null;null!==e&&this.d_min>e&&(this.d_min=e),this.point_material.uniforms.r2_max.value=1/(this.d_min*this.d_min);var i=null!==e?e.toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")},t.prototype.change_dmax=function(t){var e=Math.min(this.d_max_inv+t,1/this.d_min);e<1e-6&&(e=0),this.d_max_inv=e,this.point_material.uniforms.r2_min.value=e*e;var i=0<e?(1/e).toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")},t.prototype.redraw_models=function(){this.set_points(this.data)},t.prototype.get_cell_box_func=function(){if(0===this.map_bags.length)return null;var e=this.map_bags[0].map.box_size;return function(t){return[(t[0]-.5)*e[0],(t[1]-.5)*e[1],(t[2]-.5)*e[2]]}},t}(fi);yi.prototype.ColorSchemes=[{name:"solarized dark",bg:11062,fg:16643811,map_den:15657173,center:16643811,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]},{name:"solarized light",bg:16643811,fg:11062,map_den:472642,center:11062,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]}],yi.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","V = show (un)indexed","A = toggle axes","U = toggle map box","B = bg color","E = toggle fog","M/N = zoom","D/F = clip width","&lt;/> = move clip","R = center view","Z/X = point size","S = point shape","Shift+P = permalink","Shift+F = full screen","←/→ = max resol.","↑/↓ = min resol.","+/- = map level"].join("\n"),yi.prototype.MOUSE_HELP=fi.prototype.MOUSE_HELP.split("\n").slice(0,-2).join("\n"),t.UnitCell=z,t.modelsFromPDB=s,t.Model=n,t.Block=r,t.ElMap=l,t.ShaderMaterial=Ct,t.Matrix4=mt,t.CatmullRomCurve3=_e,t.Texture=B,t.Vector2=T,t.VertexColors=w,t.BufferGeometry=Ht,t.Raycaster=de,t.Quaternion=A,t.BufferAttribute=It,t.Vector3=pt,t.OrthographicCamera=Bt,t.Fog=se,t.Object3D=Dt,t.Ray=Ut,t.Points=ce,t.WebGLRenderer=oe,t.Mesh=qt,t.Color=Rt,t.AmbientLight=ue,t.LineSegments=he,t.Scene=ae,t.TriangleStripDrawMode=ft,t.Line=le,t.makeCube=xe,t.makeRgbBox=we,t.makeUniforms=ze,t.makeRibbon=Fe,t.makeChickenWire=Pe,t.makeGrid=Ne,t.makeLineMaterial=De,t.makeLine=Ie,t.makeLineSegments=je,t.makeWheels=qe,t.makeBalls=Ge,t.makeLabel=Ze,t.addXyzCross=Qe,t.STATE=$e,t.Controls=Je,t.Viewer=fi,t.ReciprocalSpaceMap=gi,t.ReciprocalViewer=yi,Object.defineProperty(t,"__esModule",{value:!0})});