!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.UM=t.UM||{},t.THREE)}(this,function(t,e){"use strict";function i(t,e){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],+e[4]*t[1]+e[5]*t[2],+e[8]*t[2]]}function o(t){for(var e=[],i=0;i<8;++i){var o=lt[i];e.push(o[0]+t[2]*(o[1]+t[1]*o[2]))}return e}function r(t,e,i,r,n){var s="snapped MC"===n,a="squarish"===n?at:st,l=new Array(12),h=o(t),c=new Float32Array(8),d=[0,0,0],u=[d,d,d,d,d,d,d,d],f=t[0],p=t[1],_=t[2];if(null!=e&&null!=i){for(var m=[],v=[],g=0,y=0;y<f-1;y++)for(var b=0;b<p-1;b++)for(var w=0;w<_-1;w++){var x=w+_*(b+p*y),z=0,A=void 0,M=void 0;for(A=0;A<8;++A)M=x+h[A],z|=e[M]<r?1<<A:0;if(0!==z&&255!==z){for(A=0;A<8;++A)M=x+h[A],c[A]=e[M],u[A]=i[M];var E=nt[z];for(A=0;A<12;++A)if(0!==(E&1<<A)){var C=ht[A],S=(r-c[C[0]])/(c[C[1]]-c[C[0]]);s===!0&&(S>.85?S=1:S<.15&&(S=0));var k=u[C[0]],O=u[C[1]];m.push(k[0]+(O[0]-k[0])*S,k[1]+(O[1]-k[1])*S,k[2]+(O[2]-k[2])*S),l[A]=g++}var L=a[z];for(A=0;A<L.length;A++)v.push(l[L[A]])}}return{vertices:m,segments:v}}}function n(t,e){var i=t%e;return i>=0?i:i+e}function s(t,e){for(var i=0,o=0,r=t.length,n=e;n<r;n++)i+=t[n],o+=t[n]*t[n];var s=i/(r-e),a=o/(r-e)-s*s;return{mean:s,rms:Math.sqrt(a)}}function a(t){var e=t.toLowerCase().replace(/\s+/g,"").split(",");if(3!==e.length)throw Error("Unexpected symop: "+t);for(var i=[],o=0;o<3;o++){for(var r=e[o].split(/(?=[+-])/),n=[0,0,0,0],s=0;s<r.length;s++){var a=r[s],l="-"===a[0]?-1:1,h=r[s].match(/^[+-]?([xyz])$/);if(h){var c={x:0,y:1,z:2}[h[1]];n[c]=l}else{if(h=r[s].match(/^[+-]?(\d)\/(\d)$/),!h)throw Error("What is "+r[s]+" in "+t);n[3]=l*Number(h[1])/Number(h[2])}}i.push(n)}return i}function l(t,e,i){var o=ut.map(function(i){return{x:e.x+t*(i[0]-.5),y:e.y+t*(i[1]-.5),z:e.z+t*(i[2]-.5)}}),r=z({gl_lines:!0,color:i.color,linewidth:i.linewidth,win_size:i.win_size,segments:!0});return S(r,o)}function h(t,i){for(var o=ut.map(function(e){return{xyz:t(e)}}),r=[new e.Color(16711680),new e.Color(16755200),new e.Color(65280),new e.Color(11206400),new e.Color(255),new e.Color(43775)],n=6;n<ut.length;n++)r.push(i.color);var s=z({gl_lines:!0,linewidth:1,segments:!0});return S(s,o,r)}function c(t){var e,i=[];if(t&&t[0].xyz)for(e=0;e<t.length;e++){var o=t[e].xyz;i.push(o[0],o[1],o[2]),i.push(o[0],o[1],o[2])}else for(e=0;e<t.length;e++){var r=t[e];i.push(r.x,r.y,r.z),i.push(r.x,r.y,r.z)}return i}function d(t){for(var e=t.length,i=new Float32Array(6*e),o=0;o<e;o++){var r=t[o];i[6*o]=r.r,i[6*o+1]=r.g,i[6*o+2]=r.b,i[6*o+3]=r.r,i[6*o+4]=r.g,i[6*o+5]=r.b}return i}function u(t,i){var o,r=t.length,n=c(t),s=new Float32Array(n),a=new Float32Array(6*r);for(o=0;o<6;o++)a[o]=n[o];for(;o<6*r;o++)a[o]=n[o-6];var l=new Float32Array(6*r);for(o=0;o<6*(r-1);o++)l[o]=n[o+6];for(;o<6*r;o++)l[o]=n[o];var h=new Float32Array(2*r);for(o=0;o<r;o++)h[2*o]=1,h[2*o+1]=-1;var u=d(i),f=new e.BufferGeometry;return f.addAttribute("position",new e.BufferAttribute(s,3)),f.addAttribute("previous",new e.BufferAttribute(a,3)),f.addAttribute("next",new e.BufferAttribute(l,3)),f.addAttribute("side",new e.BufferAttribute(h,1)),f.addAttribute("color",new e.BufferAttribute(u,3)),f}function f(t,i){var o,r,n=t.length,s=c(t),a=new Float32Array(s),l=new Float32Array(6*n);for(o=0;o<6*n;o+=12){for(r=0;r<6;r++)l[o+r]=s[o+r+6];for(;r<12;r++)l[o+r]=s[o+r-6]}var h=new Float32Array(2*n);for(o=0;o<n;o++)h[2*o]=-1,h[2*o+1]=1;var u=2*n<65536?new Uint16Array(3*n):new Uint32Array(3*n),f=[0,1,2,0,2,3];for(o=0;o<n/2;o++)for(r=0;r<6;r++)u[6*o+r]=4*o+f[r];var p=new e.BufferGeometry;if(p.addAttribute("position",new e.BufferAttribute(a,3)),p.addAttribute("other",new e.BufferAttribute(l,3)),p.addAttribute("side",new e.BufferAttribute(h,1)),null!=i){var _=d(i);p.addAttribute("color",new e.BufferAttribute(_,3))}return p.setIndex(new e.BufferAttribute(u,1)),p}function p(t,i){for(var o=[],r=0;r<t.length;r++){var n=t[r].xyz;o.push(new e.Vector3(n[0],n[1],n[2]))}if(!i||i<2)return o;var s=new e.CatmullRomCurve3(o);return s.getPoints((t.length-1)*i)}function _(t,e){if(!e||e<2)return t;for(var i=[],o=0;o<t.length-1;o++)for(var r=0;r<e;r++)i.push(t[o]);return i.push(t[t.length-1]),i}function m(t,e){e=e||1;var i,o=[];for(i=0;i<t.length-1;i++)for(var r=t[i],n=t[i+1],s=0;s<e;s++){var a=s/e,l=1-a;o.push(l*r[0]+a*n[0],l*r[1]+a*n[1],l*r[2]+a*n[2])}return o.push(t[i][0],t[i][1],t[i][2]),o}function v(t){var e={fogNear:{value:null},fogFar:{value:null},fogColor:{value:null}};for(var i in t)e[i]={value:t[i]};return e}function g(t,i,o,r){var n=p(t,r),s=_(i,r),a=m(o,r),l=new e.Object3D,h=A(n,s),c=new Float32Array(a);h.addAttribute("normal",new e.BufferAttribute(c,3));for(var d=new e.ShaderMaterial({uniforms:v({shift:0}),vertexShader:mt,fragmentShader:vt,fog:!0,vertexColors:e.VertexColors}),u=-4;u<5;u++){var f=0===u?d:d.clone();f.uniforms.shift.value=.1*u,l.add(new e.Line(h,f))}return l}function y(t,i){var o=new e.BufferGeometry,r=new Float32Array(t.vertices);o.addAttribute("position",new e.BufferAttribute(r,3));var n=t.vertices.length<196608?new Uint16Array(t.segments):new Uint32Array(t.segments);o.setIndex(new e.BufferAttribute(n,1));var s=new e.LineBasicMaterial(i);return new e.LineSegments(o,s)}function b(){for(var t=50,i=[],o=-t;o<=t;o++){var r=0;o%5===0&&(r=o%2===0?2:1),i.push(-t,o,r,t,o,r),i.push(o,-t,r,o,t,r)}var n=new e.BufferGeometry;n.addAttribute("position",new e.BufferAttribute(new Float32Array(i),3));var s=new e.ShaderMaterial({uniforms:v({ucolor:new e.Color(8947848)}),vertexShader:gt,fragmentShader:yt,fog:!0});s.transparent=!0;var a=new e.LineSegments(n,s);return a.frustumCulled=!1,a.color_value=s.uniforms.ucolor.value,a}function w(t){var i={};return i.linewidth=t.linewidth,void 0===t.color?i.vertexColors=e.VertexColors:i.color=t.color,new e.LineBasicMaterial(i)}function x(t){var i=v({linewidth:t.linewidth,win_size:t.win_size});return new e.ShaderMaterial({uniforms:i,vertexShader:t.segments?pt:ft,fragmentShader:_t,fog:!0,vertexColors:e.VertexColors})}function z(t){return t.gl_lines?w(t):x(t)}function A(t,i){var o,r=new e.BufferGeometry,n=new Float32Array(3*t.length);if(t&&t[0].xyz)for(o=0;o<t.length;o++){var s=t[o].xyz;n[3*o]=s[0],n[3*o+1]=s[1],n[3*o+2]=s[2]}else for(o=0;o<t.length;o++){var a=t[o];n[3*o]=a.x,n[3*o+1]=a.y,n[3*o+2]=a.z}if(r.addAttribute("position",new e.BufferAttribute(n,3)),null!=i){var l=new Float32Array(3*i.length);for(o=0;o<i.length;o++){var h=i[o];l[3*o]=h.r,l[3*o+1]=h.g,l[3*o+2]=h.b}r.addAttribute("color",new e.BufferAttribute(l,3))}return r}function M(t,i,o){var r=new e.Mesh(u(i,o),t);return r.drawMode=e.TriangleStripDrawMode,r.raycast=O,r}function E(t,i,o){return t.isShaderMaterial?M(t,i,o):new e.Line(A(i,o),t)}function C(t,i,o){var r=new e.Mesh(f(i,o),t);return r.raycast=O,r}function S(t,i,o){return t.isShaderMaterial?C(t,i,o):new e.LineSegments(A(i,o),t)}function k(t,i,o){var r=A(t,i),n=new e.ShaderMaterial({uniforms:v({size:o}),vertexShader:bt,fragmentShader:wt,fog:!0,vertexColors:e.VertexColors}),s=new e.Points(r,n);return s.raycast=function(){},s}function O(t,i){var o=t.linePrecision*t.linePrecision;xt.getInverse(this.matrixWorld),zt.copy(t.ray).applyMatrix4(xt);for(var r=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,l=this.drawMode===e.TriangleStripDrawMode?1:2,h=this.geometry.attributes.position.array,c=0,d=h.length/6-1;c<d;c+=l){r.fromArray(h,6*c),n.fromArray(h,6*c+6);var u=zt.distanceSqToSegment(r,n,a,s);if(!(u>o)){a.applyMatrix4(this.matrixWorld);var f=t.ray.origin.distanceTo(a);f<t.near||f>t.far||i.push({distance:f,point:s.clone().applyMatrix4(this.matrixWorld),index:c,object:this,line_dist:Math.sqrt(u)})}}}function L(t,e){if("undefined"!=typeof document){var i=document.createElement("canvas");i.width=256,i.height=16;var o=i.getContext("2d");return o?(o.font=(e.font||"bold 14px")+" sans-serif",o.textBaseline="bottom",e.color&&(o.fillStyle=e.color),o.fillText(t,0,i.height),i):null}}function F(t,i){var o=L(t,i);if(o){var r=new e.Texture(o);r.needsUpdate=!0;var n=new e.BufferGeometry,s=i.pos,a=new Float32Array([].concat(s,s,s,s)),l=new Float32Array([0,1,1,1,0,0,1,0]),h=new Uint16Array([0,2,1,2,3,1]);n.setIndex(new e.BufferAttribute(h,1)),n.addAttribute("position",new e.BufferAttribute(a,3)),n.addAttribute("uv",new e.BufferAttribute(l,2));var c=new e.ShaderMaterial({uniforms:v({map:r,canvas_size:[o.width,o.height],win_size:i.win_size}),vertexShader:At,fragmentShader:Mt,fog:!0});c.transparent=!0;var d=new e.Mesh(n,c);return d.remake=function(t,e){r.image=L(t,e),r.needsUpdate=!0},d}}function T(t,i,o){t.push(new e.Vector3(i[0]-o,i[1],i[2])),t.push(new e.Vector3(i[0]+o,i[1],i[2])),t.push(new e.Vector3(i[0],i[1]-o,i[2])),t.push(new e.Vector3(i[0],i[1]+o,i[2])),t.push(new e.Vector3(i[0],i[1],i[2]-o)),t.push(new e.Vector3(i[0],i[1],i[2]+o))}function j(t,e){var i=0,o=t*t+e*e;if(o<1)i=Math.sqrt(1-o);else{var r=Math.sqrt(o);t/=r,e/=r}return[t,e,i]}function P(t,e){return t*e[1]/700}function q(t,i){function o(i){var o=new e.Quaternion;o.setFromUnitVectors(c,h),i.applyQuaternion(o),t.up.applyQuaternion(o),c.applyQuaternion(o),h.copy(c)}function r(e){var o=u.x-d.x,r=u.y-d.y;return l===Ct.ZOOM?t.zoom/=1-o+r:l===Ct.SLAB?i.addScaledVector(e,-5/e.length()*r):l===Ct.ROLL&&t.up.applyAxisAngle(e,.05*(o-r)),d.copy(u),l===Ct.SLAB?10*o:null}function n(e){var o=m.x-_.x,r=m.y-_.y;o*=.5*(t.right-t.left)/t.zoom,r*=.5*(t.bottom-t.top)/t.zoom;var n=e.clone().cross(t.up).setLength(o);n.addScaledVector(t.up,r/t.up.length()),t.position.add(n),i.add(n),_.copy(m)}function s(e){h.copy(e).normalize();var i=Date.now(),o=null!==y?i-y:16.7,r=18e-6*o*a;y=i,g===!0?r=-r:g!==!1&&(g+=.02,r=4e-5*a*Math.cos(g)),c.crossVectors(t.up,e).multiplyScalar(r).add(h)}var a=1,l=Ct.NONE,h=new e.Vector3,c=new e.Vector3,d=new e.Vector2,u=new e.Vector2,f=0,p=0,_=new e.Vector2,m=new e.Vector2,v=!0,g=null,y=null,b=null;this.slab_width=[2.5,7.5],this.toggle_auto=function(t){l===Ct.AUTO_ROTATE&&typeof t==typeof g?l=Ct.NONE:(l=Ct.AUTO_ROTATE,y=null,g=t)},this.is_going=function(){return l===Ct.GO},this.is_moving=function(){return l!==Ct.NONE},this.update=function(){var e=!1,a=t.position.clone().sub(i);if(l===Ct.AUTO_ROTATE&&s(a),h.equals(c)||(o(a),e=!0),p!==f&&(t.zoom*=p/f,f=p,e=!0),!u.equals(d)){var g=r(a);g&&(this.slab_width[0]=Math.max(this.slab_width[0]+g,.01),this.slab_width[1]=Math.max(this.slab_width[1]+g,.01)),e=!0}return m.equals(_)||(n(a),v=!0,e=!0),t.position.addVectors(i,a),l===Ct.GO&&b&&(b(),e=!0),t.lookAt(i),e},this.start=function(t,e,i,o){switch(l!==Ct.NONE&&l!==Ct.AUTO_ROTATE||(l=t),this.move(e,i,o),l){case Ct.ROTATE:h.copy(c);break;case Ct.ZOOM:case Ct.SLAB:case Ct.ROLL:d.copy(u);break;case Ct.PAN:_.copy(m),v=!1;break;case Ct.PAN_ZOOM:f=p,_.copy(m)}},this.move=function(e,o,r){switch(l){case Ct.ROTATE:var n=j(e,o),s=t.position.clone().sub(i);c.crossVectors(t.up,s).setLength(n[0]),c.addScaledVector(t.up,n[1]/t.up.length()),c.addScaledVector(s,n[2]/s.length());break;case Ct.ZOOM:case Ct.SLAB:case Ct.ROLL:u.set(e,o);break;case Ct.PAN:m.set(e,o);break;case Ct.PAN_ZOOM:m.set(e,o),p=r}},this.stop=function(){var t=null;return l!==Ct.PAN||v||(t=_),l=Ct.NONE,h.copy(c),f=p,_.copy(m),t},this.go_to=function(o,r,n,s){if(o instanceof Array&&(o=new e.Vector3(o[0],o[1],o[2])),o&&!(o.distanceToSquared(i)<.001)||r&&!(r.distanceToSquared(t.position)<.1)||n&&!(n.distanceToSquared(t.up)<.1)){l=Ct.GO,s=(s||60)/a;for(var h=[],c=0,d=1;d<=s;++d){var u=d/s;u=u<.5?2*u*u:-2*u*(u-2)-1,h.push((u-c)/(1-c)),c=u}b=function(){var e=h.shift();o&&(r||t.position.sub(i),i.lerp(o,e),r||t.position.add(i)),r&&t.position.lerp(r,e),n&&t.up.lerp(n,e),0===h.length&&(l=Ct.NONE,b=null)}}}}function R(t,i,o){var r=new e.Color(14737632);if(i<o){var n=(t-i)/(o-i),s=(240-240*n)/360;r.setHSL(s,1,.5)}return r}function B(t,e,i){var o,r,n=e[e.length-1];if("index"===t)o=function(t){return R(t.i_seq,0,n.i_seq)};else if("B-factor"===t){var s=1/0,a=-(1/0);for(r=0;r<e.length;r++){var l=e[r].b;l>a&&(a=l),l<s&&(s=l)}o=function(t){return R(t.b,s,a)}}else o="occupancy"===t?function(t){return R(t.occ,0,1)}:"chain"===t?function(t){return R(t.chain_index,0,n.chain_index)}:function(t){return i[t.element]||i.def};var h=[];for(r=0;r<e.length;r++)h.push(o(e[r]));return h}function V(t,i){this.map=t,this.name="",this.isolevel=i?3:1.5,this.visible=!0,this.types=i?["map_pos","map_neg"]:["map_den"],this.block_ctr=new e.Vector3(1/0,0,0),this.el_objects=[]}function N(t,e,i){this.model=t,this.name="",this.visible=!0,this.conf=e,this.win_size=i,this.atomic_objects=null}function H(t){function i(e){return null===t[e]?null:document.getElementById(t[e]||e)}if(this.model_bags=[],this.map_bags=[],this.decor={cell_box:null,selection:null,zoom_grid:b()},this.labels={},this.nav=null,this.config={bond_line:4,map_line:1.25,map_radius:10,map_style:Ot[0],render_style:kt[0],color_aim:St[0],line_style:Lt[0],label_font:Ft[0],colors:this.ColorSchemes[0],hydrogens:!1},this.set_colors(),this.window_size=[1,1],this.window_offset=[0,0],this.last_ctr=new e.Vector3(1/0,0,0),this.selected_atom=null,this.active_model_bag=null,this.scene=new e.Scene,this.scene.fog=new e.Fog(this.config.colors.bg,0,1),this.light=new e.AmbientLight(16777215),this.scene.add(this.light),this.default_camera_pos=[0,0,100],t.share_view?(this.target=t.share_view.target,this.camera=t.share_view.camera,this.controls=t.share_view.controls,this.tied_viewer=t.share_view,this.tied_viewer.tied_viewer=this):(this.target=new e.Vector3(0,0,0),this.camera=new e.OrthographicCamera,this.camera.position.fromArray(this.default_camera_pos),this.controls=new q(this.camera,this.target)),this.raycaster=new e.Raycaster,this.set_common_key_bindings(),this.constructor===H&&this.set_real_space_key_bindings(),"undefined"!=typeof document){try{this.renderer=new e.WebGLRenderer({antialias:!0})}catch(t){return this.hud("no WebGL in your browser?","ERR"),void(this.renderer=null)}if(this.container=i("viewer"),this.hud_el=i("hud"),this.help_el=i("help"),this.hud_el&&(this.initial_hud_html=this.hud_el.innerHTML,this.initial_hud_bg=this.hud_el.style["background-color"]),null!==this.container){this.renderer.setClearColor(this.config.colors.bg,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.resize(),this.camera.zoom=this.camera.right/35,this.update_camera(),this.container.appendChild(this.renderer.domElement),t.focusable&&(this.renderer.domElement.tabIndex=0),this.decor.zoom_grid.visible=!1,this.scene.add(this.decor.zoom_grid),window.Stats&&(this.stats=new window.Stats,this.container.appendChild(this.stats.dom)),window.addEventListener("resize",this.resize.bind(this));var o=this.renderer.domElement,r=t.focusable?o:window;r.addEventListener("keydown",this.keydown.bind(this)),o.addEventListener("contextmenu",function(t){t.preventDefault()}),o.addEventListener("mousewheel",this.mousewheel.bind(this)),o.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this)),o.addEventListener("mousedown",this.mousedown.bind(this)),o.addEventListener("touchstart",this.touchstart.bind(this)),o.addEventListener("touchmove",this.touchmove.bind(this)),o.addEventListener("touchend",this.touchend.bind(this)),o.addEventListener("touchcancel",this.touchend.bind(this)),o.addEventListener("dblclick",this.dblclick.bind(this));var n=this;this.mousemove=function(t){t.preventDefault(),n.controls.move(n.relX(t),n.relY(t))},this.mouseup=function(t){t.preventDefault(),t.stopPropagation(),document.removeEventListener("mousemove",n.mousemove),document.removeEventListener("mouseup",n.mouseup),n.decor.zoom_grid.visible=!1;var e=n.controls.stop();if(e){var i=n.pick_atom(e,n.camera);null!=i&&n.select_atom(i,{steps:60})}n.redraw_maps()},this.scheduled=!1,this.request_render()}}}function U(t,e){return[t.x.toFixed(e),t.y.toFixed(e),t.z.toFixed(e)]}function K(t){var e=t.touches,i=e[0].pageX-e[1].pageX,o=e[0].pageY-e[1].pageY;return{pageX:(e[0].pageX+e[1].pageX)/2,pageY:(e[0].pageY+e[1].pageY)/2,dist:Math.sqrt(i*i+o*o)}}function D(){var t={};if("undefined"==typeof window)return t;for(var e=window.location.hash.substr(1).split("&"),i=0;i<e.length;i++){var o=e[i].split("="),r=o[1];"xyz"===o[0]||"eye"===o[0]?r=r.split(",").map(Number):"zoom"===o[0]&&(r=Number(r)),t[o[0]]=r}return t}function G(t){H.call(this,t),this.default_camera_pos=[100,0,0],this.axes=null,this.points=null,this.map=null,this.max_dist=null,this.d_min=null,this.d_max_inv=0,this.data=null,this.config.show_only=Tt[0],this.config.show_axes=jt[0],this.set_reciprocal_key_bindings(),this.set_dropzone()}function Y(t){for(var e=0,i=0;i<t.length;i+=3){var o=3*i,r=t[o]*t[o]+t[o+1]*t[o+1]+t[o+2]*t[o+2];r>e&&(e=r)}return Math.sqrt(e)}function I(t){for(var e=-(1/0),i=0;i<t.length;i++)t[i]>e&&(e=t[i]);return e}function X(t){for(var e=t.split("\n").filter(function(t){return t.length>0&&"#"!==t[0]}),i=new Float32Array(3*e.length),o=[],r=0;r<e.length;r++){for(var n=e[r].split(",").map(Number),s=0;s<3;s++)i[3*r+s]=n[s];o.push(n[3])}return{pos:i,lattice_ids:o}}function W(t){for(var e=[],i=0;i<t;i++)e.push(-1);return e}function Z(t){for(var e=JSON.parse(t),i=e.rlp.length,o=new Float32Array(3*i),r=0;r<i;r++)for(var n=0;n<3;n++)o[3*r+n]=e.rlp[r][n];var s=e.experiment_id||W(i);return{pos:o,lattice_ids:s}}t.VERSION="0.5.2";var Q=function(t,e,i,o,r,n){if(t<=0||e<=0||i<=0||o<=0||r<=0||n<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[t,e,i,o,r,n];var s=Math.PI/180,a=Math.cos(s*o),l=Math.cos(s*r),h=Math.cos(s*n),c=Math.sin(s*o),d=Math.sin(s*r),u=Math.sin(s*n);if(0===c||0===d||0===u)throw Error("Impossible angle - N*180deg.");var f=(l*h-a)/u,p=f/d,_=Math.sqrt(1-p*p);this.orth=[t,e*h,i*l,0,e*u,-i*f,0,0,i*d*_],this.frac=[1/t,-h/(u*t),-(h*f+l*u)/(d*_*u*t),0,1/(u*e),p/(_*u*e),0,0,1/(d*_*i)]};Q.prototype.fractionalize=function(t){return i(t,this.frac)},Q.prototype.orthogonalize=function(t){return i(t,this.orth)};var $=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","MSE","PHE","PRO","SER","THR","TRP","TYR","VAL","UNK"],J=["DA","DC","DG","DT","A","C","G","U","rA","rC","rG","rU","Ar","Cr","Gr","Ur"],tt=["HOH"].concat($,J),et=function(){this.atoms=[],this.unit_cell=null,this.space_group=null,this.has_hydrogens=!1,this.lower_bound=[0,0,0],this.upper_bound=[0,0,0],this.residue_map=null,this.cubes=null};et.prototype.from_pdb=function(t){for(var e=t.split("\n"),i=0,o=null,r=0,n=0;n<e.length;n++){var s=e[n],a=s.substring(0,6);if("ATOM  "===a||"HETATM"===a){var l=new it;l.from_pdb_line(s),l.i_seq=r++,this.has_hydrogens||"H"!==l.element||(this.has_hydrogens=!0),l.chain!==o&&i++,l.chain_index=i,o=l.chain,this.atoms.push(l)}else if("ANISOU"===a);else if("CRYST1"===a){var h=parseFloat(s.substring(6,15)),c=parseFloat(s.substring(15,24)),d=parseFloat(s.substring(24,33)),u=parseFloat(s.substring(33,40)),f=parseFloat(s.substring(40,47)),p=parseFloat(s.substring(47,54));this.unit_cell=new Q(h,c,d,u,f,p)}else"TER"===a.substring(0,3)&&(o=null)}if(0===this.atoms.length)throw Error("No atom records found.");this.calculate_bounds(),this.calculate_connectivity()},et.prototype.calculate_bounds=function(){for(var t=this.lower_bound=[1/0,1/0,1/0],e=this.upper_bound=[-(1/0),-(1/0),-(1/0)],i=0;i<this.atoms.length;i++)for(var o=this.atoms[i],r=0;r<3;r++){var n=o.xyz[r];n<t[r]&&(t[r]=n),n>e[r]&&(e[r]=n)}for(var s=0;s<3;++s)t[s]-=.001,e[s]+=.001},et.prototype.next_residue=function(t,e){for(var i=this.atoms.length,o=(t?t.i_seq:0)+i,r=t?1:0;r<i;r++){var n=(o+(e?-r:r))%i,s=this.atoms[n];if(s.is_main_conformer()&&("CA"===s.name&&"C"===s.element||"P"===s.name))return s}},et.prototype.extract_trace=function(){for(var t=[],e=[],i=null,o=0;o<this.atoms.length;o++){var r=this.atoms[o];if((""===r.altloc||"A"===r.altloc)&&("CA"===r.name&&"C"===r.element||"P"===r.name)){var n=!0;if(null!==i&&i.chain_index===r.chain_index){var s=r.distance_sq(i);("CA"===r.name&&s<=30.25||"P"===r.name&&s<56.25)&&(e.push(r),n=!1)}n&&(e.length>2&&t.push(e),e=[r]),i=r}}return e.length>2&&t.push(e),t},et.prototype.get_residues=function(){if(null!=this.residue_map)return this.residue_map;for(var t={},e=0;e<this.atoms.length;e++){var i=this.atoms[e],o=i.resid(),r=t[o];void 0===r?t[o]=[i]:r.push(i)}return this.residue_map=t,t},et.prototype.calculate_tangent_vector=function(t){for(var e=null,i=null,o=3===t[0].resname.length,r=o?"C":"C2'",n=o?"O":"O4'",s=0;s<t.length;s++){var a=t[s];a.is_main_conformer()&&(a.name===r?e=a.xyz:a.name===n&&(i=a.xyz))}if(null===e||null===i)return[0,0,1];var l=[e[0]-i[0],e[1]-i[1],e[2]-i[2]],h=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);return[l[0]/h,l[1]/h,l[2]/h]},et.prototype.get_center=function(){for(var t=0,e=0,i=0,o=this.atoms.length,r=0;r<o;r++){var n=this.atoms[r].xyz;t+=n[0],e+=n[1],i+=n[2]}return[t/o,e/o,i/o]},et.prototype.calculate_connectivity=function(){for(var t=this.atoms,e=new ot(t,3,this.lower_bound,this.upper_bound),i=0;i<e.boxes.length;i++){var o=e.boxes[i];if(0!==o.length)for(var r=e.get_nearby_atoms(i),n=0;n<o.length;n++)for(var s=o[n],a=0;a<r.length;a++){var l=r[a];l>s&&t[s].is_bonded_to(t[l])&&(t[s].bonds.push(l),t[l].bonds.push(s))}}this.cubes=e},et.prototype.get_nearest_atom=function(t,e,i,o){var r=this.cubes;if(null==r)throw Error("Missing Cubicles");for(var n=r.find_box_id(t,e,i),s=r.get_nearby_atoms(n),a=null,l=1/0,h=0;h<s.length;h++){var c=this.atoms[s[h]];if(void 0===o||null===o||o===c.name){var d=c.xyz[0]-t,u=c.xyz[1]-e,f=c.xyz[2]-i,p=d*d+u*u+f*f;p<l&&(a=c,l=p)}}return a};var it=function(){this.hetero=!1,this.name="",this.altloc="",this.resname="",this.chain="",this.chain_index=null,this.resseq=-1,this.icode=null,this.xyz=[0,0,0],this.occ=1,this.b=0,this.element="",this.i_seq=null,this.is_ligand=null,this.bonds=[]};it.prototype.from_pdb_line=function(t){if(t.length<66)throw Error("ATOM or HETATM record is too short: "+t);var e=t.substring(0,6);if("HETATM"===e)this.hetero=!0;else if("ATOM  "!==e)throw Error("Wrong record type: "+e);this.name=t.substring(12,16).trim(),this.altloc=t.substring(16,17).trim(),this.resname=t.substring(17,20).trim(),this.chain=t.substring(20,22).trim(),this.resseq=parseInt(t.substring(22,26),10),this.icode=t.substring(26,27).trim();var i=parseFloat(t.substring(30,38)),o=parseFloat(t.substring(38,46)),r=parseFloat(t.substring(46,54));this.xyz=[i,o,r],this.occ=parseFloat(t.substring(54,60)),this.b=parseFloat(t.substring(60,66)),t.length>=78&&(this.element=t.substring(76,78).trim().toUpperCase()),this.is_ligand=tt.indexOf(this.resname)===-1},it.prototype.b_as_u=function(){return Math.sqrt(this.b/(25.13272*3.14159))},it.prototype.distance_sq=function(t){var e=this.xyz[0]-t.xyz[0],i=this.xyz[1]-t.xyz[1],o=this.xyz[2]-t.xyz[2];return e*e+i*i+o*o},it.prototype.distance=function(t){return Math.sqrt(this.distance_sq(t))},it.prototype.midpoint=function(t){return[(this.xyz[0]+t.xyz[0])/2,(this.xyz[1]+t.xyz[1])/2,(this.xyz[2]+t.xyz[2])/2]},it.prototype.is_hydrogen=function(){return"H"===this.element||"D"===this.element},it.prototype.is_s_or_p=function(){return"S"===this.element||"P"===this.element},it.prototype.is_ion=function(){return this.element===this.resname},it.prototype.is_water=function(){return"HOH"===this.resname},it.prototype.is_same_residue=function(t,e){return t.resseq===this.resseq&&t.icode===this.icode&&t.chain===this.chain&&t.resname===this.resname&&(e||t.altloc===this.altloc)},it.prototype.is_same_conformer=function(t){return""===this.altloc||""===t.altloc||this.altloc===t.altloc},it.prototype.is_main_conformer=function(){return""===this.altloc||"A"===this.altloc},it.prototype.is_bonded_to=function(t){var e=3.9601,i=1.3*1.3,o=2.2*2.2;if(!this.is_same_conformer(t))return!1;if("H"===this.element&&"H"===t.element)return!1;var r=this.distance_sq(t);return!(r>o)&&("H"===this.element||"H"===t.element?r<=i:r<=e||this.is_s_or_p()||t.is_s_or_p())},it.prototype.resid=function(){return this.resseq+"/"+this.chain},it.prototype.long_label=function(){var t=this;return t.name+" /"+t.resseq+" "+t.resname+"/"+t.chain+" - occ: "+t.occ.toFixed(2)+" bf: "+t.b.toFixed(2)+" ele: "+t.element+" pos: ("+t.xyz[0].toFixed(2)+","+t.xyz[1].toFixed(2)+","+t.xyz[2].toFixed(2)+")"},it.prototype.short_label=function(){var t=this;return t.name+" /"+t.resseq+" "+t.resname+"/"+t.chain};var ot=function(t,e,i,o){this.boxes=[],this.box_length=e,this.lower_bound=i,this.upper_bound=o,this.xdim=Math.ceil((o[0]-i[0])/e),this.ydim=Math.ceil((o[1]-i[1])/e),this.zdim=Math.ceil((o[2]-i[2])/e);for(var r=this.xdim*this.ydim*this.zdim,n=0;n<r;n++)this.boxes.push([]);for(var s=0;s<t.length;s++){var a=t[s].xyz,l=this.find_box_id(a[0],a[1],a[2]);if(null===l)throw Error("wrong cubicle");this.boxes[l].push(s)}};ot.prototype.find_box_id=function(t,e,i){var o=Math.floor((t-this.lower_bound[0])/this.box_length),r=Math.floor((e-this.lower_bound[1])/this.box_length),n=Math.floor((i-this.lower_bound[2])/this.box_length),s=(n*this.ydim+r)*this.xdim+o;if(s<0||s>=this.boxes.length)throw Error("Ups!");return s},ot.prototype.get_nearby_atoms=function(t){var e=[],i=this.xdim*this.ydim,o=Math.max(t%i,0),r=Math.max(o%this.xdim,0),n=Math.floor(o/this.xdim),s=Math.floor(t/i);console.assert(s*i+n*this.xdim+r===t);for(var a=r-1;a<=r+1;a++)if(!(a<0||a>=this.xdim))for(var l=n-1;l<=n+1;l++)if(!(l<0||l>=this.ydim))for(var h=s-1;h<=s+1;h++)if(!(h<0||h>=this.zdim)){var c=h*i+l*this.xdim+a;if(c>=this.boxes.length||c<0)throw Error("Box out of bounds: ID "+c);for(var d=this.boxes[c],u=0;u<d.length;u++)e.push(d[u])}return e};var rt=function(){this._points=null,this._values=null,this._size=[0,0,0]};rt.prototype.set=function(t,e,i){if(i[0]<=0||i[1]<=0||i[2]<=0)throw Error("Grid dimensions are zero along at least one edge");var o=i[0]*i[1]*i[2];if(e.length!==o||t.length!==o)throw Error("isosurface: array size mismatch");this._points=t,this._values=e,this._size=i},rt.prototype.clear=function(){this._points=null,this._values=null},rt.prototype.empty=function(){return null===this._values},rt.prototype.isosurface=function(t,e){return r(this._size,this._values,this._points,t,e)};var nt=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),st=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]],at=[[],[],[1,9],[1,9],[2,10,10,1],[2,10,10,1],[2,10,10,9],[2,10,10,9],[11,2],[11,2],[1,9,11,2],[11,2,1,9],[10,1,11,10],[10,1,11,10],[11,10,10,9],[10,9,11,10],[4,7],[4,7],[1,9,4,7],[1,9,4,7],[2,10,10,1,4,7],[4,7,2,10,10,1],[2,10,10,9,4,7],[2,10,10,9,4,7],[4,7,11,2],[4,7,11,2],[1,9,4,7,11,2],[4,7,11,2,1,9],[10,1,11,10,4,7],[11,10,10,1,4,7],[4,7,11,10,10,9],[4,7,11,10,10,9],[9,5,5,4],[9,5,5,4],[5,4,1,5],[5,4,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[2,10,10,5,5,4],[2,10,10,5,5,4],[9,5,5,4,11,2],[11,2,9,5,5,4],[5,4,1,5,11,2],[1,5,11,2,5,4],[11,10,10,1,9,5,5,4],[9,5,5,4,10,1,11,10],[5,4,11,10,10,5],[5,4,10,5,11,10],[5,7,9,5],[9,5,5,7],[1,5,5,7],[1,5,5,7],[9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,7],[5,7,10,5,2,10],[2,10,10,5,5,7],[9,5,5,7,11,2],[9,5,5,7,11,2],[11,2,1,5,5,7],[11,2,1,5,5,7],[9,5,5,7,10,1,11,10],[5,7,9,5,10,1,11,10],[11,10,10,5,5,7],[11,10,10,5,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[6,5,5,1,2,6],[6,5,5,1,2,6],[6,5,5,9,2,6],[5,9,2,6,6,5],[11,2,10,6,6,5,5,10],[11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,11,2],[11,6,6,5,5,1],[5,1,11,6,6,5],[11,6,6,5,5,9],[6,5,5,9,11,6],[5,10,10,6,6,5,4,7],[4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,4,7],[2,6,6,5,5,1,4,7],[5,1,2,6,6,5,4,7],[4,7,5,9,6,5,2,6],[4,7,5,9,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[1,9,11,2,4,7,5,10,10,6,6,5],[4,7,5,1,11,6,6,5],[5,1,11,6,6,5,4,7],[5,9,6,5,11,6,4,7],[6,5,5,9,11,6,4,7],[9,10,6,4,10,6],[10,6,6,4,9,10],[1,10,10,6,6,4],[6,4,1,10,10,6],[9,1,2,6,6,4],[9,1,2,6,6,4],[2,6,6,4],[2,6,6,4],[9,10,10,6,6,4,11,2],[11,2,9,10,10,6,6,4],[11,2,6,4,1,10,10,6],[6,4,1,10,10,6,11,2],[6,4,9,1,11,6],[11,6,9,1,6,4],[11,6,6,4],[6,4,11,6],[10,6,6,7,9,10],[9,10,6,7,10,6],[10,6,6,7,1,10],[10,6,6,7,1,10],[2,6,9,1,6,7],[2,6,9,1,6,7],[6,7,2,6],[6,7,2,6],[11,2,10,6,9,10,6,7],[11,2,6,7,10,6,9,10],[1,10,6,7,10,6,11,2],[11,2,10,6,1,10,6,7],[6,7,9,1,11,6],[9,1,11,6,6,7],[6,7,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,9],[6,2,7,6],[7,6,6,2],[7,6,6,2,1,9],[6,2,1,9,7,6],[7,6,6,10,10,1],[7,6,6,10,10,1],[10,9,6,10,7,6],[7,6,6,10,10,9],[4,6,6,11],[6,11,4,6],[6,11,4,6,1,9],[4,6,1,9,6,11],[4,6,6,11,2,10,10,1],[2,10,10,1,6,11,4,6],[4,6,6,11,2,10,10,9],[10,9,2,10,6,11,4,6],[4,6,6,2],[4,6,6,2],[1,9,4,6,6,2],[1,9,4,6,6,2],[4,6,6,10,10,1],[10,1,6,10,4,6],[4,6,6,10,10,9],[10,9,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[1,5,5,4,7,6,6,11],[7,6,6,11,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,10,5,2,10],[5,4,10,5,2,10,7,6,6,11],[7,6,6,2,5,4,9,5],[9,5,5,4,6,2,7,6],[6,2,7,6,1,5,5,4],[6,2,7,6,5,4,1,5],[9,5,5,4,10,1,6,10,7,6],[6,10,10,1,7,6,9,5,5,4],[10,5,5,4,6,10,7,6],[7,6,6,10,5,4,10,5],[9,5,5,6,6,11],[6,11,5,6,9,5],[1,5,5,6,6,11],[6,11,5,6,1,5],[2,10,10,1,9,5,5,6,6,11],[6,11,5,6,9,5,2,10,10,1],[5,6,6,11,10,5,2,10],[6,11,5,6,2,10,10,5],[9,5,5,6,6,2],[9,5,5,6,6,2],[1,5,5,6,6,2],[1,5,5,6,6,2],[6,10,10,1,5,6,9,5],[10,1,6,10,9,5,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[5,10,10,11,7,5],[5,10,10,11,7,5],[7,5,5,10,10,11,1,9],[7,5,5,10,10,11,1,9],[2,11,7,5,5,1],[7,5,5,1,2,11],[7,5,5,9,2,11],[7,5,2,11,5,9],[5,10,10,2,7,5],[7,5,10,2,5,10],[1,9,5,10,7,5,10,2],[1,9,10,2,5,10,7,5],[5,1,7,5],[7,5,5,1],[5,9,7,5],[5,9,7,5],[4,5,5,10,10,11],[4,5,5,10,10,11],[1,9,10,11,4,5,5,10],[10,11,4,5,5,10,1,9],[5,1,2,11,4,5],[4,5,2,11,5,1],[5,9,2,11,4,5],[4,5,5,9,2,11],[5,10,10,2,4,5],[5,10,10,2,4,5],[10,2,5,10,4,5,1,9],[5,10,10,2,4,5,1,9],[4,5,5,1],[4,5,5,1],[4,5,5,9],[4,5,5,9],[7,4,9,10,10,11],[7,4,9,10,10,11],[1,10,10,11,7,4],[1,10,7,4,10,11],[7,4,2,11,9,1],[7,4,9,1,2,11],[7,4,2,11],[7,4,2,11],[9,10,10,2,7,4],[9,10,7,4,10,2],[10,2,7,4,1,10],[1,10,10,2,7,4],[9,1,7,4],[9,1,7,4],[7,4],[7,4],[9,10,10,11],[9,10,10,11],[1,10,10,11],[1,10,10,11],[2,11,9,1],[9,1,2,11],[2,11],[2,11],[10,2,9,10],[9,10,10,2],[10,2,1,10],[1,10,10,2],[9,1],[9,1],[],[]],lt=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],ht=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]],ct=function(t){
this.dim=t,this.values=new Float32Array(t[0]*t[1]*t[2])};ct.prototype.grid2index=function(t,e,i){return t=n(t,this.dim[0]),e=n(e,this.dim[1]),i=n(i,this.dim[2]),this.dim[2]*(this.dim[1]*t+e)+i},ct.prototype.grid2frac=function(t,e,i){return[t/this.dim[0],e/this.dim[1],i/this.dim[2]]},ct.prototype.frac2grid=function(t){return[0|Math.floor(t[0]*this.dim[0]),0|Math.floor(t[1]*this.dim[1]),0|Math.floor(t[2]*this.dim[2])]},ct.prototype.set_grid_value=function(t,e,i,o){var r=this.grid2index(t,e,i);this.values[r]=o},ct.prototype.get_grid_value=function(t,e,i){var o=this.grid2index(t,e,i);return this.values[o]};var dt=function(){this.unit_cell=null,this.grid=null,this.stats={mean:0,rms:1},this.block=new rt};dt.prototype.abs_level=function(t){return t*this.stats.rms+this.stats.mean},dt.prototype.from_ccp4=function(t,e){if(void 0===e&&(e=!0),t.byteLength<1024)throw Error("File shorter than 1024 bytes.");var i=new Int32Array(t,0,256);if(542130509!==i[52])throw Error("not a CCP4 map");var o,r=[i[0],i[1],i[2]],n=i[3];if(2===n)o=4;else{if(0!==n)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");o=1}var l=[i[4],i[5],i[6]],h=[i[7],i[8],i[9]],c=i[23];if(1024+c+o*r[0]*r[1]*r[2]!==t.byteLength)throw Error("ccp4 file too short or too long");var d=new Float32Array(t,0,t.byteLength>>2);this.unit_cell=new Q(d[10],d[11],d[12],d[13],d[14],d[15]);var u=[i[16],i[17],i[18]],f=u.indexOf(1),p=u.indexOf(2),_=u.indexOf(3),m=d[19],v=d[20],g=new ct(h);if(c%4!==0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");var y;y=2===n?d:new Int8Array(t);var b=(1024+c)/o|0;this.stats.mean=d[21],this.stats.rms=d[54],(this.stats.mean<m||this.stats.mean>v||this.stats.rms<=0)&&(this.stats=s(y,b));var w=1,x=0;0===n&&i[39]===-128&&127===i[40]&&(w=(v-m)/255,x=.5*(m+v+w));var z=[l[0]+r[0],l[1]+r[1],l[2]+r[2]],A=[0,0,0];for(A[2]=l[2];A[2]<z[2];A[2]++)for(A[1]=l[1];A[1]<z[1];A[1]++)for(A[0]=l[0];A[0]<z[0];A[0]++)g.set_grid_value(A[f],A[p],A[_],w*y[b]+x),b++;if(e&&c>0)for(var M=new Uint8Array(t),E=0;E+80<=c;E+=80){var C=void 0,S="";for(C=0;C<80;++C)S+=String.fromCharCode(M[1024+E+C]);if(!/^\s*x\s*,\s*y\s*,\s*z\s*$/i.test(S)){var k=a(S);for(C=0;C<3;++C)k[C][3]=0|Math.round(k[C][3]*h[C]);b=(1024+c)/o|0;var O=[0,0,0];for(A[2]=l[2];A[2]<z[2];A[2]++)for(A[1]=l[1];A[1]<z[1];A[1]++)for(A[0]=l[0];A[0]<z[0];A[0]++){for(C=0;C<3;++C)O[C]=A[f]*k[C][0]+A[p]*k[C][1]+A[_]*k[C][2]+k[C][3];g.set_grid_value(O[0],O[1],O[2],w*y[b]+x),b++}}}this.grid=g},dt.prototype.from_dsn6=function(t){var e=new Uint8Array(t),i=new Int16Array(e.buffer);if(100!==i[18])for(var o=i.length,r=0;r<o;r++){var n=i[r];i[r]=(255&n)<<8|n>>8&255}if(100!==i[18])throw Error("Endian swap failed");var a=[i[0],i[1],i[2]],l=[i[3],i[4],i[5]],h=[i[6],i[7],i[8]],c=1/i[17];this.unit_cell=new Q(c*i[9],c*i[10],c*i[11],c*i[12],c*i[13],c*i[14]);for(var d=new ct(h),u=i[15]/100,f=i[16],p=512,_=[Math.ceil(l[0]/8),Math.ceil(l[1]/8),Math.ceil(l[2]/8)],m=0;m<_[2];m++)for(var v=0;v<_[1];v++)for(var g=0;g<_[0];g++)for(var y=0;y<8;y++)for(var b=8*m+y,w=0;w<8;w++)for(var x=8*v+w,z=0;z<8;z++){var A=8*g+z;if(!(A<l[0]&&x<l[1]&&b<l[2])){p+=8-z;break}var M=(e[p]-f)/u;p++,d.set_grid_value(a[0]+A,a[1]+x,a[2]+b,M)}this.stats=s(d.values,0),this.grid=d},dt.prototype.show_debug_info=function(){console.log("unit cell:",this.unit_cell&&this.unit_cell.parameters),console.log("grid:",this.grid&&this.grid.dim)},dt.prototype.extract_block=function(t,e){var i=this.grid,o=this.unit_cell;if(null!=i&&null!=o){var r=[0,0,0],n=i.dim;if(e){var s=[e[0]-t,e[1]-t,e[2]-t],a=[e[0]+t,e[1]+t,e[2]+t],l=o.fractionalize(s),h=o.fractionalize(a);r=i.frac2grid(l),n=i.frac2grid(h)}for(var c=[n[0]-r[0]+1,n[1]-r[1]+1,n[2]-r[2]+1],d=[],u=[],f=r[0];f<=n[0];f++)for(var p=r[1];p<=n[1];p++)for(var _=r[2];_<=n[2];_++){var m=i.grid2frac(f,p,_),v=o.orthogonalize(m);d.push(v);var g=i.get_grid_value(f,p,_);u.push(g)}this.block.set(d,u,c)}},dt.prototype.isomesh_in_block=function(t,e){var i=this.abs_level(t);return this.block.isosurface(i,e)};var ut=[[0,0,0],[1,0,0],[0,0,0],[0,1,0],[0,0,0],[0,0,1],[1,0,0],[1,1,0],[1,0,0],[1,0,1],[0,1,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[0,0,1],[0,1,1],[1,0,1],[1,1,1],[1,1,0],[1,1,1],[0,1,1],[1,1,1]],ft=["attribute vec3 previous;","attribute vec3 next;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir1 = (mat * vec4(next - position, 0.0)).xy * win_size;","  float len = length(dir1);","  if (len > 0.0) dir1 /= len;","  vec2 dir2 = (mat * vec4(position - previous, 0.0)).xy * win_size;","  len = length(dir2);","  dir2 = len > 0.0 ? dir2 / len : dir1;","  vec2 tang = normalize(dir1 + dir2);","  vec2 normal = vec2(-tang.y, tang.x);","  float outer = side * dot(dir2, normal);","  float angle_factor = max(dot(tang, dir2), outer > 0.0 ? 0.5 : 0.1);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth / angle_factor * normal / win_size;","}"].join("\n"),pt=["attribute vec3 other;","attribute float side;","uniform vec2 win_size;","uniform float linewidth;","varying vec3 vcolor;","void main() {","  vcolor = color;","  mat4 mat = projectionMatrix * modelViewMatrix;","  vec2 dir = normalize((mat * vec4(position - other, 0.0)).xy);","  vec2 normal = vec2(-dir.y, dir.x);","  gl_Position = mat * vec4(position, 1.0);","  gl_Position.xy += side * linewidth * normal / win_size;","}"].join("\n"),_t=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),mt=["uniform float shift;","varying vec3 vcolor;","void main() {","  vcolor = color;","  vec3 pos = position + shift * normalize(normal);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);","}"].join("\n"),vt=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),gt=["uniform vec3 ucolor;","uniform vec3 fogColor;","varying vec4 vcolor;","void main() {","  vec2 scale = vec2(projectionMatrix[0][0], projectionMatrix[1][1]);","  float z = position.z;","  float fogFactor = (z > 0.5 ? 0.2 : 0.7);","  float alpha = 0.8 * smoothstep(z > 1.5 ? -10.0 : 0.01, 0.1, scale.y);","  vcolor = vec4(mix(ucolor, fogColor, fogFactor), alpha);","  gl_Position = vec4(position.xy * scale, -0.99, 1.0);","}"].join("\n"),yt=["varying vec4 vcolor;","void main() {","  gl_FragColor = vcolor;","}"].join("\n"),bt=["uniform float size;","varying vec3 vcolor;","void main() {","  vcolor = color;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_PointSize = size;","}"].join("\n"),wt=["#include <fog_pars_fragment>","varying vec3 vcolor;","void main() {","  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);","  if (dot(diff, diff) >= 0.25) discard;","  gl_FragColor = vec4(vcolor, 1.0);","#include <fog_fragment>","}"].join("\n"),xt=new e.Matrix4,zt=new e.Ray,At=["uniform vec2 canvas_size;","uniform vec2 win_size;","varying vec2 vUv;","void main() {","  vUv = uv;","  vec2 rel_offset = vec2(0.02, -0.3);","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","  gl_Position.xy += (uv + rel_offset) * 2.0 * canvas_size / win_size;","  gl_Position.z += 1.0 * projectionMatrix[2][2];","}"].join("\n"),Mt=["#include <fog_pars_fragment>","varying vec2 vUv;","uniform sampler2D map;","void main() {","  gl_FragColor = texture2D(map, vUv);","#include <fog_fragment>","}"].join("\n"),Et=[{name:"coot dark",bg:0,fg:16777215,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13211568,H:8750469,C:11776768,N:8301307,O:15878532,S:4259648,MG:12632256,P:16760896,CL:10551136,CA:16777215,MN:16748736,FE:10498048,NI:65408,def:10526880},{name:"solarized dark",bg:11062,fg:16643811,map_den:2526162,map_pos:8755456,map_neg:13842050,center:16643811,H:5795445,C:9675169,N:7107012,O:13323030,S:11897088,def:15657173},{name:"solarized light",bg:16643811,fg:11062,map_den:2526162,map_pos:8755456,map_neg:13842050,center:11062,H:9675169,C:5795445,N:7107012,O:13323030,S:11897088,def:472642},{name:"coot light",bg:16777215,fg:0,map_den:3367602,map_pos:2719785,map_neg:9121326,center:13092713,H:10066329,C:11101284,N:1855923,O:12793961,S:10386237,def:8421504}],Ct={NONE:-1,ROTATE:0,PAN:1,ZOOM:2,PAN_ZOOM:3,SLAB:4,ROLL:5,AUTO_ROTATE:6,GO:7},St=["element","B-factor","occupancy","index","chain"],kt=["lines","trace","ribbon"],Ot=["marching cubes","squarish"],Lt=["normal","simplistic"],Ft=["bold 14px","14px","16px","bold 16px"];N.prototype.get_visible_atoms=function(){var t=this.model.atoms;if(this.conf.hydrogens||!this.model.has_hydrogens)return t;for(var e=[],i=0;i<t.length;i++)"H"!==t[i].element&&e.push(t[i]);return e},N.prototype.add_bonds=function(t,i){for(var o=this.get_visible_atoms(),r=t?"element":this.conf.color_aim,n=B(r,o,this.conf.colors),s=[],a=[],l={hydrogens:this.conf.hydrogens,ligands_only:t,balls:"ball&stick"===this.conf.render_style},h=0;h<o.length;h++){var c=o[h],d=n[h];if(!t||c.is_ligand)if(0!==c.bonds.length||l.balls)for(var u=0;u<c.bonds.length;u++){var f=this.model.atoms[c.bonds[u]];if((l.hydrogens||"H"!==f.element)&&(!l.ligands_only||f.is_ligand)){var p=c.midpoint(f),_=new e.Vector3(p[0],p[1],p[2]),m=new e.Vector3(c.xyz[0],c.xyz[1],c.xyz[2]);if(l.balls){var v=m.distanceTo(_)/i;m.lerp(_,v)}s.push(m,_),a.push(d,d)}}else{T(s,c.xyz,.7);for(var g=0;g<6;g++)a.push(d)}}var y=P(this.conf.bond_line,this.win_size),b="simplistic"===this.conf.line_style,w=z({gl_lines:b,linewidth:y,win_size:this.win_size,segments:!0});this.atomic_objects.push(S(w,s,a)),l.balls?this.atomic_objects.push(k(o,n,i)):b||t||this.atomic_objects.push(k(o,n,y))},N.prototype.add_trace=function(){for(var t=this.model.extract_trace(),e=[].concat.apply([],t),i=B(this.conf.color_aim,e,this.conf.colors),o=z({gl_lines:"simplistic"===this.conf.line_style,linewidth:P(this.conf.bond_line,this.win_size),win_size:this.win_size}),r=0,n=0;n<t.length;n++){var s=t[n],a=i.slice(r,r+s.length);r+=s.length;var l=E(o,s,a);this.atomic_objects.push(l)}},N.prototype.add_ribbon=function(t){for(var e=this.model.extract_trace(),i=this.model.get_residues(),o=[].concat.apply([],e),r=B(this.conf.color_aim,o,this.conf.colors),n=0,s=0;s<e.length;s++){for(var a=e[s],l=[],h=[0,0,0],c=0;c<a.length;c++){var d=i[a[c].resid()],u=this.model.calculate_tangent_vector(d);u[0]*h[0]+u[1]*h[1]+u[2]*h[2]<0&&(u[0]=-u[0],u[1]=-u[1],u[2]=-u[2]),l.push(u),h=u}var f=r.slice(n,n+a.length);n+=a.length;var p=g(a,f,l,t);this.atomic_objects.push(p)}},H.prototype.pick_atom=function(t,e){var i=this.active_model_bag;if(null!==i){this.raycaster.setFromCamera(t,e),this.raycaster.near=e.near,this.raycaster.far=e.far-.15*(e.far-e.near),this.raycaster.linePrecision=.3;var o=this.raycaster.intersectObjects(i.atomic_objects);if(o.length<1)return null;o.sort(function(t){return t.line_dist||1/0});var r=o[0].point;return i.model.get_nearest_atom(r.x,r.y,r.z)}},H.prototype.set_colors=function(t){function i(t){return new e.Color(t)}if(null==t)t=this.ColorSchemes[0];else if("number"==typeof t)t=this.ColorSchemes[t%this.ColorSchemes.length];else if("string"==typeof t)for(var o=0;o!==this.ColorSchemes.length;o++)if(this.ColorSchemes[o].name===t){t=this.ColorSchemes[o];break}if(void 0!==t.bg){if("number"==typeof t.bg)for(var r in t)"name"!==r&&(t[r]=t[r]instanceof Array?t[r].map(i):i(t[r]));this.decor.zoom_grid.color_value.set(t.fg),this.redraw_all()}},H.prototype.relX=function(t){return 2*(t.pageX-this.window_offset[0])/this.window_size[0]-1},H.prototype.relY=function(t){return 1-2*(t.pageY-this.window_offset[1])/this.window_size[1]},H.prototype.hud=function(t,e){if("undefined"!=typeof document){var i=this.hud_el;if(i){void 0!==t?"HTML"===e?i.innerHTML=t:i.textContent=t:i.innerHTML=this.initial_hud_html;var o="ERR"===e;i.style["background-color"]=o?"#b00":this.initial_hud_bg,o&&console.log("ERR: "+t)}else console.log("hud: "+t)}},H.prototype.redraw_center=function(){this.target.distanceToSquared(this.last_ctr)>1e-4&&(this.last_ctr.copy(this.target),this.mark&&this.scene.remove(this.mark),this.mark=l(.1,this.target,{color:this.config.colors.center,linewidth:2,win_size:this.window_size}),this.scene.add(this.mark))},H.prototype.redraw_maps=function(t){this.redraw_center();for(var e=0;e<this.map_bags.length;e++){var i=this.map_bags[e];(t||this.target.distanceToSquared(i.block_ctr)>.01)&&this.redraw_map(i)}},H.prototype.remove_and_dispose=function(t,e){e||this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material&&(t.material.uniforms&&t.material.uniforms.map&&t.material.uniforms.map.value.dispose(),t.material.dispose());for(var i=0;i<t.children.length;i++)this.remove_and_dispose(t.children[i])},H.prototype.clear_el_objects=function(t){for(var e=0;e<t.el_objects.length;e++)this.remove_and_dispose(t.el_objects[e]);t.el_objects=[]},H.prototype.clear_atomic_objects=function(t){if(t.atomic_objects)for(var e=0;e<t.atomic_objects.length;e++)this.remove_and_dispose(t.atomic_objects[e]);t.atomic_objects=null},H.prototype.set_atomic_objects=function(t){switch(t.atomic_objects=[],t.conf.render_style){case"lines":t.add_bonds();break;case"ball&stick":var e=this.camera.projectionMatrix.elements[5],i=Math.max(1,200*e);t.add_bonds(!1,i);break;case"trace":t.add_trace(),t.add_bonds(!0);break;case"ribbon":t.add_ribbon(8),t.add_bonds(!0)}for(var o=0;o<t.atomic_objects.length;o++)this.scene.add(t.atomic_objects[o])},H.prototype.toggle_label=function(t,e){if(t){var i=t.short_label(),o=i,r=o in this.labels;if(void 0===e&&(e=!r),e){if(r)return;var n=F(i,{pos:t.xyz,font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString(),win_size:this.window_size});if(!n)return;this.labels[o]=n,this.scene.add(n)}else{if(!r)return;this.remove_and_dispose(this.labels[o]),delete this.labels[o]}}},H.prototype.redraw_labels=function(){for(var t in this.labels){var e=t;this.labels[t].remake(e,{font:this.config.label_font,color:"#"+this.config.colors.fg.getHexString()})}},H.prototype.toggle_map_visibility=function(t){"number"==typeof t&&(t=this.map_bags[t]),t.visible=!t.visible,this.redraw_map(t),this.request_render()},H.prototype.redraw_map=function(t){this.clear_el_objects(t),t.visible&&(t.map.block.clear(),this.add_el_objects(t))},H.prototype.toggle_model_visibility=function(t){t=t||this.active_model_bag,t.visible=!t.visible,this.redraw_model(t),this.request_render()},H.prototype.redraw_model=function(t){this.clear_atomic_objects(t),t.visible&&this.set_atomic_objects(t)},H.prototype.redraw_models=function(){for(var t=0;t<this.model_bags.length;t++)this.redraw_model(this.model_bags[t])},H.prototype.add_el_objects=function(t){if(t.visible&&!(this.config.map_radius<=0)){if(t.map.block.empty()){var e=this.target;t.block_ctr.copy(e),t.map.extract_block(this.config.map_radius,[e.x,e.y,e.z])}for(var i=0;i<t.types.length;i++){var o=t.types[i],r=("map_neg"===o?-1:1)*t.isolevel,n=t.map.isomesh_in_block(r,this.config.map_style),s=y(n,{color:this.config.colors[o],linewidth:this.config.map_line});t.el_objects.push(s),this.scene.add(s)}}},H.prototype.change_isolevel_by=function(t,e){if(!(t>=this.map_bags.length)){var i=this.map_bags[t];i.isolevel+=e,this.clear_el_objects(i),this.add_el_objects(i);var o=i.map.abs_level(i.isolevel),r=o.toFixed(4),n=this.tied_viewer;if(n&&t<n.map_bags.length){var s=n.map_bags[t];s.isolevel=i.isolevel,r+=" / "+s.map.abs_level(s.isolevel).toFixed(4),n.clear_el_objects(s),n.add_el_objects(s)}this.hud("map "+(t+1)+" level =  "+r+" e/Å³ ("+i.isolevel.toFixed(2)+" rmsd)")}},H.prototype.change_map_radius=function(t){var e=40,i=this.config;i.map_radius=Math.min(Math.max(i.map_radius+t,0),e);var o='map "radius": '+i.map_radius;i.map_radius===e?o+=" (max)":0===i.map_radius&&(o+=" (hidden maps)"),this.hud(o),this.redraw_maps(!0)},H.prototype.change_slab_width_by=function(t){var e=this.controls.slab_width;e[0]=Math.max(e[0]+t,.01),e[1]=Math.max(e[1]+t,.01),this.update_camera(),this.hud("clip width: "+(this.camera.far-this.camera.near).toPrecision(3))},H.prototype.change_zoom_by_factor=function(t){this.camera.zoom*=t,this.update_camera(),this.hud("zoom: "+this.camera.zoom.toPrecision(3))},H.prototype.change_bond_line=function(t){this.config.bond_line=Math.max(this.config.bond_line+t,.1),this.redraw_models(),this.hud("bond width: "+P(this.config.bond_line,this.window_size).toFixed(1))},H.prototype.change_map_line=function(t){this.config.map_line=Math.max(this.config.map_line+t,.1),this.redraw_maps(!0),this.hud("wireframe width: "+this.config.map_line.toFixed(1))},H.prototype.toggle_full_screen=function(){var t=document;if(t.fullscreenElement||t.mozFullScreenElement||t.webkitFullscreenElement||t.msFullscreenElement){var e=t.exitFullscreen||t.webkitExitFullscreen||t.mozCancelFullScreen||t.msExitFullscreen;e&&e.call(t)}else{var i=this.container,o=i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen;o&&o.call(i)}},H.prototype.toggle_cell_box=function(){if(this.decor.cell_box)this.scene.remove(this.decor.cell_box),this.decor.cell_box=null;else{var t=null;this.model_bags.length>0&&(t=this.model_bags[0].model.unit_cell),!t&&this.map_bags.length>0&&(t=this.map_bags[0].map.unit_cell),t&&(this.decor.cell_box=h(t.orthogonalize.bind(t),{color:this.config.colors.fg}),this.scene.add(this.decor.cell_box))}},H.prototype.shift_clip=function(t){var e=this.camera.position.clone().sub(this.target);e.multiplyScalar(t/e.length()),this.target.add(e),this.camera.position.add(e),this.update_camera(),this.redraw_maps(),this.hud("clip shifted by ["+U(e,2).join(" ")+"]")},H.prototype.go_to_nearest_Ca=function(){var t=this.target;if(null!==this.active_model_bag){var e=this.active_model_bag.model.get_nearest_atom(t.x,t.y,t.z,"CA");e?this.select_atom(e,{steps:30}):this.hud("no nearby CA")}},H.prototype.permalink=function(){"undefined"!=typeof window&&(window.location.hash="#xyz="+U(this.target,1).join(",")+"&eye="+U(this.camera.position,1).join(",")+"&zoom="+this.camera.zoom.toFixed(0),this.hud("copy URL from the location bar"))},H.prototype.redraw_all=function(){this.renderer&&(this.scene.fog.color=this.config.colors.bg,this.renderer&&this.renderer.setClearColor(this.config.colors.bg,1),this.redraw_models(),this.redraw_maps(!0),this.redraw_labels())},H.prototype.toggle_help=function(){var t=this.help_el;t&&(t.style.display="block"===t.style.display?"none":"block",""===t.innerHTML&&(t.innerHTML=[this.MOUSE_HELP,this.KEYBOARD_HELP,this.ABOUT_HELP].join("\n\n")))},H.prototype.MOUSE_HELP=["<b>mouse:</b>","Left = rotate","Middle or Ctrl+Left = pan","Right = zoom","Ctrl+Right = clipping","Ctrl+Shift+Right = roll","Wheel = σ level","Shift+Wheel = diff map σ"].join("\n"),H.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","T = representation","C = coloring","B = bg color","Q = label font","+/- = sigma level","]/[ = map radius","D/F = clip width","numpad 3/. = move clip","M/N = zoom","U = unitcell box","Y = hydrogens","R = center view","W = wireframe style","I = spin","K = rock","Home/End = bond width","\\ = bond caps","P = nearest Cα","Shift+P = permalink","(Shift+)space = next res.","Shift+F = full screen"].join("\n"),H.prototype.ABOUT_HELP='<a href="https://uglymol.github.io">about uglymol</a>',H.prototype.select_next=function(t,e,i,o){var r=i.indexOf(this.config[e]),n=i.length,s=(r+(o?n-1:1))%n;this.config[e]=i[s];for(var a=t+":",l=0;l<n;l++){var h=l===s?"u":"s",c=i[l].name||i[l];a+=" <"+h+">"+c+"</"+h+">"}this.hud(a,"HTML")},H.prototype.keydown=function(t){var e=this.key_bindings[t.keyCode];e?e.bind(this)(t):(e===!1&&t.preventDefault(),this.help_el&&this.hud("Nothing here. Press H for help.")),this.request_render()},H.prototype.set_common_key_bindings=function(){var t=new Array(256);t[66]=function(t){this.select_next("color scheme","colors",this.ColorSchemes,t.shiftKey),this.set_colors(this.config.colors)},t[67]=function(t){this.select_next("coloring by","color_aim",St,t.shiftKey),this.redraw_models()},t[68]=function(){this.change_slab_width_by(-.1)},t[70]=function(t){t.shiftKey?this.toggle_full_screen():this.change_slab_width_by(.1)},t[72]=this.toggle_help,t[73]=function(t){this.hud("toggled spinning"),this.controls.toggle_auto(t.shiftKey)},t[75]=function(){this.hud("toggled rocking"),this.controls.toggle_auto(0)},t[77]=function(t){this.change_zoom_by_factor(t.shiftKey?1.2:1.03)},t[78]=function(t){this.change_zoom_by_factor(1/(t.shiftKey?1.2:1.03))},t[81]=function(t){this.select_next("label font","label_font",Ft,t.shiftKey),this.redraw_labels()},t[82]=function(t){t.shiftKey?(this.hud("redraw!"),this.redraw_all()):(this.hud("recentered"),this.recenter())},t[85]=function(){this.hud("toggled unit cell box"),this.toggle_cell_box()},t[87]=function(t){this.select_next("map style","map_style",Ot,t.shiftKey),this.redraw_maps(!0)},t[107]=t[61]=t[187]=function(t){this.change_isolevel_by(t.shiftKey?1:0,.1)},t[109]=t[173]=t[189]=function(t){this.change_isolevel_by(t.shiftKey?1:0,-.1)},t[219]=function(){this.change_map_radius(-2)},t[221]=function(){this.change_map_radius(2)},t[220]=function(t){this.select_next("bond lines","line_style",Lt,t.shiftKey),this.redraw_models()},t[51]=t[99]=function(){this.shift_clip(1)},t[108]=t[110]=function(){this.shift_clip(-1)},t[16]=t[17]=t[18]=t[225]=function(){},t[191]=t[222]=!1,this.key_bindings=t},H.prototype.set_real_space_key_bindings=function(){var t=this.key_bindings;t[36]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_bond_line(.2)},t[35]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_bond_line(-.2)},t[32]=function(t){this.center_next_residue(t.shiftKey)},t[80]=function(t){t.shiftKey?this.permalink():this.go_to_nearest_Ca()},t[84]=function(t){this.select_next("rendering as","render_style",kt,t.shiftKey),this.redraw_models()},t[89]=function(t){this.config.hydrogens=!this.config.hydrogens,this.hud((this.config.hydrogens?"show":"hide")+" hydrogens (if any)"),this.redraw_models()}},H.prototype.mousedown=function(t){t.stopPropagation(),document.addEventListener("mouseup",this.mouseup),document.addEventListener("mousemove",this.mousemove);var e=Ct.NONE;1===t.button||0===t.button&&t.ctrlKey?e=Ct.PAN:0===t.button?(t.shiftKey&&this.dblclick(t),e=Ct.ROTATE):2===t.button&&(t.ctrlKey?e=t.shiftKey?Ct.ROLL:Ct.SLAB:(this.decor.zoom_grid.visible=!0,e=Ct.ZOOM)),this.controls.start(e,this.relX(t),this.relY(t)),this.request_render()},H.prototype.dblclick=function(t){if(0===t.button){this.decor.selection&&(this.remove_and_dispose(this.decor.selection),this.decor.selection=null);var i=new e.Vector2(this.relX(t),this.relY(t)),o=this.pick_atom(i,this.camera);if(o){this.hud(o.long_label()),this.toggle_label(o);var r=this.config.colors[o.element]||this.config.colors.def,n=2.5*P(this.config.bond_line,this.window_size);this.decor.selection=k([o],[r],n),this.scene.add(this.decor.selection)}else this.hud();this.request_render()}},H.prototype.touchstart=function(t){var e=t.touches;if(1===e.length)this.controls.start(Ct.ROTATE,this.relX(e[0]),this.relY(e[0]));else{var i=K(t);this.controls.start(Ct.PAN_ZOOM,this.relX(i),this.relY(i),i.dist)}this.request_render()},H.prototype.touchmove=function(t){t.preventDefault(),t.stopPropagation();var e=t.touches;if(1===e.length)this.controls.move(this.relX(e[0]),this.relY(e[0]));else{var i=K(t);this.controls.move(this.relX(i),this.relY(i),i.dist)}},H.prototype.touchend=function(){this.controls.stop(),this.redraw_maps()},H.prototype.mousewheel=function(t){t.preventDefault(),t.stopPropagation();var e=t.wheelDelta||-2*(t.detail||0);this.mousewheel_action(e,t),this.request_render()},H.prototype.mousewheel_action=function(t,e){this.change_isolevel_by(e.shiftKey?1:0,5e-4*t)},H.prototype.resize=function(){var t=this.container,e=t.clientWidth,i=t.clientHeight;this.window_offset[0]=t.offsetLeft,this.window_offset[1]=t.offsetTop,this.camera.left=-e,this.camera.right=e,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,i),e===this.window_size[0]&&i===this.window_size[1]||(this.window_size[0]=e,this.window_size[1]=i,this.redraw_models()),this.request_render()},H.prototype.recenter=function(t,i,o){var r,n=this.active_model_bag;if(null!=t&&null==i&&null!==n){t=new e.Vector3(t[0],t[1],t[2]);var s=n.model.get_center(),a=new e.Vector3(t[0]-s[0],t[1]-s[1],t[2]-s[2]);a.setLength(100),r=a.y<90?new e.Vector3(0,1,0):new e.Vector3(1,0,0),r.projectOnPlane(a).normalize(),i=a.add(t)}else if(t=t||(n?n.model.get_center():[0,0,0]),null!=i)i=new e.Vector3(i[0],i[1],i[2]),r=null;else{var l=this.default_camera_pos;i=new e.Vector3(t[0]+l[0],t[1]+l[1],t[2]+l[2]),r=e.Object3D.DefaultUp}this.controls.go_to(t,i,r,o)},H.prototype.center_next_residue=function(t){if(this.active_model_bag){var e=this.active_model_bag.model.next_residue(this.selected_atom,t);e&&this.select_atom(e,{steps:30})}},H.prototype.select_atom=function(t,e){void 0===e&&(e={}),this.hud("-> "+t.long_label()),this.controls.go_to(t.xyz,null,null,e.steps),this.toggle_label(this.selected_atom),this.selected_atom=t,this.toggle_label(t)},H.prototype.update_camera=function(){var t=this.camera.position.distanceTo(this.target),e=this.controls.slab_width,i=3===e.length?e[2]:this.camera.zoom;this.camera.near=t*(1-e[0]/i),this.camera.far=t*(1+e[1]/i),this.camera.updateProjectionMatrix()},H.prototype.render=function(){if(this.scheduled=!0,null!==this.renderer){this.controls.update()&&this.update_camera();var t=this.tied_viewer;this.controls.is_going()||(this.redraw_maps(),t&&!t.scheduled&&t.redraw_maps()),this.renderer.render(this.scene,this.camera),t&&!t.scheduled&&t.renderer.render(t.scene,t.camera),this.nav&&this.nav.renderer.render(this.nav.scene,this.camera),this.scheduled=!1,this.controls.is_moving()&&this.request_render(),this.stats&&this.stats.update()}},H.prototype.request_render=function(){"undefined"==typeof window||this.scheduled||(this.scheduled=!0,window.requestAnimationFrame(this.render.bind(this)))},H.prototype.set_model=function(t){var e=new N(t,this.config,this.window_size);this.model_bags.push(e),this.set_atomic_objects(e),this.active_model_bag=e,this.request_render()},H.prototype.add_map=function(t,e){var i=new V(t,e);this.map_bags.push(i),this.add_el_objects(i),this.request_render()},H.prototype.load_file=function(t,e,i){if(null!==this.renderer){var o=new XMLHttpRequest;o.open("GET",t,!0),e.binary?o.responseType="arraybuffer":o.overrideMimeType("text/plain");var r=this;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status&&null!==o.response)try{i(o)}catch(e){r.hud("Error: "+e.message+"\nin "+t,"ERR")}else r.hud("Failed to fetch "+t,"ERR")},e.progress&&o.addEventListener("progress",function(e){if(e.lengthComputable&&e.loaded&&e.total){var i=t.split("/").pop();r.hud("loading "+i+" ... "+(e.loaded>>10)+" / "+(e.total>>10)+" kB"),e.loaded===e.total&&r.hud()}});try{o.send(null)}catch(e){r.hud("loading "+t+" failed:\n"+e,"ERR")}}},H.prototype.set_view=function(t){var e=D();e.zoom&&(this.camera.zoom=e.zoom),this.recenter(e.xyz||t&&t.center,e.eye,1)},H.prototype.load_pdb=function(t,e,i){var o=this;this.load_file(t,{binary:!1},function(t){var r=new et;r.from_pdb(t.responseText),o.set_model(r),o.set_view(e),i&&i()})},H.prototype.load_map=function(t,e,i){if("ccp4"!==e.format&&"dsn6"!==e.format)throw Error("Unknown map format.");var o=this;this.load_file(t,{binary:!0,progress:!0},function(t){o.load_map_from_buffer(t.response,e),i&&i()})},H.prototype.load_map_from_buffer=function(t,e){var i=new dt;"dsn6"===e.format?i.from_dsn6(t):i.from_ccp4(t,!0),this.add_map(i,e.diff_map)},H.prototype.load_ccp4_maps=function(t,e,i){var o=this;this.load_map(t,{diff_map:!1,format:"ccp4"},function(){o.load_map(e,{diff_map:!0,format:"ccp4"},i)})},H.prototype.load_pdb_and_ccp4_maps=function(t,e,i,o){var r=this;this.load_pdb(t,{},function(){r.load_ccp4_maps(e,i,o)})},H.prototype.ColorSchemes=Et;var Tt=["all","unindexed","#1"],jt=["three","two","none"];G.prototype=Object.create(H.prototype),G.prototype.constructor=G,G.prototype.KEYBOARD_HELP=["<b>keyboard:</b>","H = toggle help","V = show (un)indexed","A = toggle axes","B = bg color","M/N = zoom","D/F = clip width","R = center view","Z/X = point size","Shift+P = permalink","Shift+F = full screen","←/→ = max resol.","↑/↓ = min resol."].join("\n"),G.prototype.MOUSE_HELP=H.prototype.MOUSE_HELP.split("\n").slice(0,-2).join("\n"),G.prototype.set_reciprocal_key_bindings=function(){var t=this.key_bindings;t[65]=function(t){this.select_next("axes","show_axes",jt,t.shiftKey),this.set_axes()},t[80]=function(t){this.permalink()},t[86]=function(t){this.select_next("show","show_only",Tt,t.shiftKey);var e=Tt.indexOf(this.config.show_only);this.points.material.uniforms.show_only.value=e-2},t[88]=function(t){t.ctrlKey?this.change_map_line(.1):this.change_point_size(.5)},t[90]=function(t){t.ctrlKey?this.change_map_line(-.1):this.change_point_size(-.5)},t[51]=t[99]=function(){this.shift_clip(.1)},t[108]=t[110]=function(){this.shift_clip(-.1)},t[37]=function(){this.change_dmin(.05)},t[39]=function(){this.change_dmin(-.05)},t[38]=function(){this.change_dmax(.025)},t[40]=function(){this.change_dmax(-.025)}},G.prototype.set_dropzone=function(){if("undefined"!=typeof document){var t=this.renderer.domElement,e=this;t.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",e.hud("ready for drop...")}),t.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault();for(var i=[],o=0,r=t.dataTransfer.files;o<r.length;o+=1){var n=r[o],s=new FileReader;/\.(map|ccp4)$/.test(n.name)?(s.onload=function(t){e.load_map_from_ab(t.target.result)},s.readAsArrayBuffer(n)):(s.onload=function(t){e.load_from_string(t.target.result,{})},s.readAsText(n)),i.push(n.name)}e.hud("loading "+i.join(", "))})}},G.prototype.load_data=function(t,e){void 0===e&&(e={});var i=this;this.load_file(t,{binary:!1,progress:!0},function(t){i.load_from_string(t.responseText,e),e.callback&&e.callback()})},G.prototype.load_from_string=function(t,e){"{"===t[0]?this.data=Z(t):this.data=X(t),this.max_dist=Y(this.data.pos),this.d_min=1/this.max_dist;var i=I(this.data.lattice_ids);Tt.splice(3);for(var o=1;o<=i;o++)Tt.push("#"+(o+1));this.set_axes(),this.set_points(),this.camera.zoom=.5*(this.camera.top-this.camera.bottom);var r=1.01*this.max_dist;this.controls.slab_width=[r,r,100],this.set_view(e)},G.prototype.load_map_from_ab=function(t){this.map_bags.length>0&&this.clear_el_objects(this.map_bags.pop()),this.load_map_from_buffer(t,{format:"ccp4"})},G.prototype.set_axes=function(){if(null!=this.axes&&(this.remove_and_dispose(this.axes),this.axes=null),"none"!==this.config.show_axes){var t=1.2*this.max_dist,e=[];T(e,[0,0,0],t);var i=this.config.colors.axes,o=[i[0],i[0],i[1],i[1],i[2],i[2]];"two"===this.config.show_axes&&(e.splice(4),o.splice(4));var r=z({win_size:this.window_size,linewidth:3,segments:!0});this.axes=S(r,e,o),this.scene.add(this.axes)}};var Pt="\nattribute float group;\nuniform float show_only;\nuniform float r2_max;\nuniform float r2_min;\nuniform float size;\nvarying vec3 vcolor;\nvoid main() {\n  vcolor = color;\n  float r2 = dot(position, position);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  if (r2 < r2_min || r2 >= r2_max || (show_only != -2.0 && show_only != group))\n    gl_Position.x = 2.0;\n  gl_PointSize = size;\n}",qt="\nvarying vec3 vcolor;\nvoid main() {\n  // not sure how reliable is such rounding of points\n  vec2 diff = gl_PointCoord - vec2(0.5, 0.5);\n  float dist_sq = 4.0 * dot(diff, diff);\n  if (dist_sq >= 1.0) discard;\n  gl_FragColor = vec4(vcolor, 1.0 - dist_sq * dist_sq * dist_sq);\n}";G.prototype.set_points=function(){if(null!=this.data){null!=this.points&&(this.remove_and_dispose(this.points),this.points=null);var t=this.data.pos,i=this.data.lattice_ids,o=new Float32Array(3*i.length);this.colorize_by_id(o,i);var r=new e.BufferGeometry;r.addAttribute("position",new e.BufferAttribute(t,3)),r.addAttribute("color",new e.BufferAttribute(o,3));var n=new Float32Array(i);
r.addAttribute("group",new e.BufferAttribute(n,1));var s=new e.ShaderMaterial({uniforms:{size:{value:3},show_only:{value:-2},r2_max:{value:100},r2_min:{value:0}},vertexShader:Pt,fragmentShader:qt,vertexColors:e.VertexColors});s.transparent=!0,this.points=new e.Points(r,s),this.scene.add(this.points),this.request_render()}},G.prototype.colorize_by_id=function(t,e){for(var i=this.config.colors.lattices,o=0;o<e.length;o++){var r=i[(e[o]+1)%4];t[3*o]=r.r,t[3*o+1]=r.g,t[3*o+2]=r.b}},G.prototype.redraw_center=function(){},G.prototype.mousewheel_action=function(t,e){this.change_zoom_by_factor(1+5e-4*t)},G.prototype.change_point_size=function(t){if(null!==this.points){var e=this.points.material.uniforms.size;e.value=Math.max(e.value+t,.5),this.hud("point size: "+e.value.toFixed(1))}},G.prototype.change_dmin=function(t){if(null!=this.d_min){this.d_min=Math.max(this.d_min+t,.1);var e=this.d_max_inv>0?1/this.d_max_inv:null;null!==e&&this.d_min>e&&(this.d_min=e),this.points.material.uniforms.r2_max.value=1/(this.d_min*this.d_min);var i=null!==e?e.toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")}},G.prototype.change_dmax=function(t){if(null!=this.d_min){var e=Math.min(this.d_max_inv+t,1/this.d_min);e<1e-6&&(e=0),this.d_max_inv=e,this.points.material.uniforms.r2_min.value=e*e;var i=e>0?(1/e).toFixed(2):"∞";this.hud("res. limit: "+i+" - "+this.d_min.toFixed(2)+"Å")}},G.prototype.redraw_models=function(){this.points&&this.remove_and_dispose(this.points),this.set_points()},G.prototype.ColorSchemes=[{name:"solarized dark",bg:11062,fg:16643811,map_den:15657173,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]},{name:"solarized light",bg:16643811,fg:11062,map_den:472642,lattices:[14430767,2793880,2526162,8755456,13842050,11897088,7107012,13323030],axes:[16755370,11206570,11184895]}],t.UnitCell=Q,t.Model=et,t.Block=rt,t.ElMap=dt,t.makeCube=l,t.makeRgbBox=h,t.makeRibbon=g,t.makeChickenWire=y,t.makeGrid=b,t.makeLineMaterial=z,t.makeLine=E,t.makeLineSegments=S,t.makeWheels=k,t.makeLabel=F,t.addXyzCross=T,t.Viewer=H,t.ReciprocalViewer=G,Object.defineProperty(t,"__esModule",{value:!0})});